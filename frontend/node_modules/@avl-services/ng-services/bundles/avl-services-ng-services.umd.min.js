!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/router"),require("rxjs"),require("uuid"),require("@avl-ng-controls/auth"),require("@ngx-translate/core"),require("@avl-controls/ng-binders"),require("@avl-controls/core/dist/avl-localization-service/avl-localization-service"),require("@angular/common/http"),require("rxjs/operators"),require("@microsoft/signalr")):"function"==typeof define&&define.amd?define("@avl-services/ng-services",["exports","@angular/core","@angular/router","rxjs","uuid","@avl-ng-controls/auth","@ngx-translate/core","@avl-controls/ng-binders","@avl-controls/core/dist/avl-localization-service/avl-localization-service","@angular/common/http","rxjs/operators","@microsoft/signalr"],t):t(((e=e||self)["avl-services"]=e["avl-services"]||{},e["avl-services"]["ng-services"]={}),e.ng.core,e.ng.router,e.rxjs,e.uuid,e["@avl-ng-controls/auth"],e["@ngx-translate/core"],e["@avl-controls/ng-binders"],null,e.ng.common.http,e.rxjs.operators,e.signalr)}(this,(function(e,t,o,n,i,r,s,a,c,g,u,l){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var h,p=function(){return(p=Object.assign||function(e){for(var t,o=1,n=arguments.length;o<n;o++)for(var i in t=arguments[o])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function d(e,t,o,n){var i,r=arguments.length,s=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(r<3?i(s):r>3?i(t,o,s):i(t,o))||s);return r>3&&s&&Object.defineProperty(t,o,s),s}function f(e,t){return function(o,n){t(o,n,e)}}(h=e.MessageType||(e.MessageType={})).action="action",h.colorScheme="colorScheme",h.language="language",h.locale="locale",h.navigation="navigation",h.registration="registration",h.theme="theme",h.login="login",h.authentication="authentication",h.redirectedFromLogIn="redirectedFromLogIn",h.user="user";var v,y=function(){function s(t,o){var r,s=this;this.router=t,this.authService=o,this.handlers=((r={})[e.MessageType.theme]=function(e){return s.handleTheme(e)},r[e.MessageType.locale]=function(e){return s.handleLocale(e)},r[e.MessageType.language]=function(e){return s.handleLanguage(e)},r[e.MessageType.colorScheme]=function(e){return s.handleColorScheme(e)},r[e.MessageType.navigation]=function(e){return s.handleNavigation(e)},r[e.MessageType.action]=function(e){return s.handleAction(e)},r[e.MessageType.authentication]=function(e){return s.handleAuthentication(e)},r[e.MessageType.redirectedFromLogIn]=function(e){return s.handleRedirectedFromLogIn(e)},r),this.themeSubject=new n.Subject,this.languageSubject=new n.Subject,this.actionSubject=new n.Subject,this.localeSubject=new n.Subject,this.colorSchemeSubject=new n.Subject,this.theme$=this.themeSubject,this.language$=this.languageSubject,this.action$=this.actionSubject,this.locale$=this.localeSubject,this.colorScheme$=this.colorSchemeSubject,this.redirectedFromLogIn=new n.BehaviorSubject(void 0),this.isChild=window.location!==window.parent.location,window.addEventListener("message",(function(e){return s.onMessage(e)})),this.id=i.v4()}return s.prototype.notifyShellAboutAction=function(t){this.postMessageToShell(e.MessageType.action,t)},s.prototype.notifyShellAboutLogin=function(t){this.postMessageToShell(e.MessageType.login,t)},s.prototype.notifyShellAboutNavigation=function(t){this.postMessageToShell(e.MessageType.navigation,t)},s.prototype.registerToShell=function(){this.postMessageToShell(e.MessageType.registration,this.id)},s.prototype.updateUserToShell=function(){var t=this.authService.readUserFromSessionStorage();this.postMessageToShell(e.MessageType.user,t)},s.prototype.onMessage=function(e){var t=e.data,o=t.payload,n=t.messageType,i=p(p({},this.handlers),{default:function(){return console.log("Unrecognized message for the shell.",e)}});(i[n]||i.default)(o)},s.prototype.postMessageToShell=function(e,t){var o={messageType:e,payload:t};window.parent.window.postMessage(o,"*")},s.prototype.handleColorScheme=function(e){this.colorSchemeSubject.next(e)},s.prototype.handleLanguage=function(e){this.languageSubject.next(e)},s.prototype.handleLocale=function(e){this.localeSubject.next(e)},s.prototype.handleTheme=function(e){this.themeSubject.next(e)},s.prototype.handleNavigation=function(e){this.router.navigateByUrl(e)},s.prototype.handleAction=function(e){this.actionSubject.next(e)},s.prototype.handleAuthentication=function(e){(null==e?void 0:e.access_token)?this.authService.storeUserToSessionStorage(e):this.authService.clearUserFromSessionStorage(),this.authService.reloadPersistedUserData()},s.prototype.handleRedirectedFromLogIn=function(e){this.redirectedFromLogIn.next(e)},s.ctorParameters=function(){return[{type:o.Router},{type:r.AvlAuthService}]},s.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new s(t.ɵɵinject(o.Router),t.ɵɵinject(r.AvlAuthService))},token:s,providedIn:"root"}),s=d([t.Injectable({providedIn:"root"})],s)}(),S=function(){function e(e,t){this.translateService=e,this.translationService=t,this.languages=[{code:"en",label:"English"},{code:"hr",label:"Croatian"}]}return e.prototype.initializeTranslations=function(){var e=this;return function(){AvlLocalizationService.translationService=e.translationService;var t=localStorage.getItem("lang");return null==t&&(t=e.languages[0].code,localStorage.setItem("lang",t)),e.translateService.use(t).toPromise()}},Object.defineProperty(e.prototype,"language",{get:function(){return localStorage.getItem("lang")},enumerable:!0,configurable:!0}),e.prototype.changeLanguage=function(e){var t=localStorage.getItem("lang");t&&t===e||(localStorage.setItem("lang",e),location.reload())},e.ctorParameters=function(){return[{type:s.TranslateService},{type:a.NgxTranslateTranslationService}]},e.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new e(t.ɵɵinject(s.TranslateService),t.ɵɵinject(a.NgxTranslateTranslationService))},token:e,providedIn:"root"}),e=d([t.Injectable({providedIn:"root"})],e)}(),m=function(){function e(){this.themeChangedSubject=new n.Subject,this.themeChanged=this.themeChangedSubject.asObservable(),this.changeTheme()}return Object.defineProperty(e.prototype,"isDarkTheme",{get:function(){return null==this._isDarkTheme&&(this._isDarkTheme="dark"===localStorage.getItem("theme")||!1),this._isDarkTheme},set:function(e){this._isDarkTheme=e,localStorage.setItem("theme",!0===e?"dark":"light"),this.themeChangedSubject.next(this.getCurrentTheme()),this.changeTheme()},enumerable:!0,configurable:!0}),e.prototype.getCurrentTheme=function(){return this.isDarkTheme?"dark":"light"},e.prototype.changeTheme=function(){document.body.setAttribute("theme",this.getCurrentTheme())},e.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new e},token:e,providedIn:"root"}),e=d([t.Injectable({providedIn:"root"})],e)}(),b=function(){function o(t,o,i){var r,s=this;this.translationManagementService=t,this.themeService=o,this.authService=i,this.handlers=((r={})[e.MessageType.login]=function(e){return s.handleLogin(e)},r[e.MessageType.navigation]=function(e){return s.handleNavigation(e)},r[e.MessageType.action]=function(e){return s.handleAction(e)},r[e.MessageType.registration]=function(e){return s.handleRegistration()},r[e.MessageType.user]=function(e){return s.handleUser(e)},r),this.actionSubject=new n.Subject,this.navigationSubject=new n.Subject,this.loginSubject=new n.Subject,this.registrationCompletedSubject=new n.Subject,this.action$=this.actionSubject,this.navigation$=this.navigationSubject,this.login$=this.loginSubject,this.registrationCompleted$=this.registrationCompletedSubject,window.addEventListener("message",(function(e){return s.onMessage(e)})),this.themeService.themeChanged.subscribe((function(){return s.postThemeToChildren()}))}return o.prototype.notifyChildAboutLocale=function(t){this.postMessageToChild(e.MessageType.locale,t)},o.prototype.notifyChildAboutLanguage=function(t){this.postMessageToChild(e.MessageType.language,t)},o.prototype.notifyChildAboutAction=function(t){this.postMessageToChild(e.MessageType.action,t)},o.prototype.notifyChildAboutNavigation=function(t){this.postMessageToChild(e.MessageType.navigation,t)},o.prototype.postAuthenticationDataToChildren=function(){var t=this.authService.readUserFromSessionStorage();this.postMessageToChild(e.MessageType.authentication,t)},o.prototype.postThemeToChildren=function(){var t=this.themeService.getCurrentTheme();this.postMessageToChild(e.MessageType.theme,t)},o.prototype.postLanguageToChildren=function(){this.postMessageToChild(e.MessageType.language,this.translationManagementService.language)},o.prototype.postLocaleToChildren=function(){var t=localStorage.getItem("country");this.postMessageToChild(e.MessageType.locale,t)},o.prototype.postRedirectedFromLogIn=function(t){this.postMessageToChild(e.MessageType.redirectedFromLogIn,t)},o.prototype.postColorSchemeToChildren=function(){var t=window.getComputedStyle(document.body),o={"--avl-product-color":t.getPropertyValue("--avl-product-color"),"--avl-product-hover-color":t.getPropertyValue("--avl-product-hover-color"),"--avl-product-focus-color":t.getPropertyValue("--avl-product-focus-color")};this.postMessageToChild(e.MessageType.colorScheme,o)},o.prototype.handleAction=function(e){this.actionSubject.next(e)},o.prototype.handleNavigation=function(e){this.navigationSubject.next(e)},o.prototype.handleLogin=function(e){this.loginSubject.next(e)},o.prototype.handleRegistration=function(){this.iframeEl=document.getElementsByTagName("iframe")[0],this.postThemeToChildren(),this.postColorSchemeToChildren(),this.postLanguageToChildren(),this.postLocaleToChildren(),this.registrationCompletedSubject.next(!0)},o.prototype.onMessage=function(e){var t=e.data,o=t.payload,n=t.messageType,i=p(p({},this.handlers),{default:function(){return console.log("Unrecognized message for the child.",e)}});(i[n]||i.default)(o)},o.prototype.postMessageToChild=function(e,t){var o;if(this.iframeEl){var n={messageType:e,payload:t};null===(o=this.iframeEl.contentWindow)||void 0===o||o.postMessage(n,"*")}},o.prototype.handleUser=function(e){(null==e?void 0:e.access_token)?this.authService.storeUserToSessionStorage(e):this.authService.clearUserFromSessionStorage(),this.authService.reloadPersistedUserData()},o.ctorParameters=function(){return[{type:S},{type:m},{type:r.AvlAuthService}]},o.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new o(t.ɵɵinject(S),t.ɵɵinject(m),t.ɵɵinject(r.AvlAuthService))},token:o,providedIn:"root"}),o=d([t.Injectable({providedIn:"root"})],o)}();(v=e.LogSeverity||(e.LogSeverity={}))[v.Debug=0]="Debug",v[v.Info=1]="Info",v[v.Warning=2]="Warning",v[v.Error=3]="Error",v[v.Fatal=4]="Fatal";var T=function(t,o,n,i,r,s,a,c){void 0===r&&(r=!1),void 0===s&&(s=e.LogSeverity.Info),void 0===a&&(a=3e4),void 0===c&&(c=10),this.autologging=!1,this.globalLogLevel=e.LogSeverity.Info,this.debounceTime=3e4,this.capacity=10,this.endpoint=t,this.targetName=o,this.appName=n,this.version=i,this.autologging=r,this.globalLogLevel=s,this.debounceTime=a,this.capacity=c},L=function(){function o(e,t,o){var i,r=this;this.http=e,this.config=t,this.authService=o,this.logs=[],this.isLogging=!1,this.debounceTime$=new n.Subject,this.logs$=new n.Subject,this.stopLogging$=new n.Subject,this.postLogs$=new n.Subject,this.destroyed$=new n.Subject,this.headers=new g.HttpHeaders({targetName:this.config.targetName}),t.autologging&&(null===(i=this.authService)||void 0===i||i.isLoggedIn$.pipe(u.takeUntil(this.destroyed$)).subscribe((function(e){return r.decideOnLogging(e)})))}return o.prototype.ngOnDestroy=function(){this.postLogs$.complete(),this.debounceTime$.complete(),this.logs$.complete(),this.stopLogging$.next(),this.stopLogging$.complete(),this.destroyed$.next(),this.destroyed$.complete()},o.prototype.startLogging=function(){var e=this;this.isLogging=!0,this.debounceTime$.pipe(u.takeUntil(this.stopLogging$),u.switchMap((function(t){return e.periodicalLogging(t)}))).subscribe((function(){return e.onPostMessages()})),this.postLogs$.pipe(u.takeUntil(this.stopLogging$),u.switchMap((function(){return e.postMessages()}))).subscribe((function(){return e.onPostMessages()})),this.setLoggingDebounceTime(this.config.debounceTime)},o.prototype.stopLogging=function(){this.isLogging=!1,this.postLogs(),this.stopLogging$.next()},o.prototype.getLogs$=function(){return this.logs$.asObservable()},o.prototype.debug=function(t,o){void 0===o&&(o=""),this.log(t,e.LogSeverity.Debug,o)},o.prototype.info=function(t,o){void 0===o&&(o=""),this.log(t,e.LogSeverity.Info,o)},o.prototype.warn=function(t,o){void 0===o&&(o=""),this.log(t,e.LogSeverity.Warning,o)},o.prototype.error=function(t,o){void 0===o&&(o=""),this.log(t,e.LogSeverity.Error,o)},o.prototype.fatal=function(t,o){void 0===o&&(o=""),this.log(t,e.LogSeverity.Fatal,o)},o.prototype.setLoggingDebounceTime=function(e){this.config.debounceTime=e,this.debounceTime$.next(e)},o.prototype.setGlobalLogLevel=function(e){this.config.globalLogLevel=e},o.prototype.setLogCapacity=function(e){this.config.capacity=e},o.prototype.log=function(e,t,o){!this.isLogging||t<this.config.globalLogLevel||(this.createAndStoreLog(e,t,o),this.dispatchLogs(),this.isFullCapacity()&&this.postLogs$.next())},o.prototype.createAndStoreLog=function(e,t,o){var n=(new Date).toISOString(),i=this.config,r=i.appName,s=i.version,a={message:e,severity:t.toString(),timestamp:n,componentName:o,appName:r,version:s};this.logs.push(a)},o.prototype.isFullCapacity=function(){return this.logs.length>=this.config.capacity},o.prototype.clearLogs=function(){this.logs=[]},o.prototype.onPostMessages=function(){this.clearLogs(),this.dispatchLogs()},o.prototype.postLogs=function(){this.postLogs$.next()},o.prototype.periodicalLogging=function(e){var t=this;return n.interval(e).pipe(u.tap((function(){t.logs.length||t.dispatchLogs()})),u.filter((function(){return!!t.logs.length})),u.switchMap((function(){return t.postMessages()})))},o.prototype.postMessages=function(){return this.http.post(this.config.endpoint,this.logs,{headers:this.headers})},o.prototype.dispatchLogs=function(){this.logs$.next(this.logs)},o.prototype.decideOnLogging=function(e){e?this.startLogging():this.stopLogging()},o.ctorParameters=function(){return[{type:g.HttpClient},{type:T,decorators:[{type:t.Inject,args:["loggingConfig"]}]},{type:r.AvlAuthService,decorators:[{type:t.Optional},{type:t.Inject,args:[r.AvlAuthService]}]}]},o.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new o(t.ɵɵinject(g.HttpClient),t.ɵɵinject("loggingConfig"),t.ɵɵinject(r.AvlAuthService,8))},token:o,providedIn:"root"}),o=d([t.Injectable({providedIn:"root"}),f(1,t.Inject("loggingConfig")),f(2,t.Optional()),f(2,t.Inject(r.AvlAuthService))],o)}(),j=function(){function e(e){if(e)throw new Error("LoggingModule is already loaded. Import it in the AppModule only")}var o;return o=e,e.forRoot=function(e){return{ngModule:o,providers:[L,{provide:"loggingConfig",useValue:e}]}},e.ctorParameters=function(){return[{type:e,decorators:[{type:t.Optional},{type:t.SkipSelf}]}]},e=o=d([t.NgModule(),f(0,t.Optional()),f(0,t.SkipSelf())],e)}(),C=function(){function e(){this.hubConnections=[],this.notification=new n.Subject,this.notification$=this.notification}return e.prototype.startConnection=function(e,t){var o=this,n=this.getConnectionByID(t.connectionID);n||(n=this.buildConnection(e,t)),n.state!==l.HubConnectionState.Connected&&n.start().then((function(){return o.startNotifications(n,t.metadata)})).catch((function(){return console.warn("Notification service: Failed to establish connection.")}))},e.prototype.stopConnection=function(e){var t=this.getConnectionByID(e);t&&(t.off("transferNotification"),t.stop())},e.prototype.removeConnection=function(e){this.stopConnection(e);var t=this.hubConnections.findIndex((function(t){return t.id===e}));-1!==t&&this.hubConnections.splice(t,1)},e.prototype.updateNotifications=function(e,t){var o=this.getConnectionByID(e);o&&this.startNotifications(o,t)},e.prototype.startNotifications=function(e,t){e.invoke("startNotifications",t)},e.prototype.getConnectionByID=function(e){var t,o=this.hubConnections.findIndex((function(t){return t.id===e}));return null===(t=this.hubConnections[o])||void 0===t?void 0:t.connection},e.prototype.buildConnection=function(e,t){var o=this,n=(new l.HubConnectionBuilder).configureLogging(l.LogLevel.None).withUrl(e).withAutomaticReconnect().build();return n.onreconnected((function(){return o.startNotifications(n,t.metadata)})),n.on("transferNotification",(function(e){o.notification.next(e)})),this.hubConnections.push({id:t.connectionID,connection:n}),n},e=d([t.Injectable()],e)}();e.ChildCommunicationService=b,e.LogConfig=T,e.LoggingModule=j,e.LoggingService=L,e.NotificationService=C,e.ShellCommunicationService=y,e.ThemeService=m,e.TranslationManagementService=S,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=avl-services-ng-services.umd.min.js.map