!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/router"),require("rxjs"),require("uuid"),require("@avl-ng-controls/auth"),require("@ngx-translate/core"),require("@avl-controls/ng-binders"),require("@avl-controls/core/dist/avl-localization-service/avl-localization-service"),require("@angular/common/http"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("@avl-services/ng-services",["exports","@angular/core","@angular/router","rxjs","uuid","@avl-ng-controls/auth","@ngx-translate/core","@avl-controls/ng-binders","@avl-controls/core/dist/avl-localization-service/avl-localization-service","@angular/common/http","rxjs/operators"],t):t(((e=e||self)["avl-services"]=e["avl-services"]||{},e["avl-services"]["ng-services"]={}),e.ng.core,e.ng.router,e.rxjs,e.uuid,e["@avl-ng-controls/auth"],e["@ngx-translate/core"],e["@avl-controls/ng-binders"],null,e.ng.common.http,e.rxjs.operators)}(this,(function(e,t,o,n,i,s,r,a,c,g,l){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var u,h=function(){return(h=Object.assign||function(e){for(var t,o=1,n=arguments.length;o<n;o++)for(var i in t=arguments[o])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function p(e,t,o,n){var i,s=arguments.length,r=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(r=(s<3?i(r):s>3?i(t,o,r):i(t,o))||r);return s>3&&r&&Object.defineProperty(t,o,r),r}function d(e,t){return function(o,n){t(o,n,e)}}(u=e.MessageType||(e.MessageType={})).action="action",u.colorScheme="colorScheme",u.language="language",u.locale="locale",u.navigation="navigation",u.registration="registration",u.theme="theme",u.login="login",u.authentication="authentication",u.redirectedFromLogIn="redirectedFromLogIn";var f,m=function(){function r(t,o){var s,r=this;this.router=t,this.authService=o,this.handlers=((s={})[e.MessageType.theme]=function(e){return r.handleTheme(e)},s[e.MessageType.locale]=function(e){return r.handleLocale(e)},s[e.MessageType.language]=function(e){return r.handleLanguage(e)},s[e.MessageType.colorScheme]=function(e){return r.handleColorScheme(e)},s[e.MessageType.navigation]=function(e){return r.handleNavigation(e)},s[e.MessageType.action]=function(e){return r.handleAction(e)},s[e.MessageType.authentication]=function(e){return r.handleAuthentication(e)},s[e.MessageType.redirectedFromLogIn]=function(e){return r.handleRedirectedFromLogIn(e)},s),this.themeSubject=new n.Subject,this.languageSubject=new n.Subject,this.actionSubject=new n.Subject,this.localeSubject=new n.Subject,this.colorSchemeSubject=new n.Subject,this.theme$=this.themeSubject,this.language$=this.languageSubject,this.action$=this.actionSubject,this.locale$=this.localeSubject,this.colorScheme$=this.colorSchemeSubject,this.redirectedFromLogIn=new n.BehaviorSubject(void 0),this.isChild=window.location!==window.parent.location,window.addEventListener("message",(function(e){return r.onMessage(e)})),this.id=i.v4()}return r.prototype.notifyShellAboutAction=function(t){this.postMessageToShell(e.MessageType.action,t)},r.prototype.notifyShellAboutLogin=function(t){this.postMessageToShell(e.MessageType.login,t)},r.prototype.notifyShellAboutNavigation=function(t){this.postMessageToShell(e.MessageType.navigation,t)},r.prototype.registerToShell=function(){this.postMessageToShell(e.MessageType.registration,this.id)},r.prototype.onMessage=function(e){var t=e.data,o=t.payload,n=t.messageType,i=h(h({},this.handlers),{default:function(){return console.log("Unrecognized message for the shell.",e)}});(i[n]||i.default)(o)},r.prototype.postMessageToShell=function(e,t){var o={messageType:e,payload:t};window.parent.window.postMessage(o,"*")},r.prototype.handleColorScheme=function(e){this.colorSchemeSubject.next(e)},r.prototype.handleLanguage=function(e){this.languageSubject.next(e)},r.prototype.handleLocale=function(e){this.localeSubject.next(e)},r.prototype.handleTheme=function(e){this.themeSubject.next(e)},r.prototype.handleNavigation=function(e){this.router.navigateByUrl(e)},r.prototype.handleAction=function(e){this.actionSubject.next(e)},r.prototype.handleAuthentication=function(e){(null==e?void 0:e.access_token)?this.setUserToSessionStorage(e):this.removeUserFromSessionStorage(),this.authService.reloadPersistedUserData()},r.prototype.handleRedirectedFromLogIn=function(e){this.redirectedFromLogIn.next(e)},r.prototype.setUserToSessionStorage=function(e){sessionStorage.setItem("refresh_token",e.refresh_token),sessionStorage.setItem("access_token",e.access_token),sessionStorage.setItem("id_token",e.id_token),sessionStorage.setItem("refresh_token_expires_at",String(e.refresh_token_expires_at)),sessionStorage.setItem("access_token_expires_at",String(e.access_token_expires_at)),sessionStorage.setItem("access_token_stored_at",String(e.access_token_stored_at)),sessionStorage.setItem("username",e.username),sessionStorage.setItem("name",e.name),sessionStorage.setItem("roles",JSON.stringify(e.roles))},r.prototype.removeUserFromSessionStorage=function(){sessionStorage.removeItem("refresh_token"),sessionStorage.removeItem("access_token"),sessionStorage.removeItem("id_token"),sessionStorage.removeItem("refresh_token_expires_at"),sessionStorage.removeItem("access_token_expires_at"),sessionStorage.removeItem("access_token_stored_at"),sessionStorage.removeItem("username"),sessionStorage.removeItem("name"),sessionStorage.removeItem("roles")},r.ctorParameters=function(){return[{type:o.Router},{type:s.AvlAuthService}]},r.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new r(t.ɵɵinject(o.Router),t.ɵɵinject(s.AvlAuthService))},token:r,providedIn:"root"}),r=p([t.Injectable({providedIn:"root"})],r)}(),v=function(){function e(e,t){this.translateService=e,this.translationService=t,this.languages=[{code:"en",label:"English"},{code:"hr",label:"Croatian"}]}return e.prototype.initializeTranslations=function(){var e=this;return function(){AvlLocalizationService.translationService=e.translationService;var t=localStorage.getItem("lang");return null==t&&(t=e.languages[0].code,localStorage.setItem("lang",t)),e.translateService.use(t).toPromise()}},Object.defineProperty(e.prototype,"language",{get:function(){return localStorage.getItem("lang")},enumerable:!0,configurable:!0}),e.prototype.changeLanguage=function(e){var t=localStorage.getItem("lang");t&&t===e||(localStorage.setItem("lang",e),location.reload())},e.ctorParameters=function(){return[{type:r.TranslateService},{type:a.NgxTranslateTranslationService}]},e.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new e(t.ɵɵinject(r.TranslateService),t.ɵɵinject(a.NgxTranslateTranslationService))},token:e,providedIn:"root"}),e=p([t.Injectable({providedIn:"root"})],e)}(),y=function(){function e(){this.themeChangedSubject=new n.Subject,this.themeChanged=this.themeChangedSubject.asObservable(),this.changeTheme()}return Object.defineProperty(e.prototype,"isDarkTheme",{get:function(){return null==this._isDarkTheme&&(this._isDarkTheme="dark"===localStorage.getItem("theme")||!1),this._isDarkTheme},set:function(e){this._isDarkTheme=e,localStorage.setItem("theme",!0===e?"dark":"light"),this.themeChangedSubject.next(this.getCurrentTheme()),this.changeTheme()},enumerable:!0,configurable:!0}),e.prototype.getCurrentTheme=function(){return this.isDarkTheme?"dark":"light"},e.prototype.changeTheme=function(){document.body.setAttribute("theme",this.getCurrentTheme())},e.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new e},token:e,providedIn:"root"}),e=p([t.Injectable({providedIn:"root"})],e)}(),S=function(){function o(t,o){var i,s=this;this.translationManagementService=t,this.themeService=o,this.handlers=((i={})[e.MessageType.login]=function(e){return s.handleLogin(e)},i[e.MessageType.navigation]=function(e){return s.handleNavigation(e)},i[e.MessageType.action]=function(e){return s.handleAction(e)},i[e.MessageType.registration]=function(e){return s.handleRegistration()},i),this.actionSubject=new n.Subject,this.navigationSubject=new n.Subject,this.loginSubject=new n.Subject,this.registrationCompletedSubject=new n.Subject,this.action$=this.actionSubject,this.navigation$=this.navigationSubject,this.login$=this.loginSubject,this.registrationCompleted$=this.registrationCompletedSubject,window.addEventListener("message",(function(e){return s.onMessage(e)})),this.themeService.themeChanged.subscribe((function(){return s.postThemeToChildren()}))}return o.prototype.notifyChildAboutLocale=function(t){this.postMessageToChild(e.MessageType.locale,t)},o.prototype.notifyChildAboutLanguage=function(t){this.postMessageToChild(e.MessageType.language,t)},o.prototype.notifyChildAboutAction=function(t){this.postMessageToChild(e.MessageType.action,t)},o.prototype.notifyChildAboutNavigation=function(t){this.postMessageToChild(e.MessageType.navigation,t)},o.prototype.postAuthenticationDataToChildren=function(){var t={refresh_token:sessionStorage.getItem("refresh_token"),access_token:sessionStorage.getItem("access_token"),id_token:sessionStorage.getItem("id_token"),refresh_token_expires_at:Number(sessionStorage.getItem("refresh_token_expires_at")),access_token_expires_at:Number(sessionStorage.getItem("access_token_expires_at")),access_token_stored_at:Number(sessionStorage.getItem("access_token_stored_at")),username:sessionStorage.getItem("username"),name:sessionStorage.getItem("name"),roles:JSON.parse(sessionStorage.getItem("roles"))};this.postMessageToChild(e.MessageType.authentication,t)},o.prototype.postThemeToChildren=function(){var t=this.themeService.getCurrentTheme();this.postMessageToChild(e.MessageType.theme,t)},o.prototype.postLanguageToChildren=function(){this.postMessageToChild(e.MessageType.language,this.translationManagementService.language)},o.prototype.postLocaleToChildren=function(){var t=localStorage.getItem("country");this.postMessageToChild(e.MessageType.locale,t)},o.prototype.postRedirectedFromLogIn=function(t){this.postMessageToChild(e.MessageType.redirectedFromLogIn,t)},o.prototype.postColorSchemeToChildren=function(){var t=window.getComputedStyle(document.body),o={"--avl-product-color":t.getPropertyValue("--avl-product-color"),"--avl-product-hover-color":t.getPropertyValue("--avl-product-hover-color"),"--avl-product-focus-color":t.getPropertyValue("--avl-product-focus-color")};this.postMessageToChild(e.MessageType.colorScheme,o)},o.prototype.handleAction=function(e){this.actionSubject.next(e)},o.prototype.handleNavigation=function(e){this.navigationSubject.next(e)},o.prototype.handleLogin=function(e){this.loginSubject.next(e)},o.prototype.handleRegistration=function(){this.iframeEl=document.getElementsByTagName("iframe")[0],this.postThemeToChildren(),this.postColorSchemeToChildren(),this.postLanguageToChildren(),this.postLocaleToChildren(),this.registrationCompletedSubject.next(!0)},o.prototype.onMessage=function(e){var t=e.data,o=t.payload,n=t.messageType,i=h(h({},this.handlers),{default:function(){return console.log("Unrecognized message for the child.",e)}});(i[n]||i.default)(o)},o.prototype.postMessageToChild=function(e,t){var o;if(this.iframeEl){var n={messageType:e,payload:t};null===(o=this.iframeEl.contentWindow)||void 0===o||o.postMessage(n,"*")}},o.ctorParameters=function(){return[{type:v},{type:y}]},o.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new o(t.ɵɵinject(v),t.ɵɵinject(y))},token:o,providedIn:"root"}),o=p([t.Injectable({providedIn:"root"})],o)}();(f=e.LogSeverity||(e.LogSeverity={}))[f.Debug=0]="Debug",f[f.Info=1]="Info",f[f.Warning=2]="Warning",f[f.Error=3]="Error",f[f.Fatal=4]="Fatal";var b=function(t,o,n,i,s,r,a,c){void 0===s&&(s=!1),void 0===r&&(r=e.LogSeverity.Info),void 0===a&&(a=3e4),void 0===c&&(c=10),this.autologging=!1,this.globalLogLevel=e.LogSeverity.Info,this.debounceTime=3e4,this.capacity=10,this.endpoint=t,this.targetName=o,this.appName=n,this.version=i,this.autologging=s,this.globalLogLevel=r,this.debounceTime=a,this.capacity=c},T=function(){function o(e,t,o){var i,s=this;this.http=e,this.config=t,this.authService=o,this.logs=[],this.isLogging=!1,this.debounceTime$=new n.Subject,this.logs$=new n.Subject,this.stopLogging$=new n.Subject,this.postLogs$=new n.Subject,this.destroyed$=new n.Subject,this.headers=new g.HttpHeaders({targetName:this.config.targetName}),t.autologging&&(null===(i=this.authService)||void 0===i||i.isLoggedIn$.pipe(l.takeUntil(this.destroyed$)).subscribe((function(e){return s.decideOnLogging(e)})))}return o.prototype.ngOnDestroy=function(){this.postLogs$.complete(),this.debounceTime$.complete(),this.logs$.complete(),this.stopLogging$.next(),this.stopLogging$.complete(),this.destroyed$.next(),this.destroyed$.complete()},o.prototype.startLogging=function(){var e=this;this.isLogging=!0,console.log("Start logging"),this.debounceTime$.pipe(l.takeUntil(this.stopLogging$),l.switchMap((function(t){return e.periodicalLogging(t)}))).subscribe((function(){return e.onPostMessages()})),this.postLogs$.pipe(l.takeUntil(this.stopLogging$),l.switchMap((function(){return e.postMessages()}))).subscribe((function(){return e.onPostMessages()})),this.setLoggingDebounceTime(this.config.debounceTime)},o.prototype.stopLogging=function(){this.isLogging=!1,console.log("Stop logging"),this.postLogs(),this.stopLogging$.next()},o.prototype.getLogs$=function(){return this.logs$.asObservable()},o.prototype.debug=function(t,o){void 0===o&&(o=""),this.log(t,e.LogSeverity.Debug,o)},o.prototype.info=function(t,o){void 0===o&&(o=""),this.log(t,e.LogSeverity.Info,o)},o.prototype.warn=function(t,o){void 0===o&&(o=""),this.log(t,e.LogSeverity.Warning,o)},o.prototype.error=function(t,o){void 0===o&&(o=""),this.log(t,e.LogSeverity.Error,o)},o.prototype.fatal=function(t,o){void 0===o&&(o=""),this.log(t,e.LogSeverity.Fatal,o)},o.prototype.setLoggingDebounceTime=function(e){console.log("New debounce time: ",e),this.config.debounceTime=e,this.debounceTime$.next(e)},o.prototype.setGlobalLogLevel=function(e){console.log("New global log level: ",e),this.config.globalLogLevel=e},o.prototype.setLogCapacity=function(e){console.log("New capacity: ",e),this.config.capacity=e},o.prototype.log=function(e,t,o){!this.isLogging||t<this.config.globalLogLevel||(this.createAndStoreLog(e,t,o),this.dispatchLogs(),this.isFullCapacity()&&(console.log("Full capacity. Logging..."),this.postLogs$.next()))},o.prototype.createAndStoreLog=function(e,t,o){var n=(new Date).toISOString(),i=this.config,s=i.appName,r=i.version,a={message:e,severity:t.toString(),timestamp:n,componentName:o,appName:s,version:r};this.logs.push(a)},o.prototype.isFullCapacity=function(){return this.logs.length>=this.config.capacity},o.prototype.clearLogs=function(){this.logs=[]},o.prototype.onPostMessages=function(){this.clearLogs(),this.dispatchLogs(),console.log("Logs posted.")},o.prototype.postLogs=function(){this.postLogs$.next()},o.prototype.periodicalLogging=function(e){var t=this;return n.interval(e).pipe(l.tap((function(){t.logs.length||(t.dispatchLogs(),console.log("Empty logs. Nothing to send."))})),l.filter((function(){return!!t.logs.length})),l.tap((function(){return console.log("Time expired. Logging...")})),l.switchMap((function(){return t.postMessages()})))},o.prototype.postMessages=function(){return this.http.post(this.config.endpoint,this.logs,{headers:this.headers})},o.prototype.dispatchLogs=function(){this.logs$.next(this.logs)},o.prototype.decideOnLogging=function(e){e?this.startLogging():this.stopLogging()},o.ctorParameters=function(){return[{type:g.HttpClient},{type:b,decorators:[{type:t.Inject,args:["loggingConfig"]}]},{type:s.AvlAuthService,decorators:[{type:t.Optional},{type:t.Inject,args:[s.AvlAuthService]}]}]},o.ɵprov=t.ɵɵdefineInjectable({factory:function(){return new o(t.ɵɵinject(g.HttpClient),t.ɵɵinject("loggingConfig"),t.ɵɵinject(s.AvlAuthService,8))},token:o,providedIn:"root"}),o=p([t.Injectable({providedIn:"root"}),d(1,t.Inject("loggingConfig")),d(2,t.Optional()),d(2,t.Inject(s.AvlAuthService))],o)}(),L=function(){function e(e){if(e)throw new Error("LoggingModule is already loaded. Import it in the AppModule only")}var o;return o=e,e.forRoot=function(e){return{ngModule:o,providers:[T,{provide:"loggingConfig",useValue:e}]}},e.ctorParameters=function(){return[{type:e,decorators:[{type:t.Optional},{type:t.SkipSelf}]}]},e=o=p([t.NgModule(),d(0,t.Optional()),d(0,t.SkipSelf())],e)}();e.ChildCommunicationService=S,e.LogConfig=b,e.LoggingModule=L,e.LoggingService=T,e.ShellCommunicationService=m,e.ThemeService=y,e.TranslationManagementService=v,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=avl-services-ng-services.umd.min.js.map