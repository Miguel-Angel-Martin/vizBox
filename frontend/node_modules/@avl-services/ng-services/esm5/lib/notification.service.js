import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { HubConnectionBuilder, HubConnectionState, LogLevel } from '@microsoft/signalr';
import * as ɵngcc0 from '@angular/core';
var NotificationService = /** @class */ (function () {
    function NotificationService() {
        this.hubConnections = [];
        this.notification = new Subject();
        /**
         * Observable which emits newly arrived notifications.
         */
        this.notification$ = this.notification;
    }
    /**
     * Builds and starts signalR hub connection with the server.
     * If connection already exists and is not connected, restarts the connection.
     * @param endpoint server endpoint
     * @param options options of the connection
     */
    NotificationService.prototype.startConnection = function (endpoint, options) {
        var _this = this;
        var connection = this.getConnectionByID(options.connectionID);
        if (!connection) {
            connection = this.buildConnection(endpoint, options);
        }
        if (connection.state === HubConnectionState.Connected) {
            return;
        }
        connection
            .start()
            .then(function () { return _this.startNotifications(connection, options.metadata); })
            .catch(function () { return console.warn('Notification service: Failed to establish connection.'); });
    };
    /**
     * Stops connection with the server
     * @param connectionID connection identifier
     */
    NotificationService.prototype.stopConnection = function (connectionID) {
        var connection = this.getConnectionByID(connectionID);
        if (!connection) {
            return;
        }
        connection.off('transferNotification');
        connection.stop();
    };
    /**
     * Removes connection entirely
     * @param connectionID connection identifier
     */
    NotificationService.prototype.removeConnection = function (connectionID) {
        this.stopConnection(connectionID);
        var index = this.hubConnections.findIndex(function (connection) { return connection.id === connectionID; });
        if (index !== -1) {
            this.hubConnections.splice(index, 1);
        }
    };
    /**
     * Updates notifications metadata for specific connection. Notifies server about it.
     * @param connectionID connection identifier
     * @param metadata notification metadata, (e.g language)
     */
    NotificationService.prototype.updateNotifications = function (connectionID, metadata) {
        var connection = this.getConnectionByID(connectionID);
        if (!connection) {
            return;
        }
        this.startNotifications(connection, metadata);
    };
    // Private methods
    NotificationService.prototype.startNotifications = function (connection, metadata) {
        connection.invoke('startNotifications', metadata);
    };
    NotificationService.prototype.getConnectionByID = function (connectionID) {
        var _a;
        var index = this.hubConnections.findIndex(function (connection) { return connection.id === connectionID; });
        return (_a = this.hubConnections[index]) === null || _a === void 0 ? void 0 : _a.connection;
    };
    NotificationService.prototype.buildConnection = function (endpoint, options) {
        var _this = this;
        var hubConnection = new HubConnectionBuilder()
            .configureLogging(LogLevel.None)
            .withUrl(endpoint)
            .withAutomaticReconnect()
            .build();
        hubConnection.onreconnected(function () { return _this.startNotifications(hubConnection, options.metadata); });
        hubConnection.on('transferNotification', function (notification) {
            _this.notification.next(notification);
        });
        this.hubConnections.push({
            id: options.connectionID,
            connection: hubConnection
        });
        return hubConnection;
    };
NotificationService.ɵfac = function NotificationService_Factory(t) { return new (t || NotificationService)(); };
NotificationService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: NotificationService, factory: function (t) { return NotificationService.ɵfac(t); } });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(NotificationService, [{
        type: Injectable
    }], function () { return []; }, null); })();
    return NotificationService;
}());
export { NotificationService };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZpY2F0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIm5nOi9AYXZsLXNlcnZpY2VzL25nLXNlcnZpY2VzL2xpYi9ub3RpZmljYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRTNDLE9BQU8sRUFFTCxvQkFBb0IsRUFDcEIsa0JBQWtCLEVBQ2xCLFFBQVEsRUFDVCxNQUFNLG9CQUFvQixDQUFDOztBQW1CNUI7QUFDb0IsSUFEcEI7QUFBaUMsUUFDdkIsbUJBQWMsR0FBNEIsRUFBRSxDQUFDO0FBQ3ZELFFBQVUsaUJBQVksR0FBNkIsSUFBSSxPQUFPLEVBQUUsQ0FBQztBQUNqRSxRQUNFO0FBQ0Y7QUFFQSxXQURLO0FBQ0wsUUFBUyxrQkFBYSxHQUFnQyxJQUFJLENBQUMsWUFBWSxDQUFDO0FBQ3hFLElBa0dBLENBQUM7QUFDRCxJQWxHRTtBQUNGO0FBQ0U7QUFDRTtBQUNFO0FBRUosT0FERztBQUNMLElBQVMsNkNBQWUsR0FBdEIsVUFBdUIsUUFBZ0IsRUFBRSxPQUF5QztBQUFJLFFBQXRGLGlCQWNDO0FBQ0gsUUFkSSxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ2xFLFFBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtBQUNyQixZQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUMzRCxTQUFLO0FBQ0wsUUFDSSxJQUFJLFVBQVUsQ0FBQyxLQUFLLEtBQUssa0JBQWtCLENBQUMsU0FBUyxFQUFFO0FBQzNELFlBQU0sT0FBTztBQUNiLFNBQUs7QUFDTCxRQUNJLFVBQVU7QUFDZCxhQUFPLEtBQUssRUFBRTtBQUNkLGFBQU8sSUFBSSxDQUFDLGNBQU0s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QSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUVBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFHQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFHQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFDQSxBQUFBLEFBRUEsQUFJQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFFQSxBQUFBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBQUEsQUFGQSxBQXFCQSxBQWpCQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUF6R0EsQUFBQSxBQURBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUEwR0EsQUFBQSxBQUFBLEFBQUEsQUExR0EsQUEwR0EsQUExR0EsQUFBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHtcclxuICBIdWJDb25uZWN0aW9uLFxyXG4gIEh1YkNvbm5lY3Rpb25CdWlsZGVyLFxyXG4gIEh1YkNvbm5lY3Rpb25TdGF0ZSxcclxuICBMb2dMZXZlbFxyXG59IGZyb20gJ0BtaWNyb3NvZnQvc2lnbmFscic7XHJcblxyXG5pbXBvcnQge1xyXG4gIEF2bE5vdGlmaWNhdGlvbixcclxuICBBdmxOb3RpZmljYXRpb25Db25uZWN0aW9uT3B0aW9ucyxcclxuICBBdmxOb3RpZmljYXRpb25NZXRhZGF0YVxyXG59IGZyb20gJ0BhdmwtY29udHJvbHMvaW50ZXJmYWNlcyc7XHJcblxyXG5pbnRlcmZhY2UgQXBwbGljYXRpb25Db25uZWN0aW9uIHtcclxuICAvKiogQ29ubmVjdGlvbiBpZGVudGlmaWVyICovXHJcbiAgcmVhZG9ubHkgaWQ6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICogQ29ubmVjdGlvbiB0byB0aGUgYmFja2VuZCBodWIuXHJcbiAgICovXHJcbiAgcmVhZG9ubHkgY29ubmVjdGlvbjogSHViQ29ubmVjdGlvbjtcclxufVxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgTm90aWZpY2F0aW9uU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBodWJDb25uZWN0aW9uczogQXBwbGljYXRpb25Db25uZWN0aW9uW10gPSBbXTtcclxuICBwcml2YXRlIG5vdGlmaWNhdGlvbjogU3ViamVjdDxBdmxOb3RpZmljYXRpb24+ID0gbmV3IFN1YmplY3QoKTtcclxuXHJcbiAgLyoqXHJcbiAgICogT2JzZXJ2YWJsZSB3aGljaCBlbWl0cyBuZXdseSBhcnJpdmVkIG5vdGlmaWNhdGlvbnMuXHJcbiAgICovXHJcbiAgcHVibGljIG5vdGlmaWNhdGlvbiQ6IE9ic2VydmFibGU8QXZsTm90aWZpY2F0aW9uPiA9IHRoaXMubm90aWZpY2F0aW9uO1xyXG5cclxuICAvKipcclxuICAgKiBCdWlsZHMgYW5kIHN0YXJ0cyBzaWduYWxSIGh1YiBjb25uZWN0aW9uIHdpdGggdGhlIHNlcnZlci5cclxuICAgKiBJZiBjb25uZWN0aW9uIGFscmVhZHkgZXhpc3RzIGFuZCBpcyBub3QgY29ubmVjdGVkLCByZXN0YXJ0cyB0aGUgY29ubmVjdGlvbi5cclxuICAgKiBAcGFyYW0gZW5kcG9pbnQgc2VydmVyIGVuZHBvaW50XHJcbiAgICogQHBhcmFtIG9wdGlvbnMgb3B0aW9ucyBvZiB0aGUgY29ubmVjdGlvblxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGFydENvbm5lY3Rpb24oZW5kcG9pbnQ6IHN0cmluZywgb3B0aW9uczogQXZsTm90aWZpY2F0aW9uQ29ubmVjdGlvbk9wdGlvbnMpOiB2b2lkIHtcclxuICAgIGxldCBjb25uZWN0aW9uID0gdGhpcy5nZXRDb25uZWN0aW9uQnlJRChvcHRpb25zLmNvbm5lY3Rpb25JRCk7XHJcbiAgICBpZiAoIWNvbm5lY3Rpb24pIHtcclxuICAgICAgY29ubmVjdGlvbiA9IHRoaXMuYnVpbGRDb25uZWN0aW9uKGVuZHBvaW50LCBvcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoY29ubmVjdGlvbi5zdGF0ZSA9PT0gSHViQ29ubmVjdGlvblN0YXRlLkNvbm5lY3RlZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29ubmVjdGlvblxyXG4gICAgICAuc3RhcnQoKVxyXG4gICAgICAudGhlbigoKSA9PiB0aGlzLnN0YXJ0Tm90aWZpY2F0aW9ucyhjb25uZWN0aW9uLCBvcHRpb25zLm1ldGFkYXRhKSlcclxuICAgICAgLmNhdGNoKCgpID0+IGNvbnNvbGUud2FybignTm90aWZpY2F0aW9uIHNlcnZpY2U6IEZhaWxlZCB0byBlc3RhYmxpc2ggY29ubmVjdGlvbi4nKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdG9wcyBjb25uZWN0aW9uIHdpdGggdGhlIHNlcnZlclxyXG4gICAqIEBwYXJhbSBjb25uZWN0aW9uSUQgY29ubmVjdGlvbiBpZGVudGlmaWVyXHJcbiAgICovXHJcbiAgcHVibGljIHN0b3BDb25uZWN0aW9uKGNvbm5lY3Rpb25JRDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBjb25zdCBjb25uZWN0aW9uID0gdGhpcy5nZXRDb25uZWN0aW9uQnlJRChjb25uZWN0aW9uSUQpO1xyXG5cclxuICAgIGlmICghY29ubmVjdGlvbikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29ubmVjdGlvbi5vZmYoJ3RyYW5zZmVyTm90aWZpY2F0aW9uJyk7XHJcbiAgICBjb25uZWN0aW9uLnN0b3AoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlbW92ZXMgY29ubmVjdGlvbiBlbnRpcmVseVxyXG4gICAqIEBwYXJhbSBjb25uZWN0aW9uSUQgY29ubmVjdGlvbiBpZGVudGlmaWVyXHJcbiAgICovXHJcbiAgcHVibGljIHJlbW92ZUNvbm5lY3Rpb24oY29ubmVjdGlvbklEOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMuc3RvcENvbm5lY3Rpb24oY29ubmVjdGlvbklEKTtcclxuXHJcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuaHViQ29ubmVjdGlvbnMuZmluZEluZGV4KGNvbm5lY3Rpb24gPT4gY29ubmVjdGlvbi5pZCA9PT0gY29ubmVjdGlvbklEKTtcclxuICAgIGlmIChpbmRleCAhPT0gLTEpIHtcclxuICAgICAgdGhpcy5odWJDb25uZWN0aW9ucy5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogVXBkYXRlcyBub3RpZmljYXRpb25zIG1ldGFkYXRhIGZvciBzcGVjaWZpYyBjb25uZWN0aW9uLiBOb3RpZmllcyBzZXJ2ZXIgYWJvdXQgaXQuXHJcbiAgICogQHBhcmFtIGNvbm5lY3Rpb25JRCBjb25uZWN0aW9uIGlkZW50aWZpZXJcclxuICAgKiBAcGFyYW0gbWV0YWRhdGEgbm90aWZpY2F0aW9uIG1ldGFkYXRhLCAoZS5nIGxhbmd1YWdlKVxyXG4gICAqL1xyXG4gIHB1YmxpYyB1cGRhdGVOb3RpZmljYXRpb25zKGNvbm5lY3Rpb25JRDogc3RyaW5nLCBtZXRhZGF0YTogQXZsTm90aWZpY2F0aW9uTWV0YWRhdGEpOiB2b2lkIHtcclxuICAgIGNvbnN0IGNvbm5lY3Rpb24gPSB0aGlzLmdldENvbm5lY3Rpb25CeUlEKGNvbm5lY3Rpb25JRCk7XHJcbiAgICBpZiAoIWNvbm5lY3Rpb24pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuc3RhcnROb3RpZmljYXRpb25zKGNvbm5lY3Rpb24sIG1ldGFkYXRhKTtcclxuICB9XHJcblxyXG4gIC8vIFByaXZhdGUgbWV0aG9kc1xyXG5cclxuICBwcml2YXRlIHN0YXJ0Tm90aWZpY2F0aW9ucyhjb25uZWN0aW9uOiBIdWJDb25uZWN0aW9uLCBtZXRhZGF0YTogQXZsTm90aWZpY2F0aW9uTWV0YWRhdGEpOiB2b2lkIHtcclxuICAgIGNvbm5lY3Rpb24uaW52b2tlKCdzdGFydE5vdGlmaWNhdGlvbnMnLCBtZXRhZGF0YSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldENvbm5lY3Rpb25CeUlEKGNvbm5lY3Rpb25JRDogc3RyaW5nKTogSHViQ29ubmVjdGlvbiB7XHJcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuaHViQ29ubmVjdGlvbnMuZmluZEluZGV4KGNvbm5lY3Rpb24gPT4gY29ubmVjdGlvbi5pZCA9PT0gY29ubmVjdGlvbklEKTtcclxuICAgIHJldHVybiB0aGlzLmh1YkNvbm5lY3Rpb25zW2luZGV4XT8uY29ubmVjdGlvbjtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYnVpbGRDb25uZWN0aW9uKFxyXG4gICAgZW5kcG9pbnQ6IHN0cmluZyxcclxuICAgIG9wdGlvbnM6IEF2bE5vdGlmaWNhdGlvbkNvbm5lY3Rpb25PcHRpb25zXHJcbiAgKTogSHViQ29ubmVjdGlvbiB7XHJcbiAgICBjb25zdCBodWJDb25uZWN0aW9uID0gbmV3IEh1YkNvbm5lY3Rpb25CdWlsZGVyKClcclxuICAgICAgLmNvbmZpZ3VyZUxvZ2dpbmcoTG9nTGV2ZWwuTm9uZSlcclxuICAgICAgLndpdGhVcmwoZW5kcG9pbnQpXHJcbiAgICAgIC53aXRoQXV0b21hdGljUmVjb25uZWN0KClcclxuICAgICAgLmJ1aWxkKCk7XHJcblxyXG4gICAgaHViQ29ubmVjdGlvbi5vbnJlY29ubmVjdGVkKCgpID0+IHRoaXMuc3RhcnROb3RpZmljYXRpb25zKGh1YkNvbm5lY3Rpb24sIG9wdGlvbnMubWV0YWRhdGEpKTtcclxuICAgIGh1YkNvbm5lY3Rpb24ub24oJ3RyYW5zZmVyTm90aWZpY2F0aW9uJywgKG5vdGlmaWNhdGlvbjogQXZsTm90aWZpY2F0aW9uKSA9PiB7XHJcbiAgICAgIHRoaXMubm90aWZpY2F0aW9uLm5leHQobm90aWZpY2F0aW9uKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuaHViQ29ubmVjdGlvbnMucHVzaCh7XHJcbiAgICAgIGlkOiBvcHRpb25zLmNvbm5lY3Rpb25JRCxcclxuICAgICAgY29ubmVjdGlvbjogaHViQ29ubmVjdGlvblxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGh1YkNvbm5lY3Rpb247XHJcbiAgfVxyXG59XHJcbiJdfQ==