import { __assign, __decorate } from "tslib";
import { Injectable } from "@angular/core";
import { TranslationManagementService } from "./translation-management.service";
import { ThemeService } from "./theme.service";
import { Subject } from "rxjs";
import { MessageType, } from "./message.model";
import * as i0 from "@angular/core";
import * as i1 from "./translation-management.service";
import * as i2 from "./theme.service";
var ChildCommunicationService = /** @class */ (function () {
    function ChildCommunicationService(translationManagementService, themeService) {
        var _a;
        var _this = this;
        this.translationManagementService = translationManagementService;
        this.themeService = themeService;
        this.handlers = (_a = {},
            _a[MessageType.login] = function (url) { return _this.handleLogin(url); },
            _a[MessageType.navigation] = function (url) { return _this.handleNavigation(url); },
            _a[MessageType.action] = function (action) { return _this.handleAction(action); },
            _a[MessageType.registration] = function (_) { return _this.handleRegistration(); },
            _a);
        this.actionSubject = new Subject();
        this.navigationSubject = new Subject();
        this.loginSubject = new Subject();
        this.registrationCompletedSubject = new Subject();
        this.action$ = this.actionSubject;
        /**
         * Observable tracking url to navigate to
         */
        this.navigation$ = this.navigationSubject;
        /**
         * Observable tracking url for login
         * Url for login provided by child application
         */
        this.login$ = this.loginSubject;
        /**
         * Observable tracking child registration
         * Emits true if registration was successful, false otherwise
         */
        this.registrationCompleted$ = this
            .registrationCompletedSubject;
        window.addEventListener("message", function (event) { return _this.onMessage(event); });
        this.themeService.themeChanged.subscribe(function () { return _this.postThemeToChildren(); });
    }
    /**
     * Sends message to child about locale
     */
    ChildCommunicationService.prototype.notifyChildAboutLocale = function (country) {
        this.postMessageToChild(MessageType.locale, country);
    };
    /**
     * Sends message to child about language
     */
    ChildCommunicationService.prototype.notifyChildAboutLanguage = function (language) {
        this.postMessageToChild(MessageType.language, language);
    };
    /**
     * Sends message to child about action
     */
    ChildCommunicationService.prototype.notifyChildAboutAction = function (action) {
        this.postMessageToChild(MessageType.action, action);
    };
    /**
     * Sends message to child about navigation
     */
    ChildCommunicationService.prototype.notifyChildAboutNavigation = function (url) {
        this.postMessageToChild(MessageType.navigation, url);
    };
    /**
     * Sends messages to children about current user
     */
    ChildCommunicationService.prototype.postAuthenticationDataToChildren = function () {
        var payload = {
            refresh_token: sessionStorage.getItem("refresh_token"),
            access_token: sessionStorage.getItem("access_token"),
            id_token: sessionStorage.getItem("id_token"),
            refresh_token_expires_at: Number(sessionStorage.getItem("refresh_token_expires_at")),
            access_token_expires_at: Number(sessionStorage.getItem("access_token_expires_at")),
            access_token_stored_at: Number(sessionStorage.getItem("access_token_stored_at")),
            username: sessionStorage.getItem("username"),
            name: sessionStorage.getItem("name"),
            roles: JSON.parse(sessionStorage.getItem("roles")),
        };
        this.postMessageToChild(MessageType.authentication, payload);
    };
    /**
     * Sends messages to children about selected application theme
     */
    ChildCommunicationService.prototype.postThemeToChildren = function () {
        var theme = this.themeService.getCurrentTheme();
        this.postMessageToChild(MessageType.theme, theme);
    };
    /**
     * Sends messages to children about selected language
     */
    ChildCommunicationService.prototype.postLanguageToChildren = function () {
        this.postMessageToChild(MessageType.language, this.translationManagementService.language);
    };
    /**
     * Sends messages to children about selected country
     */
    ChildCommunicationService.prototype.postLocaleToChildren = function () {
        var country = localStorage.getItem("country");
        this.postMessageToChild(MessageType.locale, country);
    };
    /**
     * Sends message to child about redirection from idb
     */
    ChildCommunicationService.prototype.postRedirectedFromLogIn = function (payload) {
        this.postMessageToChild(MessageType.redirectedFromLogIn, payload);
    };
    /**
     * Sends message to children about color scheme
     */
    ChildCommunicationService.prototype.postColorSchemeToChildren = function () {
        var computedStyle = window.getComputedStyle(document.body);
        var productColor = computedStyle.getPropertyValue("--avl-product-color");
        var productHoverColor = computedStyle.getPropertyValue("--avl-product-hover-color");
        var productFocusColor = computedStyle.getPropertyValue("--avl-product-focus-color");
        var colorScheme = {
            "--avl-product-color": productColor,
            "--avl-product-hover-color": productHoverColor,
            "--avl-product-focus-color": productFocusColor,
        };
        this.postMessageToChild(MessageType.colorScheme, colorScheme);
    };
    ChildCommunicationService.prototype.handleAction = function (action) {
        this.actionSubject.next(action);
    };
    ChildCommunicationService.prototype.handleNavigation = function (navigation) {
        this.navigationSubject.next(navigation);
    };
    ChildCommunicationService.prototype.handleLogin = function (login) {
        this.loginSubject.next(login);
    };
    // when child started its registration iframe is loaded and shell gets a message that he can send messages to iframe
    ChildCommunicationService.prototype.handleRegistration = function () {
        this.iframeEl = document.getElementsByTagName("iframe")[0];
        this.postThemeToChildren();
        this.postColorSchemeToChildren();
        this.postLanguageToChildren();
        this.postLocaleToChildren();
        this.registrationCompletedSubject.next(true);
    };
    ChildCommunicationService.prototype.onMessage = function (event) {
        var _a = event.data, payload = _a.payload, messageType = _a.messageType;
        var handlers = __assign(__assign({}, this.handlers), { default: function () { return console.log("Unrecognized message for the child.", event); } });
        (handlers[messageType] || handlers.default)(payload);
    };
    ChildCommunicationService.prototype.postMessageToChild = function (messageType, payload) {
        var _a;
        if (!this.iframeEl) {
            return;
        }
        var message = { messageType: messageType, payload: payload };
        (_a = this.iframeEl.contentWindow) === null || _a === void 0 ? void 0 : _a.postMessage(message, "*");
    };
    ChildCommunicationService.ctorParameters = function () { return [
        { type: TranslationManagementService },
        { type: ThemeService }
    ]; };
    ChildCommunicationService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ChildCommunicationService_Factory() { return new ChildCommunicationService(i0.ɵɵinject(i1.TranslationManagementService), i0.ɵɵinject(i2.ThemeService)); }, token: ChildCommunicationService, providedIn: "root" });
    ChildCommunicationService = __decorate([
        Injectable({
            providedIn: "root",
        })
    ], ChildCommunicationService);
    return ChildCommunicationService;
}());
export { ChildCommunicationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hpbGQtY29tbXVuaWNhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGF2bC1zZXJ2aWNlcy9uZy1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9jaGlsZC1jb21tdW5pY2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDaEYsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxPQUFPLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUlMLFdBQVcsR0FHWixNQUFNLGlCQUFpQixDQUFDOzs7O0FBS3pCO0lBbUNFLG1DQUNVLDRCQUEwRCxFQUMxRCxZQUEwQjs7UUFGcEMsaUJBTUM7UUFMUyxpQ0FBNEIsR0FBNUIsNEJBQTRCLENBQThCO1FBQzFELGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBcEM1QixhQUFRO1lBQ2QsR0FBQyxXQUFXLENBQUMsS0FBSyxJQUFHLFVBQUMsR0FBVyxJQUFLLE9BQUEsS0FBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsRUFBckIsQ0FBcUI7WUFDM0QsR0FBQyxXQUFXLENBQUMsVUFBVSxJQUFHLFVBQUMsR0FBVyxJQUFLLE9BQUEsS0FBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxFQUExQixDQUEwQjtZQUNyRSxHQUFDLFdBQVcsQ0FBQyxNQUFNLElBQUcsVUFBQyxNQUFjLElBQUssT0FBQSxLQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxFQUF6QixDQUF5QjtZQUNuRSxHQUFDLFdBQVcsQ0FBQyxZQUFZLElBQUcsVUFBQyxDQUFDLElBQUssT0FBQSxLQUFJLENBQUMsa0JBQWtCLEVBQUUsRUFBekIsQ0FBeUI7Z0JBQzVEO1FBRU0sa0JBQWEsR0FBRyxJQUFJLE9BQU8sRUFBVSxDQUFDO1FBQ3RDLHNCQUFpQixHQUFHLElBQUksT0FBTyxFQUFVLENBQUM7UUFDMUMsaUJBQVksR0FBRyxJQUFJLE9BQU8sRUFBVSxDQUFDO1FBQ3JDLGlDQUE0QixHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7UUFJdkQsWUFBTyxHQUF1QixJQUFJLENBQUMsYUFBYSxDQUFDO1FBRXhEOztXQUVHO1FBQ0ksZ0JBQVcsR0FBdUIsSUFBSSxDQUFDLGlCQUFpQixDQUFDO1FBRWhFOzs7V0FHRztRQUNJLFdBQU0sR0FBdUIsSUFBSSxDQUFDLFlBQVksQ0FBQztRQUV0RDs7O1dBR0c7UUFDSSwyQkFBc0IsR0FBd0IsSUFBSTthQUN0RCw0QkFBNEIsQ0FBQztRQU05QixNQUFNLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLFVBQUMsS0FBSyxJQUFLLE9BQUEsS0FBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBckIsQ0FBcUIsQ0FBQyxDQUFDO1FBQ3JFLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxjQUFNLE9BQUEsS0FBSSxDQUFDLG1CQUFtQixFQUFFLEVBQTFCLENBQTBCLENBQUMsQ0FBQztJQUM3RSxDQUFDO0lBRUQ7O09BRUc7SUFDSSwwREFBc0IsR0FBN0IsVUFBOEIsT0FBZTtRQUMzQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRUQ7O09BRUc7SUFDSSw0REFBd0IsR0FBL0IsVUFBZ0MsUUFBZ0I7UUFDOUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDMUQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksMERBQXNCLEdBQTdCLFVBQThCLE1BQWM7UUFDMUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksOERBQTBCLEdBQWpDLFVBQWtDLEdBQVc7UUFDM0MsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksb0VBQWdDLEdBQXZDO1FBQ0UsSUFBTSxPQUFPLEdBQVM7WUFDcEIsYUFBYSxFQUFFLGNBQWMsQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDO1lBQ3RELFlBQVksRUFBRSxjQUFjLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQztZQUNwRCxRQUFRLEVBQUUsY0FBYyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUM7WUFDNUMsd0JBQXdCLEVBQUUsTUFBTSxDQUM5QixjQUFjLENBQUMsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQ25EO1lBQ0QsdUJBQXVCLEVBQUUsTUFBTSxDQUM3QixjQUFjLENBQUMsT0FBTyxDQUFDLHlCQUF5QixDQUFDLENBQ2xEO1lBQ0Qsc0JBQXNCLEVBQUUsTUFBTSxDQUM1QixjQUFjLENBQUMsT0FBTyxDQUFDLHdCQUF3QixDQUFDLENBQ2pEO1lBQ0QsUUFBUSxFQUFFLGNBQWMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDO1lBQzVDLElBQUksRUFBRSxjQUFjLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztZQUNwQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ25ELENBQUM7UUFFRixJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxDQUFDLGNBQWMsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUMvRCxDQUFDO0lBRUQ7O09BRUc7SUFDSSx1REFBbUIsR0FBMUI7UUFDRSxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ2xELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3BELENBQUM7SUFFRDs7T0FFRztJQUNJLDBEQUFzQixHQUE3QjtRQUNFLElBQUksQ0FBQyxrQkFBa0IsQ0FDckIsV0FBVyxDQUFDLFFBQVEsRUFDcEIsSUFBSSxDQUFDLDRCQUE0QixDQUFDLFFBQVEsQ0FDM0MsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNJLHdEQUFvQixHQUEzQjtRQUNFLElBQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksMkRBQXVCLEdBQTlCLFVBQStCLE9BQWdCO1FBQzdDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsbUJBQW1CLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDcEUsQ0FBQztJQUVEOztPQUVHO0lBQ0ksNkRBQXlCLEdBQWhDO1FBQ0UsSUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3RCxJQUFNLFlBQVksR0FBRyxhQUFhLENBQUMsZ0JBQWdCLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUMzRSxJQUFNLGlCQUFpQixHQUFHLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FDdEQsMkJBQTJCLENBQzVCLENBQUM7UUFDRixJQUFNLGlCQUFpQixHQUFHLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FDdEQsMkJBQTJCLENBQzVCLENBQUM7UUFFRixJQUFNLFdBQVcsR0FBZ0I7WUFDL0IscUJBQXFCLEVBQUUsWUFBWTtZQUNuQywyQkFBMkIsRUFBRSxpQkFBaUI7WUFDOUMsMkJBQTJCLEVBQUUsaUJBQWlCO1NBQy9DLENBQUM7UUFFRixJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNoRSxDQUFDO0lBRU8sZ0RBQVksR0FBcEIsVUFBcUIsTUFBYztRQUNqQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRU8sb0RBQWdCLEdBQXhCLFVBQXlCLFVBQWtCO1FBQ3pDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVPLCtDQUFXLEdBQW5CLFVBQW9CLEtBQWE7UUFDL0IsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELG9IQUFvSDtJQUM1RyxzREFBa0IsR0FBMUI7UUFDRSxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxvQkFBb0IsQ0FDM0MsUUFBUSxDQUNULENBQUMsQ0FBQyxDQUFzQixDQUFDO1FBRTFCLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBRTVCLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVPLDZDQUFTLEdBQWpCLFVBQWtCLEtBQW1CO1FBQzdCLElBQUEsZUFBOEMsRUFBNUMsb0JBQU8sRUFBRSw0QkFBbUMsQ0FBQztRQUNyRCxJQUFNLFFBQVEseUJBQ1QsSUFBSSxDQUFDLFFBQVEsS0FDaEIsT0FBTyxFQUFFLGNBQU0sT0FBQSxPQUFPLENBQUMsR0FBRyxDQUFDLHFDQUFxQyxFQUFFLEtBQUssQ0FBQyxFQUF6RCxDQUF5RCxHQUN6RSxDQUFDO1FBRUYsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFTyxzREFBa0IsR0FBMUIsVUFBMkIsV0FBd0IsRUFBRSxPQUFnQjs7UUFDbkUsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDbEIsT0FBTztTQUNSO1FBRUQsSUFBTSxPQUFPLEdBQVksRUFBRSxXQUFXLGFBQUEsRUFBRSxPQUFPLFNBQUEsRUFBRSxDQUFDO1FBQ2xELE1BQUEsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLDBDQUFFLFdBQVcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO0lBQ3pELENBQUM7O2dCQTlKdUMsNEJBQTRCO2dCQUM1QyxZQUFZOzs7SUFyQ3pCLHlCQUF5QjtRQUhyQyxVQUFVLENBQUM7WUFDVixVQUFVLEVBQUUsTUFBTTtTQUNuQixDQUFDO09BQ1cseUJBQXlCLENBbU1yQztvQ0FuTkQ7Q0FtTkMsQUFuTUQsSUFtTUM7U0FuTVkseUJBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IFRyYW5zbGF0aW9uTWFuYWdlbWVudFNlcnZpY2UgfSBmcm9tIFwiLi90cmFuc2xhdGlvbi1tYW5hZ2VtZW50LnNlcnZpY2VcIjtcclxuaW1wb3J0IHsgVGhlbWVTZXJ2aWNlIH0gZnJvbSBcIi4vdGhlbWUuc2VydmljZVwiO1xyXG5pbXBvcnQgeyBTdWJqZWN0LCBPYnNlcnZhYmxlIH0gZnJvbSBcInJ4anNcIjtcclxuaW1wb3J0IHtcclxuICBDb2xvclNjaGVtZSxcclxuICBNZXNzYWdlLFxyXG4gIE1lc3NhZ2VIYW5kbGVycyxcclxuICBNZXNzYWdlVHlwZSxcclxuICBQYXlsb2FkLFxyXG4gIFVzZXIsXHJcbn0gZnJvbSBcIi4vbWVzc2FnZS5tb2RlbFwiO1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46IFwicm9vdFwiLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgQ2hpbGRDb21tdW5pY2F0aW9uU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBoYW5kbGVyczogTWVzc2FnZUhhbmRsZXJzID0ge1xyXG4gICAgW01lc3NhZ2VUeXBlLmxvZ2luXTogKHVybDogc3RyaW5nKSA9PiB0aGlzLmhhbmRsZUxvZ2luKHVybCksXHJcbiAgICBbTWVzc2FnZVR5cGUubmF2aWdhdGlvbl06ICh1cmw6IHN0cmluZykgPT4gdGhpcy5oYW5kbGVOYXZpZ2F0aW9uKHVybCksXHJcbiAgICBbTWVzc2FnZVR5cGUuYWN0aW9uXTogKGFjdGlvbjogc3RyaW5nKSA9PiB0aGlzLmhhbmRsZUFjdGlvbihhY3Rpb24pLFxyXG4gICAgW01lc3NhZ2VUeXBlLnJlZ2lzdHJhdGlvbl06IChfKSA9PiB0aGlzLmhhbmRsZVJlZ2lzdHJhdGlvbigpLFxyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgYWN0aW9uU3ViamVjdCA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKTtcclxuICBwcml2YXRlIG5hdmlnYXRpb25TdWJqZWN0ID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xyXG4gIHByaXZhdGUgbG9naW5TdWJqZWN0ID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xyXG4gIHByaXZhdGUgcmVnaXN0cmF0aW9uQ29tcGxldGVkU3ViamVjdCA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XHJcblxyXG4gIHByb3RlY3RlZCBpZnJhbWVFbDogSFRNTElGcmFtZUVsZW1lbnQ7XHJcblxyXG4gIHB1YmxpYyBhY3Rpb24kOiBPYnNlcnZhYmxlPHN0cmluZz4gPSB0aGlzLmFjdGlvblN1YmplY3Q7XHJcblxyXG4gIC8qKlxyXG4gICAqIE9ic2VydmFibGUgdHJhY2tpbmcgdXJsIHRvIG5hdmlnYXRlIHRvXHJcbiAgICovXHJcbiAgcHVibGljIG5hdmlnYXRpb24kOiBPYnNlcnZhYmxlPHN0cmluZz4gPSB0aGlzLm5hdmlnYXRpb25TdWJqZWN0O1xyXG5cclxuICAvKipcclxuICAgKiBPYnNlcnZhYmxlIHRyYWNraW5nIHVybCBmb3IgbG9naW5cclxuICAgKiBVcmwgZm9yIGxvZ2luIHByb3ZpZGVkIGJ5IGNoaWxkIGFwcGxpY2F0aW9uXHJcbiAgICovXHJcbiAgcHVibGljIGxvZ2luJDogT2JzZXJ2YWJsZTxzdHJpbmc+ID0gdGhpcy5sb2dpblN1YmplY3Q7XHJcblxyXG4gIC8qKlxyXG4gICAqIE9ic2VydmFibGUgdHJhY2tpbmcgY2hpbGQgcmVnaXN0cmF0aW9uXHJcbiAgICogRW1pdHMgdHJ1ZSBpZiByZWdpc3RyYXRpb24gd2FzIHN1Y2Nlc3NmdWwsIGZhbHNlIG90aGVyd2lzZVxyXG4gICAqL1xyXG4gIHB1YmxpYyByZWdpc3RyYXRpb25Db21wbGV0ZWQkOiBPYnNlcnZhYmxlPGJvb2xlYW4+ID0gdGhpc1xyXG4gICAgLnJlZ2lzdHJhdGlvbkNvbXBsZXRlZFN1YmplY3Q7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSB0cmFuc2xhdGlvbk1hbmFnZW1lbnRTZXJ2aWNlOiBUcmFuc2xhdGlvbk1hbmFnZW1lbnRTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSB0aGVtZVNlcnZpY2U6IFRoZW1lU2VydmljZVxyXG4gICkge1xyXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJtZXNzYWdlXCIsIChldmVudCkgPT4gdGhpcy5vbk1lc3NhZ2UoZXZlbnQpKTtcclxuICAgIHRoaXMudGhlbWVTZXJ2aWNlLnRoZW1lQ2hhbmdlZC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5wb3N0VGhlbWVUb0NoaWxkcmVuKCkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VuZHMgbWVzc2FnZSB0byBjaGlsZCBhYm91dCBsb2NhbGVcclxuICAgKi9cclxuICBwdWJsaWMgbm90aWZ5Q2hpbGRBYm91dExvY2FsZShjb3VudHJ5OiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb0NoaWxkKE1lc3NhZ2VUeXBlLmxvY2FsZSwgY291bnRyeSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kcyBtZXNzYWdlIHRvIGNoaWxkIGFib3V0IGxhbmd1YWdlXHJcbiAgICovXHJcbiAgcHVibGljIG5vdGlmeUNoaWxkQWJvdXRMYW5ndWFnZShsYW5ndWFnZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9DaGlsZChNZXNzYWdlVHlwZS5sYW5ndWFnZSwgbGFuZ3VhZ2UpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VuZHMgbWVzc2FnZSB0byBjaGlsZCBhYm91dCBhY3Rpb25cclxuICAgKi9cclxuICBwdWJsaWMgbm90aWZ5Q2hpbGRBYm91dEFjdGlvbihhY3Rpb246IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvQ2hpbGQoTWVzc2FnZVR5cGUuYWN0aW9uLCBhY3Rpb24pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VuZHMgbWVzc2FnZSB0byBjaGlsZCBhYm91dCBuYXZpZ2F0aW9uXHJcbiAgICovXHJcbiAgcHVibGljIG5vdGlmeUNoaWxkQWJvdXROYXZpZ2F0aW9uKHVybDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9DaGlsZChNZXNzYWdlVHlwZS5uYXZpZ2F0aW9uLCB1cmwpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VuZHMgbWVzc2FnZXMgdG8gY2hpbGRyZW4gYWJvdXQgY3VycmVudCB1c2VyXHJcbiAgICovXHJcbiAgcHVibGljIHBvc3RBdXRoZW50aWNhdGlvbkRhdGFUb0NoaWxkcmVuKCkge1xyXG4gICAgY29uc3QgcGF5bG9hZDogVXNlciA9IHtcclxuICAgICAgcmVmcmVzaF90b2tlbjogc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShcInJlZnJlc2hfdG9rZW5cIiksXHJcbiAgICAgIGFjY2Vzc190b2tlbjogc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShcImFjY2Vzc190b2tlblwiKSxcclxuICAgICAgaWRfdG9rZW46IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oXCJpZF90b2tlblwiKSxcclxuICAgICAgcmVmcmVzaF90b2tlbl9leHBpcmVzX2F0OiBOdW1iZXIoXHJcbiAgICAgICAgc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShcInJlZnJlc2hfdG9rZW5fZXhwaXJlc19hdFwiKVxyXG4gICAgICApLFxyXG4gICAgICBhY2Nlc3NfdG9rZW5fZXhwaXJlc19hdDogTnVtYmVyKFxyXG4gICAgICAgIHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oXCJhY2Nlc3NfdG9rZW5fZXhwaXJlc19hdFwiKVxyXG4gICAgICApLFxyXG4gICAgICBhY2Nlc3NfdG9rZW5fc3RvcmVkX2F0OiBOdW1iZXIoXHJcbiAgICAgICAgc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShcImFjY2Vzc190b2tlbl9zdG9yZWRfYXRcIilcclxuICAgICAgKSxcclxuICAgICAgdXNlcm5hbWU6IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oXCJ1c2VybmFtZVwiKSxcclxuICAgICAgbmFtZTogc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShcIm5hbWVcIiksXHJcbiAgICAgIHJvbGVzOiBKU09OLnBhcnNlKHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oXCJyb2xlc1wiKSksXHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb0NoaWxkKE1lc3NhZ2VUeXBlLmF1dGhlbnRpY2F0aW9uLCBwYXlsb2FkKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIG1lc3NhZ2VzIHRvIGNoaWxkcmVuIGFib3V0IHNlbGVjdGVkIGFwcGxpY2F0aW9uIHRoZW1lXHJcbiAgICovXHJcbiAgcHVibGljIHBvc3RUaGVtZVRvQ2hpbGRyZW4oKTogdm9pZCB7XHJcbiAgICBjb25zdCB0aGVtZSA9IHRoaXMudGhlbWVTZXJ2aWNlLmdldEN1cnJlbnRUaGVtZSgpO1xyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvQ2hpbGQoTWVzc2FnZVR5cGUudGhlbWUsIHRoZW1lKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIG1lc3NhZ2VzIHRvIGNoaWxkcmVuIGFib3V0IHNlbGVjdGVkIGxhbmd1YWdlXHJcbiAgICovXHJcbiAgcHVibGljIHBvc3RMYW5ndWFnZVRvQ2hpbGRyZW4oKTogdm9pZCB7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9DaGlsZChcclxuICAgICAgTWVzc2FnZVR5cGUubGFuZ3VhZ2UsXHJcbiAgICAgIHRoaXMudHJhbnNsYXRpb25NYW5hZ2VtZW50U2VydmljZS5sYW5ndWFnZVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIG1lc3NhZ2VzIHRvIGNoaWxkcmVuIGFib3V0IHNlbGVjdGVkIGNvdW50cnlcclxuICAgKi9cclxuICBwdWJsaWMgcG9zdExvY2FsZVRvQ2hpbGRyZW4oKTogdm9pZCB7XHJcbiAgICBjb25zdCBjb3VudHJ5ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJjb3VudHJ5XCIpO1xyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvQ2hpbGQoTWVzc2FnZVR5cGUubG9jYWxlLCBjb3VudHJ5KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIG1lc3NhZ2UgdG8gY2hpbGQgYWJvdXQgcmVkaXJlY3Rpb24gZnJvbSBpZGJcclxuICAgKi9cclxuICBwdWJsaWMgcG9zdFJlZGlyZWN0ZWRGcm9tTG9nSW4ocGF5bG9hZDogYm9vbGVhbik6IHZvaWQge1xyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvQ2hpbGQoTWVzc2FnZVR5cGUucmVkaXJlY3RlZEZyb21Mb2dJbiwgcGF5bG9hZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kcyBtZXNzYWdlIHRvIGNoaWxkcmVuIGFib3V0IGNvbG9yIHNjaGVtZVxyXG4gICAqL1xyXG4gIHB1YmxpYyBwb3N0Q29sb3JTY2hlbWVUb0NoaWxkcmVuKCk6IHZvaWQge1xyXG4gICAgY29uc3QgY29tcHV0ZWRTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGRvY3VtZW50LmJvZHkpO1xyXG4gICAgY29uc3QgcHJvZHVjdENvbG9yID0gY29tcHV0ZWRTdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKFwiLS1hdmwtcHJvZHVjdC1jb2xvclwiKTtcclxuICAgIGNvbnN0IHByb2R1Y3RIb3ZlckNvbG9yID0gY29tcHV0ZWRTdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKFxyXG4gICAgICBcIi0tYXZsLXByb2R1Y3QtaG92ZXItY29sb3JcIlxyXG4gICAgKTtcclxuICAgIGNvbnN0IHByb2R1Y3RGb2N1c0NvbG9yID0gY29tcHV0ZWRTdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKFxyXG4gICAgICBcIi0tYXZsLXByb2R1Y3QtZm9jdXMtY29sb3JcIlxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCBjb2xvclNjaGVtZTogQ29sb3JTY2hlbWUgPSB7XHJcbiAgICAgIFwiLS1hdmwtcHJvZHVjdC1jb2xvclwiOiBwcm9kdWN0Q29sb3IsXHJcbiAgICAgIFwiLS1hdmwtcHJvZHVjdC1ob3Zlci1jb2xvclwiOiBwcm9kdWN0SG92ZXJDb2xvcixcclxuICAgICAgXCItLWF2bC1wcm9kdWN0LWZvY3VzLWNvbG9yXCI6IHByb2R1Y3RGb2N1c0NvbG9yLFxyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9DaGlsZChNZXNzYWdlVHlwZS5jb2xvclNjaGVtZSwgY29sb3JTY2hlbWUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVBY3Rpb24oYWN0aW9uOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMuYWN0aW9uU3ViamVjdC5uZXh0KGFjdGlvbik7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZU5hdmlnYXRpb24obmF2aWdhdGlvbjogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLm5hdmlnYXRpb25TdWJqZWN0Lm5leHQobmF2aWdhdGlvbik7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUxvZ2luKGxvZ2luOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMubG9naW5TdWJqZWN0Lm5leHQobG9naW4pO1xyXG4gIH1cclxuXHJcbiAgLy8gd2hlbiBjaGlsZCBzdGFydGVkIGl0cyByZWdpc3RyYXRpb24gaWZyYW1lIGlzIGxvYWRlZCBhbmQgc2hlbGwgZ2V0cyBhIG1lc3NhZ2UgdGhhdCBoZSBjYW4gc2VuZCBtZXNzYWdlcyB0byBpZnJhbWVcclxuICBwcml2YXRlIGhhbmRsZVJlZ2lzdHJhdGlvbigpOiB2b2lkIHtcclxuICAgIHRoaXMuaWZyYW1lRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcclxuICAgICAgXCJpZnJhbWVcIlxyXG4gICAgKVswXSBhcyBIVE1MSUZyYW1lRWxlbWVudDtcclxuXHJcbiAgICB0aGlzLnBvc3RUaGVtZVRvQ2hpbGRyZW4oKTtcclxuICAgIHRoaXMucG9zdENvbG9yU2NoZW1lVG9DaGlsZHJlbigpO1xyXG4gICAgdGhpcy5wb3N0TGFuZ3VhZ2VUb0NoaWxkcmVuKCk7XHJcbiAgICB0aGlzLnBvc3RMb2NhbGVUb0NoaWxkcmVuKCk7XHJcblxyXG4gICAgdGhpcy5yZWdpc3RyYXRpb25Db21wbGV0ZWRTdWJqZWN0Lm5leHQodHJ1ZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG9uTWVzc2FnZShldmVudDogTWVzc2FnZUV2ZW50KTogdm9pZCB7XHJcbiAgICBjb25zdCB7IHBheWxvYWQsIG1lc3NhZ2VUeXBlIH06IE1lc3NhZ2UgPSBldmVudC5kYXRhO1xyXG4gICAgY29uc3QgaGFuZGxlcnMgPSB7XHJcbiAgICAgIC4uLnRoaXMuaGFuZGxlcnMsXHJcbiAgICAgIGRlZmF1bHQ6ICgpID0+IGNvbnNvbGUubG9nKFwiVW5yZWNvZ25pemVkIG1lc3NhZ2UgZm9yIHRoZSBjaGlsZC5cIiwgZXZlbnQpLFxyXG4gICAgfTtcclxuXHJcbiAgICAoaGFuZGxlcnNbbWVzc2FnZVR5cGVdIHx8IGhhbmRsZXJzLmRlZmF1bHQpKHBheWxvYWQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwb3N0TWVzc2FnZVRvQ2hpbGQobWVzc2FnZVR5cGU6IE1lc3NhZ2VUeXBlLCBwYXlsb2FkOiBQYXlsb2FkKTogdm9pZCB7XHJcbiAgICBpZiAoIXRoaXMuaWZyYW1lRWwpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG1lc3NhZ2U6IE1lc3NhZ2UgPSB7IG1lc3NhZ2VUeXBlLCBwYXlsb2FkIH07XHJcbiAgICB0aGlzLmlmcmFtZUVsLmNvbnRlbnRXaW5kb3c/LnBvc3RNZXNzYWdlKG1lc3NhZ2UsIFwiKlwiKTtcclxuICB9XHJcbn1cclxuIl19