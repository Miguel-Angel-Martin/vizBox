import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { HubConnectionBuilder, HubConnectionState, LogLevel } from '@microsoft/signalr';
var NotificationService = /** @class */ (function () {
    function NotificationService() {
        this.hubConnections = [];
        this.notification = new Subject();
        /**
         * Observable which emits newly arrived notifications.
         */
        this.notification$ = this.notification;
    }
    /**
     * Builds and starts signalR hub connection with the server.
     * If connection already exists and is not connected, restarts the connection.
     * @param endpoint server endpoint
     * @param options options of the connection
     */
    NotificationService.prototype.startConnection = function (endpoint, options) {
        var _this = this;
        var connection = this.getConnectionByID(options.connectionID);
        if (!connection) {
            connection = this.buildConnection(endpoint, options);
        }
        if (connection.state === HubConnectionState.Connected) {
            return;
        }
        connection
            .start()
            .then(function () { return _this.startNotifications(connection, options.metadata); })
            .catch(function () { return console.warn('Notification service: Failed to establish connection.'); });
    };
    /**
     * Stops connection with the server
     * @param connectionID connection identifier
     */
    NotificationService.prototype.stopConnection = function (connectionID) {
        var connection = this.getConnectionByID(connectionID);
        if (!connection) {
            return;
        }
        connection.off('transferNotification');
        connection.stop();
    };
    /**
     * Removes connection entirely
     * @param connectionID connection identifier
     */
    NotificationService.prototype.removeConnection = function (connectionID) {
        this.stopConnection(connectionID);
        var index = this.hubConnections.findIndex(function (connection) { return connection.id === connectionID; });
        if (index !== -1) {
            this.hubConnections.splice(index, 1);
        }
    };
    /**
     * Updates notifications metadata for specific connection. Notifies server about it.
     * @param connectionID connection identifier
     * @param metadata notification metadata, (e.g language)
     */
    NotificationService.prototype.updateNotifications = function (connectionID, metadata) {
        var connection = this.getConnectionByID(connectionID);
        if (!connection) {
            return;
        }
        this.startNotifications(connection, metadata);
    };
    // Private methods
    NotificationService.prototype.startNotifications = function (connection, metadata) {
        connection.invoke('startNotifications', metadata);
    };
    NotificationService.prototype.getConnectionByID = function (connectionID) {
        var _a;
        var index = this.hubConnections.findIndex(function (connection) { return connection.id === connectionID; });
        return (_a = this.hubConnections[index]) === null || _a === void 0 ? void 0 : _a.connection;
    };
    NotificationService.prototype.buildConnection = function (endpoint, options) {
        var _this = this;
        var hubConnection = new HubConnectionBuilder()
            .configureLogging(LogLevel.None)
            .withUrl(endpoint)
            .withAutomaticReconnect()
            .build();
        hubConnection.onreconnected(function () { return _this.startNotifications(hubConnection, options.metadata); });
        hubConnection.on('transferNotification', function (notification) {
            _this.notification.next(notification);
        });
        this.hubConnections.push({
            id: options.connectionID,
            connection: hubConnection
        });
        return hubConnection;
    };
    NotificationService = __decorate([
        Injectable()
    ], NotificationService);
    return NotificationService;
}());
export { NotificationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZpY2F0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYXZsLXNlcnZpY2VzL25nLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL25vdGlmaWNhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFM0MsT0FBTyxFQUVMLG9CQUFvQixFQUNwQixrQkFBa0IsRUFDbEIsUUFBUSxFQUNULE1BQU0sb0JBQW9CLENBQUM7QUFtQjVCO0lBQUE7UUFDVSxtQkFBYyxHQUE0QixFQUFFLENBQUM7UUFDN0MsaUJBQVksR0FBNkIsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUUvRDs7V0FFRztRQUNJLGtCQUFhLEdBQWdDLElBQUksQ0FBQyxZQUFZLENBQUM7SUFtR3hFLENBQUM7SUFqR0M7Ozs7O09BS0c7SUFDSSw2Q0FBZSxHQUF0QixVQUF1QixRQUFnQixFQUFFLE9BQXlDO1FBQWxGLGlCQWNDO1FBYkMsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUM5RCxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ2YsVUFBVSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1NBQ3REO1FBRUQsSUFBSSxVQUFVLENBQUMsS0FBSyxLQUFLLGtCQUFrQixDQUFDLFNBQVMsRUFBRTtZQUNyRCxPQUFPO1NBQ1I7UUFFRCxVQUFVO2FBQ1AsS0FBSyxFQUFFO2FBQ1AsSUFBSSxDQUFDLGNBQU0sT0FBQSxLQUFJLENBQUMsa0JBQWtCLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBckQsQ0FBcUQsQ0FBQzthQUNqRSxLQUFLLENBQUMsY0FBTSxPQUFBLE9BQU8sQ0FBQyxJQUFJ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bnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQge1xyXG4gIEh1YkNvbm5lY3Rpb24sXHJcbiAgSHViQ29ubmVjdGlvbkJ1aWxkZXIsXHJcbiAgSHViQ29ubmVjdGlvblN0YXRlLFxyXG4gIExvZ0xldmVsXHJcbn0gZnJvbSAnQG1pY3Jvc29mdC9zaWduYWxyJztcclxuXHJcbmltcG9ydCB7XHJcbiAgQXZsTm90aWZpY2F0aW9uLFxyXG4gIEF2bE5vdGlmaWNhdGlvbkNvbm5lY3Rpb25PcHRpb25zLFxyXG4gIEF2bE5vdGlmaWNhdGlvbk1ldGFkYXRhXHJcbn0gZnJvbSAnQGF2bC1jb250cm9scy9pbnRlcmZhY2VzJztcclxuXHJcbmludGVyZmFjZSBBcHBsaWNhdGlvbkNvbm5lY3Rpb24ge1xyXG4gIC8qKiBDb25uZWN0aW9uIGlkZW50aWZpZXIgKi9cclxuICByZWFkb25seSBpZDogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiBDb25uZWN0aW9uIHRvIHRoZSBiYWNrZW5kIGh1Yi5cclxuICAgKi9cclxuICByZWFkb25seSBjb25uZWN0aW9uOiBIdWJDb25uZWN0aW9uO1xyXG59XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBOb3RpZmljYXRpb25TZXJ2aWNlIHtcclxuICBwcml2YXRlIGh1YkNvbm5lY3Rpb25zOiBBcHBsaWNhdGlvbkNvbm5lY3Rpb25bXSA9IFtdO1xyXG4gIHByaXZhdGUgbm90aWZpY2F0aW9uOiBTdWJqZWN0PEF2bE5vdGlmaWNhdGlvbj4gPSBuZXcgU3ViamVjdCgpO1xyXG5cclxuICAvKipcclxuICAgKiBPYnNlcnZhYmxlIHdoaWNoIGVtaXRzIG5ld2x5IGFycml2ZWQgbm90aWZpY2F0aW9ucy5cclxuICAgKi9cclxuICBwdWJsaWMgbm90aWZpY2F0aW9uJDogT2JzZXJ2YWJsZTxBdmxOb3RpZmljYXRpb24+ID0gdGhpcy5ub3RpZmljYXRpb247XHJcblxyXG4gIC8qKlxyXG4gICAqIEJ1aWxkcyBhbmQgc3RhcnRzIHNpZ25hbFIgaHViIGNvbm5lY3Rpb24gd2l0aCB0aGUgc2VydmVyLlxyXG4gICAqIElmIGNvbm5lY3Rpb24gYWxyZWFkeSBleGlzdHMgYW5kIGlzIG5vdCBjb25uZWN0ZWQsIHJlc3RhcnRzIHRoZSBjb25uZWN0aW9uLlxyXG4gICAqIEBwYXJhbSBlbmRwb2ludCBzZXJ2ZXIgZW5kcG9pbnRcclxuICAgKiBAcGFyYW0gb3B0aW9ucyBvcHRpb25zIG9mIHRoZSBjb25uZWN0aW9uXHJcbiAgICovXHJcbiAgcHVibGljIHN0YXJ0Q29ubmVjdGlvbihlbmRwb2ludDogc3RyaW5nLCBvcHRpb25zOiBBdmxOb3RpZmljYXRpb25Db25uZWN0aW9uT3B0aW9ucyk6IHZvaWQge1xyXG4gICAgbGV0IGNvbm5lY3Rpb24gPSB0aGlzLmdldENvbm5lY3Rpb25CeUlEKG9wdGlvbnMuY29ubmVjdGlvbklEKTtcclxuICAgIGlmICghY29ubmVjdGlvbikge1xyXG4gICAgICBjb25uZWN0aW9uID0gdGhpcy5idWlsZENvbm5lY3Rpb24oZW5kcG9pbnQsIG9wdGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChjb25uZWN0aW9uLnN0YXRlID09PSBIdWJDb25uZWN0aW9uU3RhdGUuQ29ubmVjdGVkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25uZWN0aW9uXHJcbiAgICAgIC5zdGFydCgpXHJcbiAgICAgIC50aGVuKCgpID0+IHRoaXMuc3RhcnROb3RpZmljYXRpb25zKGNvbm5lY3Rpb24sIG9wdGlvbnMubWV0YWRhdGEpKVxyXG4gICAgICAuY2F0Y2goKCkgPT4gY29uc29sZS53YXJuKCdOb3RpZmljYXRpb24gc2VydmljZTogRmFpbGVkIHRvIGVzdGFibGlzaCBjb25uZWN0aW9uLicpKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFN0b3BzIGNvbm5lY3Rpb24gd2l0aCB0aGUgc2VydmVyXHJcbiAgICogQHBhcmFtIGNvbm5lY3Rpb25JRCBjb25uZWN0aW9uIGlkZW50aWZpZXJcclxuICAgKi9cclxuICBwdWJsaWMgc3RvcENvbm5lY3Rpb24oY29ubmVjdGlvbklEOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGNvbnN0IGNvbm5lY3Rpb24gPSB0aGlzLmdldENvbm5lY3Rpb25CeUlEKGNvbm5lY3Rpb25JRCk7XHJcblxyXG4gICAgaWYgKCFjb25uZWN0aW9uKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25uZWN0aW9uLm9mZigndHJhbnNmZXJOb3RpZmljYXRpb24nKTtcclxuICAgIGNvbm5lY3Rpb24uc3RvcCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVtb3ZlcyBjb25uZWN0aW9uIGVudGlyZWx5XHJcbiAgICogQHBhcmFtIGNvbm5lY3Rpb25JRCBjb25uZWN0aW9uIGlkZW50aWZpZXJcclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlQ29ubmVjdGlvbihjb25uZWN0aW9uSUQ6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5zdG9wQ29ubmVjdGlvbihjb25uZWN0aW9uSUQpO1xyXG5cclxuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5odWJDb25uZWN0aW9ucy5maW5kSW5kZXgoY29ubmVjdGlvbiA9PiBjb25uZWN0aW9uLmlkID09PSBjb25uZWN0aW9uSUQpO1xyXG4gICAgaWYgKGluZGV4ICE9PSAtMSkge1xyXG4gICAgICB0aGlzLmh1YkNvbm5lY3Rpb25zLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBVcGRhdGVzIG5vdGlmaWNhdGlvbnMgbWV0YWRhdGEgZm9yIHNwZWNpZmljIGNvbm5lY3Rpb24uIE5vdGlmaWVzIHNlcnZlciBhYm91dCBpdC5cclxuICAgKiBAcGFyYW0gY29ubmVjdGlvbklEIGNvbm5lY3Rpb24gaWRlbnRpZmllclxyXG4gICAqIEBwYXJhbSBtZXRhZGF0YSBub3RpZmljYXRpb24gbWV0YWRhdGEsIChlLmcgbGFuZ3VhZ2UpXHJcbiAgICovXHJcbiAgcHVibGljIHVwZGF0ZU5vdGlmaWNhdGlvbnMoY29ubmVjdGlvbklEOiBzdHJpbmcsIG1ldGFkYXRhOiBBdmxOb3RpZmljYXRpb25NZXRhZGF0YSk6IHZvaWQge1xyXG4gICAgY29uc3QgY29ubmVjdGlvbiA9IHRoaXMuZ2V0Q29ubmVjdGlvbkJ5SUQoY29ubmVjdGlvbklEKTtcclxuICAgIGlmICghY29ubmVjdGlvbikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5zdGFydE5vdGlmaWNhdGlvbnMoY29ubmVjdGlvbiwgbWV0YWRhdGEpO1xyXG4gIH1cclxuXHJcbiAgLy8gUHJpdmF0ZSBtZXRob2RzXHJcblxyXG4gIHByaXZhdGUgc3RhcnROb3RpZmljYXRpb25zKGNvbm5lY3Rpb246IEh1YkNvbm5lY3Rpb24sIG1ldGFkYXRhOiBBdmxOb3RpZmljYXRpb25NZXRhZGF0YSk6IHZvaWQge1xyXG4gICAgY29ubmVjdGlvbi5pbnZva2UoJ3N0YXJ0Tm90aWZpY2F0aW9ucycsIG1ldGFkYXRhKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0Q29ubmVjdGlvbkJ5SUQoY29ubmVjdGlvbklEOiBzdHJpbmcpOiBIdWJDb25uZWN0aW9uIHtcclxuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5odWJDb25uZWN0aW9ucy5maW5kSW5kZXgoY29ubmVjdGlvbiA9PiBjb25uZWN0aW9uLmlkID09PSBjb25uZWN0aW9uSUQpO1xyXG4gICAgcmV0dXJuIHRoaXMuaHViQ29ubmVjdGlvbnNbaW5kZXhdPy5jb25uZWN0aW9uO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBidWlsZENvbm5lY3Rpb24oXHJcbiAgICBlbmRwb2ludDogc3RyaW5nLFxyXG4gICAgb3B0aW9uczogQXZsTm90aWZpY2F0aW9uQ29ubmVjdGlvbk9wdGlvbnNcclxuICApOiBIdWJDb25uZWN0aW9uIHtcclxuICAgIGNvbnN0IGh1YkNvbm5lY3Rpb24gPSBuZXcgSHViQ29ubmVjdGlvbkJ1aWxkZXIoKVxyXG4gICAgICAuY29uZmlndXJlTG9nZ2luZyhMb2dMZXZlbC5Ob25lKVxyXG4gICAgICAud2l0aFVybChlbmRwb2ludClcclxuICAgICAgLndpdGhBdXRvbWF0aWNSZWNvbm5lY3QoKVxyXG4gICAgICAuYnVpbGQoKTtcclxuXHJcbiAgICBodWJDb25uZWN0aW9uLm9ucmVjb25uZWN0ZWQoKCkgPT4gdGhpcy5zdGFydE5vdGlmaWNhdGlvbnMoaHViQ29ubmVjdGlvbiwgb3B0aW9ucy5tZXRhZGF0YSkpO1xyXG4gICAgaHViQ29ubmVjdGlvbi5vbigndHJhbnNmZXJOb3RpZmljYXRpb24nLCAobm90aWZpY2F0aW9uOiBBdmxOb3RpZmljYXRpb24pID0+IHtcclxuICAgICAgdGhpcy5ub3RpZmljYXRpb24ubmV4dChub3RpZmljYXRpb24pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5odWJDb25uZWN0aW9ucy5wdXNoKHtcclxuICAgICAgaWQ6IG9wdGlvbnMuY29ubmVjdGlvbklELFxyXG4gICAgICBjb25uZWN0aW9uOiBodWJDb25uZWN0aW9uXHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gaHViQ29ubmVjdGlvbjtcclxuICB9XHJcbn1cclxuIl19