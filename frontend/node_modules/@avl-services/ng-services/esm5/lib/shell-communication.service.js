import { __assign, __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { Subject, BehaviorSubject } from 'rxjs';
import { v4 as uuidv4 } from 'uuid';
import { MessageType } from './message.model';
import { AvlAuthService } from '@avl-ng-controls/auth';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "@avl-ng-controls/auth";
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/router';
import * as ɵngcc2 from '@avl-ng-controls/auth';
var ShellCommunicationService = /** @class */ (function () {
    function ShellCommunicationService(router, authService) {
        var _a;
        var _this = this;
        this.router = router;
        this.authService = authService;
        this.handlers = (_a = {},
            _a[MessageType.theme] = function (theme) { return _this.handleTheme(theme); },
            _a[MessageType.locale] = function (locale) { return _this.handleLocale(locale); },
            _a[MessageType.language] = function (language) { return _this.handleLanguage(language); },
            _a[MessageType.colorScheme] = function (colorScheme) { return _this.handleColorScheme(colorScheme); },
            _a[MessageType.navigation] = function (url) { return _this.handleNavigation(url); },
            _a[MessageType.action] = function (action) { return _this.handleAction(action); },
            _a[MessageType.authentication] = function (user) { return _this.handleAuthentication(user); },
            _a[MessageType.redirectedFromLogIn] = function (redirected) { return _this.handleRedirectedFromLogIn(redirected); },
            _a);
        this.themeSubject = new Subject();
        this.languageSubject = new Subject();
        this.actionSubject = new Subject();
        this.localeSubject = new Subject();
        this.colorSchemeSubject = new Subject();
        /**
        * Observable tracking theme
        * Emits "dark" if dark theme selected, "light" otherwise
        */
        this.theme$ = this.themeSubject;
        /**
        * Observable tracking language
        */
        this.language$ = this.languageSubject;
        this.action$ = this.actionSubject;
        /**
        * Observable tracking country changes
        */
        this.locale$ = this.localeSubject;
        /**
        * Observable tracking color scheme changes
        */
        this.colorScheme$ = this.colorSchemeSubject;
        /**
         * Observable tracking if redirected from idb
         * Resolves to true on redirection, false otherwise
         */
        this.redirectedFromLogIn = new BehaviorSubject(undefined);
        /**
         * If current application is inside shell application
         * True if current application is inside shell application, false otherwise.
         */
        this.isChild = window.location !== window.parent.location;
        window.addEventListener('message', function (event) { return _this.onMessage(event); });
        this.id = uuidv4();
    }
    ShellCommunicationService.prototype.notifyShellAboutAction = function (action) {
        this.postMessageToShell(MessageType.action, action);
    };
    /**
     * Sends message to shell that it needs to navigate to login page
     */
    ShellCommunicationService.prototype.notifyShellAboutLogin = function (url) {
        this.postMessageToShell(MessageType.login, url);
    };
    /**
     * Sends message to shell that it needs to navigate to @url
     */
    ShellCommunicationService.prototype.notifyShellAboutNavigation = function (url) {
        this.postMessageToShell(MessageType.navigation, url);
    };
    /**
     * Sends registration message to shell
     */
    ShellCommunicationService.prototype.registerToShell = function () {
        this.postMessageToShell(MessageType.registration, this.id);
    };
    ShellCommunicationService.prototype.onMessage = function (event) {
        var _a = event.data, payload = _a.payload, messageType = _a.messageType;
        var handlers = __assign(__assign({}, this.handlers), { default: function () { return console.log('Unrecognized message for the shell.', event); } });
        (handlers[messageType] || handlers.default)(payload);
    };
    ShellCommunicationService.prototype.postMessageToShell = function (messageType, payload) {
        var message = { messageType: messageType, payload: payload };
        window.parent.window.postMessage(message, '*');
    };
    ShellCommunicationService.prototype.handleColorScheme = function (colorScheme) {
        this.colorSchemeSubject.next(colorScheme);
    };
    ShellCommunicationService.prototype.handleLanguage = function (language) {
        this.languageSubject.next(language);
    };
    ShellCommunicationService.prototype.handleLocale = function (locale) {
        this.localeSubject.next(locale);
    };
    ShellCommunicationService.prototype.handleTheme = function (theme) {
        this.themeSubject.next(theme);
    };
    ShellCommunicationService.prototype.handleNavigation = function (url) {
        this.router.navigateByUrl(url);
    };
    ShellCommunicationService.prototype.handleAction = function (action) {
        this.actionSubject.next(action);
    };
    ShellCommunicationService.prototype.handleAuthentication = function (user) {
        if (user === null || user === void 0 ? void 0 : user.access_token) {
            this.setUserToSessionStorage(user);
        }
        else {
            this.removeUserFromSessionStorage();
        }
        this.authService.reloadPersistedUserData();
    };
    ShellCommunicationService.prototype.handleRedirectedFromLogIn = function (redirected) {
        this.redirectedFromLogIn.next(redirected);
    };
    ShellCommunicationService.prototype.setUserToSessionStorage = function (user) {
        sessionStorage.setItem('refresh_token', user.refresh_token);
        sessionStorage.setItem('access_token', user.access_token);
        sessionStorage.setItem('id_token', user.id_token);
        sessionStorage.setItem('refresh_token_expires_at', String(user.refresh_token_expires_at));
        sessionStorage.setItem('access_token_expires_at', String(user.access_token_expires_at));
        sessionStorage.setItem('access_token_stored_at', String(user.access_token_stored_at));
        sessionStorage.setItem('username', user.username);
        sessionStorage.setItem('name', user.name);
        sessionStorage.setItem('roles', JSON.stringify(user.roles));
    };
    ShellCommunicationService.prototype.removeUserFromSessionStorage = function () {
        sessionStorage.removeItem('refresh_token');
        sessionStorage.removeItem('access_token');
        sessionStorage.removeItem('id_token');
        sessionStorage.removeItem('refresh_token_expires_at');
        sessionStorage.removeItem('access_token_expires_at');
        sessionStorage.removeItem('access_token_stored_at');
        sessionStorage.removeItem('username');
        sessionStorage.removeItem('name');
        sessionStorage.removeItem('roles');
    };
    ShellCommunicationService.ctorParameters = function () { return [
        { type: Router },
        { type: AvlAuthService }
    ]; };
    ShellCommunicationService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ShellCommunicationService_Factory() { return new ShellCommunicationService(i0.ɵɵinject(i1.Router), i0.ɵɵinject(i2.AvlAuthService)); }, token: ShellCommunicationService, providedIn: "root" });
ShellCommunicationService.ɵfac = function ShellCommunicationService_Factory(t) { return new (t || ShellCommunicationService)(ɵngcc0.ɵɵinject(ɵngcc1.Router), ɵngcc0.ɵɵinject(ɵngcc2.AvlAuthService)); };
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ShellCommunicationService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: ɵngcc1.Router }, { type: ɵngcc2.AvlAuthService }]; }, null); })();
    return ShellCommunicationService;
}());
export { ShellCommunicationService };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hlbGwtY29tbXVuaWNhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyJuZzovQGF2bC1zZXJ2aWNlcy9uZy1zZXJ2aWNlcy9saWIvc2hlbGwtY29tbXVuaWNhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsT0FBTyxFQUFjLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1RCxPQUFPLEVBQUUsRUFBRSxJQUFJLE1BQU0sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwQyxPQUFPLEVBQXlDLFdBQVcsRUFBaUIsTUFBTSxpQkFBaUIsQ0FBQztBQUNwRyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDdkQ7QUFHQztBQUNvQzs7OztBQUFyQztBQUNvQixJQTJEbEIsbUNBQW9CLE1BQWMsRUFBVSxXQUEyQjtBQUN6RTtBQUFnQixRQURkLGlCQUlDO0FBQ0gsUUFMc0IsV0FBTSxHQUFOLE1BQU0sQ0FBUTtBQUFDLFFBQVMsZ0JBQVcsR0FBWCxXQUFXLENBQWdCO0FBQUMsUUF6RGhFLGFBQVE7QUFBYSxZQUMzQixHQUFDLFdBQVcsQ0FBQyxLQUFLLElBQUcsVUFBQyxLQUFhLElBQUssT0FBQSxLQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxFQUF2QixDQUF1QjtBQUNuRSxZQUFJLEdBQUMsV0FBVyxDQUFDLE1BQU0sSUFBRyxVQUFDLE1BQWMsSUFBSyxPQUFBLEtBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEVBQXpCLENBQXlCO0FBQ3ZFLFlBQUksR0FBQyxXQUFXLENBQUMsUUFBUSxJQUFHLFVBQUMsUUFBZ0IsSUFBSyxPQUFBLEtBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLEVBQTdCLENBQTZCO0FBQy9FLFlBQUks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LEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFFQSxBQUdBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFFQSxBQUVBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUVBLEFBRUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUVBLEFBRUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQVFBLEFBR0EsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFFQSxBQUdBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFHQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFFQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFFQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFFQSxBQUNBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBMUdBLEFBQUEsQUFBQSxBQUFBLEFBNURBLEFBQUEsQUFIQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBdUtBLEFBakxBLEFBaUxBLEFBdktBLEFBdUtBLEFBdktBLEFBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUsIEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcclxuaW1wb3J0IHsgQ29sb3JTY2hlbWUsIE1lc3NhZ2UsIE1lc3NhZ2VIYW5kbGVycywgTWVzc2FnZVR5cGUsIFBheWxvYWQsIFVzZXIgfSBmcm9tICcuL21lc3NhZ2UubW9kZWwnO1xyXG5pbXBvcnQgeyBBdmxBdXRoU2VydmljZSB9IGZyb20gJ0BhdmwtbmctY29udHJvbHMvYXV0aCc7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBTaGVsbENvbW11bmljYXRpb25TZXJ2aWNlIHtcclxuICBwcml2YXRlIHJlYWRvbmx5IGlkOiBzdHJpbmc7XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlcnM6IE1lc3NhZ2VIYW5kbGVycyA9IHtcclxuICAgIFtNZXNzYWdlVHlwZS50aGVtZV06ICh0aGVtZTogc3RyaW5nKSA9PiB0aGlzLmhhbmRsZVRoZW1lKHRoZW1lKSxcclxuICAgIFtNZXNzYWdlVHlwZS5sb2NhbGVdOiAobG9jYWxlOiBzdHJpbmcpID0+IHRoaXMuaGFuZGxlTG9jYWxlKGxvY2FsZSksXHJcbiAgICBbTWVzc2FnZVR5cGUubGFuZ3VhZ2VdOiAobGFuZ3VhZ2U6IHN0cmluZykgPT4gdGhpcy5oYW5kbGVMYW5ndWFnZShsYW5ndWFnZSksXHJcbiAgICBbTWVzc2FnZVR5cGUuY29sb3JTY2hlbWVdOiAoY29sb3JTY2hlbWU6IENvbG9yU2NoZW1lKSA9PiB0aGlzLmhhbmRsZUNvbG9yU2NoZW1lKGNvbG9yU2NoZW1lKSxcclxuICAgIFtNZXNzYWdlVHlwZS5uYXZpZ2F0aW9uXTogKHVybDogc3RyaW5nKSA9PiB0aGlzLmhhbmRsZU5hdmlnYXRpb24odXJsKSxcclxuICAgIFtNZXNzYWdlVHlwZS5hY3Rpb25dOiAoYWN0aW9uOiBzdHJpbmcpID0+IHRoaXMuaGFuZGxlQWN0aW9uKGFjdGlvbiksXHJcbiAgICBbTWVzc2FnZVR5cGUuYXV0aGVudGljYXRpb25dOiAodXNlcjogVXNlcikgPT4gdGhpcy5oYW5kbGVBdXRoZW50aWNhdGlvbih1c2VyKSxcclxuICAgIFtNZXNzYWdlVHlwZS5yZWRpcmVjdGVkRnJvbUxvZ0luXTogKHJlZGlyZWN0ZWQ6IGJvb2xlYW4pID0+IHRoaXMuaGFuZGxlUmVkaXJlY3RlZEZyb21Mb2dJbihyZWRpcmVjdGVkKSxcclxuICB9O1xyXG5cclxuICBwcml2YXRlIHRoZW1lU3ViamVjdCA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKTtcclxuICBwcml2YXRlIGxhbmd1YWdlU3ViamVjdCA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKTtcclxuICBwcml2YXRlIGFjdGlvblN1YmplY3QgPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XHJcbiAgcHJpdmF0ZSBsb2NhbGVTdWJqZWN0ID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xyXG4gIHByaXZhdGUgY29sb3JTY2hlbWVTdWJqZWN0ID0gbmV3IFN1YmplY3Q8Q29sb3JTY2hlbWU+KCk7XHJcblxyXG4gIC8qKlxyXG4gICogT2JzZXJ2YWJsZSB0cmFja2luZyB0aGVtZVxyXG4gICogRW1pdHMgXCJkYXJrXCIgaWYgZGFyayB0aGVtZSBzZWxlY3RlZCwgXCJsaWdodFwiIG90aGVyd2lzZSBcclxuICAqL1xyXG4gIHB1YmxpYyB0aGVtZSQ6IE9ic2VydmFibGU8c3RyaW5nPiA9IHRoaXMudGhlbWVTdWJqZWN0O1xyXG5cclxuICAvKipcclxuICAqIE9ic2VydmFibGUgdHJhY2tpbmcgbGFuZ3VhZ2VcclxuICAqL1xyXG4gIHB1YmxpYyBsYW5ndWFnZSQ6IE9ic2VydmFibGU8c3RyaW5nPiA9IHRoaXMubGFuZ3VhZ2VTdWJqZWN0O1xyXG4gIHB1YmxpYyBhY3Rpb24kOiBPYnNlcnZhYmxlPHN0cmluZz4gPSB0aGlzLmFjdGlvblN1YmplY3Q7XHJcblxyXG4gIC8qKlxyXG4gICogT2JzZXJ2YWJsZSB0cmFja2luZyBjb3VudHJ5IGNoYW5nZXNcclxuICAqL1xyXG4gIHB1YmxpYyBsb2NhbGUkOiBPYnNlcnZhYmxlPHN0cmluZz4gPSB0aGlzLmxvY2FsZVN1YmplY3Q7XHJcblxyXG4gIC8qKlxyXG4gICogT2JzZXJ2YWJsZSB0cmFja2luZyBjb2xvciBzY2hlbWUgY2hhbmdlc1xyXG4gICovXHJcbiAgcHVibGljIGNvbG9yU2NoZW1lJDogT2JzZXJ2YWJsZTxDb2xvclNjaGVtZT4gPSB0aGlzLmNvbG9yU2NoZW1lU3ViamVjdDtcclxuXHJcbiAgLyoqXHJcbiAgKiBPYnNlcnZhYmxlIHRyYWNraW5nIGxvZ2luIHN0YXRlXHJcbiAgKiBSZXNvbHZlcyB0byB0cnVlIG9uIHN1Y2Nlc3NmdWwgbG9naW4sIGZhbHNlIG90aGVyd2lzZVxyXG4gICovXHJcbiAgcHVibGljIGlzTG9nZ2VkSW4kOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xyXG5cclxuICAvKipcclxuICAgKiBPYnNlcnZhYmxlIHRyYWNraW5nIGlmIHJlZGlyZWN0ZWQgZnJvbSBpZGJcclxuICAgKiBSZXNvbHZlcyB0byB0cnVlIG9uIHJlZGlyZWN0aW9uLCBmYWxzZSBvdGhlcndpc2VcclxuICAgKi9cclxuICBwdWJsaWMgcmVkaXJlY3RlZEZyb21Mb2dJbiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4odW5kZWZpbmVkKTtcclxuICBcclxuICAvKipcclxuICAgKiBJZiBjdXJyZW50IGFwcGxpY2F0aW9uIGlzIGluc2lkZSBzaGVsbCBhcHBsaWNhdGlvbiBcclxuICAgKiBUcnVlIGlmIGN1cnJlbnQgYXBwbGljYXRpb24gaXMgaW5zaWRlIHNoZWxsIGFwcGxpY2F0aW9uLCBmYWxzZSBvdGhlcndpc2UuXHJcbiAgICovXHJcbiAgcHVibGljIGlzQ2hpbGQgPSB3aW5kb3cubG9jYXRpb24gIT09IHdpbmRvdy5wYXJlbnQubG9jYXRpb247XHJcbiAgXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByb3V0ZXI6IFJvdXRlciwgcHJpdmF0ZSBhdXRoU2VydmljZTogQXZsQXV0aFNlcnZpY2UpIHtcclxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgKGV2ZW50KSA9PiB0aGlzLm9uTWVzc2FnZShldmVudCkpO1xyXG4gICAgXHJcbiAgICB0aGlzLmlkID0gdXVpZHY0KCk7XHJcbiAgfVxyXG4gIFxyXG4gIHB1YmxpYyBub3RpZnlTaGVsbEFib3V0QWN0aW9uKGFjdGlvbjogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9TaGVsbChNZXNzYWdlVHlwZS5hY3Rpb24sIGFjdGlvbik7XHJcbiAgfVxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIG1lc3NhZ2UgdG8gc2hlbGwgdGhhdCBpdCBuZWVkcyB0byBuYXZpZ2F0ZSB0byBsb2dpbiBwYWdlXHJcbiAgICovXHJcbiAgcHVibGljIG5vdGlmeVNoZWxsQWJvdXRMb2dpbih1cmw6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvU2hlbGwoTWVzc2FnZVR5cGUubG9naW4sIHVybCk7XHJcbiAgfVxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIG1lc3NhZ2UgdG8gc2hlbGwgdGhhdCBpdCBuZWVkcyB0byBuYXZpZ2F0ZSB0byBAdXJsXHJcbiAgICovXHJcbiAgcHVibGljIG5vdGlmeVNoZWxsQWJvdXROYXZpZ2F0aW9uKHVybDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9TaGVsbChNZXNzYWdlVHlwZS5uYXZpZ2F0aW9uLCB1cmwpO1xyXG4gIH1cclxuICBcclxuICAvKipcclxuICAgKiBTZW5kcyByZWdpc3RyYXRpb24gbWVzc2FnZSB0byBzaGVsbCBcclxuICAgKi9cclxuICBwdWJsaWMgcmVnaXN0ZXJUb1NoZWxsKCk6IHZvaWQge1xyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvU2hlbGwoTWVzc2FnZVR5cGUucmVnaXN0cmF0aW9uLCB0aGlzLmlkKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgb25NZXNzYWdlKGV2ZW50OiBNZXNzYWdlRXZlbnQpOiB2b2lkIHtcclxuICAgIGNvbnN0IHsgcGF5bG9hZCwgbWVzc2FnZVR5cGUgfTogTWVzc2FnZSA9IGV2ZW50LmRhdGE7XHJcbiAgICBjb25zdCBoYW5kbGVycyA9IHtcclxuICAgICAgLi4udGhpcy5oYW5kbGVycyxcclxuICAgICAgZGVmYXVsdDogKCkgPT4gY29uc29sZS5sb2coJ1VucmVjb2duaXplZCBtZXNzYWdlIGZvciB0aGUgc2hlbGwuJywgZXZlbnQpXHJcbiAgICB9O1xyXG5cclxuICAgIChoYW5kbGVyc1ttZXNzYWdlVHlwZV0gfHwgaGFuZGxlcnMuZGVmYXVsdCkocGF5bG9hZCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBvc3RNZXNzYWdlVG9TaGVsbChtZXNzYWdlVHlwZTogTWVzc2FnZVR5cGUsIHBheWxvYWQ6IFBheWxvYWQpOiB2b2lkIHtcclxuICAgIGNvbnN0IG1lc3NhZ2U6IE1lc3NhZ2UgPSB7IG1lc3NhZ2VUeXBlLCBwYXlsb2FkIH07XHJcbiAgICB3aW5kb3cucGFyZW50LndpbmRvdy5wb3N0TWVzc2FnZShtZXNzYWdlLCAnKicpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVDb2xvclNjaGVtZShjb2xvclNjaGVtZTogQ29sb3JTY2hlbWUpOiB2b2lkIHtcclxuICAgIHRoaXMuY29sb3JTY2hlbWVTdWJqZWN0Lm5leHQoY29sb3JTY2hlbWUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVMYW5ndWFnZShsYW5ndWFnZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLmxhbmd1YWdlU3ViamVjdC5uZXh0KGxhbmd1YWdlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlTG9jYWxlKGxvY2FsZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLmxvY2FsZVN1YmplY3QubmV4dChsb2NhbGUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVUaGVtZSh0aGVtZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnRoZW1lU3ViamVjdC5uZXh0KHRoZW1lKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlTmF2aWdhdGlvbih1cmw6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybCh1cmwpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVBY3Rpb24oYWN0aW9uOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMuYWN0aW9uU3ViamVjdC5uZXh0KGFjdGlvbik7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUF1dGhlbnRpY2F0aW9uKHVzZXI6IFVzZXIpOiB2b2lkIHtcclxuICAgIGlmICh1c2VyPy5hY2Nlc3NfdG9rZW4pIHtcclxuICAgICAgdGhpcy5zZXRVc2VyVG9TZXNzaW9uU3RvcmFnZSh1c2VyKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMucmVtb3ZlVXNlckZyb21TZXNzaW9uU3RvcmFnZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuYXV0aFNlcnZpY2UucmVsb2FkUGVyc2lzdGVkVXNlckRhdGEoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlUmVkaXJlY3RlZEZyb21Mb2dJbihyZWRpcmVjdGVkOiBib29sZWFuKSB7XHJcbiAgICB0aGlzLnJlZGlyZWN0ZWRGcm9tTG9nSW4ubmV4dChyZWRpcmVjdGVkKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2V0VXNlclRvU2Vzc2lvblN0b3JhZ2UodXNlcjogVXNlcik6IHZvaWQge1xyXG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgncmVmcmVzaF90b2tlbicsIHVzZXIucmVmcmVzaF90b2tlbik7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCdhY2Nlc3NfdG9rZW4nLCB1c2VyLmFjY2Vzc190b2tlbik7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCdpZF90b2tlbicsIHVzZXIuaWRfdG9rZW4pO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgncmVmcmVzaF90b2tlbl9leHBpcmVzX2F0JywgU3RyaW5nKHVzZXIucmVmcmVzaF90b2tlbl9leHBpcmVzX2F0KSk7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCdhY2Nlc3NfdG9rZW5fZXhwaXJlc19hdCcsIFN0cmluZyh1c2VyLmFjY2Vzc190b2tlbl9leHBpcmVzX2F0KSk7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCdhY2Nlc3NfdG9rZW5fc3RvcmVkX2F0JywgU3RyaW5nKHVzZXIuYWNjZXNzX3Rva2VuX3N0b3JlZF9hdCkpO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgndXNlcm5hbWUnLCB1c2VyLnVzZXJuYW1lKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oJ25hbWUnLCB1c2VyLm5hbWUpO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgncm9sZXMnLCBKU09OLnN0cmluZ2lmeSh1c2VyLnJvbGVzKSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlbW92ZVVzZXJGcm9tU2Vzc2lvblN0b3JhZ2UoKTogdm9pZCB7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCdyZWZyZXNoX3Rva2VuJyk7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCdhY2Nlc3NfdG9rZW4nKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oJ2lkX3Rva2VuJyk7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCdyZWZyZXNoX3Rva2VuX2V4cGlyZXNfYXQnKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oJ2FjY2Vzc190b2tlbl9leHBpcmVzX2F0Jyk7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCdhY2Nlc3NfdG9rZW5fc3RvcmVkX2F0Jyk7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCd1c2VybmFtZScpO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSgnbmFtZScpO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSgncm9sZXMnKTtcclxuICB9XHJcbn1cclxuIl19