import { __assign, __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { Subject, BehaviorSubject } from 'rxjs';
import { v4 as uuidv4 } from 'uuid';
import { MessageType } from './message.model';
import { AvlAuthService } from '@avl-ng-controls/auth';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "@avl-ng-controls/auth";
var ShellCommunicationService = /** @class */ (function () {
    function ShellCommunicationService(router, authService) {
        var _a;
        var _this = this;
        this.router = router;
        this.authService = authService;
        this.handlers = (_a = {},
            _a[MessageType.theme] = function (theme) { return _this.handleTheme(theme); },
            _a[MessageType.locale] = function (locale) { return _this.handleLocale(locale); },
            _a[MessageType.language] = function (language) { return _this.handleLanguage(language); },
            _a[MessageType.colorScheme] = function (colorScheme) { return _this.handleColorScheme(colorScheme); },
            _a[MessageType.navigation] = function (url) { return _this.handleNavigation(url); },
            _a[MessageType.action] = function (action) { return _this.handleAction(action); },
            _a[MessageType.authentication] = function (user) { return _this.handleAuthentication(user); },
            _a[MessageType.redirectedFromLogIn] = function (redirected) { return _this.handleRedirectedFromLogIn(redirected); },
            _a);
        this.themeSubject = new Subject();
        this.languageSubject = new Subject();
        this.actionSubject = new Subject();
        this.localeSubject = new Subject();
        this.colorSchemeSubject = new Subject();
        /**
        * Observable tracking theme
        * Emits "dark" if dark theme selected, "light" otherwise
        */
        this.theme$ = this.themeSubject;
        /**
        * Observable tracking language
        */
        this.language$ = this.languageSubject;
        this.action$ = this.actionSubject;
        /**
        * Observable tracking country changes
        */
        this.locale$ = this.localeSubject;
        /**
        * Observable tracking color scheme changes
        */
        this.colorScheme$ = this.colorSchemeSubject;
        /**
         * Observable tracking if redirected from idb
         * Resolves to true on redirection, false otherwise
         */
        this.redirectedFromLogIn = new BehaviorSubject(undefined);
        /**
         * If current application is inside shell application
         * True if current application is inside shell application, false otherwise.
         */
        this.isChild = window.location !== window.parent.location;
        window.addEventListener('message', function (event) { return _this.onMessage(event); });
        this.id = uuidv4();
    }
    ShellCommunicationService.prototype.notifyShellAboutAction = function (action) {
        this.postMessageToShell(MessageType.action, action);
    };
    /**
     * Sends message to shell that it needs to navigate to login page
     */
    ShellCommunicationService.prototype.notifyShellAboutLogin = function (url) {
        this.postMessageToShell(MessageType.login, url);
    };
    /**
     * Sends message to shell that it needs to navigate to @url
     */
    ShellCommunicationService.prototype.notifyShellAboutNavigation = function (url) {
        this.postMessageToShell(MessageType.navigation, url);
    };
    /**
     * Sends registration message to shell
     */
    ShellCommunicationService.prototype.registerToShell = function () {
        this.postMessageToShell(MessageType.registration, this.id);
    };
    ShellCommunicationService.prototype.onMessage = function (event) {
        var _a = event.data, payload = _a.payload, messageType = _a.messageType;
        var handlers = __assign(__assign({}, this.handlers), { default: function () { return console.log('Unrecognized message for the shell.', event); } });
        (handlers[messageType] || handlers.default)(payload);
    };
    ShellCommunicationService.prototype.postMessageToShell = function (messageType, payload) {
        var message = { messageType: messageType, payload: payload };
        window.parent.window.postMessage(message, '*');
    };
    ShellCommunicationService.prototype.handleColorScheme = function (colorScheme) {
        this.colorSchemeSubject.next(colorScheme);
    };
    ShellCommunicationService.prototype.handleLanguage = function (language) {
        this.languageSubject.next(language);
    };
    ShellCommunicationService.prototype.handleLocale = function (locale) {
        this.localeSubject.next(locale);
    };
    ShellCommunicationService.prototype.handleTheme = function (theme) {
        this.themeSubject.next(theme);
    };
    ShellCommunicationService.prototype.handleNavigation = function (url) {
        this.router.navigateByUrl(url);
    };
    ShellCommunicationService.prototype.handleAction = function (action) {
        this.actionSubject.next(action);
    };
    ShellCommunicationService.prototype.handleAuthentication = function (user) {
        if (user === null || user === void 0 ? void 0 : user.access_token) {
            this.setUserToSessionStorage(user);
        }
        else {
            this.removeUserFromSessionStorage();
        }
        this.authService.reloadPersistedUserData();
    };
    ShellCommunicationService.prototype.handleRedirectedFromLogIn = function (redirected) {
        this.redirectedFromLogIn.next(redirected);
    };
    ShellCommunicationService.prototype.setUserToSessionStorage = function (user) {
        sessionStorage.setItem('refresh_token', user.refresh_token);
        sessionStorage.setItem('access_token', user.access_token);
        sessionStorage.setItem('id_token', user.id_token);
        sessionStorage.setItem('refresh_token_expires_at', String(user.refresh_token_expires_at));
        sessionStorage.setItem('access_token_expires_at', String(user.access_token_expires_at));
        sessionStorage.setItem('access_token_stored_at', String(user.access_token_stored_at));
        sessionStorage.setItem('username', user.username);
        sessionStorage.setItem('name', user.name);
        sessionStorage.setItem('roles', JSON.stringify(user.roles));
    };
    ShellCommunicationService.prototype.removeUserFromSessionStorage = function () {
        sessionStorage.removeItem('refresh_token');
        sessionStorage.removeItem('access_token');
        sessionStorage.removeItem('id_token');
        sessionStorage.removeItem('refresh_token_expires_at');
        sessionStorage.removeItem('access_token_expires_at');
        sessionStorage.removeItem('access_token_stored_at');
        sessionStorage.removeItem('username');
        sessionStorage.removeItem('name');
        sessionStorage.removeItem('roles');
    };
    ShellCommunicationService.ctorParameters = function () { return [
        { type: Router },
        { type: AvlAuthService }
    ]; };
    ShellCommunicationService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ShellCommunicationService_Factory() { return new ShellCommunicationService(i0.ɵɵinject(i1.Router), i0.ɵɵinject(i2.AvlAuthService)); }, token: ShellCommunicationService, providedIn: "root" });
    ShellCommunicationService = __decorate([
        Injectable({
            providedIn: 'root'
        })
    ], ShellCommunicationService);
    return ShellCommunicationService;
}());
export { ShellCommunicationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hlbGwtY29tbXVuaWNhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGF2bC1zZXJ2aWNlcy9uZy1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9zaGVsbC1jb21tdW5pY2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxPQUFPLEVBQWMsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVELE9BQU8sRUFBRSxFQUFFLElBQUksTUFBTSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3BDLE9BQU8sRUFBeUMsV0FBVyxFQUFpQixNQUFNLGlCQUFpQixDQUFDO0FBQ3BHLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQzs7OztBQUt2RDtJQTRERSxtQ0FBb0IsTUFBYyxFQUFVLFdBQTJCOztRQUF2RSxpQkFJQztRQUptQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVUsZ0JBQVcsR0FBWCxXQUFXLENBQWdCO1FBekQvRCxhQUFRO1lBQ2QsR0FBQyxXQUFXLENBQUMsS0FBSyxJQUFHLFVBQUMsS0FBYSxJQUFLLE9BQUEsS0FBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBdkIsQ0FBdUI7WUFDL0QsR0FBQyxXQUFXLENBQUMsTUFBTSxJQUFHLFVBQUMsTUFBYyxJQUFLLE9BQUEsS0FBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsRUFBekIsQ0FBeUI7WUFDbkUsR0FBQyxXQUFXLENBQUMsUUFBUSxJQUFHLFVBQUMsUUFBZ0IsSUFBSyxPQUFBLEtBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLEVBQTdCLENBQTZCO1lBQzNFLEdBQUMsV0FBVyxDQUFDLFdBQVcsSUFBRyxVQUFDLFdBQXdCLElBQUssT0FBQSxLQUFJLENB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Z0VBQTRCLEdBQXBDO1FBQ0UsY0FBYyxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUMzQyxjQUFjLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQzFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDdEMsY0FBYyxDQUFDLFVBQVUsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1FBQ3RELGNBQWMsQ0FBQyxVQUFVLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUNyRCxjQUFjLENBQUMsVUFBVSxDQUFDLHdCQUF3QixDQUFDLENBQUM7UUFDcEQsY0FBYyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN0QyxjQUFjLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2xDLGNBQWMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDckMsQ0FBQzs7Z0JBMUcyQixNQUFNO2dCQUF1QixjQUFjOzs7SUE1RDVELHlCQUF5QjtRQUhyQyxVQUFVLENBQUM7WUFDVixVQUFVLEVBQUUsTUFBTTtTQUNuQixDQUFDO09BQ1cseUJBQXlCLENBdUtyQztvQ0FqTEQ7Q0FpTEMsQUF2S0QsSUF1S0M7U0F2S1kseUJBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xyXG5pbXBvcnQgeyBTdWJqZWN0LCBPYnNlcnZhYmxlLCBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XHJcbmltcG9ydCB7IENvbG9yU2NoZW1lLCBNZXNzYWdlLCBNZXNzYWdlSGFuZGxlcnMsIE1lc3NhZ2VUeXBlLCBQYXlsb2FkLCBVc2VyIH0gZnJvbSAnLi9tZXNzYWdlLm1vZGVsJztcclxuaW1wb3J0IHsgQXZsQXV0aFNlcnZpY2UgfSBmcm9tICdAYXZsLW5nLWNvbnRyb2xzL2F1dGgnO1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46ICdyb290J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgU2hlbGxDb21tdW5pY2F0aW9uU2VydmljZSB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBpZDogc3RyaW5nO1xyXG5cclxuICBwcml2YXRlIGhhbmRsZXJzOiBNZXNzYWdlSGFuZGxlcnMgPSB7XHJcbiAgICBbTWVzc2FnZVR5cGUudGhlbWVdOiAodGhlbWU6IHN0cmluZykgPT4gdGhpcy5oYW5kbGVUaGVtZSh0aGVtZSksXHJcbiAgICBbTWVzc2FnZVR5cGUubG9jYWxlXTogKGxvY2FsZTogc3RyaW5nKSA9PiB0aGlzLmhhbmRsZUxvY2FsZShsb2NhbGUpLFxyXG4gICAgW01lc3NhZ2VUeXBlLmxhbmd1YWdlXTogKGxhbmd1YWdlOiBzdHJpbmcpID0+IHRoaXMuaGFuZGxlTGFuZ3VhZ2UobGFuZ3VhZ2UpLFxyXG4gICAgW01lc3NhZ2VUeXBlLmNvbG9yU2NoZW1lXTogKGNvbG9yU2NoZW1lOiBDb2xvclNjaGVtZSkgPT4gdGhpcy5oYW5kbGVDb2xvclNjaGVtZShjb2xvclNjaGVtZSksXHJcbiAgICBbTWVzc2FnZVR5cGUubmF2aWdhdGlvbl06ICh1cmw6IHN0cmluZykgPT4gdGhpcy5oYW5kbGVOYXZpZ2F0aW9uKHVybCksXHJcbiAgICBbTWVzc2FnZVR5cGUuYWN0aW9uXTogKGFjdGlvbjogc3RyaW5nKSA9PiB0aGlzLmhhbmRsZUFjdGlvbihhY3Rpb24pLFxyXG4gICAgW01lc3NhZ2VUeXBlLmF1dGhlbnRpY2F0aW9uXTogKHVzZXI6IFVzZXIpID0+IHRoaXMuaGFuZGxlQXV0aGVudGljYXRpb24odXNlciksXHJcbiAgICBbTWVzc2FnZVR5cGUucmVkaXJlY3RlZEZyb21Mb2dJbl06IChyZWRpcmVjdGVkOiBib29sZWFuKSA9PiB0aGlzLmhhbmRsZVJlZGlyZWN0ZWRGcm9tTG9nSW4ocmVkaXJlY3RlZCksXHJcbiAgfTtcclxuXHJcbiAgcHJpdmF0ZSB0aGVtZVN1YmplY3QgPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XHJcbiAgcHJpdmF0ZSBsYW5ndWFnZVN1YmplY3QgPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XHJcbiAgcHJpdmF0ZSBhY3Rpb25TdWJqZWN0ID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xyXG4gIHByaXZhdGUgbG9jYWxlU3ViamVjdCA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKTtcclxuICBwcml2YXRlIGNvbG9yU2NoZW1lU3ViamVjdCA9IG5ldyBTdWJqZWN0PENvbG9yU2NoZW1lPigpO1xyXG5cclxuICAvKipcclxuICAqIE9ic2VydmFibGUgdHJhY2tpbmcgdGhlbWVcclxuICAqIEVtaXRzIFwiZGFya1wiIGlmIGRhcmsgdGhlbWUgc2VsZWN0ZWQsIFwibGlnaHRcIiBvdGhlcndpc2UgXHJcbiAgKi9cclxuICBwdWJsaWMgdGhlbWUkOiBPYnNlcnZhYmxlPHN0cmluZz4gPSB0aGlzLnRoZW1lU3ViamVjdDtcclxuXHJcbiAgLyoqXHJcbiAgKiBPYnNlcnZhYmxlIHRyYWNraW5nIGxhbmd1YWdlXHJcbiAgKi9cclxuICBwdWJsaWMgbGFuZ3VhZ2UkOiBPYnNlcnZhYmxlPHN0cmluZz4gPSB0aGlzLmxhbmd1YWdlU3ViamVjdDtcclxuICBwdWJsaWMgYWN0aW9uJDogT2JzZXJ2YWJsZTxzdHJpbmc+ID0gdGhpcy5hY3Rpb25TdWJqZWN0O1xyXG5cclxuICAvKipcclxuICAqIE9ic2VydmFibGUgdHJhY2tpbmcgY291bnRyeSBjaGFuZ2VzXHJcbiAgKi9cclxuICBwdWJsaWMgbG9jYWxlJDogT2JzZXJ2YWJsZTxzdHJpbmc+ID0gdGhpcy5sb2NhbGVTdWJqZWN0O1xyXG5cclxuICAvKipcclxuICAqIE9ic2VydmFibGUgdHJhY2tpbmcgY29sb3Igc2NoZW1lIGNoYW5nZXNcclxuICAqL1xyXG4gIHB1YmxpYyBjb2xvclNjaGVtZSQ6IE9ic2VydmFibGU8Q29sb3JTY2hlbWU+ID0gdGhpcy5jb2xvclNjaGVtZVN1YmplY3Q7XHJcblxyXG4gIC8qKlxyXG4gICogT2JzZXJ2YWJsZSB0cmFja2luZyBsb2dpbiBzdGF0ZVxyXG4gICogUmVzb2x2ZXMgdG8gdHJ1ZSBvbiBzdWNjZXNzZnVsIGxvZ2luLCBmYWxzZSBvdGhlcndpc2VcclxuICAqL1xyXG4gIHB1YmxpYyBpc0xvZ2dlZEluJDogT2JzZXJ2YWJsZTxib29sZWFuPjtcclxuXHJcbiAgLyoqXHJcbiAgICogT2JzZXJ2YWJsZSB0cmFja2luZyBpZiByZWRpcmVjdGVkIGZyb20gaWRiXHJcbiAgICogUmVzb2x2ZXMgdG8gdHJ1ZSBvbiByZWRpcmVjdGlvbiwgZmFsc2Ugb3RoZXJ3aXNlXHJcbiAgICovXHJcbiAgcHVibGljIHJlZGlyZWN0ZWRGcm9tTG9nSW4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KHVuZGVmaW5lZCk7XHJcbiAgXHJcbiAgLyoqXHJcbiAgICogSWYgY3VycmVudCBhcHBsaWNhdGlvbiBpcyBpbnNpZGUgc2hlbGwgYXBwbGljYXRpb24gXHJcbiAgICogVHJ1ZSBpZiBjdXJyZW50IGFwcGxpY2F0aW9uIGlzIGluc2lkZSBzaGVsbCBhcHBsaWNhdGlvbiwgZmFsc2Ugb3RoZXJ3aXNlLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBpc0NoaWxkID0gd2luZG93LmxvY2F0aW9uICE9PSB3aW5kb3cucGFyZW50LmxvY2F0aW9uO1xyXG4gIFxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsIHByaXZhdGUgYXV0aFNlcnZpY2U6IEF2bEF1dGhTZXJ2aWNlKSB7XHJcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIChldmVudCkgPT4gdGhpcy5vbk1lc3NhZ2UoZXZlbnQpKTtcclxuICAgIFxyXG4gICAgdGhpcy5pZCA9IHV1aWR2NCgpO1xyXG4gIH1cclxuICBcclxuICBwdWJsaWMgbm90aWZ5U2hlbGxBYm91dEFjdGlvbihhY3Rpb246IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvU2hlbGwoTWVzc2FnZVR5cGUuYWN0aW9uLCBhY3Rpb24pO1xyXG4gIH1cclxuICBcclxuICAvKipcclxuICAgKiBTZW5kcyBtZXNzYWdlIHRvIHNoZWxsIHRoYXQgaXQgbmVlZHMgdG8gbmF2aWdhdGUgdG8gbG9naW4gcGFnZVxyXG4gICAqL1xyXG4gIHB1YmxpYyBub3RpZnlTaGVsbEFib3V0TG9naW4odXJsOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb1NoZWxsKE1lc3NhZ2VUeXBlLmxvZ2luLCB1cmwpO1xyXG4gIH1cclxuICBcclxuICAvKipcclxuICAgKiBTZW5kcyBtZXNzYWdlIHRvIHNoZWxsIHRoYXQgaXQgbmVlZHMgdG8gbmF2aWdhdGUgdG8gQHVybFxyXG4gICAqL1xyXG4gIHB1YmxpYyBub3RpZnlTaGVsbEFib3V0TmF2aWdhdGlvbih1cmw6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvU2hlbGwoTWVzc2FnZVR5cGUubmF2aWdhdGlvbiwgdXJsKTtcclxuICB9XHJcbiAgXHJcbiAgLyoqXHJcbiAgICogU2VuZHMgcmVnaXN0cmF0aW9uIG1lc3NhZ2UgdG8gc2hlbGwgXHJcbiAgICovXHJcbiAgcHVibGljIHJlZ2lzdGVyVG9TaGVsbCgpOiB2b2lkIHtcclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb1NoZWxsKE1lc3NhZ2VUeXBlLnJlZ2lzdHJhdGlvbiwgdGhpcy5pZCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG9uTWVzc2FnZShldmVudDogTWVzc2FnZUV2ZW50KTogdm9pZCB7XHJcbiAgICBjb25zdCB7IHBheWxvYWQsIG1lc3NhZ2VUeXBlIH06IE1lc3NhZ2UgPSBldmVudC5kYXRhO1xyXG4gICAgY29uc3QgaGFuZGxlcnMgPSB7XHJcbiAgICAgIC4uLnRoaXMuaGFuZGxlcnMsXHJcbiAgICAgIGRlZmF1bHQ6ICgpID0+IGNvbnNvbGUubG9nKCdVbnJlY29nbml6ZWQgbWVzc2FnZSBmb3IgdGhlIHNoZWxsLicsIGV2ZW50KVxyXG4gICAgfTtcclxuXHJcbiAgICAoaGFuZGxlcnNbbWVzc2FnZVR5cGVdIHx8IGhhbmRsZXJzLmRlZmF1bHQpKHBheWxvYWQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwb3N0TWVzc2FnZVRvU2hlbGwobWVzc2FnZVR5cGU6IE1lc3NhZ2VUeXBlLCBwYXlsb2FkOiBQYXlsb2FkKTogdm9pZCB7XHJcbiAgICBjb25zdCBtZXNzYWdlOiBNZXNzYWdlID0geyBtZXNzYWdlVHlwZSwgcGF5bG9hZCB9O1xyXG4gICAgd2luZG93LnBhcmVudC53aW5kb3cucG9zdE1lc3NhZ2UobWVzc2FnZSwgJyonKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlQ29sb3JTY2hlbWUoY29sb3JTY2hlbWU6IENvbG9yU2NoZW1lKTogdm9pZCB7XHJcbiAgICB0aGlzLmNvbG9yU2NoZW1lU3ViamVjdC5uZXh0KGNvbG9yU2NoZW1lKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlTGFuZ3VhZ2UobGFuZ3VhZ2U6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5sYW5ndWFnZVN1YmplY3QubmV4dChsYW5ndWFnZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUxvY2FsZShsb2NhbGU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5sb2NhbGVTdWJqZWN0Lm5leHQobG9jYWxlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlVGhlbWUodGhlbWU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy50aGVtZVN1YmplY3QubmV4dCh0aGVtZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZU5hdmlnYXRpb24odXJsOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwodXJsKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlQWN0aW9uKGFjdGlvbjogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLmFjdGlvblN1YmplY3QubmV4dChhY3Rpb24pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVBdXRoZW50aWNhdGlvbih1c2VyOiBVc2VyKTogdm9pZCB7XHJcbiAgICBpZiAodXNlcj8uYWNjZXNzX3Rva2VuKSB7XHJcbiAgICAgIHRoaXMuc2V0VXNlclRvU2Vzc2lvblN0b3JhZ2UodXNlcik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnJlbW92ZVVzZXJGcm9tU2Vzc2lvblN0b3JhZ2UoKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmF1dGhTZXJ2aWNlLnJlbG9hZFBlcnNpc3RlZFVzZXJEYXRhKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZVJlZGlyZWN0ZWRGcm9tTG9nSW4ocmVkaXJlY3RlZDogYm9vbGVhbikge1xyXG4gICAgdGhpcy5yZWRpcmVjdGVkRnJvbUxvZ0luLm5leHQocmVkaXJlY3RlZCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldFVzZXJUb1Nlc3Npb25TdG9yYWdlKHVzZXI6IFVzZXIpOiB2b2lkIHtcclxuICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oJ3JlZnJlc2hfdG9rZW4nLCB1c2VyLnJlZnJlc2hfdG9rZW4pO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgnYWNjZXNzX3Rva2VuJywgdXNlci5hY2Nlc3NfdG9rZW4pO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgnaWRfdG9rZW4nLCB1c2VyLmlkX3Rva2VuKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oJ3JlZnJlc2hfdG9rZW5fZXhwaXJlc19hdCcsIFN0cmluZyh1c2VyLnJlZnJlc2hfdG9rZW5fZXhwaXJlc19hdCkpO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgnYWNjZXNzX3Rva2VuX2V4cGlyZXNfYXQnLCBTdHJpbmcodXNlci5hY2Nlc3NfdG9rZW5fZXhwaXJlc19hdCkpO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgnYWNjZXNzX3Rva2VuX3N0b3JlZF9hdCcsIFN0cmluZyh1c2VyLmFjY2Vzc190b2tlbl9zdG9yZWRfYXQpKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oJ3VzZXJuYW1lJywgdXNlci51c2VybmFtZSk7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCduYW1lJywgdXNlci5uYW1lKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oJ3JvbGVzJywgSlNPTi5zdHJpbmdpZnkodXNlci5yb2xlcykpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZW1vdmVVc2VyRnJvbVNlc3Npb25TdG9yYWdlKCk6IHZvaWQge1xyXG4gICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSgncmVmcmVzaF90b2tlbicpO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSgnYWNjZXNzX3Rva2VuJyk7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCdpZF90b2tlbicpO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSgncmVmcmVzaF90b2tlbl9leHBpcmVzX2F0Jyk7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCdhY2Nlc3NfdG9rZW5fZXhwaXJlc19hdCcpO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSgnYWNjZXNzX3Rva2VuX3N0b3JlZF9hdCcpO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSgndXNlcm5hbWUnKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oJ25hbWUnKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oJ3JvbGVzJyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==