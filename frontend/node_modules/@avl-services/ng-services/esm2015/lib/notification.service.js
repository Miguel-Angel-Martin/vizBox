import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { Subject } from 'rxjs';
import { HubConnectionBuilder, HubConnectionState, LogLevel } from '@microsoft/signalr';
import * as ɵngcc0 from '@angular/core';
let NotificationService = class NotificationService {
    constructor() {
        this.hubConnections = [];
        this.notification = new Subject();
        /**
         * Observable which emits newly arrived notifications.
         */
        this.notification$ = this.notification;
    }
    /**
     * Builds and starts signalR hub connection with the server.
     * If connection already exists and is not connected, restarts the connection.
     * @param endpoint server endpoint
     * @param options options of the connection
     */
    startConnection(endpoint, options) {
        let connection = this.getConnectionByID(options.connectionID);
        if (!connection) {
            connection = this.buildConnection(endpoint, options);
        }
        if (connection.state === HubConnectionState.Connected) {
            return;
        }
        connection
            .start()
            .then(() => this.startNotifications(connection, options.metadata))
            .catch(() => console.warn('Notification service: Failed to establish connection.'));
    }
    /**
     * Stops connection with the server
     * @param connectionID connection identifier
     */
    stopConnection(connectionID) {
        const connection = this.getConnectionByID(connectionID);
        if (!connection) {
            return;
        }
        connection.off('transferNotification');
        connection.stop();
    }
    /**
     * Removes connection entirely
     * @param connectionID connection identifier
     */
    removeConnection(connectionID) {
        this.stopConnection(connectionID);
        const index = this.hubConnections.findIndex(connection => connection.id === connectionID);
        if (index !== -1) {
            this.hubConnections.splice(index, 1);
        }
    }
    /**
     * Updates notifications metadata for specific connection. Notifies server about it.
     * @param connectionID connection identifier
     * @param metadata notification metadata, (e.g language)
     */
    updateNotifications(connectionID, metadata) {
        const connection = this.getConnectionByID(connectionID);
        if (!connection) {
            return;
        }
        this.startNotifications(connection, metadata);
    }
    // Private methods
    startNotifications(connection, metadata) {
        connection.invoke('startNotifications', metadata);
    }
    getConnectionByID(connectionID) {
        var _a;
        const index = this.hubConnections.findIndex(connection => connection.id === connectionID);
        return (_a = this.hubConnections[index]) === null || _a === void 0 ? void 0 : _a.connection;
    }
    buildConnection(endpoint, options) {
        const hubConnection = new HubConnectionBuilder()
            .configureLogging(LogLevel.None)
            .withUrl(endpoint)
            .withAutomaticReconnect()
            .build();
        hubConnection.onreconnected(() => this.startNotifications(hubConnection, options.metadata));
        hubConnection.on('transferNotification', (notification) => {
            this.notification.next(notification);
        });
        this.hubConnections.push({
            id: options.connectionID,
            connection: hubConnection
        });
        return hubConnection;
    }
};
NotificationService.ɵfac = function NotificationService_Factory(t) { return new (t || NotificationService)(); };
NotificationService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: NotificationService, factory: NotificationService.ɵfac });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(NotificationService, [{
        type: Injectable
    }], function () { return []; }, null); })();
export { NotificationService };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZpY2F0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIm5nOi9AYXZsLXNlcnZpY2VzL25nLXNlcnZpY2VzL2xpYi9ub3RpZmljYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRTNDLE9BQU8sRUFFTCxvQkFBb0IsRUFDcEIsa0JBQWtCLEVBQ2xCLFFBQVEsRUFDVCxNQUFNLG9CQUFvQixDQUFDOztBQW1CNUIsSUFBYSxtQkFBbUIsR0FBaEMsTUFBYSxtQkFBbUI7QUFDaEMsSUFEQTtBQUFnQixRQUNOLG1CQUFjLEdBQTRCLEVBQUUsQ0FBQztBQUN2RCxRQUFVLGlCQUFZLEdBQTZCLElBQUksT0FBTyxFQUFFLENBQUM7QUFDakUsUUFDRTtBQUNGO0FBRUEsV0FESztBQUNMLFFBQVMsa0JBQWEsR0FBZ0MsSUFBSSxDQUFDLFlBQVksQ0FBQztBQUN4RSxJQWtHQSxDQUFDO0FBQ0QsSUFsR0U7QUFDRjtBQUNFO0FBQ0U7QUFDRTtBQUVKLE9BREc7QUFDTCxJQUFTLGVBQWUsQ0FBQyxRQUFnQixFQUFFLE9BQXlDO0FBQUksUUFDcEYsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUNsRSxRQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7QUFDckIsWUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDM0QsU0FBSztBQUNMLFFBQ0ksSUFBSSxVQUFVLENBQUMsS0FBSyxLQUFLLGtCQUFrQixDQUFDLFNBQVMsRUFBRTtBQUMzRCxZQUFNLE9BQU87QUFDYixTQUFLO0FBQ0wsUUFDSSxVQUFVO0FBQ2QsYUFBTyxLQUFLLEVBQUU7QUFDZCxhQUFPLElBQUksQ0FBQyxH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QUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFHQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUVBLEFBR0EsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQ0EsQUFBQSxBQUVBLEFBSUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUVBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBRUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUVBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFFQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBMUdBLEFBQUEsQUFEQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBMEdBLEFBMUdBLEFBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuXHJcbmltcG9ydCB7XHJcbiAgSHViQ29ubmVjdGlvbixcclxuICBIdWJDb25uZWN0aW9uQnVpbGRlcixcclxuICBIdWJDb25uZWN0aW9uU3RhdGUsXHJcbiAgTG9nTGV2ZWxcclxufSBmcm9tICdAbWljcm9zb2Z0L3NpZ25hbHInO1xyXG5cclxuaW1wb3J0IHtcclxuICBBdmxOb3RpZmljYXRpb24sXHJcbiAgQXZsTm90aWZpY2F0aW9uQ29ubmVjdGlvbk9wdGlvbnMsXHJcbiAgQXZsTm90aWZpY2F0aW9uTWV0YWRhdGFcclxufSBmcm9tICdAYXZsLWNvbnRyb2xzL2ludGVyZmFjZXMnO1xyXG5cclxuaW50ZXJmYWNlIEFwcGxpY2F0aW9uQ29ubmVjdGlvbiB7XHJcbiAgLyoqIENvbm5lY3Rpb24gaWRlbnRpZmllciAqL1xyXG4gIHJlYWRvbmx5IGlkOiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIENvbm5lY3Rpb24gdG8gdGhlIGJhY2tlbmQgaHViLlxyXG4gICAqL1xyXG4gIHJlYWRvbmx5IGNvbm5lY3Rpb246IEh1YkNvbm5lY3Rpb247XHJcbn1cclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIE5vdGlmaWNhdGlvblNlcnZpY2Uge1xyXG4gIHByaXZhdGUgaHViQ29ubmVjdGlvbnM6IEFwcGxpY2F0aW9uQ29ubmVjdGlvbltdID0gW107XHJcbiAgcHJpdmF0ZSBub3RpZmljYXRpb246IFN1YmplY3Q8QXZsTm90aWZpY2F0aW9uPiA9IG5ldyBTdWJqZWN0KCk7XHJcblxyXG4gIC8qKlxyXG4gICAqIE9ic2VydmFibGUgd2hpY2ggZW1pdHMgbmV3bHkgYXJyaXZlZCBub3RpZmljYXRpb25zLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBub3RpZmljYXRpb24kOiBPYnNlcnZhYmxlPEF2bE5vdGlmaWNhdGlvbj4gPSB0aGlzLm5vdGlmaWNhdGlvbjtcclxuXHJcbiAgLyoqXHJcbiAgICogQnVpbGRzIGFuZCBzdGFydHMgc2lnbmFsUiBodWIgY29ubmVjdGlvbiB3aXRoIHRoZSBzZXJ2ZXIuXHJcbiAgICogSWYgY29ubmVjdGlvbiBhbHJlYWR5IGV4aXN0cyBhbmQgaXMgbm90IGNvbm5lY3RlZCwgcmVzdGFydHMgdGhlIGNvbm5lY3Rpb24uXHJcbiAgICogQHBhcmFtIGVuZHBvaW50IHNlcnZlciBlbmRwb2ludFxyXG4gICAqIEBwYXJhbSBvcHRpb25zIG9wdGlvbnMgb2YgdGhlIGNvbm5lY3Rpb25cclxuICAgKi9cclxuICBwdWJsaWMgc3RhcnRDb25uZWN0aW9uKGVuZHBvaW50OiBzdHJpbmcsIG9wdGlvbnM6IEF2bE5vdGlmaWNhdGlvbkNvbm5lY3Rpb25PcHRpb25zKTogdm9pZCB7XHJcbiAgICBsZXQgY29ubmVjdGlvbiA9IHRoaXMuZ2V0Q29ubmVjdGlvbkJ5SUQob3B0aW9ucy5jb25uZWN0aW9uSUQpO1xyXG4gICAgaWYgKCFjb25uZWN0aW9uKSB7XHJcbiAgICAgIGNvbm5lY3Rpb24gPSB0aGlzLmJ1aWxkQ29ubmVjdGlvbihlbmRwb2ludCwgb3B0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGNvbm5lY3Rpb24uc3RhdGUgPT09IEh1YkNvbm5lY3Rpb25TdGF0ZS5Db25uZWN0ZWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbm5lY3Rpb25cclxuICAgICAgLnN0YXJ0KClcclxuICAgICAgLnRoZW4oKCkgPT4gdGhpcy5zdGFydE5vdGlmaWNhdGlvbnMoY29ubmVjdGlvbiwgb3B0aW9ucy5tZXRhZGF0YSkpXHJcbiAgICAgIC5jYXRjaCgoKSA9PiBjb25zb2xlLndhcm4oJ05vdGlmaWNhdGlvbiBzZXJ2aWNlOiBGYWlsZWQgdG8gZXN0YWJsaXNoIGNvbm5lY3Rpb24uJykpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU3RvcHMgY29ubmVjdGlvbiB3aXRoIHRoZSBzZXJ2ZXJcclxuICAgKiBAcGFyYW0gY29ubmVjdGlvbklEIGNvbm5lY3Rpb24gaWRlbnRpZmllclxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdG9wQ29ubmVjdGlvbihjb25uZWN0aW9uSUQ6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgY29uc3QgY29ubmVjdGlvbiA9IHRoaXMuZ2V0Q29ubmVjdGlvbkJ5SUQoY29ubmVjdGlvbklEKTtcclxuXHJcbiAgICBpZiAoIWNvbm5lY3Rpb24pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbm5lY3Rpb24ub2ZmKCd0cmFuc2Zlck5vdGlmaWNhdGlvbicpO1xyXG4gICAgY29ubmVjdGlvbi5zdG9wKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZW1vdmVzIGNvbm5lY3Rpb24gZW50aXJlbHlcclxuICAgKiBAcGFyYW0gY29ubmVjdGlvbklEIGNvbm5lY3Rpb24gaWRlbnRpZmllclxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVDb25uZWN0aW9uKGNvbm5lY3Rpb25JRDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnN0b3BDb25uZWN0aW9uKGNvbm5lY3Rpb25JRCk7XHJcblxyXG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmh1YkNvbm5lY3Rpb25zLmZpbmRJbmRleChjb25uZWN0aW9uID0+IGNvbm5lY3Rpb24uaWQgPT09IGNvbm5lY3Rpb25JRCk7XHJcbiAgICBpZiAoaW5kZXggIT09IC0xKSB7XHJcbiAgICAgIHRoaXMuaHViQ29ubmVjdGlvbnMuc3BsaWNlKGluZGV4LCAxKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZXMgbm90aWZpY2F0aW9ucyBtZXRhZGF0YSBmb3Igc3BlY2lmaWMgY29ubmVjdGlvbi4gTm90aWZpZXMgc2VydmVyIGFib3V0IGl0LlxyXG4gICAqIEBwYXJhbSBjb25uZWN0aW9uSUQgY29ubmVjdGlvbiBpZGVudGlmaWVyXHJcbiAgICogQHBhcmFtIG1ldGFkYXRhIG5vdGlmaWNhdGlvbiBtZXRhZGF0YSwgKGUuZyBsYW5ndWFnZSlcclxuICAgKi9cclxuICBwdWJsaWMgdXBkYXRlTm90aWZpY2F0aW9ucyhjb25uZWN0aW9uSUQ6IHN0cmluZywgbWV0YWRhdGE6IEF2bE5vdGlmaWNhdGlvbk1ldGFkYXRhKTogdm9pZCB7XHJcbiAgICBjb25zdCBjb25uZWN0aW9uID0gdGhpcy5nZXRDb25uZWN0aW9uQnlJRChjb25uZWN0aW9uSUQpO1xyXG4gICAgaWYgKCFjb25uZWN0aW9uKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnN0YXJ0Tm90aWZpY2F0aW9ucyhjb25uZWN0aW9uLCBtZXRhZGF0YSk7XHJcbiAgfVxyXG5cclxuICAvLyBQcml2YXRlIG1ldGhvZHNcclxuXHJcbiAgcHJpdmF0ZSBzdGFydE5vdGlmaWNhdGlvbnMoY29ubmVjdGlvbjogSHViQ29ubmVjdGlvbiwgbWV0YWRhdGE6IEF2bE5vdGlmaWNhdGlvbk1ldGFkYXRhKTogdm9pZCB7XHJcbiAgICBjb25uZWN0aW9uLmludm9rZSgnc3RhcnROb3RpZmljYXRpb25zJywgbWV0YWRhdGEpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRDb25uZWN0aW9uQnlJRChjb25uZWN0aW9uSUQ6IHN0cmluZyk6IEh1YkNvbm5lY3Rpb24ge1xyXG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmh1YkNvbm5lY3Rpb25zLmZpbmRJbmRleChjb25uZWN0aW9uID0+IGNvbm5lY3Rpb24uaWQgPT09IGNvbm5lY3Rpb25JRCk7XHJcbiAgICByZXR1cm4gdGhpcy5odWJDb25uZWN0aW9uc1tpbmRleF0/LmNvbm5lY3Rpb247XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGJ1aWxkQ29ubmVjdGlvbihcclxuICAgIGVuZHBvaW50OiBzdHJpbmcsXHJcbiAgICBvcHRpb25zOiBBdmxOb3RpZmljYXRpb25Db25uZWN0aW9uT3B0aW9uc1xyXG4gICk6IEh1YkNvbm5lY3Rpb24ge1xyXG4gICAgY29uc3QgaHViQ29ubmVjdGlvbiA9IG5ldyBIdWJDb25uZWN0aW9uQnVpbGRlcigpXHJcbiAgICAgIC5jb25maWd1cmVMb2dnaW5nKExvZ0xldmVsLk5vbmUpXHJcbiAgICAgIC53aXRoVXJsKGVuZHBvaW50KVxyXG4gICAgICAud2l0aEF1dG9tYXRpY1JlY29ubmVjdCgpXHJcbiAgICAgIC5idWlsZCgpO1xyXG5cclxuICAgIGh1YkNvbm5lY3Rpb24ub25yZWNvbm5lY3RlZCgoKSA9PiB0aGlzLnN0YXJ0Tm90aWZpY2F0aW9ucyhodWJDb25uZWN0aW9uLCBvcHRpb25zLm1ldGFkYXRhKSk7XHJcbiAgICBodWJDb25uZWN0aW9uLm9uKCd0cmFuc2Zlck5vdGlmaWNhdGlvbicsIChub3RpZmljYXRpb246IEF2bE5vdGlmaWNhdGlvbikgPT4ge1xyXG4gICAgICB0aGlzLm5vdGlmaWNhdGlvbi5uZXh0KG5vdGlmaWNhdGlvbik7XHJcbiAgICB9KTtcclxuXHJcbiAgICB0aGlzLmh1YkNvbm5lY3Rpb25zLnB1c2goe1xyXG4gICAgICBpZDogb3B0aW9ucy5jb25uZWN0aW9uSUQsXHJcbiAgICAgIGNvbm5lY3Rpb246IGh1YkNvbm5lY3Rpb25cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBodWJDb25uZWN0aW9uO1xyXG4gIH1cclxufVxyXG4iXX0=