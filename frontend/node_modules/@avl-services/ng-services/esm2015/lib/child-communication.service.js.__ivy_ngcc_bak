import { __decorate } from "tslib";
import { Injectable } from "@angular/core";
import { TranslationManagementService } from "./translation-management.service";
import { ThemeService } from "./theme.service";
import { Subject } from "rxjs";
import { MessageType, } from "./message.model";
import * as i0 from "@angular/core";
import * as i1 from "./translation-management.service";
import * as i2 from "./theme.service";
let ChildCommunicationService = class ChildCommunicationService {
    constructor(translationManagementService, themeService) {
        this.translationManagementService = translationManagementService;
        this.themeService = themeService;
        this.handlers = {
            [MessageType.login]: (url) => this.handleLogin(url),
            [MessageType.navigation]: (url) => this.handleNavigation(url),
            [MessageType.action]: (action) => this.handleAction(action),
            [MessageType.registration]: (_) => this.handleRegistration(),
        };
        this.actionSubject = new Subject();
        this.navigationSubject = new Subject();
        this.loginSubject = new Subject();
        this.registrationCompletedSubject = new Subject();
        this.action$ = this.actionSubject;
        /**
         * Observable tracking url to navigate to
         */
        this.navigation$ = this.navigationSubject;
        /**
         * Observable tracking url for login
         * Url for login provided by child application
         */
        this.login$ = this.loginSubject;
        /**
         * Observable tracking child registration
         * Emits true if registration was successful, false otherwise
         */
        this.registrationCompleted$ = this
            .registrationCompletedSubject;
        window.addEventListener("message", (event) => this.onMessage(event));
        this.themeService.themeChanged.subscribe(() => this.postThemeToChildren());
    }
    /**
     * Sends message to child about locale
     */
    notifyChildAboutLocale(country) {
        this.postMessageToChild(MessageType.locale, country);
    }
    /**
     * Sends message to child about language
     */
    notifyChildAboutLanguage(language) {
        this.postMessageToChild(MessageType.language, language);
    }
    /**
     * Sends message to child about action
     */
    notifyChildAboutAction(action) {
        this.postMessageToChild(MessageType.action, action);
    }
    /**
     * Sends message to child about navigation
     */
    notifyChildAboutNavigation(url) {
        this.postMessageToChild(MessageType.navigation, url);
    }
    /**
     * Sends messages to children about current user
     */
    postAuthenticationDataToChildren() {
        const payload = {
            refresh_token: sessionStorage.getItem("refresh_token"),
            access_token: sessionStorage.getItem("access_token"),
            id_token: sessionStorage.getItem("id_token"),
            refresh_token_expires_at: Number(sessionStorage.getItem("refresh_token_expires_at")),
            access_token_expires_at: Number(sessionStorage.getItem("access_token_expires_at")),
            access_token_stored_at: Number(sessionStorage.getItem("access_token_stored_at")),
            username: sessionStorage.getItem("username"),
            name: sessionStorage.getItem("name"),
            roles: JSON.parse(sessionStorage.getItem("roles")),
        };
        this.postMessageToChild(MessageType.authentication, payload);
    }
    /**
     * Sends messages to children about selected application theme
     */
    postThemeToChildren() {
        const theme = this.themeService.getCurrentTheme();
        this.postMessageToChild(MessageType.theme, theme);
    }
    /**
     * Sends messages to children about selected language
     */
    postLanguageToChildren() {
        this.postMessageToChild(MessageType.language, this.translationManagementService.language);
    }
    /**
     * Sends messages to children about selected country
     */
    postLocaleToChildren() {
        const country = localStorage.getItem("country");
        this.postMessageToChild(MessageType.locale, country);
    }
    /**
     * Sends message to child about redirection from idb
     */
    postRedirectedFromLogIn(payload) {
        this.postMessageToChild(MessageType.redirectedFromLogIn, payload);
    }
    /**
     * Sends message to children about color scheme
     */
    postColorSchemeToChildren() {
        const computedStyle = window.getComputedStyle(document.body);
        const productColor = computedStyle.getPropertyValue("--avl-product-color");
        const productHoverColor = computedStyle.getPropertyValue("--avl-product-hover-color");
        const productFocusColor = computedStyle.getPropertyValue("--avl-product-focus-color");
        const colorScheme = {
            "--avl-product-color": productColor,
            "--avl-product-hover-color": productHoverColor,
            "--avl-product-focus-color": productFocusColor,
        };
        this.postMessageToChild(MessageType.colorScheme, colorScheme);
    }
    handleAction(action) {
        this.actionSubject.next(action);
    }
    handleNavigation(navigation) {
        this.navigationSubject.next(navigation);
    }
    handleLogin(login) {
        this.loginSubject.next(login);
    }
    // when child started its registration iframe is loaded and shell gets a message that he can send messages to iframe
    handleRegistration() {
        this.iframeEl = document.getElementsByTagName("iframe")[0];
        this.postThemeToChildren();
        this.postColorSchemeToChildren();
        this.postLanguageToChildren();
        this.postLocaleToChildren();
        this.registrationCompletedSubject.next(true);
    }
    onMessage(event) {
        const { payload, messageType } = event.data;
        const handlers = Object.assign(Object.assign({}, this.handlers), { default: () => console.log("Unrecognized message for the child.", event) });
        (handlers[messageType] || handlers.default)(payload);
    }
    postMessageToChild(messageType, payload) {
        var _a;
        if (!this.iframeEl) {
            return;
        }
        const message = { messageType, payload };
        (_a = this.iframeEl.contentWindow) === null || _a === void 0 ? void 0 : _a.postMessage(message, "*");
    }
};
ChildCommunicationService.ctorParameters = () => [
    { type: TranslationManagementService },
    { type: ThemeService }
];
ChildCommunicationService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ChildCommunicationService_Factory() { return new ChildCommunicationService(i0.ɵɵinject(i1.TranslationManagementService), i0.ɵɵinject(i2.ThemeService)); }, token: ChildCommunicationService, providedIn: "root" });
ChildCommunicationService = __decorate([
    Injectable({
        providedIn: "root",
    })
], ChildCommunicationService);
export { ChildCommunicationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hpbGQtY29tbXVuaWNhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGF2bC1zZXJ2aWNlcy9uZy1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9jaGlsZC1jb21tdW5pY2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDaEYsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxPQUFPLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUlMLFdBQVcsR0FHWixNQUFNLGlCQUFpQixDQUFDOzs7O0FBS3pCLElBQWEseUJBQXlCLEdBQXRDLE1BQWEseUJBQXlCO0lBbUNwQyxZQUNVLDRCQUEwRCxFQUMxRCxZQUEwQjtRQUQxQixpQ0FBNEIsR0FBNUIsNEJBQTRCLENBQThCO1FBQzFELGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBcEM1QixhQUFRLEdBQW9CO1lBQ2xDLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsR0FBVyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQztZQUMzRCxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLEdBQVcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQztZQUNyRSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQWMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUM7WUFDbkUsQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRTtTQUM3RCxDQUFD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LENBQUMsYUFBYSwwQ0FBRSxXQUFXLENBQUMsT0FBTyxFQUFFLEdBQUcsRUFBRTtJQUN6RCxDQUFDO0NBQ0YsQ0FBQTs7WUEvSnlDLDRCQUE0QjtZQUM1QyxZQUFZOzs7QUFyQ3pCLHlCQUF5QjtJQUhyQyxVQUFVLENBQUM7UUFDVixVQUFVLEVBQUUsTUFBTTtLQUNuQixDQUFDO0dBQ1cseUJBQXlCLENBbU1yQztTQW5NWSx5QkFBeUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgVHJhbnNsYXRpb25NYW5hZ2VtZW50U2VydmljZSB9IGZyb20gXCIuL3RyYW5zbGF0aW9uLW1hbmFnZW1lbnQuc2VydmljZVwiO1xyXG5pbXBvcnQgeyBUaGVtZVNlcnZpY2UgfSBmcm9tIFwiLi90aGVtZS5zZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQge1xyXG4gIENvbG9yU2NoZW1lLFxyXG4gIE1lc3NhZ2UsXHJcbiAgTWVzc2FnZUhhbmRsZXJzLFxyXG4gIE1lc3NhZ2VUeXBlLFxyXG4gIFBheWxvYWQsXHJcbiAgVXNlcixcclxufSBmcm9tIFwiLi9tZXNzYWdlLm1vZGVsXCI7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogXCJyb290XCIsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBDaGlsZENvbW11bmljYXRpb25TZXJ2aWNlIHtcclxuICBwcml2YXRlIGhhbmRsZXJzOiBNZXNzYWdlSGFuZGxlcnMgPSB7XHJcbiAgICBbTWVzc2FnZVR5cGUubG9naW5dOiAodXJsOiBzdHJpbmcpID0+IHRoaXMuaGFuZGxlTG9naW4odXJsKSxcclxuICAgIFtNZXNzYWdlVHlwZS5uYXZpZ2F0aW9uXTogKHVybDogc3RyaW5nKSA9PiB0aGlzLmhhbmRsZU5hdmlnYXRpb24odXJsKSxcclxuICAgIFtNZXNzYWdlVHlwZS5hY3Rpb25dOiAoYWN0aW9uOiBzdHJpbmcpID0+IHRoaXMuaGFuZGxlQWN0aW9uKGFjdGlvbiksXHJcbiAgICBbTWVzc2FnZVR5cGUucmVnaXN0cmF0aW9uXTogKF8pID0+IHRoaXMuaGFuZGxlUmVnaXN0cmF0aW9uKCksXHJcbiAgfTtcclxuXHJcbiAgcHJpdmF0ZSBhY3Rpb25TdWJqZWN0ID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xyXG4gIHByaXZhdGUgbmF2aWdhdGlvblN1YmplY3QgPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XHJcbiAgcHJpdmF0ZSBsb2dpblN1YmplY3QgPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XHJcbiAgcHJpdmF0ZSByZWdpc3RyYXRpb25Db21wbGV0ZWRTdWJqZWN0ID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcclxuXHJcbiAgcHJvdGVjdGVkIGlmcmFtZUVsOiBIVE1MSUZyYW1lRWxlbWVudDtcclxuXHJcbiAgcHVibGljIGFjdGlvbiQ6IE9ic2VydmFibGU8c3RyaW5nPiA9IHRoaXMuYWN0aW9uU3ViamVjdDtcclxuXHJcbiAgLyoqXHJcbiAgICogT2JzZXJ2YWJsZSB0cmFja2luZyB1cmwgdG8gbmF2aWdhdGUgdG9cclxuICAgKi9cclxuICBwdWJsaWMgbmF2aWdhdGlvbiQ6IE9ic2VydmFibGU8c3RyaW5nPiA9IHRoaXMubmF2aWdhdGlvblN1YmplY3Q7XHJcblxyXG4gIC8qKlxyXG4gICAqIE9ic2VydmFibGUgdHJhY2tpbmcgdXJsIGZvciBsb2dpblxyXG4gICAqIFVybCBmb3IgbG9naW4gcHJvdmlkZWQgYnkgY2hpbGQgYXBwbGljYXRpb25cclxuICAgKi9cclxuICBwdWJsaWMgbG9naW4kOiBPYnNlcnZhYmxlPHN0cmluZz4gPSB0aGlzLmxvZ2luU3ViamVjdDtcclxuXHJcbiAgLyoqXHJcbiAgICogT2JzZXJ2YWJsZSB0cmFja2luZyBjaGlsZCByZWdpc3RyYXRpb25cclxuICAgKiBFbWl0cyB0cnVlIGlmIHJlZ2lzdHJhdGlvbiB3YXMgc3VjY2Vzc2Z1bCwgZmFsc2Ugb3RoZXJ3aXNlXHJcbiAgICovXHJcbiAgcHVibGljIHJlZ2lzdHJhdGlvbkNvbXBsZXRlZCQ6IE9ic2VydmFibGU8Ym9vbGVhbj4gPSB0aGlzXHJcbiAgICAucmVnaXN0cmF0aW9uQ29tcGxldGVkU3ViamVjdDtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHRyYW5zbGF0aW9uTWFuYWdlbWVudFNlcnZpY2U6IFRyYW5zbGF0aW9uTWFuYWdlbWVudFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHRoZW1lU2VydmljZTogVGhlbWVTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcIm1lc3NhZ2VcIiwgKGV2ZW50KSA9PiB0aGlzLm9uTWVzc2FnZShldmVudCkpO1xyXG4gICAgdGhpcy50aGVtZVNlcnZpY2UudGhlbWVDaGFuZ2VkLnN1YnNjcmliZSgoKSA9PiB0aGlzLnBvc3RUaGVtZVRvQ2hpbGRyZW4oKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kcyBtZXNzYWdlIHRvIGNoaWxkIGFib3V0IGxvY2FsZVxyXG4gICAqL1xyXG4gIHB1YmxpYyBub3RpZnlDaGlsZEFib3V0TG9jYWxlKGNvdW50cnk6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvQ2hpbGQoTWVzc2FnZVR5cGUubG9jYWxlLCBjb3VudHJ5KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIG1lc3NhZ2UgdG8gY2hpbGQgYWJvdXQgbGFuZ3VhZ2VcclxuICAgKi9cclxuICBwdWJsaWMgbm90aWZ5Q2hpbGRBYm91dExhbmd1YWdlKGxhbmd1YWdlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb0NoaWxkKE1lc3NhZ2VUeXBlLmxhbmd1YWdlLCBsYW5ndWFnZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kcyBtZXNzYWdlIHRvIGNoaWxkIGFib3V0IGFjdGlvblxyXG4gICAqL1xyXG4gIHB1YmxpYyBub3RpZnlDaGlsZEFib3V0QWN0aW9uKGFjdGlvbjogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9DaGlsZChNZXNzYWdlVHlwZS5hY3Rpb24sIGFjdGlvbik7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kcyBtZXNzYWdlIHRvIGNoaWxkIGFib3V0IG5hdmlnYXRpb25cclxuICAgKi9cclxuICBwdWJsaWMgbm90aWZ5Q2hpbGRBYm91dE5hdmlnYXRpb24odXJsOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb0NoaWxkKE1lc3NhZ2VUeXBlLm5hdmlnYXRpb24sIHVybCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kcyBtZXNzYWdlcyB0byBjaGlsZHJlbiBhYm91dCBjdXJyZW50IHVzZXJcclxuICAgKi9cclxuICBwdWJsaWMgcG9zdEF1dGhlbnRpY2F0aW9uRGF0YVRvQ2hpbGRyZW4oKSB7XHJcbiAgICBjb25zdCBwYXlsb2FkOiBVc2VyID0ge1xyXG4gICAgICByZWZyZXNoX3Rva2VuOiBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKFwicmVmcmVzaF90b2tlblwiKSxcclxuICAgICAgYWNjZXNzX3Rva2VuOiBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKFwiYWNjZXNzX3Rva2VuXCIpLFxyXG4gICAgICBpZF90b2tlbjogc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShcImlkX3Rva2VuXCIpLFxyXG4gICAgICByZWZyZXNoX3Rva2VuX2V4cGlyZXNfYXQ6IE51bWJlcihcclxuICAgICAgICBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKFwicmVmcmVzaF90b2tlbl9leHBpcmVzX2F0XCIpXHJcbiAgICAgICksXHJcbiAgICAgIGFjY2Vzc190b2tlbl9leHBpcmVzX2F0OiBOdW1iZXIoXHJcbiAgICAgICAgc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShcImFjY2Vzc190b2tlbl9leHBpcmVzX2F0XCIpXHJcbiAgICAgICksXHJcbiAgICAgIGFjY2Vzc190b2tlbl9zdG9yZWRfYXQ6IE51bWJlcihcclxuICAgICAgICBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKFwiYWNjZXNzX3Rva2VuX3N0b3JlZF9hdFwiKVxyXG4gICAgICApLFxyXG4gICAgICB1c2VybmFtZTogc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShcInVzZXJuYW1lXCIpLFxyXG4gICAgICBuYW1lOiBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKFwibmFtZVwiKSxcclxuICAgICAgcm9sZXM6IEpTT04ucGFyc2Uoc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShcInJvbGVzXCIpKSxcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvQ2hpbGQoTWVzc2FnZVR5cGUuYXV0aGVudGljYXRpb24sIHBheWxvYWQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VuZHMgbWVzc2FnZXMgdG8gY2hpbGRyZW4gYWJvdXQgc2VsZWN0ZWQgYXBwbGljYXRpb24gdGhlbWVcclxuICAgKi9cclxuICBwdWJsaWMgcG9zdFRoZW1lVG9DaGlsZHJlbigpOiB2b2lkIHtcclxuICAgIGNvbnN0IHRoZW1lID0gdGhpcy50aGVtZVNlcnZpY2UuZ2V0Q3VycmVudFRoZW1lKCk7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9DaGlsZChNZXNzYWdlVHlwZS50aGVtZSwgdGhlbWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VuZHMgbWVzc2FnZXMgdG8gY2hpbGRyZW4gYWJvdXQgc2VsZWN0ZWQgbGFuZ3VhZ2VcclxuICAgKi9cclxuICBwdWJsaWMgcG9zdExhbmd1YWdlVG9DaGlsZHJlbigpOiB2b2lkIHtcclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb0NoaWxkKFxyXG4gICAgICBNZXNzYWdlVHlwZS5sYW5ndWFnZSxcclxuICAgICAgdGhpcy50cmFuc2xhdGlvbk1hbmFnZW1lbnRTZXJ2aWNlLmxhbmd1YWdlXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VuZHMgbWVzc2FnZXMgdG8gY2hpbGRyZW4gYWJvdXQgc2VsZWN0ZWQgY291bnRyeVxyXG4gICAqL1xyXG4gIHB1YmxpYyBwb3N0TG9jYWxlVG9DaGlsZHJlbigpOiB2b2lkIHtcclxuICAgIGNvbnN0IGNvdW50cnkgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShcImNvdW50cnlcIik7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9DaGlsZChNZXNzYWdlVHlwZS5sb2NhbGUsIGNvdW50cnkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VuZHMgbWVzc2FnZSB0byBjaGlsZCBhYm91dCByZWRpcmVjdGlvbiBmcm9tIGlkYlxyXG4gICAqL1xyXG4gIHB1YmxpYyBwb3N0UmVkaXJlY3RlZEZyb21Mb2dJbihwYXlsb2FkOiBib29sZWFuKTogdm9pZCB7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9DaGlsZChNZXNzYWdlVHlwZS5yZWRpcmVjdGVkRnJvbUxvZ0luLCBwYXlsb2FkKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIG1lc3NhZ2UgdG8gY2hpbGRyZW4gYWJvdXQgY29sb3Igc2NoZW1lXHJcbiAgICovXHJcbiAgcHVibGljIHBvc3RDb2xvclNjaGVtZVRvQ2hpbGRyZW4oKTogdm9pZCB7XHJcbiAgICBjb25zdCBjb21wdXRlZFN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZG9jdW1lbnQuYm9keSk7XHJcbiAgICBjb25zdCBwcm9kdWN0Q29sb3IgPSBjb21wdXRlZFN0eWxlLmdldFByb3BlcnR5VmFsdWUoXCItLWF2bC1wcm9kdWN0LWNvbG9yXCIpO1xyXG4gICAgY29uc3QgcHJvZHVjdEhvdmVyQ29sb3IgPSBjb21wdXRlZFN0eWxlLmdldFByb3BlcnR5VmFsdWUoXHJcbiAgICAgIFwiLS1hdmwtcHJvZHVjdC1ob3Zlci1jb2xvclwiXHJcbiAgICApO1xyXG4gICAgY29uc3QgcHJvZHVjdEZvY3VzQ29sb3IgPSBjb21wdXRlZFN0eWxlLmdldFByb3BlcnR5VmFsdWUoXHJcbiAgICAgIFwiLS1hdmwtcHJvZHVjdC1mb2N1cy1jb2xvclwiXHJcbiAgICApO1xyXG5cclxuICAgIGNvbnN0IGNvbG9yU2NoZW1lOiBDb2xvclNjaGVtZSA9IHtcclxuICAgICAgXCItLWF2bC1wcm9kdWN0LWNvbG9yXCI6IHByb2R1Y3RDb2xvcixcclxuICAgICAgXCItLWF2bC1wcm9kdWN0LWhvdmVyLWNvbG9yXCI6IHByb2R1Y3RIb3ZlckNvbG9yLFxyXG4gICAgICBcIi0tYXZsLXByb2R1Y3QtZm9jdXMtY29sb3JcIjogcHJvZHVjdEZvY3VzQ29sb3IsXHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb0NoaWxkKE1lc3NhZ2VUeXBlLmNvbG9yU2NoZW1lLCBjb2xvclNjaGVtZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUFjdGlvbihhY3Rpb246IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5hY3Rpb25TdWJqZWN0Lm5leHQoYWN0aW9uKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlTmF2aWdhdGlvbihuYXZpZ2F0aW9uOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMubmF2aWdhdGlvblN1YmplY3QubmV4dChuYXZpZ2F0aW9uKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlTG9naW4obG9naW46IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5sb2dpblN1YmplY3QubmV4dChsb2dpbik7XHJcbiAgfVxyXG5cclxuICAvLyB3aGVuIGNoaWxkIHN0YXJ0ZWQgaXRzIHJlZ2lzdHJhdGlvbiBpZnJhbWUgaXMgbG9hZGVkIGFuZCBzaGVsbCBnZXRzIGEgbWVzc2FnZSB0aGF0IGhlIGNhbiBzZW5kIG1lc3NhZ2VzIHRvIGlmcmFtZVxyXG4gIHByaXZhdGUgaGFuZGxlUmVnaXN0cmF0aW9uKCk6IHZvaWQge1xyXG4gICAgdGhpcy5pZnJhbWVFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFxyXG4gICAgICBcImlmcmFtZVwiXHJcbiAgICApWzBdIGFzIEhUTUxJRnJhbWVFbGVtZW50O1xyXG5cclxuICAgIHRoaXMucG9zdFRoZW1lVG9DaGlsZHJlbigpO1xyXG4gICAgdGhpcy5wb3N0Q29sb3JTY2hlbWVUb0NoaWxkcmVuKCk7XHJcbiAgICB0aGlzLnBvc3RMYW5ndWFnZVRvQ2hpbGRyZW4oKTtcclxuICAgIHRoaXMucG9zdExvY2FsZVRvQ2hpbGRyZW4oKTtcclxuXHJcbiAgICB0aGlzLnJlZ2lzdHJhdGlvbkNvbXBsZXRlZFN1YmplY3QubmV4dCh0cnVlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgb25NZXNzYWdlKGV2ZW50OiBNZXNzYWdlRXZlbnQpOiB2b2lkIHtcclxuICAgIGNvbnN0IHsgcGF5bG9hZCwgbWVzc2FnZVR5cGUgfTogTWVzc2FnZSA9IGV2ZW50LmRhdGE7XHJcbiAgICBjb25zdCBoYW5kbGVycyA9IHtcclxuICAgICAgLi4udGhpcy5oYW5kbGVycyxcclxuICAgICAgZGVmYXVsdDogKCkgPT4gY29uc29sZS5sb2coXCJVbnJlY29nbml6ZWQgbWVzc2FnZSBmb3IgdGhlIGNoaWxkLlwiLCBldmVudCksXHJcbiAgICB9O1xyXG5cclxuICAgIChoYW5kbGVyc1ttZXNzYWdlVHlwZV0gfHwgaGFuZGxlcnMuZGVmYXVsdCkocGF5bG9hZCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBvc3RNZXNzYWdlVG9DaGlsZChtZXNzYWdlVHlwZTogTWVzc2FnZVR5cGUsIHBheWxvYWQ6IFBheWxvYWQpOiB2b2lkIHtcclxuICAgIGlmICghdGhpcy5pZnJhbWVFbCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbWVzc2FnZTogTWVzc2FnZSA9IHsgbWVzc2FnZVR5cGUsIHBheWxvYWQgfTtcclxuICAgIHRoaXMuaWZyYW1lRWwuY29udGVudFdpbmRvdz8ucG9zdE1lc3NhZ2UobWVzc2FnZSwgXCIqXCIpO1xyXG4gIH1cclxufVxyXG4iXX0=