import { __decorate } from "tslib";
import { Injectable } from "@angular/core";
import { TranslationManagementService } from "./translation-management.service";
import { ThemeService } from "./theme.service";
import { Subject } from "rxjs";
import { MessageType, } from "./message.model";
import { AvlAuthService, User } from '@avl-ng-controls/auth';
import * as i0 from "@angular/core";
import * as i1 from "./translation-management.service";
import * as i2 from "./theme.service";
import * as i3 from "@avl-ng-controls/auth";
let ChildCommunicationService = class ChildCommunicationService {
    constructor(translationManagementService, themeService, authService) {
        this.translationManagementService = translationManagementService;
        this.themeService = themeService;
        this.authService = authService;
        this.handlers = {
            [MessageType.login]: (url) => this.handleLogin(url),
            [MessageType.navigation]: (url) => this.handleNavigation(url),
            [MessageType.action]: (action) => this.handleAction(action),
            [MessageType.registration]: (_) => this.handleRegistration(),
            [MessageType.user]: (user) => this.handleUser(user),
        };
        this.actionSubject = new Subject();
        this.navigationSubject = new Subject();
        this.loginSubject = new Subject();
        this.registrationCompletedSubject = new Subject();
        this.action$ = this.actionSubject;
        /**
         * Observable tracking url to navigate to
         */
        this.navigation$ = this.navigationSubject;
        /**
         * Observable tracking url for login
         * Url for login provided by child application
         */
        this.login$ = this.loginSubject;
        /**
         * Observable tracking child registration
         * Emits true if registration was successful, false otherwise
         */
        this.registrationCompleted$ = this
            .registrationCompletedSubject;
        window.addEventListener("message", (event) => this.onMessage(event));
        this.themeService.themeChanged.subscribe(() => this.postThemeToChildren());
    }
    /**
     * Sends message to child about locale
     */
    notifyChildAboutLocale(country) {
        this.postMessageToChild(MessageType.locale, country);
    }
    /**
     * Sends message to child about language
     */
    notifyChildAboutLanguage(language) {
        this.postMessageToChild(MessageType.language, language);
    }
    /**
     * Sends message to child about action
     */
    notifyChildAboutAction(action) {
        this.postMessageToChild(MessageType.action, action);
    }
    /**
     * Sends message to child about navigation
     */
    notifyChildAboutNavigation(url) {
        this.postMessageToChild(MessageType.navigation, url);
    }
    /**
     * Sends messages to children about current user
     */
    postAuthenticationDataToChildren() {
        const payload = this.authService.readUserFromSessionStorage();
        this.postMessageToChild(MessageType.authentication, payload);
    }
    /**
     * Sends messages to children about selected application theme
     */
    postThemeToChildren() {
        const theme = this.themeService.getCurrentTheme();
        this.postMessageToChild(MessageType.theme, theme);
    }
    /**
     * Sends messages to children about selected language
     */
    postLanguageToChildren() {
        this.postMessageToChild(MessageType.language, this.translationManagementService.language);
    }
    /**
     * Sends messages to children about selected country
     */
    postLocaleToChildren() {
        const country = localStorage.getItem("country");
        this.postMessageToChild(MessageType.locale, country);
    }
    /**
     * Sends message to child about redirection from idb
     */
    postRedirectedFromLogIn(payload) {
        this.postMessageToChild(MessageType.redirectedFromLogIn, payload);
    }
    /**
     * Sends message to children about color scheme
     */
    postColorSchemeToChildren() {
        const computedStyle = window.getComputedStyle(document.body);
        const productColor = computedStyle.getPropertyValue("--avl-product-color");
        const productHoverColor = computedStyle.getPropertyValue("--avl-product-hover-color");
        const productFocusColor = computedStyle.getPropertyValue("--avl-product-focus-color");
        const colorScheme = {
            "--avl-product-color": productColor,
            "--avl-product-hover-color": productHoverColor,
            "--avl-product-focus-color": productFocusColor,
        };
        this.postMessageToChild(MessageType.colorScheme, colorScheme);
    }
    handleAction(action) {
        this.actionSubject.next(action);
    }
    handleNavigation(navigation) {
        this.navigationSubject.next(navigation);
    }
    handleLogin(login) {
        this.loginSubject.next(login);
    }
    // when child started its registration iframe is loaded and shell gets a message that he can send messages to iframe
    handleRegistration() {
        this.iframeEl = document.getElementsByTagName("iframe")[0];
        this.postThemeToChildren();
        this.postColorSchemeToChildren();
        this.postLanguageToChildren();
        this.postLocaleToChildren();
        this.registrationCompletedSubject.next(true);
    }
    onMessage(event) {
        const { payload, messageType } = event.data;
        const handlers = Object.assign(Object.assign({}, this.handlers), { default: () => console.log("Unrecognized message for the child.", event) });
        (handlers[messageType] || handlers.default)(payload);
    }
    postMessageToChild(messageType, payload) {
        var _a;
        if (!this.iframeEl) {
            return;
        }
        const message = { messageType, payload };
        (_a = this.iframeEl.contentWindow) === null || _a === void 0 ? void 0 : _a.postMessage(message, "*");
    }
    // when child updates user data, it has to reflect in user data in shell
    handleUser(user) {
        if (user === null || user === void 0 ? void 0 : user.access_token) {
            this.authService.storeUserToSessionStorage(user);
        }
        else {
            this.authService.clearUserFromSessionStorage();
        }
        this.authService.reloadPersistedUserData();
    }
};
ChildCommunicationService.ctorParameters = () => [
    { type: TranslationManagementService },
    { type: ThemeService },
    { type: AvlAuthService }
];
ChildCommunicationService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ChildCommunicationService_Factory() { return new ChildCommunicationService(i0.ɵɵinject(i1.TranslationManagementService), i0.ɵɵinject(i2.ThemeService), i0.ɵɵinject(i3.AvlAuthService)); }, token: ChildCommunicationService, providedIn: "root" });
ChildCommunicationService = __decorate([
    Injectable({
        providedIn: "root",
    })
], ChildCommunicationService);
export { ChildCommunicationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hpbGQtY29tbXVuaWNhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGF2bC1zZXJ2aWNlcy9uZy1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9jaGlsZC1jb21tdW5pY2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDaEYsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxPQUFPLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUlMLFdBQVcsR0FFWixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7Ozs7O0FBSzdELElBQWEseUJBQXlCLEdBQXRDLE1BQWEseUJBQXlCO0lBb0NwQyxZQUNVLDRCQUEwRCxFQUMxRCxZQUEwQixFQUMxQixXQUEyQjtRQUYzQixpQ0FBNEIsR0FBNUIsNEJBQTRCLENBQThCO1FBQzFELGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGdCQUFXLEdBQVgsV0FBVyxDQUFnQjtRQXRDN0IsYUFBUSxHQUFvQjtZQUNsQyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEdBQVcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUM7WUFDM0QsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxHQUFXLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUM7WUFDckUsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFjLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFD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RUFBRSxDQUFDO0lBQzdDLENBQUM7Q0FDRixDQUFBOztZQTFKeUMsNEJBQTRCO1lBQzVDLFlBQVk7WUFDYixjQUFjOzs7QUF2QzFCLHlCQUF5QjtJQUhyQyxVQUFVLENBQUM7UUFDVixVQUFVLEVBQUUsTUFBTTtLQUNuQixDQUFDO0dBQ1cseUJBQXlCLENBK0xyQztTQS9MWSx5QkFBeUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgVHJhbnNsYXRpb25NYW5hZ2VtZW50U2VydmljZSB9IGZyb20gXCIuL3RyYW5zbGF0aW9uLW1hbmFnZW1lbnQuc2VydmljZVwiO1xyXG5pbXBvcnQgeyBUaGVtZVNlcnZpY2UgfSBmcm9tIFwiLi90aGVtZS5zZXJ2aWNlXCI7XHJcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQge1xyXG4gIENvbG9yU2NoZW1lLFxyXG4gIE1lc3NhZ2UsXHJcbiAgTWVzc2FnZUhhbmRsZXJzLFxyXG4gIE1lc3NhZ2VUeXBlLFxyXG4gIFBheWxvYWQsXHJcbn0gZnJvbSBcIi4vbWVzc2FnZS5tb2RlbFwiO1xyXG5pbXBvcnQgeyBBdmxBdXRoU2VydmljZSwgVXNlciB9IGZyb20gJ0BhdmwtbmctY29udHJvbHMvYXV0aCc7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogXCJyb290XCIsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBDaGlsZENvbW11bmljYXRpb25TZXJ2aWNlIHtcclxuICBwcml2YXRlIGhhbmRsZXJzOiBNZXNzYWdlSGFuZGxlcnMgPSB7XHJcbiAgICBbTWVzc2FnZVR5cGUubG9naW5dOiAodXJsOiBzdHJpbmcpID0+IHRoaXMuaGFuZGxlTG9naW4odXJsKSxcclxuICAgIFtNZXNzYWdlVHlwZS5uYXZpZ2F0aW9uXTogKHVybDogc3RyaW5nKSA9PiB0aGlzLmhhbmRsZU5hdmlnYXRpb24odXJsKSxcclxuICAgIFtNZXNzYWdlVHlwZS5hY3Rpb25dOiAoYWN0aW9uOiBzdHJpbmcpID0+IHRoaXMuaGFuZGxlQWN0aW9uKGFjdGlvbiksXHJcbiAgICBbTWVzc2FnZVR5cGUucmVnaXN0cmF0aW9uXTogKF8pID0+IHRoaXMuaGFuZGxlUmVnaXN0cmF0aW9uKCksXHJcbiAgICBbTWVzc2FnZVR5cGUudXNlcl06ICh1c2VyOiBVc2VyKSA9PiB0aGlzLmhhbmRsZVVzZXIodXNlciksXHJcbiAgfTtcclxuXHJcbiAgcHJpdmF0ZSBhY3Rpb25TdWJqZWN0ID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xyXG4gIHByaXZhdGUgbmF2aWdhdGlvblN1YmplY3QgPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XHJcbiAgcHJpdmF0ZSBsb2dpblN1YmplY3QgPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XHJcbiAgcHJpdmF0ZSByZWdpc3RyYXRpb25Db21wbGV0ZWRTdWJqZWN0ID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcclxuXHJcbiAgcHJvdGVjdGVkIGlmcmFtZUVsOiBIVE1MSUZyYW1lRWxlbWVudDtcclxuXHJcbiAgcHVibGljIGFjdGlvbiQ6IE9ic2VydmFibGU8c3RyaW5nPiA9IHRoaXMuYWN0aW9uU3ViamVjdDtcclxuXHJcbiAgLyoqXHJcbiAgICogT2JzZXJ2YWJsZSB0cmFja2luZyB1cmwgdG8gbmF2aWdhdGUgdG9cclxuICAgKi9cclxuICBwdWJsaWMgbmF2aWdhdGlvbiQ6IE9ic2VydmFibGU8c3RyaW5nPiA9IHRoaXMubmF2aWdhdGlvblN1YmplY3Q7XHJcblxyXG4gIC8qKlxyXG4gICAqIE9ic2VydmFibGUgdHJhY2tpbmcgdXJsIGZvciBsb2dpblxyXG4gICAqIFVybCBmb3IgbG9naW4gcHJvdmlkZWQgYnkgY2hpbGQgYXBwbGljYXRpb25cclxuICAgKi9cclxuICBwdWJsaWMgbG9naW4kOiBPYnNlcnZhYmxlPHN0cmluZz4gPSB0aGlzLmxvZ2luU3ViamVjdDtcclxuXHJcbiAgLyoqXHJcbiAgICogT2JzZXJ2YWJsZSB0cmFja2luZyBjaGlsZCByZWdpc3RyYXRpb25cclxuICAgKiBFbWl0cyB0cnVlIGlmIHJlZ2lzdHJhdGlvbiB3YXMgc3VjY2Vzc2Z1bCwgZmFsc2Ugb3RoZXJ3aXNlXHJcbiAgICovXHJcbiAgcHVibGljIHJlZ2lzdHJhdGlvbkNvbXBsZXRlZCQ6IE9ic2VydmFibGU8Ym9vbGVhbj4gPSB0aGlzXHJcbiAgICAucmVnaXN0cmF0aW9uQ29tcGxldGVkU3ViamVjdDtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHRyYW5zbGF0aW9uTWFuYWdlbWVudFNlcnZpY2U6IFRyYW5zbGF0aW9uTWFuYWdlbWVudFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHRoZW1lU2VydmljZTogVGhlbWVTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBhdXRoU2VydmljZTogQXZsQXV0aFNlcnZpY2VcclxuICApIHtcclxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibWVzc2FnZVwiLCAoZXZlbnQpID0+IHRoaXMub25NZXNzYWdlKGV2ZW50KSk7XHJcbiAgICB0aGlzLnRoZW1lU2VydmljZS50aGVtZUNoYW5nZWQuc3Vic2NyaWJlKCgpID0+IHRoaXMucG9zdFRoZW1lVG9DaGlsZHJlbigpKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIG1lc3NhZ2UgdG8gY2hpbGQgYWJvdXQgbG9jYWxlXHJcbiAgICovXHJcbiAgcHVibGljIG5vdGlmeUNoaWxkQWJvdXRMb2NhbGUoY291bnRyeTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9DaGlsZChNZXNzYWdlVHlwZS5sb2NhbGUsIGNvdW50cnkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VuZHMgbWVzc2FnZSB0byBjaGlsZCBhYm91dCBsYW5ndWFnZVxyXG4gICAqL1xyXG4gIHB1YmxpYyBub3RpZnlDaGlsZEFib3V0TGFuZ3VhZ2UobGFuZ3VhZ2U6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvQ2hpbGQoTWVzc2FnZVR5cGUubGFuZ3VhZ2UsIGxhbmd1YWdlKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIG1lc3NhZ2UgdG8gY2hpbGQgYWJvdXQgYWN0aW9uXHJcbiAgICovXHJcbiAgcHVibGljIG5vdGlmeUNoaWxkQWJvdXRBY3Rpb24oYWN0aW9uOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb0NoaWxkKE1lc3NhZ2VUeXBlLmFjdGlvbiwgYWN0aW9uKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIG1lc3NhZ2UgdG8gY2hpbGQgYWJvdXQgbmF2aWdhdGlvblxyXG4gICAqL1xyXG4gIHB1YmxpYyBub3RpZnlDaGlsZEFib3V0TmF2aWdhdGlvbih1cmw6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvQ2hpbGQoTWVzc2FnZVR5cGUubmF2aWdhdGlvbiwgdXJsKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIG1lc3NhZ2VzIHRvIGNoaWxkcmVuIGFib3V0IGN1cnJlbnQgdXNlclxyXG4gICAqL1xyXG4gIHB1YmxpYyBwb3N0QXV0aGVudGljYXRpb25EYXRhVG9DaGlsZHJlbigpIHtcclxuICAgIGNvbnN0IHBheWxvYWQ6IFVzZXIgPSB0aGlzLmF1dGhTZXJ2aWNlLnJlYWRVc2VyRnJvbVNlc3Npb25TdG9yYWdlKCk7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9DaGlsZChNZXNzYWdlVHlwZS5hdXRoZW50aWNhdGlvbiwgcGF5bG9hZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kcyBtZXNzYWdlcyB0byBjaGlsZHJlbiBhYm91dCBzZWxlY3RlZCBhcHBsaWNhdGlvbiB0aGVtZVxyXG4gICAqL1xyXG4gIHB1YmxpYyBwb3N0VGhlbWVUb0NoaWxkcmVuKCk6IHZvaWQge1xyXG4gICAgY29uc3QgdGhlbWUgPSB0aGlzLnRoZW1lU2VydmljZS5nZXRDdXJyZW50VGhlbWUoKTtcclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb0NoaWxkKE1lc3NhZ2VUeXBlLnRoZW1lLCB0aGVtZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kcyBtZXNzYWdlcyB0byBjaGlsZHJlbiBhYm91dCBzZWxlY3RlZCBsYW5ndWFnZVxyXG4gICAqL1xyXG4gIHB1YmxpYyBwb3N0TGFuZ3VhZ2VUb0NoaWxkcmVuKCk6IHZvaWQge1xyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvQ2hpbGQoXHJcbiAgICAgIE1lc3NhZ2VUeXBlLmxhbmd1YWdlLFxyXG4gICAgICB0aGlzLnRyYW5zbGF0aW9uTWFuYWdlbWVudFNlcnZpY2UubGFuZ3VhZ2VcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kcyBtZXNzYWdlcyB0byBjaGlsZHJlbiBhYm91dCBzZWxlY3RlZCBjb3VudHJ5XHJcbiAgICovXHJcbiAgcHVibGljIHBvc3RMb2NhbGVUb0NoaWxkcmVuKCk6IHZvaWQge1xyXG4gICAgY29uc3QgY291bnRyeSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFwiY291bnRyeVwiKTtcclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb0NoaWxkKE1lc3NhZ2VUeXBlLmxvY2FsZSwgY291bnRyeSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kcyBtZXNzYWdlIHRvIGNoaWxkIGFib3V0IHJlZGlyZWN0aW9uIGZyb20gaWRiXHJcbiAgICovXHJcbiAgcHVibGljIHBvc3RSZWRpcmVjdGVkRnJvbUxvZ0luKHBheWxvYWQ6IGJvb2xlYW4pOiB2b2lkIHtcclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb0NoaWxkKE1lc3NhZ2VUeXBlLnJlZGlyZWN0ZWRGcm9tTG9nSW4sIHBheWxvYWQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2VuZHMgbWVzc2FnZSB0byBjaGlsZHJlbiBhYm91dCBjb2xvciBzY2hlbWVcclxuICAgKi9cclxuICBwdWJsaWMgcG9zdENvbG9yU2NoZW1lVG9DaGlsZHJlbigpOiB2b2lkIHtcclxuICAgIGNvbnN0IGNvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShkb2N1bWVudC5ib2R5KTtcclxuICAgIGNvbnN0IHByb2R1Y3RDb2xvciA9IGNvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZShcIi0tYXZsLXByb2R1Y3QtY29sb3JcIik7XHJcbiAgICBjb25zdCBwcm9kdWN0SG92ZXJDb2xvciA9IGNvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZShcclxuICAgICAgXCItLWF2bC1wcm9kdWN0LWhvdmVyLWNvbG9yXCJcclxuICAgICk7XHJcbiAgICBjb25zdCBwcm9kdWN0Rm9jdXNDb2xvciA9IGNvbXB1dGVkU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZShcclxuICAgICAgXCItLWF2bC1wcm9kdWN0LWZvY3VzLWNvbG9yXCJcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgY29sb3JTY2hlbWU6IENvbG9yU2NoZW1lID0ge1xyXG4gICAgICBcIi0tYXZsLXByb2R1Y3QtY29sb3JcIjogcHJvZHVjdENvbG9yLFxyXG4gICAgICBcIi0tYXZsLXByb2R1Y3QtaG92ZXItY29sb3JcIjogcHJvZHVjdEhvdmVyQ29sb3IsXHJcbiAgICAgIFwiLS1hdmwtcHJvZHVjdC1mb2N1cy1jb2xvclwiOiBwcm9kdWN0Rm9jdXNDb2xvcixcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvQ2hpbGQoTWVzc2FnZVR5cGUuY29sb3JTY2hlbWUsIGNvbG9yU2NoZW1lKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlQWN0aW9uKGFjdGlvbjogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLmFjdGlvblN1YmplY3QubmV4dChhY3Rpb24pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVOYXZpZ2F0aW9uKG5hdmlnYXRpb246IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5uYXZpZ2F0aW9uU3ViamVjdC5uZXh0KG5hdmlnYXRpb24pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVMb2dpbihsb2dpbjogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLmxvZ2luU3ViamVjdC5uZXh0KGxvZ2luKTtcclxuICB9XHJcblxyXG4gIC8vIHdoZW4gY2hpbGQgc3RhcnRlZCBpdHMgcmVnaXN0cmF0aW9uIGlmcmFtZSBpcyBsb2FkZWQgYW5kIHNoZWxsIGdldHMgYSBtZXNzYWdlIHRoYXQgaGUgY2FuIHNlbmQgbWVzc2FnZXMgdG8gaWZyYW1lXHJcbiAgcHJpdmF0ZSBoYW5kbGVSZWdpc3RyYXRpb24oKTogdm9pZCB7XHJcbiAgICB0aGlzLmlmcmFtZUVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXHJcbiAgICAgIFwiaWZyYW1lXCJcclxuICAgIClbMF0gYXMgSFRNTElGcmFtZUVsZW1lbnQ7XHJcblxyXG4gICAgdGhpcy5wb3N0VGhlbWVUb0NoaWxkcmVuKCk7XHJcbiAgICB0aGlzLnBvc3RDb2xvclNjaGVtZVRvQ2hpbGRyZW4oKTtcclxuICAgIHRoaXMucG9zdExhbmd1YWdlVG9DaGlsZHJlbigpO1xyXG4gICAgdGhpcy5wb3N0TG9jYWxlVG9DaGlsZHJlbigpO1xyXG5cclxuICAgIHRoaXMucmVnaXN0cmF0aW9uQ29tcGxldGVkU3ViamVjdC5uZXh0KHRydWUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvbk1lc3NhZ2UoZXZlbnQ6IE1lc3NhZ2VFdmVudCk6IHZvaWQge1xyXG4gICAgY29uc3QgeyBwYXlsb2FkLCBtZXNzYWdlVHlwZSB9OiBNZXNzYWdlID0gZXZlbnQuZGF0YTtcclxuICAgIGNvbnN0IGhhbmRsZXJzID0ge1xyXG4gICAgICAuLi50aGlzLmhhbmRsZXJzLFxyXG4gICAgICBkZWZhdWx0OiAoKSA9PiBjb25zb2xlLmxvZyhcIlVucmVjb2duaXplZCBtZXNzYWdlIGZvciB0aGUgY2hpbGQuXCIsIGV2ZW50KSxcclxuICAgIH07XHJcblxyXG4gICAgKGhhbmRsZXJzW21lc3NhZ2VUeXBlXSB8fCBoYW5kbGVycy5kZWZhdWx0KShwYXlsb2FkKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcG9zdE1lc3NhZ2VUb0NoaWxkKG1lc3NhZ2VUeXBlOiBNZXNzYWdlVHlwZSwgcGF5bG9hZDogUGF5bG9hZCk6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLmlmcmFtZUVsKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBtZXNzYWdlOiBNZXNzYWdlID0geyBtZXNzYWdlVHlwZSwgcGF5bG9hZCB9O1xyXG4gICAgdGhpcy5pZnJhbWVFbC5jb250ZW50V2luZG93Py5wb3N0TWVzc2FnZShtZXNzYWdlLCBcIipcIik7XHJcbiAgfVxyXG5cclxuICAvLyB3aGVuIGNoaWxkIHVwZGF0ZXMgdXNlciBkYXRhLCBpdCBoYXMgdG8gcmVmbGVjdCBpbiB1c2VyIGRhdGEgaW4gc2hlbGxcclxuICBwcml2YXRlIGhhbmRsZVVzZXIodXNlcjogVXNlcikge1xyXG4gICAgaWYgKHVzZXI/LmFjY2Vzc190b2tlbikge1xyXG4gICAgICB0aGlzLmF1dGhTZXJ2aWNlLnN0b3JlVXNlclRvU2Vzc2lvblN0b3JhZ2UodXNlcik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmF1dGhTZXJ2aWNlLmNsZWFyVXNlckZyb21TZXNzaW9uU3RvcmFnZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuYXV0aFNlcnZpY2UucmVsb2FkUGVyc2lzdGVkVXNlckRhdGEoKTtcclxuICB9XHJcbn1cclxuIl19