import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { Subject, BehaviorSubject } from 'rxjs';
import { v4 as uuidv4 } from 'uuid';
import { MessageType } from './message.model';
import { AvlAuthService, User } from '@avl-ng-controls/auth';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "@avl-ng-controls/auth";
let ShellCommunicationService = class ShellCommunicationService {
    constructor(router, authService) {
        this.router = router;
        this.authService = authService;
        this.handlers = {
            [MessageType.theme]: (theme) => this.handleTheme(theme),
            [MessageType.locale]: (locale) => this.handleLocale(locale),
            [MessageType.language]: (language) => this.handleLanguage(language),
            [MessageType.colorScheme]: (colorScheme) => this.handleColorScheme(colorScheme),
            [MessageType.navigation]: (url) => this.handleNavigation(url),
            [MessageType.action]: (action) => this.handleAction(action),
            [MessageType.authentication]: (user) => this.handleAuthentication(user),
            [MessageType.redirectedFromLogIn]: (redirected) => this.handleRedirectedFromLogIn(redirected),
        };
        this.themeSubject = new Subject();
        this.languageSubject = new Subject();
        this.actionSubject = new Subject();
        this.localeSubject = new Subject();
        this.colorSchemeSubject = new Subject();
        /**
        * Observable tracking theme
        * Emits "dark" if dark theme selected, "light" otherwise
        */
        this.theme$ = this.themeSubject;
        /**
        * Observable tracking language
        */
        this.language$ = this.languageSubject;
        this.action$ = this.actionSubject;
        /**
        * Observable tracking country changes
        */
        this.locale$ = this.localeSubject;
        /**
        * Observable tracking color scheme changes
        */
        this.colorScheme$ = this.colorSchemeSubject;
        /**
         * Observable tracking if redirected from idb
         * Resolves to true on redirection, false otherwise
         */
        this.redirectedFromLogIn = new BehaviorSubject(undefined);
        /**
         * If current application is inside shell application
         * True if current application is inside shell application, false otherwise.
         */
        this.isChild = window.location !== window.parent.location;
        window.addEventListener('message', (event) => this.onMessage(event));
        this.id = uuidv4();
    }
    notifyShellAboutAction(action) {
        this.postMessageToShell(MessageType.action, action);
    }
    /**
     * Sends message to shell that it needs to navigate to login page
     */
    notifyShellAboutLogin(url) {
        this.postMessageToShell(MessageType.login, url);
    }
    /**
     * Sends message to shell that it needs to navigate to @url
     */
    notifyShellAboutNavigation(url) {
        this.postMessageToShell(MessageType.navigation, url);
    }
    /**
     * Sends registration message to shell
     */
    registerToShell() {
        this.postMessageToShell(MessageType.registration, this.id);
    }
    /**
    * Send updated user data to shell
    */
    updateUserToShell() {
        const user = this.authService.readUserFromSessionStorage();
        this.postMessageToShell(MessageType.user, user);
    }
    onMessage(event) {
        const { payload, messageType } = event.data;
        const handlers = Object.assign(Object.assign({}, this.handlers), { default: () => console.log('Unrecognized message for the shell.', event) });
        (handlers[messageType] || handlers.default)(payload);
    }
    postMessageToShell(messageType, payload) {
        const message = { messageType, payload };
        window.parent.window.postMessage(message, '*');
    }
    handleColorScheme(colorScheme) {
        this.colorSchemeSubject.next(colorScheme);
    }
    handleLanguage(language) {
        this.languageSubject.next(language);
    }
    handleLocale(locale) {
        this.localeSubject.next(locale);
    }
    handleTheme(theme) {
        this.themeSubject.next(theme);
    }
    handleNavigation(url) {
        this.router.navigateByUrl(url);
    }
    handleAction(action) {
        this.actionSubject.next(action);
    }
    handleAuthentication(user) {
        if (user === null || user === void 0 ? void 0 : user.access_token) {
            this.authService.storeUserToSessionStorage(user);
        }
        else {
            this.authService.clearUserFromSessionStorage();
        }
        this.authService.reloadPersistedUserData();
    }
    handleRedirectedFromLogIn(redirected) {
        this.redirectedFromLogIn.next(redirected);
    }
};
ShellCommunicationService.ctorParameters = () => [
    { type: Router },
    { type: AvlAuthService }
];
ShellCommunicationService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ShellCommunicationService_Factory() { return new ShellCommunicationService(i0.ɵɵinject(i1.Router), i0.ɵɵinject(i2.AvlAuthService)); }, token: ShellCommunicationService, providedIn: "root" });
ShellCommunicationService = __decorate([
    Injectable({
        providedIn: 'root'
    })
], ShellCommunicationService);
export { ShellCommunicationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hlbGwtY29tbXVuaWNhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGF2bC1zZXJ2aWNlcy9uZy1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9zaGVsbC1jb21tdW5pY2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxPQUFPLEVBQWMsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVELE9BQU8sRUFBRSxFQUFFLElBQUksTUFBTSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3BDLE9BQU8sRUFBeUMsV0FBVyxFQUFXLE1BQU0saUJBQWlCLENBQUM7QUFDOUYsT0FBTyxFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQzs7OztBQUs3RCxJQUFhLHlCQUF5QixHQUF0QyxNQUFhLHlCQUF5QjtJQTREcEMsWUFBb0IsTUFBYyxFQUFVLFdBQTJCO1FBQW5ELFdBQU0sR0FBTixNQUFNLENBQVE7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBZ0I7UUF6RC9ELGFBQVEsR0FBb0I7WUFDbEMsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFhLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDO1lBQy9ELENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBYyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQztZQUNuRSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLFFBQWdCLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDO1lBQzNFLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsV0FBd0IsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQztZQUM1RixDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLEdBQVcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQztZQUNyRSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQWMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUM7WUFDbkUsQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxJQUFVLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUM7WUFDN0UsQ0FBQyxXQUFXLENBQUMsbUJBQW1CLENBQUMsRUFBRSxDQUFDLFVBQW1CLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxVQUFVLENBQUM7U0FDdkcsQ0FBQztRQUVNLGlCQUFZLEdBQUcsSUFBSSxPQUFPLEVBQVUsQ0FBQztRQUNyQyxvQkFBZSxHQUFHLElBQUksT0FBTyxFQUFVLENBQUM7UUFDeEMsa0JBQWEsR0FBRyxJQUFJLE9BQU8sRUFBVSxDQUFDO1FBQ3RDLGtCQUFhLEdBQUcsSUFBSSxPQUFPLEVBQVUsQ0FBQztRQUN0Qyx1QkFBa0IsR0FBRyxJQUFJLE9BQU8sRUFBZSxDQUFDO1FBRXhEOzs7VUFHRTtRQUNLLFdBQU0sR0FBdUIsSUFBSSxDQUFDLFlBQVksQ0FBQztRQUV0RDs7VUFFRTtRQUNLLGNBQVMsR0FBdUIsSUFBSSxDQUFDLGVBQWUsQ0FBQztRQUNyRCxZQUFPLEdBQXVCLElBQUksQ0FBQyxhQUFhLENBQUM7UUFFeEQ7O1VBRUU7UUFDSyxZQUFPLEdBQXVCLElBQUksQ0FBQyxhQUFhLENBQUM7UUFFeEQ7O1VBRUU7UUFDSyxpQkFBWSxHQUE0QixJQUFJLENBQUMsa0JBQWtCLENBQUM7UUFRdkU7OztXQUdHO1FBQ0ksd0JBQW1CLEdBQUcsSUFBSSxlQUFlLENBQVUsU0FBUyxDQUFDLENBQUM7UUFFckU7OztXQUdHO1FBQ0ksWUFBTyxHQUFHLE1BQU0sQ0FBQyxRQUFRLEtBQUssTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFHMUQsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBRXJFLElBQUksQ0FBQyxFQUFFLEdBQUcsTUFBTSxFQUFFLENBQUM7SUFDckIsQ0FBQztJQUVNLHNCQUFzQixDQUFDLE1BQWM7UUFDMUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVEOztPQUVHO0lBQ0kscUJBQXFCLENBQUMsR0FBVztRQUN0QyxJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRUQ7O09BRUc7SUFDSSwwQkFBMEIsQ0FBQyxHQUFXO1FBQzNDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFRDs7T0FFRztJQUNJLGVBQWU7UUFDcEIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFRDs7TUFFRTtJQUNLLGlCQUFpQjtRQUN0QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLDBCQUEwQixFQUFFLENBQUM7UUFDM0QsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVPLFNBQVMsQ0FBQyxLQUFtQjtRQUNuQyxNQUFNLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxHQUFZLEtBQUssQ0FBQyxJQUFJLENBQUM7UUFDckQsTUFBTSxRQUFRLG1DQUNULElBQUksQ0FBQyxRQUFRLEtBQ2hCLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLHFDQUFxQyxFQUFFLEtBQUssQ0FBQyxHQUN6RSxDQUFDO1FBRUYsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFTyxrQkFBa0IsQ0FBQyxXQUF3QixFQUFFLE9BQWdCO1FBQ25FLE1BQU0sT0FBTyxHQUFZLEVBQUUsV0FBVyxFQUFFLE9BQU8sRUFBRSxDQUFDO1FBQ2xELE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVPLGlCQUFpQixDQUFDLFdBQXdCO1FBQ2hELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVPLGNBQWMsQ0FBQyxRQUFnQjtRQUNyQyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN0QyxDQUFDO0lBRU8sWUFBWSxDQUFDLE1BQWM7UUFDakMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVPLFdBQVcsQ0FBQyxLQUFhO1FBQy9CLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxHQUFXO1FBQ2xDLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFTyxZQUFZLENBQUMsTUFBYztRQUNqQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRU8sb0JBQW9CLENBQUMsSUFBVTtRQUNyQyxJQUFJLElBQUksYUFBSixJQUFJLHVCQUFKLElBQUksQ0FBRSxZQUFZLEVBQUU7WUFDdEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNsRDthQUFNO1lBQ0wsSUFBSSxDQUFDLFdBQVcsQ0FBQywyQkFBMkIsRUFBRSxDQUFDO1NBQ2hEO1FBRUQsSUFBSSxDQUFDLFdBQVcsQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO0lBQzdDLENBQUM7SUFFTyx5QkFBeUIsQ0FBQyxVQUFtQjtRQUNuRCxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzVDLENBQUM7Q0FDRixDQUFBOztZQTNGNkIsTUFBTTtZQUF1QixjQUFjOzs7QUE1RDVELHlCQUF5QjtJQUhyQyxVQUFVLENBQUM7UUFDVixVQUFVLEVBQUUsTUFBTTtLQUNuQixDQUFDO0dBQ1cseUJBQXlCLENBdUpyQztTQXZKWSx5QkFBeUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUsIEJlaGF2aW9yU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tICd1dWlkJztcclxuaW1wb3J0IHsgQ29sb3JTY2hlbWUsIE1lc3NhZ2UsIE1lc3NhZ2VIYW5kbGVycywgTWVzc2FnZVR5cGUsIFBheWxvYWQgfSBmcm9tICcuL21lc3NhZ2UubW9kZWwnO1xyXG5pbXBvcnQgeyBBdmxBdXRoU2VydmljZSwgVXNlciB9IGZyb20gJ0BhdmwtbmctY29udHJvbHMvYXV0aCc7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBTaGVsbENvbW11bmljYXRpb25TZXJ2aWNlIHtcclxuICBwcml2YXRlIHJlYWRvbmx5IGlkOiBzdHJpbmc7XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlcnM6IE1lc3NhZ2VIYW5kbGVycyA9IHtcclxuICAgIFtNZXNzYWdlVHlwZS50aGVtZV06ICh0aGVtZTogc3RyaW5nKSA9PiB0aGlzLmhhbmRsZVRoZW1lKHRoZW1lKSxcclxuICAgIFtNZXNzYWdlVHlwZS5sb2NhbGVdOiAobG9jYWxlOiBzdHJpbmcpID0+IHRoaXMuaGFuZGxlTG9jYWxlKGxvY2FsZSksXHJcbiAgICBbTWVzc2FnZVR5cGUubGFuZ3VhZ2VdOiAobGFuZ3VhZ2U6IHN0cmluZykgPT4gdGhpcy5oYW5kbGVMYW5ndWFnZShsYW5ndWFnZSksXHJcbiAgICBbTWVzc2FnZVR5cGUuY29sb3JTY2hlbWVdOiAoY29sb3JTY2hlbWU6IENvbG9yU2NoZW1lKSA9PiB0aGlzLmhhbmRsZUNvbG9yU2NoZW1lKGNvbG9yU2NoZW1lKSxcclxuICAgIFtNZXNzYWdlVHlwZS5uYXZpZ2F0aW9uXTogKHVybDogc3RyaW5nKSA9PiB0aGlzLmhhbmRsZU5hdmlnYXRpb24odXJsKSxcclxuICAgIFtNZXNzYWdlVHlwZS5hY3Rpb25dOiAoYWN0aW9uOiBzdHJpbmcpID0+IHRoaXMuaGFuZGxlQWN0aW9uKGFjdGlvbiksXHJcbiAgICBbTWVzc2FnZVR5cGUuYXV0aGVudGljYXRpb25dOiAodXNlcjogVXNlcikgPT4gdGhpcy5oYW5kbGVBdXRoZW50aWNhdGlvbih1c2VyKSxcclxuICAgIFtNZXNzYWdlVHlwZS5yZWRpcmVjdGVkRnJvbUxvZ0luXTogKHJlZGlyZWN0ZWQ6IGJvb2xlYW4pID0+IHRoaXMuaGFuZGxlUmVkaXJlY3RlZEZyb21Mb2dJbihyZWRpcmVjdGVkKSxcclxuICB9O1xyXG5cclxuICBwcml2YXRlIHRoZW1lU3ViamVjdCA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKTtcclxuICBwcml2YXRlIGxhbmd1YWdlU3ViamVjdCA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKTtcclxuICBwcml2YXRlIGFjdGlvblN1YmplY3QgPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XHJcbiAgcHJpdmF0ZSBsb2NhbGVTdWJqZWN0ID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xyXG4gIHByaXZhdGUgY29sb3JTY2hlbWVTdWJqZWN0ID0gbmV3IFN1YmplY3Q8Q29sb3JTY2hlbWU+KCk7XHJcblxyXG4gIC8qKlxyXG4gICogT2JzZXJ2YWJsZSB0cmFja2luZyB0aGVtZVxyXG4gICogRW1pdHMgXCJkYXJrXCIgaWYgZGFyayB0aGVtZSBzZWxlY3RlZCwgXCJsaWdodFwiIG90aGVyd2lzZSBcclxuICAqL1xyXG4gIHB1YmxpYyB0aGVtZSQ6IE9ic2VydmFibGU8c3RyaW5nPiA9IHRoaXMudGhlbWVTdWJqZWN0O1xyXG5cclxuICAvKipcclxuICAqIE9ic2VydmFibGUgdHJhY2tpbmcgbGFuZ3VhZ2VcclxuICAqL1xyXG4gIHB1YmxpYyBsYW5ndWFnZSQ6IE9ic2VydmFibGU8c3RyaW5nPiA9IHRoaXMubGFuZ3VhZ2VTdWJqZWN0O1xyXG4gIHB1YmxpYyBhY3Rpb24kOiBPYnNlcnZhYmxlPHN0cmluZz4gPSB0aGlzLmFjdGlvblN1YmplY3Q7XHJcblxyXG4gIC8qKlxyXG4gICogT2JzZXJ2YWJsZSB0cmFja2luZyBjb3VudHJ5IGNoYW5nZXNcclxuICAqL1xyXG4gIHB1YmxpYyBsb2NhbGUkOiBPYnNlcnZhYmxlPHN0cmluZz4gPSB0aGlzLmxvY2FsZVN1YmplY3Q7XHJcblxyXG4gIC8qKlxyXG4gICogT2JzZXJ2YWJsZSB0cmFja2luZyBjb2xvciBzY2hlbWUgY2hhbmdlc1xyXG4gICovXHJcbiAgcHVibGljIGNvbG9yU2NoZW1lJDogT2JzZXJ2YWJsZTxDb2xvclNjaGVtZT4gPSB0aGlzLmNvbG9yU2NoZW1lU3ViamVjdDtcclxuXHJcbiAgLyoqXHJcbiAgKiBPYnNlcnZhYmxlIHRyYWNraW5nIGxvZ2luIHN0YXRlXHJcbiAgKiBSZXNvbHZlcyB0byB0cnVlIG9uIHN1Y2Nlc3NmdWwgbG9naW4sIGZhbHNlIG90aGVyd2lzZVxyXG4gICovXHJcbiAgcHVibGljIGlzTG9nZ2VkSW4kOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xyXG5cclxuICAvKipcclxuICAgKiBPYnNlcnZhYmxlIHRyYWNraW5nIGlmIHJlZGlyZWN0ZWQgZnJvbSBpZGJcclxuICAgKiBSZXNvbHZlcyB0byB0cnVlIG9uIHJlZGlyZWN0aW9uLCBmYWxzZSBvdGhlcndpc2VcclxuICAgKi9cclxuICBwdWJsaWMgcmVkaXJlY3RlZEZyb21Mb2dJbiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4odW5kZWZpbmVkKTtcclxuICBcclxuICAvKipcclxuICAgKiBJZiBjdXJyZW50IGFwcGxpY2F0aW9uIGlzIGluc2lkZSBzaGVsbCBhcHBsaWNhdGlvbiBcclxuICAgKiBUcnVlIGlmIGN1cnJlbnQgYXBwbGljYXRpb24gaXMgaW5zaWRlIHNoZWxsIGFwcGxpY2F0aW9uLCBmYWxzZSBvdGhlcndpc2UuXHJcbiAgICovXHJcbiAgcHVibGljIGlzQ2hpbGQgPSB3aW5kb3cubG9jYXRpb24gIT09IHdpbmRvdy5wYXJlbnQubG9jYXRpb247XHJcbiAgXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByb3V0ZXI6IFJvdXRlciwgcHJpdmF0ZSBhdXRoU2VydmljZTogQXZsQXV0aFNlcnZpY2UpIHtcclxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgKGV2ZW50KSA9PiB0aGlzLm9uTWVzc2FnZShldmVudCkpO1xyXG4gICAgXHJcbiAgICB0aGlzLmlkID0gdXVpZHY0KCk7XHJcbiAgfVxyXG4gIFxyXG4gIHB1YmxpYyBub3RpZnlTaGVsbEFib3V0QWN0aW9uKGFjdGlvbjogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9TaGVsbChNZXNzYWdlVHlwZS5hY3Rpb24sIGFjdGlvbik7XHJcbiAgfVxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIG1lc3NhZ2UgdG8gc2hlbGwgdGhhdCBpdCBuZWVkcyB0byBuYXZpZ2F0ZSB0byBsb2dpbiBwYWdlXHJcbiAgICovXHJcbiAgcHVibGljIG5vdGlmeVNoZWxsQWJvdXRMb2dpbih1cmw6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvU2hlbGwoTWVzc2FnZVR5cGUubG9naW4sIHVybCk7XHJcbiAgfVxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIG1lc3NhZ2UgdG8gc2hlbGwgdGhhdCBpdCBuZWVkcyB0byBuYXZpZ2F0ZSB0byBAdXJsXHJcbiAgICovXHJcbiAgcHVibGljIG5vdGlmeVNoZWxsQWJvdXROYXZpZ2F0aW9uKHVybDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9TaGVsbChNZXNzYWdlVHlwZS5uYXZpZ2F0aW9uLCB1cmwpO1xyXG4gIH1cclxuICBcclxuICAvKipcclxuICAgKiBTZW5kcyByZWdpc3RyYXRpb24gbWVzc2FnZSB0byBzaGVsbCBcclxuICAgKi9cclxuICBwdWJsaWMgcmVnaXN0ZXJUb1NoZWxsKCk6IHZvaWQge1xyXG4gICAgdGhpcy5wb3N0TWVzc2FnZVRvU2hlbGwoTWVzc2FnZVR5cGUucmVnaXN0cmF0aW9uLCB0aGlzLmlkKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICogU2VuZCB1cGRhdGVkIHVzZXIgZGF0YSB0byBzaGVsbFxyXG4gICovXHJcbiAgcHVibGljIHVwZGF0ZVVzZXJUb1NoZWxsKCk6IHZvaWQge1xyXG4gICAgY29uc3QgdXNlciA9IHRoaXMuYXV0aFNlcnZpY2UucmVhZFVzZXJGcm9tU2Vzc2lvblN0b3JhZ2UoKTtcclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb1NoZWxsKE1lc3NhZ2VUeXBlLnVzZXIsIHVzZXIpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvbk1lc3NhZ2UoZXZlbnQ6IE1lc3NhZ2VFdmVudCk6IHZvaWQge1xyXG4gICAgY29uc3QgeyBwYXlsb2FkLCBtZXNzYWdlVHlwZSB9OiBNZXNzYWdlID0gZXZlbnQuZGF0YTtcclxuICAgIGNvbnN0IGhhbmRsZXJzID0ge1xyXG4gICAgICAuLi50aGlzLmhhbmRsZXJzLFxyXG4gICAgICBkZWZhdWx0OiAoKSA9PiBjb25zb2xlLmxvZygnVW5yZWNvZ25pemVkIG1lc3NhZ2UgZm9yIHRoZSBzaGVsbC4nLCBldmVudClcclxuICAgIH07XHJcblxyXG4gICAgKGhhbmRsZXJzW21lc3NhZ2VUeXBlXSB8fCBoYW5kbGVycy5kZWZhdWx0KShwYXlsb2FkKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcG9zdE1lc3NhZ2VUb1NoZWxsKG1lc3NhZ2VUeXBlOiBNZXNzYWdlVHlwZSwgcGF5bG9hZDogUGF5bG9hZCk6IHZvaWQge1xyXG4gICAgY29uc3QgbWVzc2FnZTogTWVzc2FnZSA9IHsgbWVzc2FnZVR5cGUsIHBheWxvYWQgfTtcclxuICAgIHdpbmRvdy5wYXJlbnQud2luZG93LnBvc3RNZXNzYWdlKG1lc3NhZ2UsICcqJyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUNvbG9yU2NoZW1lKGNvbG9yU2NoZW1lOiBDb2xvclNjaGVtZSk6IHZvaWQge1xyXG4gICAgdGhpcy5jb2xvclNjaGVtZVN1YmplY3QubmV4dChjb2xvclNjaGVtZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUxhbmd1YWdlKGxhbmd1YWdlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMubGFuZ3VhZ2VTdWJqZWN0Lm5leHQobGFuZ3VhZ2UpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVMb2NhbGUobG9jYWxlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMubG9jYWxlU3ViamVjdC5uZXh0KGxvY2FsZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZVRoZW1lKHRoZW1lOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMudGhlbWVTdWJqZWN0Lm5leHQodGhlbWUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVOYXZpZ2F0aW9uKHVybDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKHVybCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUFjdGlvbihhY3Rpb246IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5hY3Rpb25TdWJqZWN0Lm5leHQoYWN0aW9uKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlQXV0aGVudGljYXRpb24odXNlcjogVXNlcik6IHZvaWQge1xyXG4gICAgaWYgKHVzZXI/LmFjY2Vzc190b2tlbikge1xyXG4gICAgICB0aGlzLmF1dGhTZXJ2aWNlLnN0b3JlVXNlclRvU2Vzc2lvblN0b3JhZ2UodXNlcik7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmF1dGhTZXJ2aWNlLmNsZWFyVXNlckZyb21TZXNzaW9uU3RvcmFnZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuYXV0aFNlcnZpY2UucmVsb2FkUGVyc2lzdGVkVXNlckRhdGEoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlUmVkaXJlY3RlZEZyb21Mb2dJbihyZWRpcmVjdGVkOiBib29sZWFuKSB7XHJcbiAgICB0aGlzLnJlZGlyZWN0ZWRGcm9tTG9nSW4ubmV4dChyZWRpcmVjdGVkKTtcclxuICB9XHJcbn1cclxuIl19