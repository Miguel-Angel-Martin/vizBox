import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { Router } from '@angular/router';
import { Subject, BehaviorSubject } from 'rxjs';
import { v4 as uuidv4 } from 'uuid';
import { MessageType } from './message.model';
import { AvlAuthService } from '@avl-ng-controls/auth';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "@avl-ng-controls/auth";
let ShellCommunicationService = class ShellCommunicationService {
    constructor(router, authService) {
        this.router = router;
        this.authService = authService;
        this.handlers = {
            [MessageType.theme]: (theme) => this.handleTheme(theme),
            [MessageType.locale]: (locale) => this.handleLocale(locale),
            [MessageType.language]: (language) => this.handleLanguage(language),
            [MessageType.colorScheme]: (colorScheme) => this.handleColorScheme(colorScheme),
            [MessageType.navigation]: (url) => this.handleNavigation(url),
            [MessageType.action]: (action) => this.handleAction(action),
            [MessageType.authentication]: (user) => this.handleAuthentication(user),
            [MessageType.redirectedFromLogIn]: (redirected) => this.handleRedirectedFromLogIn(redirected),
        };
        this.themeSubject = new Subject();
        this.languageSubject = new Subject();
        this.actionSubject = new Subject();
        this.localeSubject = new Subject();
        this.colorSchemeSubject = new Subject();
        /**
        * Observable tracking theme
        * Emits "dark" if dark theme selected, "light" otherwise
        */
        this.theme$ = this.themeSubject;
        /**
        * Observable tracking language
        */
        this.language$ = this.languageSubject;
        this.action$ = this.actionSubject;
        /**
        * Observable tracking country changes
        */
        this.locale$ = this.localeSubject;
        /**
        * Observable tracking color scheme changes
        */
        this.colorScheme$ = this.colorSchemeSubject;
        /**
         * Observable tracking if redirected from idb
         * Resolves to true on redirection, false otherwise
         */
        this.redirectedFromLogIn = new BehaviorSubject(undefined);
        /**
         * If current application is inside shell application
         * True if current application is inside shell application, false otherwise.
         */
        this.isChild = window.location !== window.parent.location;
        window.addEventListener('message', (event) => this.onMessage(event));
        this.id = uuidv4();
    }
    notifyShellAboutAction(action) {
        this.postMessageToShell(MessageType.action, action);
    }
    /**
     * Sends message to shell that it needs to navigate to login page
     */
    notifyShellAboutLogin(url) {
        this.postMessageToShell(MessageType.login, url);
    }
    /**
     * Sends message to shell that it needs to navigate to @url
     */
    notifyShellAboutNavigation(url) {
        this.postMessageToShell(MessageType.navigation, url);
    }
    /**
     * Sends registration message to shell
     */
    registerToShell() {
        this.postMessageToShell(MessageType.registration, this.id);
    }
    onMessage(event) {
        const { payload, messageType } = event.data;
        const handlers = Object.assign(Object.assign({}, this.handlers), { default: () => console.log('Unrecognized message for the shell.', event) });
        (handlers[messageType] || handlers.default)(payload);
    }
    postMessageToShell(messageType, payload) {
        const message = { messageType, payload };
        window.parent.window.postMessage(message, '*');
    }
    handleColorScheme(colorScheme) {
        this.colorSchemeSubject.next(colorScheme);
    }
    handleLanguage(language) {
        this.languageSubject.next(language);
    }
    handleLocale(locale) {
        this.localeSubject.next(locale);
    }
    handleTheme(theme) {
        this.themeSubject.next(theme);
    }
    handleNavigation(url) {
        this.router.navigateByUrl(url);
    }
    handleAction(action) {
        this.actionSubject.next(action);
    }
    handleAuthentication(user) {
        if (user === null || user === void 0 ? void 0 : user.access_token) {
            this.setUserToSessionStorage(user);
        }
        else {
            this.removeUserFromSessionStorage();
        }
        this.authService.reloadPersistedUserData();
    }
    handleRedirectedFromLogIn(redirected) {
        this.redirectedFromLogIn.next(redirected);
    }
    setUserToSessionStorage(user) {
        sessionStorage.setItem('refresh_token', user.refresh_token);
        sessionStorage.setItem('access_token', user.access_token);
        sessionStorage.setItem('id_token', user.id_token);
        sessionStorage.setItem('refresh_token_expires_at', String(user.refresh_token_expires_at));
        sessionStorage.setItem('access_token_expires_at', String(user.access_token_expires_at));
        sessionStorage.setItem('access_token_stored_at', String(user.access_token_stored_at));
        sessionStorage.setItem('username', user.username);
        sessionStorage.setItem('name', user.name);
        sessionStorage.setItem('roles', JSON.stringify(user.roles));
    }
    removeUserFromSessionStorage() {
        sessionStorage.removeItem('refresh_token');
        sessionStorage.removeItem('access_token');
        sessionStorage.removeItem('id_token');
        sessionStorage.removeItem('refresh_token_expires_at');
        sessionStorage.removeItem('access_token_expires_at');
        sessionStorage.removeItem('access_token_stored_at');
        sessionStorage.removeItem('username');
        sessionStorage.removeItem('name');
        sessionStorage.removeItem('roles');
    }
};
ShellCommunicationService.ctorParameters = () => [
    { type: Router },
    { type: AvlAuthService }
];
ShellCommunicationService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ShellCommunicationService_Factory() { return new ShellCommunicationService(i0.ɵɵinject(i1.Router), i0.ɵɵinject(i2.AvlAuthService)); }, token: ShellCommunicationService, providedIn: "root" });
ShellCommunicationService = __decorate([
    Injectable({
        providedIn: 'root'
    })
], ShellCommunicationService);
export { ShellCommunicationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hlbGwtY29tbXVuaWNhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGF2bC1zZXJ2aWNlcy9uZy1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9zaGVsbC1jb21tdW5pY2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxPQUFPLEVBQWMsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVELE9BQU8sRUFBRSxFQUFFLElBQUksTUFBTSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3BDLE9BQU8sRUFBeUMsV0FBVyxFQUFpQixNQUFNLGlCQUFpQixDQUFDO0FBQ3BHLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQzs7OztBQUt2RCxJQUFhLHlCQUF5QixHQUF0QyxNQUFhLHlCQUF5QjtJQTREcEMsWUFBb0IsTUFBYyxFQUFVLFdBQTJCO1FBQW5ELFdBQU0sR0FBTixNQUFNLENBQVE7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBZ0I7UUF6RC9ELGFBQVEsR0FBb0I7WUFDbEMsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFhLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDO1lBQy9ELENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBYyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQztZQUNuRSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLFFBQWdCLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDO1lBQzNFLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMs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QUFVLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDdEMsY0FBYyxDQUFDLFVBQVUsQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO1FBQ3RELGNBQWMsQ0FBQyxVQUFVLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUNyRCxjQUFjLENBQUMsVUFBVSxDQUFDLHdCQUF3QixDQUFDLENBQUM7UUFDcEQsY0FBYyxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN0QyxjQUFjLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2xDLGNBQWMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDckMsQ0FBQztDQUNGLENBQUE7O1lBM0c2QixNQUFNO1lBQXVCLGNBQWM7OztBQTVENUQseUJBQXlCO0lBSHJDLFVBQVUsQ0FBQztRQUNWLFVBQVUsRUFBRSxNQUFNO0tBQ25CLENBQUM7R0FDVyx5QkFBeUIsQ0F1S3JDO1NBdktZLHlCQUF5QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcclxuaW1wb3J0IHsgU3ViamVjdCwgT2JzZXJ2YWJsZSwgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xyXG5pbXBvcnQgeyBDb2xvclNjaGVtZSwgTWVzc2FnZSwgTWVzc2FnZUhhbmRsZXJzLCBNZXNzYWdlVHlwZSwgUGF5bG9hZCwgVXNlciB9IGZyb20gJy4vbWVzc2FnZS5tb2RlbCc7XHJcbmltcG9ydCB7IEF2bEF1dGhTZXJ2aWNlIH0gZnJvbSAnQGF2bC1uZy1jb250cm9scy9hdXRoJztcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFNoZWxsQ29tbXVuaWNhdGlvblNlcnZpY2Uge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgaWQ6IHN0cmluZztcclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVyczogTWVzc2FnZUhhbmRsZXJzID0ge1xyXG4gICAgW01lc3NhZ2VUeXBlLnRoZW1lXTogKHRoZW1lOiBzdHJpbmcpID0+IHRoaXMuaGFuZGxlVGhlbWUodGhlbWUpLFxyXG4gICAgW01lc3NhZ2VUeXBlLmxvY2FsZV06IChsb2NhbGU6IHN0cmluZykgPT4gdGhpcy5oYW5kbGVMb2NhbGUobG9jYWxlKSxcclxuICAgIFtNZXNzYWdlVHlwZS5sYW5ndWFnZV06IChsYW5ndWFnZTogc3RyaW5nKSA9PiB0aGlzLmhhbmRsZUxhbmd1YWdlKGxhbmd1YWdlKSxcclxuICAgIFtNZXNzYWdlVHlwZS5jb2xvclNjaGVtZV06IChjb2xvclNjaGVtZTogQ29sb3JTY2hlbWUpID0+IHRoaXMuaGFuZGxlQ29sb3JTY2hlbWUoY29sb3JTY2hlbWUpLFxyXG4gICAgW01lc3NhZ2VUeXBlLm5hdmlnYXRpb25dOiAodXJsOiBzdHJpbmcpID0+IHRoaXMuaGFuZGxlTmF2aWdhdGlvbih1cmwpLFxyXG4gICAgW01lc3NhZ2VUeXBlLmFjdGlvbl06IChhY3Rpb246IHN0cmluZykgPT4gdGhpcy5oYW5kbGVBY3Rpb24oYWN0aW9uKSxcclxuICAgIFtNZXNzYWdlVHlwZS5hdXRoZW50aWNhdGlvbl06ICh1c2VyOiBVc2VyKSA9PiB0aGlzLmhhbmRsZUF1dGhlbnRpY2F0aW9uKHVzZXIpLFxyXG4gICAgW01lc3NhZ2VUeXBlLnJlZGlyZWN0ZWRGcm9tTG9nSW5dOiAocmVkaXJlY3RlZDogYm9vbGVhbikgPT4gdGhpcy5oYW5kbGVSZWRpcmVjdGVkRnJvbUxvZ0luKHJlZGlyZWN0ZWQpLFxyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgdGhlbWVTdWJqZWN0ID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xyXG4gIHByaXZhdGUgbGFuZ3VhZ2VTdWJqZWN0ID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xyXG4gIHByaXZhdGUgYWN0aW9uU3ViamVjdCA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKTtcclxuICBwcml2YXRlIGxvY2FsZVN1YmplY3QgPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XHJcbiAgcHJpdmF0ZSBjb2xvclNjaGVtZVN1YmplY3QgPSBuZXcgU3ViamVjdDxDb2xvclNjaGVtZT4oKTtcclxuXHJcbiAgLyoqXHJcbiAgKiBPYnNlcnZhYmxlIHRyYWNraW5nIHRoZW1lXHJcbiAgKiBFbWl0cyBcImRhcmtcIiBpZiBkYXJrIHRoZW1lIHNlbGVjdGVkLCBcImxpZ2h0XCIgb3RoZXJ3aXNlIFxyXG4gICovXHJcbiAgcHVibGljIHRoZW1lJDogT2JzZXJ2YWJsZTxzdHJpbmc+ID0gdGhpcy50aGVtZVN1YmplY3Q7XHJcblxyXG4gIC8qKlxyXG4gICogT2JzZXJ2YWJsZSB0cmFja2luZyBsYW5ndWFnZVxyXG4gICovXHJcbiAgcHVibGljIGxhbmd1YWdlJDogT2JzZXJ2YWJsZTxzdHJpbmc+ID0gdGhpcy5sYW5ndWFnZVN1YmplY3Q7XHJcbiAgcHVibGljIGFjdGlvbiQ6IE9ic2VydmFibGU8c3RyaW5nPiA9IHRoaXMuYWN0aW9uU3ViamVjdDtcclxuXHJcbiAgLyoqXHJcbiAgKiBPYnNlcnZhYmxlIHRyYWNraW5nIGNvdW50cnkgY2hhbmdlc1xyXG4gICovXHJcbiAgcHVibGljIGxvY2FsZSQ6IE9ic2VydmFibGU8c3RyaW5nPiA9IHRoaXMubG9jYWxlU3ViamVjdDtcclxuXHJcbiAgLyoqXHJcbiAgKiBPYnNlcnZhYmxlIHRyYWNraW5nIGNvbG9yIHNjaGVtZSBjaGFuZ2VzXHJcbiAgKi9cclxuICBwdWJsaWMgY29sb3JTY2hlbWUkOiBPYnNlcnZhYmxlPENvbG9yU2NoZW1lPiA9IHRoaXMuY29sb3JTY2hlbWVTdWJqZWN0O1xyXG5cclxuICAvKipcclxuICAqIE9ic2VydmFibGUgdHJhY2tpbmcgbG9naW4gc3RhdGVcclxuICAqIFJlc29sdmVzIHRvIHRydWUgb24gc3VjY2Vzc2Z1bCBsb2dpbiwgZmFsc2Ugb3RoZXJ3aXNlXHJcbiAgKi9cclxuICBwdWJsaWMgaXNMb2dnZWRJbiQ6IE9ic2VydmFibGU8Ym9vbGVhbj47XHJcblxyXG4gIC8qKlxyXG4gICAqIE9ic2VydmFibGUgdHJhY2tpbmcgaWYgcmVkaXJlY3RlZCBmcm9tIGlkYlxyXG4gICAqIFJlc29sdmVzIHRvIHRydWUgb24gcmVkaXJlY3Rpb24sIGZhbHNlIG90aGVyd2lzZVxyXG4gICAqL1xyXG4gIHB1YmxpYyByZWRpcmVjdGVkRnJvbUxvZ0luID0gbmV3IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPih1bmRlZmluZWQpO1xyXG4gIFxyXG4gIC8qKlxyXG4gICAqIElmIGN1cnJlbnQgYXBwbGljYXRpb24gaXMgaW5zaWRlIHNoZWxsIGFwcGxpY2F0aW9uIFxyXG4gICAqIFRydWUgaWYgY3VycmVudCBhcHBsaWNhdGlvbiBpcyBpbnNpZGUgc2hlbGwgYXBwbGljYXRpb24sIGZhbHNlIG90aGVyd2lzZS5cclxuICAgKi9cclxuICBwdWJsaWMgaXNDaGlsZCA9IHdpbmRvdy5sb2NhdGlvbiAhPT0gd2luZG93LnBhcmVudC5sb2NhdGlvbjtcclxuICBcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJvdXRlcjogUm91dGVyLCBwcml2YXRlIGF1dGhTZXJ2aWNlOiBBdmxBdXRoU2VydmljZSkge1xyXG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCAoZXZlbnQpID0+IHRoaXMub25NZXNzYWdlKGV2ZW50KSk7XHJcbiAgICBcclxuICAgIHRoaXMuaWQgPSB1dWlkdjQoKTtcclxuICB9XHJcbiAgXHJcbiAgcHVibGljIG5vdGlmeVNoZWxsQWJvdXRBY3Rpb24oYWN0aW9uOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb1NoZWxsKE1lc3NhZ2VUeXBlLmFjdGlvbiwgYWN0aW9uKTtcclxuICB9XHJcbiAgXHJcbiAgLyoqXHJcbiAgICogU2VuZHMgbWVzc2FnZSB0byBzaGVsbCB0aGF0IGl0IG5lZWRzIHRvIG5hdmlnYXRlIHRvIGxvZ2luIHBhZ2VcclxuICAgKi9cclxuICBwdWJsaWMgbm90aWZ5U2hlbGxBYm91dExvZ2luKHVybDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9TaGVsbChNZXNzYWdlVHlwZS5sb2dpbiwgdXJsKTtcclxuICB9XHJcbiAgXHJcbiAgLyoqXHJcbiAgICogU2VuZHMgbWVzc2FnZSB0byBzaGVsbCB0aGF0IGl0IG5lZWRzIHRvIG5hdmlnYXRlIHRvIEB1cmxcclxuICAgKi9cclxuICBwdWJsaWMgbm90aWZ5U2hlbGxBYm91dE5hdmlnYXRpb24odXJsOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMucG9zdE1lc3NhZ2VUb1NoZWxsKE1lc3NhZ2VUeXBlLm5hdmlnYXRpb24sIHVybCk7XHJcbiAgfVxyXG4gIFxyXG4gIC8qKlxyXG4gICAqIFNlbmRzIHJlZ2lzdHJhdGlvbiBtZXNzYWdlIHRvIHNoZWxsIFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZWdpc3RlclRvU2hlbGwoKTogdm9pZCB7XHJcbiAgICB0aGlzLnBvc3RNZXNzYWdlVG9TaGVsbChNZXNzYWdlVHlwZS5yZWdpc3RyYXRpb24sIHRoaXMuaWQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvbk1lc3NhZ2UoZXZlbnQ6IE1lc3NhZ2VFdmVudCk6IHZvaWQge1xyXG4gICAgY29uc3QgeyBwYXlsb2FkLCBtZXNzYWdlVHlwZSB9OiBNZXNzYWdlID0gZXZlbnQuZGF0YTtcclxuICAgIGNvbnN0IGhhbmRsZXJzID0ge1xyXG4gICAgICAuLi50aGlzLmhhbmRsZXJzLFxyXG4gICAgICBkZWZhdWx0OiAoKSA9PiBjb25zb2xlLmxvZygnVW5yZWNvZ25pemVkIG1lc3NhZ2UgZm9yIHRoZSBzaGVsbC4nLCBldmVudClcclxuICAgIH07XHJcblxyXG4gICAgKGhhbmRsZXJzW21lc3NhZ2VUeXBlXSB8fCBoYW5kbGVycy5kZWZhdWx0KShwYXlsb2FkKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcG9zdE1lc3NhZ2VUb1NoZWxsKG1lc3NhZ2VUeXBlOiBNZXNzYWdlVHlwZSwgcGF5bG9hZDogUGF5bG9hZCk6IHZvaWQge1xyXG4gICAgY29uc3QgbWVzc2FnZTogTWVzc2FnZSA9IHsgbWVzc2FnZVR5cGUsIHBheWxvYWQgfTtcclxuICAgIHdpbmRvdy5wYXJlbnQud2luZG93LnBvc3RNZXNzYWdlKG1lc3NhZ2UsICcqJyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUNvbG9yU2NoZW1lKGNvbG9yU2NoZW1lOiBDb2xvclNjaGVtZSk6IHZvaWQge1xyXG4gICAgdGhpcy5jb2xvclNjaGVtZVN1YmplY3QubmV4dChjb2xvclNjaGVtZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUxhbmd1YWdlKGxhbmd1YWdlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMubGFuZ3VhZ2VTdWJqZWN0Lm5leHQobGFuZ3VhZ2UpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVMb2NhbGUobG9jYWxlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMubG9jYWxlU3ViamVjdC5uZXh0KGxvY2FsZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZVRoZW1lKHRoZW1lOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMudGhlbWVTdWJqZWN0Lm5leHQodGhlbWUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVOYXZpZ2F0aW9uKHVybDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKHVybCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUFjdGlvbihhY3Rpb246IHN0cmluZyk6IHZvaWQge1xyXG4gICAgdGhpcy5hY3Rpb25TdWJqZWN0Lm5leHQoYWN0aW9uKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlQXV0aGVudGljYXRpb24odXNlcjogVXNlcik6IHZvaWQge1xyXG4gICAgaWYgKHVzZXI/LmFjY2Vzc190b2tlbikge1xyXG4gICAgICB0aGlzLnNldFVzZXJUb1Nlc3Npb25TdG9yYWdlKHVzZXIpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5yZW1vdmVVc2VyRnJvbVNlc3Npb25TdG9yYWdlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5hdXRoU2VydmljZS5yZWxvYWRQZXJzaXN0ZWRVc2VyRGF0YSgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVSZWRpcmVjdGVkRnJvbUxvZ0luKHJlZGlyZWN0ZWQ6IGJvb2xlYW4pIHtcclxuICAgIHRoaXMucmVkaXJlY3RlZEZyb21Mb2dJbi5uZXh0KHJlZGlyZWN0ZWQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXRVc2VyVG9TZXNzaW9uU3RvcmFnZSh1c2VyOiBVc2VyKTogdm9pZCB7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCdyZWZyZXNoX3Rva2VuJywgdXNlci5yZWZyZXNoX3Rva2VuKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oJ2FjY2Vzc190b2tlbicsIHVzZXIuYWNjZXNzX3Rva2VuKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oJ2lkX3Rva2VuJywgdXNlci5pZF90b2tlbik7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCdyZWZyZXNoX3Rva2VuX2V4cGlyZXNfYXQnLCBTdHJpbmcodXNlci5yZWZyZXNoX3Rva2VuX2V4cGlyZXNfYXQpKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oJ2FjY2Vzc190b2tlbl9leHBpcmVzX2F0JywgU3RyaW5nKHVzZXIuYWNjZXNzX3Rva2VuX2V4cGlyZXNfYXQpKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oJ2FjY2Vzc190b2tlbl9zdG9yZWRfYXQnLCBTdHJpbmcodXNlci5hY2Nlc3NfdG9rZW5fc3RvcmVkX2F0KSk7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCd1c2VybmFtZScsIHVzZXIudXNlcm5hbWUpO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgnbmFtZScsIHVzZXIubmFtZSk7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCdyb2xlcycsIEpTT04uc3RyaW5naWZ5KHVzZXIucm9sZXMpKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVtb3ZlVXNlckZyb21TZXNzaW9uU3RvcmFnZSgpOiB2b2lkIHtcclxuICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oJ3JlZnJlc2hfdG9rZW4nKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oJ2FjY2Vzc190b2tlbicpO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSgnaWRfdG9rZW4nKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oJ3JlZnJlc2hfdG9rZW5fZXhwaXJlc19hdCcpO1xyXG4gICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSgnYWNjZXNzX3Rva2VuX2V4cGlyZXNfYXQnKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oJ2FjY2Vzc190b2tlbl9zdG9yZWRfYXQnKTtcclxuICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oJ3VzZXJuYW1lJyk7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCduYW1lJyk7XHJcbiAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKCdyb2xlcycpO1xyXG4gIH1cclxufVxyXG4iXX0=