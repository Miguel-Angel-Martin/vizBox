import { __decorate, __param } from "tslib";
import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Inject, Injectable, Optional } from '@angular/core';
import { AvlAuthService } from '@avl-ng-controls/auth';
import { interval, Subject } from 'rxjs';
import { filter, switchMap, takeUntil, tap } from 'rxjs/operators';
import { Log, LogConfig, LogSeverity } from './logging.model';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "@avl-ng-controls/auth";
let LoggingService = class LoggingService {
    /**
     * @ignore
     */
    constructor(http, config, authService) {
        var _a;
        this.http = http;
        this.config = config;
        this.authService = authService;
        this.logs = [];
        this.isLogging = false;
        this.debounceTime$ = new Subject();
        this.logs$ = new Subject();
        this.stopLogging$ = new Subject();
        this.postLogs$ = new Subject();
        this.destroyed$ = new Subject();
        this.headers = new HttpHeaders({
            targetName: this.config.targetName,
        });
        if (config.autologging) {
            (_a = this.authService) === null || _a === void 0 ? void 0 : _a.isLoggedIn$.pipe(takeUntil(this.destroyed$)).subscribe((isLoggedIn) => this.decideOnLogging(isLoggedIn));
        }
    }
    /**
     * @ignore
     */
    ngOnDestroy() {
        this.postLogs$.complete();
        this.debounceTime$.complete();
        this.logs$.complete();
        this.stopLogging$.next();
        this.stopLogging$.complete();
        this.destroyed$.next();
        this.destroyed$.complete();
    }
    /**
     * Starts periodical logging process.
     *
     * Depends on _debounceTime_ and _capacity_ properties.
     */
    startLogging() {
        this.isLogging = true;
        this.debounceTime$
            .pipe(takeUntil(this.stopLogging$), switchMap((debounceTime) => this.periodicalLogging(debounceTime)))
            .subscribe(() => this.onPostMessages());
        this.postLogs$
            .pipe(takeUntil(this.stopLogging$), switchMap(() => this.postMessages()))
            .subscribe(() => this.onPostMessages());
        this.setLoggingDebounceTime(this.config.debounceTime);
    }
    /**
     * Stops logging process.
     */
    stopLogging() {
        this.isLogging = false;
        this.postLogs();
        this.stopLogging$.next();
    }
    /**
     * Gets all currently queued logs as an observable value.
     * @returns All currently queued logs as an observable value
     */
    getLogs$() {
        return this.logs$.asObservable();
    }
    /**
     * Logs message with debug severity.
     * @param message Message used for constructing a debug log
     * @param componentName Name of the component which called this method
     */
    debug(message, componentName = '') {
        this.log(message, LogSeverity.Debug, componentName);
    }
    /**
     * Logs message with info severity.
     * @param message Message used for constructing a info log
     * @param componentName Name of the component which called this method
     */
    info(message, componentName = '') {
        this.log(message, LogSeverity.Info, componentName);
    }
    /**
     * Logs message with warning severity.
     * @param message Message used for constructing a warning log
     * @param componentName Name of the component which called this method
     */
    warn(message, componentName = '') {
        this.log(message, LogSeverity.Warning, componentName);
    }
    /**
     * Logs message with error severity.
     * @param message Message used for constructing a error log
     * @param componentName Name of the component which called this method
     */
    error(message, componentName = '') {
        this.log(message, LogSeverity.Error, componentName);
    }
    /**
     * Logs message with fatal severity.
     * @param message Message used for constructing a fatal log
     * @param componentName Name of the component which called this method
     */
    fatal(message, componentName = '') {
        this.log(message, LogSeverity.Fatal, componentName);
    }
    /**
     * Setter for debounce time (log period).
     * @param debounceTime Time in milliseconds; determines the period of API requests for logging
     */
    setLoggingDebounceTime(debounceTime) {
        this.config.debounceTime = debounceTime;
        this.debounceTime$.next(debounceTime);
    }
    /**
     * Setter for global log level.
     * @param globalLogLevel Minimum message severity to log
     */
    setGlobalLogLevel(globalLogLevel) {
        this.config.globalLogLevel = globalLogLevel;
    }
    /**
     * Setter for log queue capacity.
     * @param capacity Log queue capacity
     */
    setLogCapacity(capacity) {
        this.config.capacity = capacity;
    }
    // Logic, private methods
    log(message, severity, componentName) {
        if (!this.isLogging || severity < this.config.globalLogLevel) {
            return;
        }
        this.createAndStoreLog(message, severity, componentName);
        this.dispatchLogs();
        if (this.isFullCapacity()) {
            this.postLogs$.next();
        }
    }
    createAndStoreLog(message, severityType, componentName) {
        const timestamp = new Date().toISOString();
        const { appName, version } = this.config;
        const severity = severityType.toString();
        const log = { message, severity, timestamp, componentName, appName, version };
        this.logs.push(log);
    }
    isFullCapacity() {
        return this.logs.length >= this.config.capacity;
    }
    clearLogs() {
        this.logs = [];
    }
    onPostMessages() {
        this.clearLogs();
        this.dispatchLogs();
    }
    postLogs() {
        this.postLogs$.next();
    }
    periodicalLogging(period) {
        return interval(period).pipe(tap(() => {
            if (!this.logs.length) {
                this.dispatchLogs();
            }
        }), filter(() => !!this.logs.length), switchMap(() => this.postMessages()));
    }
    postMessages() {
        return this.http.post(this.config.endpoint, this.logs, {
            headers: this.headers,
        });
    }
    dispatchLogs() {
        this.logs$.next(this.logs);
    }
    decideOnLogging(isLoggedIn) {
        if (isLoggedIn) {
            this.startLogging();
        }
        else {
            this.stopLogging();
        }
    }
};
LoggingService.ctorParameters = () => [
    { type: HttpClient },
    { type: LogConfig, decorators: [{ type: Inject, args: ['loggingConfig',] }] },
    { type: AvlAuthService, decorators: [{ type: Optional }, { type: Inject, args: [AvlAuthService,] }] }
];
LoggingService.ɵprov = i0.ɵɵdefineInjectable({ factory: function LoggingService_Factory() { return new LoggingService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject("loggingConfig"), i0.ɵɵinject(i2.AvlAuthService, 8)); }, token: LoggingService, providedIn: "root" });
LoggingService = __decorate([
    Injectable({
        providedIn: 'root',
    }),
    __param(1, Inject('loggingConfig')),
    __param(2, Optional()), __param(2, Inject(AvlAuthService))
], LoggingService);
export { LoggingService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9nZ2luZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGF2bC1zZXJ2aWNlcy9uZy1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9sb2dnaW5nLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0QsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQWEsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsUUFBUSxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNyRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkUsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLE1BQU0saUJBQWlCLENBQUM7Ozs7QUFLOUQsSUFBYSxjQUFjLEdBQTNCLE1BQWEsY0FBYztJQVd6Qjs7T0FFRztJQUNILFlBQ1UsSUFBZ0IsRUFDUyxNQUFpQixFQUNOLFdBQTJCOztRQUYvRCxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ1MsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQUNOLGdCQUFXLEdBQVgsV0FBVyxDQUFnQjtRQWhCakUsU0FBSSxHQUFVLEVBQUUsQ0FBQztRQUVqQixjQUFTLEdBQUcsS0FBSyxDQUFDO1FBRWxCLGtCQUFhLEdBQW9CLElBQUksT0FBTyxFQUFFLENBQUM7UUFDL0MsVUFBSyxHQUFtQixJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ3RDLGlCQUFZLEdBQWtCLElBQUksT0FBTyxFQUFFLENBQUM7UUFDNUMsY0FBUyxHQUFrQixJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ3pDLGVBQVUsR0FBa0IsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQVVoRCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksV0FBVyxDQUFDO1lBQzdCLFVBQVUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVU7U0FDbkMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxNQUFNLENBQUMsV0FBVyxFQUFFO1lBQ3RCLE1BQUEsSUFBSSxDQUFDLFdBQVcsMENBQUUsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsRUFBRTtTQUM1SDtJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILFdBQVc7UUFDVCxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQzFCLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDOUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFDRDs7OztPQUlHO0lBQ0ksWUFBWTtRQUNqQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztRQUN0QixJQUFJLENBQUMsYUFBYTthQUNmLElBQUksQ0FDSCxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUM1QixTQUFTLENBQUMsQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUNsRTthQUNBLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztRQUUxQyxJQUFJLENBQUMsU0FBUzthQUNYLElBQUksQ0FDSCxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxFQUM1QixTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQ3JDO2FBQ0EsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBRTFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3hELENBQUM7SUFFRDs7T0FFRztJQUNJLFdBQVc7UUFDaEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7UUFDdkIsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUVEOzs7T0FHRztJQUNJLFFBQVE7UUFDYixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDbkMsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSxLQUFLLENBQUMsT0FBZSxFQUFFLGdCQUF3QixFQUFFO1FBQ3RELElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxLQUFLLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSxJQUFJLENBQUMsT0FBZSxFQUFFLGdCQUF3QixFQUFFO1FBQ3JELElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSxJQUFJLENBQUMsT0FBZSxFQUFFLGdCQUF3QixFQUFFO1FBQ3JELElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxPQUFPLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSxLQUFLLENBQUMsT0FBZSxFQUFFLGdCQUF3QixFQUFFO1FBQ3RELElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxLQUFLLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSxLQUFLLENBQUMsT0FBZSxFQUFFLGdCQUF3QixFQUFFO1FBQ3RELElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxLQUFLLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVEOzs7T0FHRztJQUNJLHNCQUFzQixDQUFDLFlBQW9CO1FBQ2hELElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztRQUN4QyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ksaUJBQWlCLENBQUMsY0FBMkI7UUFDbEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO0lBQzlDLENBQUM7SUFFRDs7O09BR0c7SUFDSSxjQUFjLENBQUMsUUFBZ0I7UUFDcEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQ2xDLENBQUM7SUFFRCx5QkFBeUI7SUFFakIsR0FBRyxDQUFDLE9BQWUsRUFBRSxRQUFxQixFQUFFLGFBQXFCO1FBQ3ZFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWMsRUFBRTtZQUM1RCxPQUFPO1NBQ1I7UUFFRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFFcEIsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFLEVBQUU7WUFDekIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUN2QjtJQUNILENBQUM7SUFFTyxpQkFBaUIsQ0FBQyxPQUFlLEVBQUUsWUFBeUIsRUFBRSxhQUFxQjtRQUN6RixNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzNDLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUN6QyxNQUFNLFFBQVEsR0FBRyxZQUFZLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDekMsTUFBTSxHQUFHLEdBQVEsRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxDQUFDO1FBQ25GLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFTyxjQUFjO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7SUFDbEQsQ0FBQztJQUVPLFNBQVM7UUFDZixJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUNqQixDQUFDO0lBRU8sY0FBYztRQUNwQixJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDakIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3RCLENBQUM7SUFFTyxRQUFRO1FBQ2QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRU8saUJBQWlCLENBQUMsTUFBYztRQUN0QyxPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQzFCLEdBQUcsQ0FBQyxHQUFHLEVBQUU7WUFDUCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7Z0JBQ3JCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQzthQUNyQjtRQUNILENBQUMsQ0FBQyxFQUNGLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFDaEMsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUNyQyxDQUFDO0lBQ0osQ0FBQztJQUVPLFlBQVk7UUFDbEIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQzNELE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTztTQUN0QixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sWUFBWTtRQUNsQixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVPLGVBQWUsQ0FBQyxVQUFtQjtRQUN6QyxJQUFJLFVBQVUsRUFBRTtZQUNkLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztTQUNyQjthQUFNO1lBQ0wsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQ3BCO0lBQ0gsQ0FBQztDQUNGLENBQUE7O1lBN01pQixVQUFVO1lBQ2lCLFNBQVMsdUJBQWpELE1BQU0sU0FBQyxlQUFlO1lBQ2tDLGNBQWMsdUJBQXRFLFFBQVEsWUFBSSxNQUFNLFNBQUMsY0FBYzs7O0FBakJ6QixjQUFjO0lBSDFCLFVBQVUsQ0FBQztRQUNWLFVBQVUsRUFBRSxNQUFNO0tBQ25CLENBQUM7SUFpQkcsV0FBQSxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUE7SUFDdkIsV0FBQSxRQUFRLEVBQUUsQ0FBQSxFQUFFLFdBQUEsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFBO0dBakIxQixjQUFjLENBNE4xQjtTQTVOWSxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgT25EZXN0cm95LCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBdmxBdXRoU2VydmljZSB9IGZyb20gJ0BhdmwtbmctY29udHJvbHMvYXV0aCc7XHJcbmltcG9ydCB7IGludGVydmFsLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGZpbHRlciwgc3dpdGNoTWFwLCB0YWtlVW50aWwsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgTG9nLCBMb2dDb25maWcsIExvZ1NldmVyaXR5IH0gZnJvbSAnLi9sb2dnaW5nLm1vZGVsJztcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCcsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBMb2dnaW5nU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XHJcbiAgcHJpdmF0ZSBsb2dzOiBMb2dbXSA9IFtdO1xyXG4gIHByaXZhdGUgaGVhZGVyczogSHR0cEhlYWRlcnM7XHJcbiAgcHJpdmF0ZSBpc0xvZ2dpbmcgPSBmYWxzZTtcclxuXHJcbiAgcHJpdmF0ZSBkZWJvdW5jZVRpbWUkOiBTdWJqZWN0PG51bWJlcj4gPSBuZXcgU3ViamVjdCgpO1xyXG4gIHByaXZhdGUgbG9ncyQ6IFN1YmplY3Q8TG9nW10+ID0gbmV3IFN1YmplY3QoKTtcclxuICBwcml2YXRlIHN0b3BMb2dnaW5nJDogU3ViamVjdDx2b2lkPiA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgcHJpdmF0ZSBwb3N0TG9ncyQ6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdCgpO1xyXG4gIHByaXZhdGUgZGVzdHJveWVkJDogU3ViamVjdDx2b2lkPiA9IG5ldyBTdWJqZWN0KCk7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBpZ25vcmVcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCxcclxuICAgIEBJbmplY3QoJ2xvZ2dpbmdDb25maWcnKSBwcml2YXRlIGNvbmZpZzogTG9nQ29uZmlnLFxyXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChBdmxBdXRoU2VydmljZSkgcHJpdmF0ZSBhdXRoU2VydmljZTogQXZsQXV0aFNlcnZpY2VcclxuICApIHtcclxuICAgIHRoaXMuaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycyh7XHJcbiAgICAgIHRhcmdldE5hbWU6IHRoaXMuY29uZmlnLnRhcmdldE5hbWUsXHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoY29uZmlnLmF1dG9sb2dnaW5nKSB7XHJcbiAgICAgIHRoaXMuYXV0aFNlcnZpY2U/LmlzTG9nZ2VkSW4kLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveWVkJCkpLnN1YnNjcmliZSgoaXNMb2dnZWRJbikgPT4gdGhpcy5kZWNpZGVPbkxvZ2dpbmcoaXNMb2dnZWRJbikpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQGlnbm9yZVxyXG4gICAqL1xyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgdGhpcy5wb3N0TG9ncyQuY29tcGxldGUoKTtcclxuICAgIHRoaXMuZGVib3VuY2VUaW1lJC5jb21wbGV0ZSgpO1xyXG4gICAgdGhpcy5sb2dzJC5jb21wbGV0ZSgpO1xyXG4gICAgdGhpcy5zdG9wTG9nZ2luZyQubmV4dCgpO1xyXG4gICAgdGhpcy5zdG9wTG9nZ2luZyQuY29tcGxldGUoKTtcclxuICAgIHRoaXMuZGVzdHJveWVkJC5uZXh0KCk7XHJcbiAgICB0aGlzLmRlc3Ryb3llZCQuY29tcGxldGUoKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICogU3RhcnRzIHBlcmlvZGljYWwgbG9nZ2luZyBwcm9jZXNzLlxyXG4gICAqIFxyXG4gICAqIERlcGVuZHMgb24gX2RlYm91bmNlVGltZV8gYW5kIF9jYXBhY2l0eV8gcHJvcGVydGllcy5cclxuICAgKi9cclxuICBwdWJsaWMgc3RhcnRMb2dnaW5nKCk6IHZvaWQge1xyXG4gICAgdGhpcy5pc0xvZ2dpbmcgPSB0cnVlO1xyXG4gICAgdGhpcy5kZWJvdW5jZVRpbWUkXHJcbiAgICAgIC5waXBlKFxyXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLnN0b3BMb2dnaW5nJCksXHJcbiAgICAgICAgc3dpdGNoTWFwKChkZWJvdW5jZVRpbWUpID0+IHRoaXMucGVyaW9kaWNhbExvZ2dpbmcoZGVib3VuY2VUaW1lKSlcclxuICAgICAgKVxyXG4gICAgICAuc3Vic2NyaWJlKCgpID0+IHRoaXMub25Qb3N0TWVzc2FnZXMoKSk7XHJcblxyXG4gICAgdGhpcy5wb3N0TG9ncyRcclxuICAgICAgLnBpcGUoXHJcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuc3RvcExvZ2dpbmckKSxcclxuICAgICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5wb3N0TWVzc2FnZXMoKSlcclxuICAgICAgKVxyXG4gICAgICAuc3Vic2NyaWJlKCgpID0+IHRoaXMub25Qb3N0TWVzc2FnZXMoKSk7XHJcblxyXG4gICAgdGhpcy5zZXRMb2dnaW5nRGVib3VuY2VUaW1lKHRoaXMuY29uZmlnLmRlYm91bmNlVGltZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdG9wcyBsb2dnaW5nIHByb2Nlc3MuXHJcbiAgICovXHJcbiAgcHVibGljIHN0b3BMb2dnaW5nKCk6IHZvaWQge1xyXG4gICAgdGhpcy5pc0xvZ2dpbmcgPSBmYWxzZTtcclxuICAgIHRoaXMucG9zdExvZ3MoKTtcclxuICAgIHRoaXMuc3RvcExvZ2dpbmckLm5leHQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEdldHMgYWxsIGN1cnJlbnRseSBxdWV1ZWQgbG9ncyBhcyBhbiBvYnNlcnZhYmxlIHZhbHVlLlxyXG4gICAqIEByZXR1cm5zIEFsbCBjdXJyZW50bHkgcXVldWVkIGxvZ3MgYXMgYW4gb2JzZXJ2YWJsZSB2YWx1ZVxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRMb2dzJCgpOiBPYnNlcnZhYmxlPExvZ1tdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5sb2dzJC5hc09ic2VydmFibGUoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIExvZ3MgbWVzc2FnZSB3aXRoIGRlYnVnIHNldmVyaXR5LlxyXG4gICAqIEBwYXJhbSBtZXNzYWdlIE1lc3NhZ2UgdXNlZCBmb3IgY29uc3RydWN0aW5nIGEgZGVidWcgbG9nXHJcbiAgICogQHBhcmFtIGNvbXBvbmVudE5hbWUgTmFtZSBvZiB0aGUgY29tcG9uZW50IHdoaWNoIGNhbGxlZCB0aGlzIG1ldGhvZFxyXG4gICAqL1xyXG4gIHB1YmxpYyBkZWJ1ZyhtZXNzYWdlOiBzdHJpbmcsIGNvbXBvbmVudE5hbWU6IHN0cmluZyA9ICcnKTogdm9pZCB7XHJcbiAgICB0aGlzLmxvZyhtZXNzYWdlLCBMb2dTZXZlcml0eS5EZWJ1ZywgY29tcG9uZW50TmFtZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBMb2dzIG1lc3NhZ2Ugd2l0aCBpbmZvIHNldmVyaXR5LlxyXG4gICAqIEBwYXJhbSBtZXNzYWdlIE1lc3NhZ2UgdXNlZCBmb3IgY29uc3RydWN0aW5nIGEgaW5mbyBsb2dcclxuICAgKiBAcGFyYW0gY29tcG9uZW50TmFtZSBOYW1lIG9mIHRoZSBjb21wb25lbnQgd2hpY2ggY2FsbGVkIHRoaXMgbWV0aG9kXHJcbiAgICovXHJcbiAgcHVibGljIGluZm8obWVzc2FnZTogc3RyaW5nLCBjb21wb25lbnROYW1lOiBzdHJpbmcgPSAnJyk6IHZvaWQge1xyXG4gICAgdGhpcy5sb2cobWVzc2FnZSwgTG9nU2V2ZXJpdHkuSW5mbywgY29tcG9uZW50TmFtZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBMb2dzIG1lc3NhZ2Ugd2l0aCB3YXJuaW5nIHNldmVyaXR5LlxyXG4gICAqIEBwYXJhbSBtZXNzYWdlIE1lc3NhZ2UgdXNlZCBmb3IgY29uc3RydWN0aW5nIGEgd2FybmluZyBsb2dcclxuICAgKiBAcGFyYW0gY29tcG9uZW50TmFtZSBOYW1lIG9mIHRoZSBjb21wb25lbnQgd2hpY2ggY2FsbGVkIHRoaXMgbWV0aG9kXHJcbiAgICovXHJcbiAgcHVibGljIHdhcm4obWVzc2FnZTogc3RyaW5nLCBjb21wb25lbnROYW1lOiBzdHJpbmcgPSAnJyk6IHZvaWQge1xyXG4gICAgdGhpcy5sb2cobWVzc2FnZSwgTG9nU2V2ZXJpdHkuV2FybmluZywgY29tcG9uZW50TmFtZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBMb2dzIG1lc3NhZ2Ugd2l0aCBlcnJvciBzZXZlcml0eS5cclxuICAgKiBAcGFyYW0gbWVzc2FnZSBNZXNzYWdlIHVzZWQgZm9yIGNvbnN0cnVjdGluZyBhIGVycm9yIGxvZ1xyXG4gICAqIEBwYXJhbSBjb21wb25lbnROYW1lIE5hbWUgb2YgdGhlIGNvbXBvbmVudCB3aGljaCBjYWxsZWQgdGhpcyBtZXRob2RcclxuICAgKi9cclxuICBwdWJsaWMgZXJyb3IobWVzc2FnZTogc3RyaW5nLCBjb21wb25lbnROYW1lOiBzdHJpbmcgPSAnJyk6IHZvaWQge1xyXG4gICAgdGhpcy5sb2cobWVzc2FnZSwgTG9nU2V2ZXJpdHkuRXJyb3IsIGNvbXBvbmVudE5hbWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTG9ncyBtZXNzYWdlIHdpdGggZmF0YWwgc2V2ZXJpdHkuXHJcbiAgICogQHBhcmFtIG1lc3NhZ2UgTWVzc2FnZSB1c2VkIGZvciBjb25zdHJ1Y3RpbmcgYSBmYXRhbCBsb2dcclxuICAgKiBAcGFyYW0gY29tcG9uZW50TmFtZSBOYW1lIG9mIHRoZSBjb21wb25lbnQgd2hpY2ggY2FsbGVkIHRoaXMgbWV0aG9kXHJcbiAgICovXHJcbiAgcHVibGljIGZhdGFsKG1lc3NhZ2U6IHN0cmluZywgY29tcG9uZW50TmFtZTogc3RyaW5nID0gJycpOiB2b2lkIHtcclxuICAgIHRoaXMubG9nKG1lc3NhZ2UsIExvZ1NldmVyaXR5LkZhdGFsLCBjb21wb25lbnROYW1lKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldHRlciBmb3IgZGVib3VuY2UgdGltZSAobG9nIHBlcmlvZCkuXHJcbiAgICogQHBhcmFtIGRlYm91bmNlVGltZSBUaW1lIGluIG1pbGxpc2Vjb25kczsgZGV0ZXJtaW5lcyB0aGUgcGVyaW9kIG9mIEFQSSByZXF1ZXN0cyBmb3IgbG9nZ2luZ1xyXG4gICAqL1xyXG4gIHB1YmxpYyBzZXRMb2dnaW5nRGVib3VuY2VUaW1lKGRlYm91bmNlVGltZTogbnVtYmVyKTogdm9pZCB7XHJcbiAgICB0aGlzLmNvbmZpZy5kZWJvdW5jZVRpbWUgPSBkZWJvdW5jZVRpbWU7XHJcbiAgICB0aGlzLmRlYm91bmNlVGltZSQubmV4dChkZWJvdW5jZVRpbWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2V0dGVyIGZvciBnbG9iYWwgbG9nIGxldmVsLlxyXG4gICAqIEBwYXJhbSBnbG9iYWxMb2dMZXZlbCBNaW5pbXVtIG1lc3NhZ2Ugc2V2ZXJpdHkgdG8gbG9nXHJcbiAgICovXHJcbiAgcHVibGljIHNldEdsb2JhbExvZ0xldmVsKGdsb2JhbExvZ0xldmVsOiBMb2dTZXZlcml0eSk6IHZvaWQge1xyXG4gICAgdGhpcy5jb25maWcuZ2xvYmFsTG9nTGV2ZWwgPSBnbG9iYWxMb2dMZXZlbDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldHRlciBmb3IgbG9nIHF1ZXVlIGNhcGFjaXR5LlxyXG4gICAqIEBwYXJhbSBjYXBhY2l0eSBMb2cgcXVldWUgY2FwYWNpdHlcclxuICAgKi9cclxuICBwdWJsaWMgc2V0TG9nQ2FwYWNpdHkoY2FwYWNpdHk6IG51bWJlcik6IHZvaWQge1xyXG4gICAgdGhpcy5jb25maWcuY2FwYWNpdHkgPSBjYXBhY2l0eTtcclxuICB9XHJcblxyXG4gIC8vIExvZ2ljLCBwcml2YXRlIG1ldGhvZHNcclxuXHJcbiAgcHJpdmF0ZSBsb2cobWVzc2FnZTogc3RyaW5nLCBzZXZlcml0eTogTG9nU2V2ZXJpdHksIGNvbXBvbmVudE5hbWU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLmlzTG9nZ2luZyB8fCBzZXZlcml0eSA8IHRoaXMuY29uZmlnLmdsb2JhbExvZ0xldmVsKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmNyZWF0ZUFuZFN0b3JlTG9nKG1lc3NhZ2UsIHNldmVyaXR5LCBjb21wb25lbnROYW1lKTtcclxuICAgIHRoaXMuZGlzcGF0Y2hMb2dzKCk7XHJcblxyXG4gICAgaWYgKHRoaXMuaXNGdWxsQ2FwYWNpdHkoKSkge1xyXG4gICAgICB0aGlzLnBvc3RMb2dzJC5uZXh0KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNyZWF0ZUFuZFN0b3JlTG9nKG1lc3NhZ2U6IHN0cmluZywgc2V2ZXJpdHlUeXBlOiBMb2dTZXZlcml0eSwgY29tcG9uZW50TmFtZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBjb25zdCB0aW1lc3RhbXAgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XHJcbiAgICBjb25zdCB7IGFwcE5hbWUsIHZlcnNpb24gfSA9IHRoaXMuY29uZmlnO1xyXG4gICAgY29uc3Qgc2V2ZXJpdHkgPSBzZXZlcml0eVR5cGUudG9TdHJpbmcoKTtcclxuICAgIGNvbnN0IGxvZzogTG9nID0geyBtZXNzYWdlLCBzZXZlcml0eSwgdGltZXN0YW1wLCBjb21wb25lbnROYW1lLCBhcHBOYW1lLCB2ZXJzaW9uIH07XHJcbiAgICB0aGlzLmxvZ3MucHVzaChsb2cpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc0Z1bGxDYXBhY2l0eSgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLmxvZ3MubGVuZ3RoID49IHRoaXMuY29uZmlnLmNhcGFjaXR5O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjbGVhckxvZ3MoKTogdm9pZCB7XHJcbiAgICB0aGlzLmxvZ3MgPSBbXTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgb25Qb3N0TWVzc2FnZXMoKTogdm9pZCB7XHJcbiAgICB0aGlzLmNsZWFyTG9ncygpO1xyXG4gICAgdGhpcy5kaXNwYXRjaExvZ3MoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcG9zdExvZ3MoKTogdm9pZCB7XHJcbiAgICB0aGlzLnBvc3RMb2dzJC5uZXh0KCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHBlcmlvZGljYWxMb2dnaW5nKHBlcmlvZDogbnVtYmVyKTogT2JzZXJ2YWJsZTx2b2lkPiB7XHJcbiAgICByZXR1cm4gaW50ZXJ2YWwocGVyaW9kKS5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIGlmICghdGhpcy5sb2dzLmxlbmd0aCkge1xyXG4gICAgICAgICAgdGhpcy5kaXNwYXRjaExvZ3MoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG4gICAgICBmaWx0ZXIoKCkgPT4gISF0aGlzLmxvZ3MubGVuZ3RoKSxcclxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMucG9zdE1lc3NhZ2VzKCkpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwb3N0TWVzc2FnZXMoKTogT2JzZXJ2YWJsZTx2b2lkPiB7XHJcbiAgICByZXR1cm4gdGhpcy5odHRwLnBvc3Q8dm9pZD4odGhpcy5jb25maWcuZW5kcG9pbnQsIHRoaXMubG9ncywge1xyXG4gICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcnMsXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZGlzcGF0Y2hMb2dzKCk6IHZvaWQge1xyXG4gICAgdGhpcy5sb2dzJC5uZXh0KHRoaXMubG9ncyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGRlY2lkZU9uTG9nZ2luZyhpc0xvZ2dlZEluOiBib29sZWFuKTogdm9pZCB7XHJcbiAgICBpZiAoaXNMb2dnZWRJbikge1xyXG4gICAgICB0aGlzLnN0YXJ0TG9nZ2luZygpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5zdG9wTG9nZ2luZygpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=