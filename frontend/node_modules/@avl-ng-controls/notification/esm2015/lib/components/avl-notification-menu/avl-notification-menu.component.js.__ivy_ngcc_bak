var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { Component, ElementRef, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { NOTIFICATIONS_OVERFLOW_MENU, TYPE_ICON_MAPPINGS } from './avl-notification-menu.consts';
let AvlNotificationMenuComponent = class AvlNotificationMenuComponent {
    constructor() {
        this.open = false;
        this.openChange = new EventEmitter();
        this.openDetails = new EventEmitter();
        this.notificationStateChanged = new EventEmitter();
        this.markAllAsRead = new EventEmitter();
        this.markAllAsUnread = new EventEmitter();
        this.overflowMenuItems = [];
        this.notificationList = [];
        this.numberOfUnreadNotifications = 0;
        this.overflowMenuHandlers = {
            markAllAsRead: () => {
                this.markAllAsRead.emit();
                this.numberOfUnreadNotifications = 0;
            },
            markAllAsUnread: () => {
                this.markAllAsUnread.emit();
                this.numberOfUnreadNotifications = this.notificationList.length;
            },
            undefined: () => { }
        };
        this.translateLabels();
    }
    set notifications(notifications) {
        this.notificationList = this.prepareNotifications(notifications);
        this.numberOfUnreadNotifications = notifications.filter(notif => !notif.read).length;
    }
    ngAfterViewInit() {
        this.list.nativeElement.revertedList = true;
    }
    onNotificationStateChanged(event) {
        const notificationMenuItem = Object.assign({}, event.detail.value);
        const notification = Object.assign(Object.assign({}, notificationMenuItem), { read: notificationMenuItem.iconToggleValue });
        notification.read ? this.numberOfUnreadNotifications-- : this.numberOfUnreadNotifications++;
        this.notificationStateChanged.emit(notification);
        this.list.nativeElement.removeFocus();
    }
    onItemClicked(item) {
        this.overflowMenuHandlers[item.action]();
    }
    onOpenChanged(event) {
        if (!event.detail.value) {
            this.openChange.emit(false);
        }
        else {
            this.notificationList = [...this.notificationList];
        }
    }
    onOverflowMenuClicked() {
        this.list.nativeElement.removeFocus();
    }
    onDetailsClicked() {
        this.open = false;
        this.openDetails.emit();
        this.openChange.emit(false);
    }
    prepareNotifications(notifications) {
        return notifications.map(notification => (Object.assign(Object.assign({}, notification), { label: notification.messageText, sublabel: this.formatDateTime(notification.timestamp), icon: TYPE_ICON_MAPPINGS[notification.type], iconToggleUnchecked: 'mail', iconToggleChecked: 'communication:mail-outline', iconToggleValue: notification.read })));
    }
    formatDateTime(date) {
        return date === null
            ? ''
            : `${AvlLocalizationService.formatDateTime(date, {
                format: 'date-short'
            })} ${AvlLocalizationService.formatDateTime(date, { format: 'time-long' })}`;
    }
    translateLabels() {
        return __awaiter(this, void 0, void 0, function* () {
            if (!AvlLocalizationService || !AvlLocalizationService.translationService) {
                return;
            }
            this.overflowMenuItems = yield this.translateMenu(NOTIFICATIONS_OVERFLOW_MENU);
        });
    }
    translateMenu(menu) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield Promise.all(menu.map((group) => __awaiter(this, void 0, void 0, function* () { return yield this.translateMenuGroup(group); })));
        });
    }
    translateMenuGroup(group) {
        return __awaiter(this, void 0, void 0, function* () {
            return {
                items: yield Promise.all(group.items.map((item) => __awaiter(this, void 0, void 0, function* () { return yield this.translateMenuItem(item); })))
            };
        });
    }
    translateMenuItem(item) {
        return __awaiter(this, void 0, void 0, function* () {
            const translateService = AvlLocalizationService.translationService;
            return Object.assign(Object.assign({}, item), { label: yield translateService.translate(item.label), sublabel: item.sublabel ? yield translateService.translate(item.sublabel) : null });
        });
    }
};
__decorate([
    Input(),
    __metadata("design:type", Boolean)
], AvlNotificationMenuComponent.prototype, "open", void 0);
__decorate([
    Input(),
    __metadata("design:type", HTMLElement)
], AvlNotificationMenuComponent.prototype, "trigger", void 0);
__decorate([
    Input(),
    __metadata("design:type", Array),
    __metadata("design:paramtypes", [Array])
], AvlNotificationMenuComponent.prototype, "notifications", null);
__decorate([
    Output(),
    __metadata("design:type", Object)
], AvlNotificationMenuComponent.prototype, "openChange", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], AvlNotificationMenuComponent.prototype, "openDetails", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], AvlNotificationMenuComponent.prototype, "notificationStateChanged", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], AvlNotificationMenuComponent.prototype, "markAllAsRead", void 0);
__decorate([
    Output(),
    __metadata("design:type", Object)
], AvlNotificationMenuComponent.prototype, "markAllAsUnread", void 0);
__decorate([
    ViewChild('list'),
    __metadata("design:type", ElementRef)
], AvlNotificationMenuComponent.prototype, "list", void 0);
AvlNotificationMenuComponent = __decorate([
    Component({
        selector: 'avl-notification-menu',
        template: "<avl-popup\r\n  [noCloseOnInsideClick]=\"true\"\r\n  [open]=\"open\"\r\n  [trigger]=\"trigger\"\r\n  (open-changed)=\"onOpenChanged($event)\"\r\n>\r\n  <div id=\"header\">\r\n    <div id=\"headerText\">\r\n      <span>{{ 'VizBox.NotificationMenu.Notifications' | translate }}</span>\r\n      <span *ngIf=\"numberOfUnreadNotifications\"> ({{ numberOfUnreadNotifications }}) </span>\r\n    </div>\r\n    <avl-overflow-menu (itemClicked)=\"onItemClicked($event)\" [items]=\"overflowMenuItems\">\r\n      <avl-icon-button\r\n        icon=\"more-vert\"\r\n        slot=\"trigger\"\r\n        (click)=\"onOverflowMenuClicked()\"\r\n      ></avl-icon-button>\r\n    </avl-overflow-menu>\r\n  </div>\r\n  <avl-list\r\n    #list\r\n    [rows]=\"notificationList\"\r\n    (row-changed)=\"onNotificationStateChanged($event)\"\r\n  ></avl-list>\r\n  <div id=\"footer\">\r\n    <avl-button (click)=\"onDetailsClicked()\">{{ 'VizBox.NotificationMenu.Details' | translate }}</avl-button>\r\n  </div>\r\n</avl-popup>\r\n",
        styles: ["avl-popup{width:40%}avl-list{width:100%;height:250px;padding-top:8px;--avl-item-padding-left:16px;--avl-item-padding-right:16px;--notification-item-height:48px}#header{display:flex;align-items:center;justify-content:space-between;box-sizing:border-box;height:56px;padding:0 16px;border-bottom:1px solid var(--avl-overflow-menu-divider-color,var(--avl-divider-color))}#footer{display:flex;align-items:center;box-sizing:border-box;height:56px;border-top:1px solid var(--avl-overflow-menu-divider-color,var(--avl-divider-color))}#headerText{font-size:20px;color:var(--avl-primary-text-color);overflow:hidden;white-space:nowrap;text-overflow:ellipsis}"]
    }),
    __metadata("design:paramtypes", [])
], AvlNotificationMenuComponent);
export { AvlNotificationMenuComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXZsLW5vdGlmaWNhdGlvbi1tZW51LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BhdmwtbmctY29udHJvbHMvbm90aWZpY2F0aW9uLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvYXZsLW5vdGlmaWNhdGlvbi1tZW51L2F2bC1ub3RpZmljYXRpb24tbWVudS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsT0FBTyxFQUVMLFNBQVMsRUFDVCxVQUFVLEVBQ1YsWUFBWSxFQUNaLEtBQUssRUFDTCxNQUFNLEVBQ04sU0FBUyxFQUNWLE1BQU0sZUFBZSxDQUFDO0FBUXZCLE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBT2pHLElBQWEsNEJBQTRCLEdBQXpDLE1BQWEsNEJBQTRCO0lBaUN2QztRQWhDUyxTQUFJLEdBQVksS0FBSyxDQUFDO1FBUXJCLGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBVyxDQUFDO1FBQ3pDLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQVEsQ0FBQztRQUN2Qyw2QkFBd0IsR0FBRyxJQUFJLFlBQVksRUFBbUIsQ0FBQztRQUMvRCxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFRLENBQUM7UUFDekMsb0JBQWUsR0FBRyxJQUFJLFlBQVksRUFBUSxDQUFDO1FBSTlDLHNCQUFpQixHQUEyQixFQUFFLENBQUM7UUFDL0MscUJBQWdCLEdBQThCLEVBQUUsQ0FBQztRQUNqRCxnQ0FBMkIsR0FBVyxDQUFDLENBQUM7UUFFdkMseUJBQW9CLEdBQWtDO1lBQzVELGFBQWEsRUFBRSxHQUFHLEVBQUU7Z0JBQ2xCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQzFCLElBQUksQ0FBQywyQkFBMkIsR0FBRyxDQUFDLENBQUM7WUFDdkMsQ0FBQztZQUNELGVBQWUsRUFBRSxHQUFHLEVBQUU7Z0JBQ3BCLElBQUksQ0FB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QyxDQUFDLENBQUMsTUFBTSxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQ2hGO1FBQ0osQ0FBQztLQUFBO0NBQ0YsQ0FBQTtBQXhIVTtJQUFSLEtBQUssRUFBRTs7MERBQXVCO0FBQ3RCO0lBQVIsS0FBSyxFQUFFOzhCQUFVLFdBQVc7NkRBQUM7QUFFOUI7SUFEQyxLQUFLLEVBQUU7OztpRUFJUDtBQUVTO0lBQVQsTUFBTSxFQUFFOztnRUFBMEM7QUFDekM7SUFBVCxNQUFNLEVBQUU7O2lFQUF3QztBQUN2QztJQUFULE1BQU0sRUFBRTs7OEVBQWdFO0FBQy9EO0lBQVQsTUFBTSxFQUFFOzttRUFBMEM7QUFDekM7SUFBVCxNQUFNLEVBQUU7O3FFQUE0QztBQUVsQztJQUFsQixTQUFTLENBQUMsTUFBTSxDQUFDOzhCQUFPLFVBQVU7MERBQVU7QUFmbEMsNEJBQTRCO0lBTHhDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSx1QkFBdUI7UUFDakMsdy9CQUFxRDs7S0FFdEQsQ0FBQzs7R0FDVyw0QkFBNEIsQ0F5SHhDO1NBekhZLDRCQUE0QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgQWZ0ZXJWaWV3SW5pdCxcclxuICBDb21wb25lbnQsXHJcbiAgRWxlbWVudFJlZixcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgSW5wdXQsXHJcbiAgT3V0cHV0LFxyXG4gIFZpZXdDaGlsZFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBdmxMaXN0IH0gZnJvbSAnQGF2bC1jb250cm9scy9jb3JlL2Rpc3QvYXZsLWxpc3QvYXZsLWxpc3QuYXBpJztcclxuaW1wb3J0IHtcclxuICBBdmxPdmVyZmxvd01lbnVHcm91cCxcclxuICBBdmxPdmVyZmxvd01lbnVJdGVtXHJcbn0gZnJvbSAnQGF2bC1jb250cm9scy9jb3JlL2Rpc3QvYXZsLW92ZXJmbG93LW1lbnUvYXZsLW92ZXJmbG93LW1lbnUuYXBpJztcclxuaW1wb3J0IHsgQXZsTm90aWZpY2F0aW9uIH0gZnJvbSAnQGF2bC1jb250cm9scy9pbnRlcmZhY2VzJztcclxuaW1wb3J0IHsgQXZsTm90aWZpY2F0aW9uTWVudUl0ZW0gfSBmcm9tICcuLi8uLi9tb2RlbHMvbm90aWZpY2F0aW9uLW1lbnUubW9kZWwnO1xyXG5pbXBvcnQgeyBOT1RJRklDQVRJT05TX09WRVJGTE9XX01FTlUsIFRZUEVfSUNPTl9NQVBQSU5HUyB9IGZyb20gJy4vYXZsLW5vdGlmaWNhdGlvbi1tZW51LmNvbnN0cyc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ2F2bC1ub3RpZmljYXRpb24tbWVudScsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL2F2bC1ub3RpZmljYXRpb24tbWVudS5jb21wb25lbnQuaHRtbCcsXHJcbiAgc3R5bGVVcmxzOiBbJy4vYXZsLW5vdGlmaWNhdGlvbi1tZW51LmNvbXBvbmVudC5jc3MnXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgQXZsTm90aWZpY2F0aW9uTWVudUNvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQge1xyXG4gIEBJbnB1dCgpIG9wZW46IGJvb2xlYW4gPSBmYWxzZTtcclxuICBASW5wdXQoKSB0cmlnZ2VyOiBIVE1MRWxlbWVudDtcclxuICBASW5wdXQoKSBcclxuICBzZXQgbm90aWZpY2F0aW9ucyhub3RpZmljYXRpb25zOiBBdmxOb3RpZmljYXRpb25bXSkge1xyXG4gICAgdGhpcy5ub3RpZmljYXRpb25MaXN0ID0gdGhpcy5wcmVwYXJlTm90aWZpY2F0aW9ucyhub3RpZmljYXRpb25zKTtcclxuICAgIHRoaXMubnVtYmVyT2ZVbnJlYWROb3RpZmljYXRpb25zID0gbm90aWZpY2F0aW9ucy5maWx0ZXIobm90aWYgPT4gIW5vdGlmLnJlYWQpLmxlbmd0aDtcclxuICB9XHJcblxyXG4gIEBPdXRwdXQoKSBvcGVuQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxib29sZWFuPigpO1xyXG4gIEBPdXRwdXQoKSBvcGVuRGV0YWlscyA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcclxuICBAT3V0cHV0KCkgbm90aWZpY2F0aW9uU3RhdGVDaGFuZ2VkID0gbmV3IEV2ZW50RW1pdHRlcjxBdmxOb3RpZmljYXRpb24+KCk7XHJcbiAgQE91dHB1dCgpIG1hcmtBbGxBc1JlYWQgPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XHJcbiAgQE91dHB1dCgpIG1hcmtBbGxBc1VucmVhZCA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcclxuXHJcbiAgQFZpZXdDaGlsZCgnbGlzdCcpIGxpc3Q6IEVsZW1lbnRSZWY8QXZsTGlzdD47XHJcblxyXG4gIHB1YmxpYyBvdmVyZmxvd01lbnVJdGVtczogQXZsT3ZlcmZsb3dNZW51R3JvdXBbXSA9IFtdO1xyXG4gIHB1YmxpYyBub3RpZmljYXRpb25MaXN0OiBBdmxOb3RpZmljYXRpb25NZW51SXRlbVtdID0gW107XHJcbiAgcHVibGljIG51bWJlck9mVW5yZWFkTm90aWZpY2F0aW9uczogbnVtYmVyID0gMDtcclxuXHJcbiAgcHJpdmF0ZSBvdmVyZmxvd01lbnVIYW5kbGVyczogeyBba2V5OiBzdHJpbmddOiAoKSA9PiB2b2lkIH0gPSB7XHJcbiAgICBtYXJrQWxsQXNSZWFkOiAoKSA9PiB7XHJcbiAgICAgIHRoaXMubWFya0FsbEFzUmVhZC5lbWl0KCk7XHJcbiAgICAgIHRoaXMubnVtYmVyT2ZVbnJlYWROb3RpZmljYXRpb25zID0gMDtcclxuICAgIH0sXHJcbiAgICBtYXJrQWxsQXNVbnJlYWQ6ICgpID0+IHtcclxuICAgICAgdGhpcy5tYXJrQWxsQXNVbnJlYWQuZW1pdCgpO1xyXG4gICAgICB0aGlzLm51bWJlck9mVW5yZWFkTm90aWZpY2F0aW9ucyA9IHRoaXMubm90aWZpY2F0aW9uTGlzdC5sZW5ndGg7XHJcbiAgICB9LFxyXG4gICAgdW5kZWZpbmVkOiAoKSA9PiB7fVxyXG4gIH07XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgdGhpcy50cmFuc2xhdGVMYWJlbHMoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmxpc3QubmF0aXZlRWxlbWVudC5yZXZlcnRlZExpc3QgPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG9uTm90aWZpY2F0aW9uU3RhdGVDaGFuZ2VkKGV2ZW50OiBFdmVudCk6IHZvaWQge1xyXG4gICAgY29uc3Qgbm90aWZpY2F0aW9uTWVudUl0ZW06IEF2bE5vdGlmaWNhdGlvbk1lbnVJdGVtID0geyAuLi4oPEN1c3RvbUV2ZW50PmV2ZW50KS5kZXRhaWwudmFsdWUgfTtcclxuICAgIGNvbnN0IG5vdGlmaWNhdGlvbiA9IHtcclxuICAgICAgLi4ubm90aWZpY2F0aW9uTWVudUl0ZW0sXHJcbiAgICAgIHJlYWQ6IG5vdGlmaWNhdGlvbk1lbnVJdGVtLmljb25Ub2dnbGVWYWx1ZVxyXG4gICAgfSBhcyBBdmxOb3RpZmljYXRpb247XHJcbiAgICBub3RpZmljYXRpb24ucmVhZCA/IHRoaXMubnVtYmVyT2ZVbnJlYWROb3RpZmljYXRpb25zLS0gOiB0aGlzLm51bWJlck9mVW5yZWFkTm90aWZpY2F0aW9ucysrO1xyXG4gICAgdGhpcy5ub3RpZmljYXRpb25TdGF0ZUNoYW5nZWQuZW1pdChub3RpZmljYXRpb24pO1xyXG5cclxuICAgIHRoaXMubGlzdC5uYXRpdmVFbGVtZW50LnJlbW92ZUZvY3VzKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb25JdGVtQ2xpY2tlZChpdGVtOiBBdmxPdmVyZmxvd01lbnVJdGVtKTogdm9pZCB7XHJcbiAgICB0aGlzLm92ZXJmbG93TWVudUhhbmRsZXJzW2l0ZW0uYWN0aW9uXSgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG9uT3BlbkNoYW5nZWQoZXZlbnQ6IEV2ZW50KTogdm9pZCB7XHJcbiAgICBpZiAoISg8Q3VzdG9tRXZlbnQ+ZXZlbnQpLmRldGFpbC52YWx1ZSkge1xyXG4gICAgICB0aGlzLm9wZW5DaGFuZ2UuZW1pdChmYWxzZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLm5vdGlmaWNhdGlvbkxpc3QgPSBbLi4udGhpcy5ub3RpZmljYXRpb25MaXN0XTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBvbk92ZXJmbG93TWVudUNsaWNrZWQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmxpc3QubmF0aXZlRWxlbWVudC5yZW1vdmVGb2N1cygpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG9uRGV0YWlsc0NsaWNrZWQoKTogdm9pZCB7XHJcbiAgICB0aGlzLm9wZW4gPSBmYWxzZTtcclxuICAgIHRoaXMub3BlbkRldGFpbHMuZW1pdCgpO1xyXG4gICAgdGhpcy5vcGVuQ2hhbmdlLmVtaXQoZmFsc2UpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBwcmVwYXJlTm90aWZpY2F0aW9ucyhub3RpZmljYXRpb25zOiBBdmxOb3RpZmljYXRpb25bXSk6IEF2bE5vdGlmaWNhdGlvbk1lbnVJdGVtW10ge1xyXG4gICAgcmV0dXJuIG5vdGlmaWNhdGlvbnMubWFwKG5vdGlmaWNhdGlvbiA9PiAoe1xyXG4gICAgICAuLi5ub3RpZmljYXRpb24sXHJcbiAgICAgIGxhYmVsOiBub3RpZmljYXRpb24ubWVzc2FnZVRleHQsXHJcbiAgICAgIHN1YmxhYmVsOiB0aGlzLmZvcm1hdERhdGVUaW1lKG5vdGlmaWNhdGlvbi50aW1lc3RhbXApLFxyXG4gICAgICBpY29uOiBUWVBFX0lDT05fTUFQUElOR1Nbbm90aWZpY2F0aW9uLnR5cGVdLFxyXG4gICAgICBpY29uVG9nZ2xlVW5jaGVja2VkOiAnbWFpbCcsXHJcbiAgICAgIGljb25Ub2dnbGVDaGVja2VkOiAnY29tbXVuaWNhdGlvbjptYWlsLW91dGxpbmUnLFxyXG4gICAgICBpY29uVG9nZ2xlVmFsdWU6IG5vdGlmaWNhdGlvbi5yZWFkXHJcbiAgICB9KSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGZvcm1hdERhdGVUaW1lKGRhdGU6IERhdGUpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIGRhdGUgPT09IG51bGxcclxuICAgICAgPyAnJ1xyXG4gICAgICA6IGAke0F2bExvY2FsaXphdGlvblNlcnZpY2UuZm9ybWF0RGF0ZVRpbWUoZGF0ZSwge1xyXG4gICAgICAgICAgZm9ybWF0OiAnZGF0ZS1zaG9ydCdcclxuICAgICAgICB9KX0gJHtBdmxMb2NhbGl6YXRpb25TZXJ2aWNlLmZvcm1hdERhdGVUaW1lKGRhdGUsIHsgZm9ybWF0OiAndGltZS1sb25nJyB9KX1gO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyB0cmFuc2xhdGVMYWJlbHMoKSB7XHJcbiAgICBpZiAoIUF2bExvY2FsaXphdGlvblNlcnZpY2UgfHwgIUF2bExvY2FsaXphdGlvblNlcnZpY2UudHJhbnNsYXRpb25TZXJ2aWNlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLm92ZXJmbG93TWVudUl0ZW1zID0gYXdhaXQgdGhpcy50cmFuc2xhdGVNZW51KE5PVElGSUNBVElPTlNfT1ZFUkZMT1dfTUVOVSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIHRyYW5zbGF0ZU1lbnUobWVudTogQXZsT3ZlcmZsb3dNZW51R3JvdXBbXSk6IFByb21pc2U8QXZsT3ZlcmZsb3dNZW51R3JvdXBbXT4ge1xyXG4gICAgcmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKG1lbnUubWFwKGFzeW5jIGdyb3VwID0+IGF3YWl0IHRoaXMudHJhbnNsYXRlTWVudUdyb3VwKGdyb3VwKSkpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyB0cmFuc2xhdGVNZW51R3JvdXAoZ3JvdXA6IEF2bE92ZXJmbG93TWVudUdyb3VwKTogUHJvbWlzZTxBdmxPdmVyZmxvd01lbnVHcm91cD4ge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgaXRlbXM6IGF3YWl0IFByb21pc2UuYWxsKGdyb3VwLml0ZW1zLm1hcChhc3luYyBpdGVtID0+IGF3YWl0IHRoaXMudHJhbnNsYXRlTWVudUl0ZW0oaXRlbSkpKVxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgdHJhbnNsYXRlTWVudUl0ZW0oaXRlbTogQXZsT3ZlcmZsb3dNZW51SXRlbSk6IFByb21pc2U8QXZsT3ZlcmZsb3dNZW51SXRlbT4ge1xyXG4gICAgY29uc3QgdHJhbnNsYXRlU2VydmljZSA9IEF2bExvY2FsaXphdGlvblNlcnZpY2UudHJhbnNsYXRpb25TZXJ2aWNlO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgLi4uaXRlbSxcclxuICAgICAgbGFiZWw6IGF3YWl0IHRyYW5zbGF0ZVNlcnZpY2UudHJhbnNsYXRlKGl0ZW0ubGFiZWwpLFxyXG4gICAgICBzdWJsYWJlbDogaXRlbS5zdWJsYWJlbCA/IGF3YWl0IHRyYW5zbGF0ZVNlcnZpY2UudHJhbnNsYXRlKGl0ZW0uc3VibGFiZWwpIDogbnVsbFxyXG4gICAgfTtcclxuICB9XHJcbn1cclxuIl19