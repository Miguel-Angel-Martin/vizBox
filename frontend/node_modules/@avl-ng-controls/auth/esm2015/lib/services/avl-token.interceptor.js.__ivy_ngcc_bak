var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
import { Injectable, Inject } from '@angular/core';
import { from, throwError } from 'rxjs';
import { catchError, switchMap } from 'rxjs/operators';
import { AvlAuthService } from './avl-auth.service';
import { INTERCEPTOR_BASE_PATHS } from '../variables';
let AvlTokenInterceptor = class AvlTokenInterceptor {
    constructor(auth, basePaths) {
        this.auth = auth;
        this.basePaths = basePaths;
        for (const i in this.basePaths) {
            if (this.basePaths.hasOwnProperty(i)) {
                this.basePaths[i] = this.basePaths[i].toLowerCase();
            }
        }
    }
    intercept(req, next) {
        if (!this.isUrlInBasePaths(req)) {
            return next.handle(req);
        }
        if (this.auth.currentUser) {
            req = this.setAuthHeader(req);
        }
        return next
            .handle(req)
            .pipe(catchError((err) => this.handleHttpError(req, next, err)));
    }
    handleHttpError(req, next, err) {
        if (err.status === 401) {
            // Unauthorized, tokens expired
            return from(this.auth.refreshTokens()).pipe(switchMap(_ => next.handle(this.setAuthHeader(req))), catchError(_ => throwError(err)));
        }
        return throwError(err);
    }
    /** Check if request URL is in provided basePaths
     * @param request Http request instance whose URL is checked.
     */
    isUrlInBasePaths(request) {
        const url = request.url.toLowerCase();
        const path = this.basePaths.find(path => url.startsWith(path));
        return Boolean(path);
    }
    /** Sets access token to authorization header of HTTP request
     * @param request HTTP request instance
     * @returns Cloned HTTP with adapted headers
     */
    setAuthHeader(req) {
        const access_token = this.auth.currentUser.access_token;
        const header = `Bearer ${access_token}`;
        const headers = req.headers.set('Authorization', header);
        return req.clone({ headers });
    }
};
AvlTokenInterceptor.ctorParameters = () => [
    { type: AvlAuthService },
    { type: Array, decorators: [{ type: Inject, args: [INTERCEPTOR_BASE_PATHS,] }] }
];
AvlTokenInterceptor = __decorate([
    Injectable(),
    __param(1, Inject(INTERCEPTOR_BASE_PATHS)),
    __metadata("design:paramtypes", [AvlAuthService, Array])
], AvlTokenInterceptor);
export { AvlTokenInterceptor };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXZsLXRva2VuLmludGVyY2VwdG9yLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGF2bC1uZy1jb250cm9scy9hdXRoLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL2F2bC10b2tlbi5pbnRlcmNlcHRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQVFuRCxPQUFPLEVBQWMsSUFBSSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwRCxPQUFPLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXZELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFHdEQsSUFBYSxtQkFBbUIsR0FBaEMsTUFBYSxtQkFBbUI7SUFDOUIsWUFDUyxJQUFvQixFQUNlLFNBQW1CO1FBRHRELFNBQUksR0FBSixJQUFJLENBQWdCO1FBQ2UsY0FBUyxHQUFULFNBQVMsQ0FBVTtRQUU3RCxLQUFLLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDOUIsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsRUFBRTtnQkFDcEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO2FBQ3JEO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsU0FBUyxDQUFDLEdBQXFCLEVBQUUsSUFBaUI7UUFDaEQsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUMvQixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDekI7UUFFRCxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ3pCLEdBQUcsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQy9CO1FBRUQsT0FBTyxJQUFJO2FBQ1IsTUFBTSxDQUFDLEdBQUcsQ0FBQzthQUNYLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFzQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3hGLENBQUM7SUFFTyxlQUFlLENBQ3JCLEdBQXFCLEVBQ3JCLElBQWlCLEVBQ2pCLEdBQXNCO1FBRXRCLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxHQUFHLEVBQUU7WUFDdEIsK0JBQStCO1lBQy9CLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQ3pDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQ3BELFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUNqQyxDQUFDO1NBQ0g7UUFDRCxPQUFPLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBRUQ7O09BRUc7SUFDSyxnQkFBZ0IsQ0FBQyxPQUF5QjtRQUNoRCxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3RDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQy9ELE9BQU8sT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7SUFFRDs7O09BR0c7SUFDSyxhQUFhLENBQUMsR0FBcUI7UUFDekMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDO1FBQ3hELE1BQU0sTUFBTSxHQUFHLFVBQVUsWUFBWSxFQUFFLENBQUM7UUFDeEMsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRXpELE9BQU8sR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFDaEMsQ0FBQztDQUNGLENBQUE7O1lBM0RnQixjQUFjO3dDQUMxQixNQUFNLFNBQUMsc0JBQXNCOztBQUhyQixtQkFBbUI7SUFEL0IsVUFBVSxFQUFFO0lBSVIsV0FBQSxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtxQ0FEbEIsY0FBYztHQUZsQixtQkFBbUIsQ0E2RC9CO1NBN0RZLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge1xyXG4gIEh0dHBSZXF1ZXN0LFxyXG4gIEh0dHBIYW5kbGVyLFxyXG4gIEh0dHBFdmVudCxcclxuICBIdHRwSW50ZXJjZXB0b3IsXHJcbiAgSHR0cEVycm9yUmVzcG9uc2VcclxufSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20sIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgY2F0Y2hFcnJvciwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuaW1wb3J0IHsgQXZsQXV0aFNlcnZpY2UgfSBmcm9tICcuL2F2bC1hdXRoLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBJTlRFUkNFUFRPUl9CQVNFX1BBVEhTIH0gZnJvbSAnLi4vdmFyaWFibGVzJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEF2bFRva2VuSW50ZXJjZXB0b3IgaW1wbGVtZW50cyBIdHRwSW50ZXJjZXB0b3Ige1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHVibGljIGF1dGg6IEF2bEF1dGhTZXJ2aWNlLFxyXG4gICAgQEluamVjdChJTlRFUkNFUFRPUl9CQVNFX1BBVEhTKSBwcm90ZWN0ZWQgYmFzZVBhdGhzOiBzdHJpbmdbXVxyXG4gICkge1xyXG4gICAgZm9yIChjb25zdCBpIGluIHRoaXMuYmFzZVBhdGhzKSB7XHJcbiAgICAgIGlmICh0aGlzLmJhc2VQYXRocy5oYXNPd25Qcm9wZXJ0eShpKSkge1xyXG4gICAgICAgIHRoaXMuYmFzZVBhdGhzW2ldID0gdGhpcy5iYXNlUGF0aHNbaV0udG9Mb3dlckNhc2UoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaW50ZXJjZXB0KHJlcTogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+PiB7XHJcbiAgICBpZiAoIXRoaXMuaXNVcmxJbkJhc2VQYXRocyhyZXEpKSB7XHJcbiAgICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXEpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmF1dGguY3VycmVudFVzZXIpIHtcclxuICAgICAgcmVxID0gdGhpcy5zZXRBdXRoSGVhZGVyKHJlcSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5leHRcclxuICAgICAgLmhhbmRsZShyZXEpXHJcbiAgICAgIC5waXBlKGNhdGNoRXJyb3IoKGVycjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHRoaXMuaGFuZGxlSHR0cEVycm9yKHJlcSwgbmV4dCwgZXJyKSkpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVIdHRwRXJyb3IoXHJcbiAgICByZXE6IEh0dHBSZXF1ZXN0PGFueT4sXHJcbiAgICBuZXh0OiBIdHRwSGFuZGxlcixcclxuICAgIGVycjogSHR0cEVycm9yUmVzcG9uc2VcclxuICApOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgaWYgKGVyci5zdGF0dXMgPT09IDQwMSkge1xyXG4gICAgICAvLyBVbmF1dGhvcml6ZWQsIHRva2VucyBleHBpcmVkXHJcbiAgICAgIHJldHVybiBmcm9tKHRoaXMuYXV0aC5yZWZyZXNoVG9rZW5zKCkpLnBpcGUoXHJcbiAgICAgICAgc3dpdGNoTWFwKF8gPT4gbmV4dC5oYW5kbGUodGhpcy5zZXRBdXRoSGVhZGVyKHJlcSkpKSxcclxuICAgICAgICBjYXRjaEVycm9yKF8gPT4gdGhyb3dFcnJvcihlcnIpKVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRocm93RXJyb3IoZXJyKTtcclxuICB9XHJcblxyXG4gIC8qKiBDaGVjayBpZiByZXF1ZXN0IFVSTCBpcyBpbiBwcm92aWRlZCBiYXNlUGF0aHNcclxuICAgKiBAcGFyYW0gcmVxdWVzdCBIdHRwIHJlcXVlc3QgaW5zdGFuY2Ugd2hvc2UgVVJMIGlzIGNoZWNrZWQuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc1VybEluQmFzZVBhdGhzKHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBib29sZWFuIHtcclxuICAgIGNvbnN0IHVybCA9IHJlcXVlc3QudXJsLnRvTG93ZXJDYXNlKCk7XHJcbiAgICBjb25zdCBwYXRoID0gdGhpcy5iYXNlUGF0aHMuZmluZChwYXRoID0+IHVybC5zdGFydHNXaXRoKHBhdGgpKTtcclxuICAgIHJldHVybiBCb29sZWFuKHBhdGgpO1xyXG4gIH1cclxuXHJcbiAgLyoqIFNldHMgYWNjZXNzIHRva2VuIHRvIGF1dGhvcml6YXRpb24gaGVhZGVyIG9mIEhUVFAgcmVxdWVzdFxyXG4gICAqIEBwYXJhbSByZXF1ZXN0IEhUVFAgcmVxdWVzdCBpbnN0YW5jZVxyXG4gICAqIEByZXR1cm5zIENsb25lZCBIVFRQIHdpdGggYWRhcHRlZCBoZWFkZXJzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzZXRBdXRoSGVhZGVyKHJlcTogSHR0cFJlcXVlc3Q8YW55Pik6IEh0dHBSZXF1ZXN0PGFueT4ge1xyXG4gICAgY29uc3QgYWNjZXNzX3Rva2VuID0gdGhpcy5hdXRoLmN1cnJlbnRVc2VyLmFjY2Vzc190b2tlbjtcclxuICAgIGNvbnN0IGhlYWRlciA9IGBCZWFyZXIgJHthY2Nlc3NfdG9rZW59YDtcclxuICAgIGNvbnN0IGhlYWRlcnMgPSByZXEuaGVhZGVycy5zZXQoJ0F1dGhvcml6YXRpb24nLCBoZWFkZXIpO1xyXG5cclxuICAgIHJldHVybiByZXEuY2xvbmUoeyBoZWFkZXJzIH0pO1xyXG4gIH1cclxufVxyXG4iXX0=