var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { Injectable, Inject } from '@angular/core';
import { Location } from '@angular/common';
import { HttpBackend, HttpClient, HttpHeaders } from '@angular/common/http';
import { Observable, BehaviorSubject } from 'rxjs';
import { Router } from '@angular/router';
import { map, take, distinctUntilKeyChanged, skipWhile, catchError } from 'rxjs/operators';
import * as CryptoJS from 'crypto-js';
import { AvlAuthService } from './avl-auth.service';
import { AUTH_CONFIG } from '../variables';
import { TokensPending } from './token-pending';
import { TokenStorage } from './token-storage';
import { StorageNames } from './storage-names';
const LOGOUT_CONFIG_NOT_SET_ERROR = 'User signed out locally, but logout request towards OIDC server not initiated since logoutUrl is not set in authConfig.';
let AvlOidcCodeAuthService = class AvlOidcCodeAuthService extends AvlAuthService {
    constructor(httpBackend, authConfig, router, loc) {
        super();
        this.httpBackend = httpBackend;
        this.authConfig = authConfig;
        this.router = router;
        this.loc = loc;
        // success will be set after tokens are successfully fetched or not
        this.tokensPendingSubject = new BehaviorSubject(new TokensPending(false));
        /**
         * Observable tracking if redirected from idb
         * Resolves to true on redirection, false otherwise
         */
        this.redirectedFromLogIn = new BehaviorSubject(undefined);
        this.http = new HttpClient(this.httpBackend);
        this.tokensPending$ = this.tokensPendingSubject.asObservable();
        this.isLoggedIn$ = new Observable(observer => {
            const tokensPendingState = this.tokensPendingSubject.value;
            this.tokensPending$
                .pipe(distinctUntilKeyChanged('waiting'), skipWhile(tokenPending => tokenPending.waiting !== false), map(tokenPending => {
                if (tokenPending.success != null) {
                    observer.next(tokenPending.success);
                }
            }), take(1))
                .subscribe();
            if (tokensPendingState.waiting !== true && tokensPendingState.success !== null) {
                observer.next(this.currentUser != null && this.isAccessTokenValid());
            }
        });
        this.storage = new TokenStorage(this.authConfig.tokenPrefix);
        const user = this.storage.readUser();
        if (this.isUserInvalid(user)) {
            this.storage.clearUser();
        }
        else {
            this.persistUser(user);
        }
        // if user is not logged in and pkce exists handle redirect from oidc server if possible
        if (this.currentUser == null && this.pkce) {
            this.handleOidcRedirect();
        }
        else {
            this.redirectedFromLogIn.next(Boolean(this.currentUser));
        }
    }
    isUserInvalid(data) {
        return (data.username == null || data.access_token == null || data.access_token_expires < Date.now());
    }
    get pkce() {
        return this.storage.getItem('pkce') || undefined;
    }
    set pkce(c) {
        if (c) {
            this.storage.setItem('pkce', c);
        }
        else {
            this.storage.removeItem('pkce');
        }
    }
    get nonce() {
        return sessionStorage.getItem('nonce') || undefined;
    }
    set nonce(c) {
        if (c) {
            this.storage.setItem('nonce', c);
        }
        else {
            this.storage.removeItem('nonce');
        }
    }
    isAccessTokenValid() {
        return Date.now() < this.currentUser.access_token_expires;
    }
    persistUser(user) {
        if (!user) {
            this.clearUser();
            return;
        }
        this.storage.storeUser(user);
        this.userSubject.next(user);
    }
    clearUser() {
        this.storage.clearUser();
        this.userSubject.next(undefined);
    }
    /*
     * Checks if current url is redirect from oidc server and gets access token from the server.
     */
    handleOidcRedirect() {
        return __awaiter(this, void 0, void 0, function* () {
            const pkce = this.pkce;
            this.pkce = undefined;
            const urlParts = this.loc.path(true).split('?', 2);
            let urlHash;
            let first;
            let last;
            let urlPartSplit;
            if (urlParts.length === 2) {
                first = urlParts[1].lastIndexOf('#');
                if (first !== -1) {
                    last = urlParts[1].lastIndexOf('&');
                    urlHash = urlParts[1].slice(first, last);
                    urlPartSplit = urlParts[1].split('#', 2);
                    urlParts[1] = urlParts[1].split('&').pop();
                    urlParts[1] = urlPartSplit[0].concat('&').concat(urlParts[1]);
                }
            }
            let query = urlParts.length === 2 ? this.parseQueryString(urlParts[1]) : [];
            let queryCode;
            for (let i = query.length - 1; i >= 0; i--) {
                if (query[i].key === 'code') {
                    queryCode = query[i].value;
                    query = [...query.slice(0, i), ...query.slice(i + 1)];
                    break;
                }
            }
            if (urlParts.length === 2 && queryCode) {
                const nonce = this.nonce;
                this.nonce = undefined;
                const httpOptions = {
                    headers: new HttpHeaders({
                        code: queryCode,
                        verifier: pkce,
                        nonce: nonce
                    })
                };
                this.updateTokensPending(new TokensPending(true));
                try {
                    const user = yield this.http
                        .post(this.authConfig.tokenUrl, {}, httpOptions)
                        .pipe(map(token => this.readUserFromToken(token)))
                        .toPromise();
                    this.persistUser(user);
                    this.updateTokensPending(new TokensPending(false, true));
                }
                catch (error) {
                    this.updateTokensPending(new TokensPending(false, false), error.message);
                }
            }
            if (urlHash) {
                this.router.navigateByUrl(`${urlParts[0]}${this.reconstructQueryParamString(query)}${urlHash}`, { replaceUrl: true });
                this.redirectedFromLogIn.next(true);
            }
            else {
                this.router.navigateByUrl(`${urlParts[0]}${this.reconstructQueryParamString(query)}`, {
                    replaceUrl: true
                });
                this.redirectedFromLogIn.next(Boolean(this.currentUser));
            }
        });
    }
    reloadPersistedUserData() {
        var _a;
        const user = this.storage.readUser();
        if (((_a = this.currentUser) === null || _a === void 0 ? void 0 : _a.access_token) === (user === null || user === void 0 ? void 0 : user.access_token)) {
            return;
        }
        if (this.isUserInvalid(user)) {
            this.clearUser();
        }
        else {
            this.persistUser(user);
        }
    }
    reconstructQueryParamString(queryParams) {
        let s = '?';
        if (queryParams.length === 0) {
            return '';
        }
        for (const q of queryParams) {
            if (s === '?') {
                s += `${encodeURIComponent(q.key)}=${encodeURIComponent(q.value)}`;
            }
            else {
                s += `&${encodeURIComponent(q.key)}=${encodeURIComponent(q.value)}`;
            }
        }
        return s;
    }
    updateTokensPending(state, errorMessage) {
        // the order here is important
        // errorMessage will be set before isLoggedIn becomes false
        if (state.waiting === false) {
            this.errorMessageSubject.next(errorMessage);
        }
        this.tokensPendingSubject.next(state);
    }
    readUserFromToken(token) {
        var _a;
        const accessTokenClaims = this.readClaimsFromToken(token.accesstoken);
        // Calculate actual expiry date for this machine
        const accessTokenStoredAt = Date.now(); // [ms]
        const accessTokenExpiresAt = accessTokenStoredAt + token.expiresIn * 1000;
        const refreshTokenClaims = this.readClaimsFromToken(token.refreshtoken);
        let refreshTokenExpiresAt = null;
        if (refreshTokenClaims) {
            // If time value is 0 token lasts indefinitely
            const refreshTokenExpiresIn = refreshTokenClaims['exp'] !== 0 ? refreshTokenClaims['exp'] - refreshTokenClaims['iat'] : 0;
            const refreshTokenStoredAt = accessTokenStoredAt;
            refreshTokenExpiresAt =
                refreshTokenExpiresIn !== 0 ? refreshTokenStoredAt + refreshTokenExpiresIn * 1000 : 0;
        }
        const roles = accessTokenClaims === null || accessTokenClaims === void 0 ? void 0 : accessTokenClaims.roles;
        return {
            username: accessTokenClaims.preferred_username,
            name: (_a = accessTokenClaims.name) !== null && _a !== void 0 ? _a : accessTokenClaims.preferred_username,
            access_token: token.accesstoken,
            access_token_expires: accessTokenExpiresAt,
            access_token_stored: accessTokenStoredAt,
            refresh_token: token.refreshtoken,
            refresh_token_expires: refreshTokenExpiresAt,
            id_token: token.idToken,
            roles: roles
        };
    }
    refreshUserIfNeeded() {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            const accessTokenExpired = ((_a = this.currentUser) === null || _a === void 0 ? void 0 : _a.access_token_expires) < Date.now();
            if (accessTokenExpired) {
                yield this.refreshTokens();
            }
        });
    }
    /**
     * If needed, this method can be called to refresh tokens for current user
     * @returns Promise resolved with object containing new tokens
     */
    refreshTokens() {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            const refreshTokenValid = ((_a = this.currentUser) === null || _a === void 0 ? void 0 : _a.refresh_token_expires) > Date.now();
            if (!refreshTokenValid) {
                this.logout();
                return;
            }
            const httpOptions = {
                headers: new HttpHeaders({
                    grant_type: 'refresh_token',
                    'refresh-token': this.storage.getItem(StorageNames.RefreshToken)
                })
            };
            if (!this.authConfig.refreshUrl) {
                throw new Error('refreshUrl missing in AuthConfig');
            }
            this.updateTokensPending(new TokensPending(true));
            try {
                const user = yield this.http
                    .post(this.authConfig.refreshUrl, {}, httpOptions)
                    .pipe(map(token => this.readUserFromToken(token)))
                    .toPromise();
                this.persistUser(user);
                this.updateTokensPending(new TokensPending(false, true));
            }
            catch (error) {
                this.updateTokensPending(new TokensPending(false, false), error.message);
                throw error;
            }
        });
    }
    /**
     * Login user and redirect after successful authentication.
     * Custom auth services need to provide implementation
     * @param redirectUrl Url to redirect after successful authentication
     */
    login(redirectUrl) {
        location.href = this.generateLoginUrl(redirectUrl ? redirectUrl : location.href);
    }
    /**
     * Log out user and redirect after.
     * Custom auth services need to provide implementation
     * @param redirectUrl Url to redirect after logging out
     */
    logout(redirectUrl) {
        const { logoutUrl } = this.authConfig;
        if (!logoutUrl) {
            console.warn(LOGOUT_CONFIG_NOT_SET_ERROR);
        }
        const headers = new HttpHeaders({ 'refresh-token': this.currentUser.refresh_token });
        this.http
            .post(logoutUrl, {}, { headers })
            .pipe(catchError(error => {
            this.onLogout(redirectUrl);
            throw error;
        }))
            .subscribe(() => this.onLogout(redirectUrl));
    }
    onLogout(redirectUrl) {
        this.clearUser();
        this.redirectIfNeeded(redirectUrl);
    }
    redirectIfNeeded(redirectUrl) {
        if (redirectUrl) {
            this.navigateTo(redirectUrl);
        }
        else {
            this.reloadPage();
        }
    }
    reloadPage() {
        window.location.reload();
    }
    navigateTo(redirectUrl) {
        this.router.navigate([redirectUrl]);
    }
    generateLoginUrl(redirectUrl) {
        const redirect_b64 = '' + CryptoJS.enc.Base64.stringify(CryptoJS.enc.Utf8.parse(redirectUrl));
        // Generate a session value.
        const nonce = CryptoJS.lib.WordArray.random(16).toString();
        // Generate pkce
        const pkce = CryptoJS.lib.WordArray.random(32).toString();
        const bytes = CryptoJS.SHA256(pkce);
        let pkce_hash = CryptoJS.enc.Base64.stringify(bytes);
        // KeyCloak requires this - https://tools.ietf.org/html/rfc7636#appendix-A
        pkce_hash = pkce_hash.replace(/=/g, '');
        pkce_hash = pkce_hash.replace(/\+/g, '-');
        pkce_hash = pkce_hash.replace(/\//g, '_');
        this.pkce = pkce;
        this.nonce = nonce;
        let url = this.authConfig.loginUrl;
        url += '?' + this.authConfig.loginUrlParamRedirect + '=' + encodeURIComponent(redirect_b64);
        url += '&' + this.authConfig.loginUrlParamChallenge + '=' + encodeURIComponent(pkce_hash);
        url += '&' + this.authConfig.loginUrlParamNonce + '=' + encodeURIComponent(nonce);
        return url;
    }
    readClaimsFromToken(token) {
        if (!token.includes('.')) {
            // Token is not a valid JWT token
            return null;
        }
        const tokenParts = token.split('.');
        const claimsString = this.b64DecodeUnicode(tokenParts[1]);
        return JSON.parse(claimsString);
    }
    b64DecodeUnicode(str) {
        const base64 = str.replace(/\-/g, '+').replace(/\_/g, '/');
        return decodeURIComponent(atob(base64)
            .split('')
            .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
            .join(''));
    }
    parseQueryString(queryString) {
        if (!queryString.length) {
            return [];
        }
        const queryDict = [];
        const pairs = queryString.split('&');
        for (const pair of pairs) {
            const index = pair.indexOf('=');
            let key;
            let value;
            if (index === -1) {
                key = pair;
                value = undefined;
            }
            else {
                key = pair.substr(0, index);
                value = pair.substr(index + 1);
            }
            queryDict.push({
                key: decodeURIComponent(key),
                value: decodeURIComponent(value)
            });
        }
        return queryDict;
    }
    readUserFromSessionStorage() {
        return this.storage.readUser();
    }
    storeUserToSessionStorage(user) {
        this.storage.storeUser(user);
    }
    clearUserFromSessionStorage() {
        this.storage.clearUser();
    }
};
AvlOidcCodeAuthService.ctorParameters = () => [
    { type: HttpBackend },
    { type: undefined, decorators: [{ type: Inject, args: [AUTH_CONFIG,] }] },
    { type: Router },
    { type: Location }
];
AvlOidcCodeAuthService = __decorate([
    Injectable(),
    __param(1, Inject(AUTH_CONFIG)),
    __metadata("design:paramtypes", [HttpBackend, Object, Router,
        Location])
], AvlOidcCodeAuthService);
export { AvlOidcCodeAuthService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXZsLW9pZGMtY29kZS1hdXRoLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYXZsLW5nLWNvbnRyb2xzL2F1dGgvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvYXZsLW9pZGMtY29kZS1hdXRoLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzVFLE9BQU8sRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSx1QkFBdUIsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0YsT0FBTyxLQUFLLFFBQVEsTUFBTSxXQUFXLENBQUM7QUFHdEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxXQUFXLEVBQWMsTUFBTSxjQUFjLENBQUM7QUFDdkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUvQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFHL0MsTUFBTSwyQkFBMkIsR0FDL0IseUhBQXlILENBQUM7QUFHNUgsSUFBYSxzQkFBc0IsR0FBbkMsTUFBYSxzQkFBdUIsU0FBUSxjQUFjO0lBMkJ4RCxZQUNVLFdBQXdCLEVBQ0gsVUFBc0IsRUFDM0MsTUFB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LENBQUM7WUFDaEIsSUFBSSxLQUFhLENBQUM7WUFDbEIsSUFBSSxLQUFLLEtBQUssQ0FBQyxDQUFDLEVBQUU7Z0JBQ2hCLEdBQUcsR0FBRyxJQUFJLENBQUM7Z0JBQ1gsS0FBSyxHQUFHLFNBQVMsQ0FBQzthQUNuQjtpQkFBTTtnQkFDTCxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQzVCLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQzthQUNoQztZQUNELFNBQVMsQ0FBQyxJQUFJLENBQUM7Z0JBQ2IsR0FBRyxFQUFFLGtCQUFrQixDQUFDLEdBQUcsQ0FBQztnQkFDNUIsS0FBSyxFQUFFLGtCQUFrQixDQUFDLEtBQUssQ0FBQzthQUNqQyxDQUFDLENBQUM7U0FDSjtRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFTSwwQkFBMEI7UUFDL0IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ2pDLENBQUM7SUFFTSx5QkFBeUIsQ0FBQyxJQUFVO1FBQ3pDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFFTSwyQkFBMkI7UUFDaEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUMzQixDQUFDO0NBQ0YsQ0FBQTs7WUE3WndCLFdBQVc7NENBQy9CLE1BQU0sU0FBQyxXQUFXO1lBQ0gsTUFBTTtZQUNULFFBQVE7O0FBL0JaLHNCQUFzQjtJQURsQyxVQUFVLEVBQUU7SUE4QlIsV0FBQSxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUE7cUNBREMsV0FBVyxVQUVoQixNQUFNO1FBQ1QsUUFBUTtHQS9CWixzQkFBc0IsQ0F5YmxDO1NBemJZLHNCQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBMb2NhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcbmltcG9ydCB7IEh0dHBCYWNrZW5kLCBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCB7IG1hcCwgdGFrZSwgZGlzdGluY3RVbnRpbEtleUNoYW5nZWQsIHNraXBXaGlsZSwgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCAqIGFzIENyeXB0b0pTIGZyb20gJ2NyeXB0by1qcyc7XHJcblxyXG5pbXBvcnQgeyBVc2VyIH0gZnJvbSAnLi4vdXNlci5tb2RlbCc7XHJcbmltcG9ydCB7IEF2bEF1dGhTZXJ2aWNlIH0gZnJvbSAnLi9hdmwtYXV0aC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQVVUSF9DT05GSUcsIEF1dGhDb25maWcgfSBmcm9tICcuLi92YXJpYWJsZXMnO1xyXG5pbXBvcnQgeyBUb2tlbnNQZW5kaW5nIH0gZnJvbSAnLi90b2tlbi1wZW5kaW5nJztcclxuaW1wb3J0IHsgVG9rZW5TdG9yYWdlIH0gZnJvbSAnLi90b2tlbi1zdG9yYWdlJztcclxuaW1wb3J0IHsgVG9rZW5SZXNwb25zZSB9IGZyb20gJy4vdG9rZW4tcmVzcG9uc2UnO1xyXG5pbXBvcnQgeyBTdG9yYWdlTmFtZXMgfSBmcm9tICcuL3N0b3JhZ2UtbmFtZXMnO1xyXG5pbXBvcnQgeyBUb2tlbkNsYWltcyB9IGZyb20gJy4vdG9rZW4tY2xhaW1zJztcclxuXHJcbmNvbnN0IExPR09VVF9DT05GSUdfTk9UX1NFVF9FUlJPUiA9XHJcbiAgJ1VzZXIgc2lnbmVkIG91dCBsb2NhbGx5LCBidXQgbG9nb3V0IHJlcXVlc3QgdG93YXJkcyBPSURDIHNlcnZlciBub3QgaW5pdGlhdGVkIHNpbmNlIGxvZ291dFVybCBpcyBub3Qgc2V0IGluIGF1dGhDb25maWcuJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEF2bE9pZGNDb2RlQXV0aFNlcnZpY2UgZXh0ZW5kcyBBdmxBdXRoU2VydmljZSB7XHJcbiAgLy8gc3VjY2VzcyB3aWxsIGJlIHNldCBhZnRlciB0b2tlbnMgYXJlIHN1Y2Nlc3NmdWxseSBmZXRjaGVkIG9yIG5vdFxyXG4gIHByaXZhdGUgdG9rZW5zUGVuZGluZ1N1YmplY3QgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFRva2Vuc1BlbmRpbmc+KG5ldyBUb2tlbnNQZW5kaW5nKGZhbHNlKSk7XHJcblxyXG4gIC8qKlxyXG4gICAqIFdoZW4gZmV0Y2hpbmcgdG9rZW5zLCB0aGlzIG9ic2VydmFibGUgY2hhbmdlc1xyXG4gICAqIEByZXR1cm5zIE9ic2VydmFibGUgd2l0aCBmb2xsb3dpbmcgY29udGV4dDpcclxuICAgKiAtIHdhaXRpbmcgLSBpZiB0cnVlLCByZXF1ZXN0IGZvciBuZXcgdG9rZW5zIGlzIG1hZGUsIHRoaXMgaGFwcGVucyBvbiBpbml0aWFsIGF1dGhlbnRpY2F0aW9uIGFuZCBvbiByZWZyZXNoVG9rZW5zXHJcbiAgICogLSBzdWNjZXNzIC0gdHJ1ZSBmb3Igc3VjY2Vzc2Z1bCBhdXRoZW50aWNhdGlvblxyXG4gICAqL1xyXG4gIHB1YmxpYyB0b2tlbnNQZW5kaW5nJDogT2JzZXJ2YWJsZTxUb2tlbnNQZW5kaW5nPjtcclxuXHJcbiAgLyoqXHJcbiAgICogT2JzZXJ2YWJsZSB0cmFja2luZyBhdXRoZW50aWNhdGVkIHN0YXRlXHJcbiAgICogUmVzb2x2ZXMgdG8gdHJ1ZSBvbiBzdWNjZXNzZnVsIGxvZyBpbiwgZmFsc2Ugb3RoZXJ3aXNlXHJcbiAgICovXHJcbiAgcHVibGljIGlzTG9nZ2VkSW4kOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xyXG5cclxuICAvKipcclxuICAgKiBPYnNlcnZhYmxlIHRyYWNraW5nIGlmIHJlZGlyZWN0ZWQgZnJvbSBpZGJcclxuICAgKiBSZXNvbHZlcyB0byB0cnVlIG9uIHJlZGlyZWN0aW9uLCBmYWxzZSBvdGhlcndpc2VcclxuICAgKi9cclxuICBwdWJsaWMgcmVkaXJlY3RlZEZyb21Mb2dJbiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Ym9vbGVhbj4odW5kZWZpbmVkKTtcclxuXHJcbiAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50O1xyXG4gIHByaXZhdGUgc3RvcmFnZTogVG9rZW5TdG9yYWdlO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgaHR0cEJhY2tlbmQ6IEh0dHBCYWNrZW5kLFxyXG4gICAgQEluamVjdChBVVRIX0NPTkZJRykgcHJpdmF0ZSBhdXRoQ29uZmlnOiBBdXRoQ29uZmlnLFxyXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcclxuICAgIHByaXZhdGUgbG9jOiBMb2NhdGlvblxyXG4gICkge1xyXG4gICAgc3VwZXIoKTtcclxuXHJcbiAgICB0aGlzLmh0dHAgPSBuZXcgSHR0cENsaWVudCh0aGlzLmh0dHBCYWNrZW5kKTtcclxuXHJcbiAgICB0aGlzLnRva2Vuc1BlbmRpbmckID0gdGhpcy50b2tlbnNQZW5kaW5nU3ViamVjdC5hc09ic2VydmFibGUoKTtcclxuICAgIHRoaXMuaXNMb2dnZWRJbiQgPSBuZXcgT2JzZXJ2YWJsZTxib29sZWFuPihvYnNlcnZlciA9PiB7XHJcbiAgICAgIGNvbnN0IHRva2Vuc1BlbmRpbmdTdGF0ZSA9IHRoaXMudG9rZW5zUGVuZGluZ1N1YmplY3QudmFsdWU7XHJcbiAgICAgIHRoaXMudG9rZW5zUGVuZGluZyRcclxuICAgICAgICAucGlwZShcclxuICAgICAgICAgIGRpc3RpbmN0VW50aWxLZXlDaGFuZ2VkKCd3YWl0aW5nJyksXHJcbiAgICAgICAgICBza2lwV2hpbGUodG9rZW5QZW5kaW5nID0+IHRva2VuUGVuZGluZy53YWl0aW5nICE9PSBmYWxzZSksXHJcbiAgICAgICAgICBtYXAodG9rZW5QZW5kaW5nID0+IHtcclxuICAgICAgICAgICAgaWYgKHRva2VuUGVuZGluZy5zdWNjZXNzICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KHRva2VuUGVuZGluZy5zdWNjZXNzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgICB0YWtlKDEpXHJcbiAgICAgICAgKVxyXG4gICAgICAgIC5zdWJzY3JpYmUoKTtcclxuICAgICAgaWYgKHRva2Vuc1BlbmRpbmdTdGF0ZS53YWl0aW5nICE9PSB0cnVlICYmIHRva2Vuc1BlbmRpbmdTdGF0ZS5zdWNjZXNzICE9PSBudWxsKSB7XHJcbiAgICAgICAgb2JzZXJ2ZXIubmV4dCh0aGlzLmN1cnJlbnRVc2VyICE9IG51bGwgJiYgdGhpcy5pc0FjY2Vzc1Rva2VuVmFsaWQoKSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuc3RvcmFnZSA9IG5ldyBUb2tlblN0b3JhZ2UodGhpcy5hdXRoQ29uZmlnLnRva2VuUHJlZml4KTtcclxuICAgIGNvbnN0IHVzZXIgPSB0aGlzLnN0b3JhZ2UucmVhZFVzZXIoKTtcclxuXHJcbiAgICBpZiAodGhpcy5pc1VzZXJJbnZhbGlkKHVzZXIpKSB7XHJcbiAgICAgIHRoaXMuc3RvcmFnZS5jbGVhclVzZXIoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMucGVyc2lzdFVzZXIodXNlcik7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gaWYgdXNlciBpcyBub3QgbG9nZ2VkIGluIGFuZCBwa2NlIGV4aXN0cyBoYW5kbGUgcmVkaXJlY3QgZnJvbSBvaWRjIHNlcnZlciBpZiBwb3NzaWJsZVxyXG4gICAgaWYgKHRoaXMuY3VycmVudFVzZXIgPT0gbnVsbCAmJiB0aGlzLnBrY2UpIHtcclxuICAgICAgdGhpcy5oYW5kbGVPaWRjUmVkaXJlY3QoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMucmVkaXJlY3RlZEZyb21Mb2dJbi5uZXh0KEJvb2xlYW4odGhpcy5jdXJyZW50VXNlcikpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc1VzZXJJbnZhbGlkKGRhdGE6IFBhcnRpYWw8VXNlcj4pOiBib29sZWFuIHtcclxuICAgIHJldHVybiAoXHJcbiAgICAgIGRhdGEudXNlcm5hbWUgPT0gbnVsbCB8fCBkYXRhLmFjY2Vzc190b2tlbiA9PSBudWxsIHx8IGRhdGEuYWNjZXNzX3Rva2VuX2V4cGlyZXMgPCBEYXRlLm5vdygpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXQgcGtjZSgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xyXG4gICAgcmV0dXJuIHRoaXMuc3RvcmFnZS5nZXRJdGVtKCdwa2NlJykgfHwgdW5kZWZpbmVkO1xyXG4gIH1cclxuICBwcml2YXRlIHNldCBwa2NlKGM6IHN0cmluZyB8IHVuZGVmaW5lZCkge1xyXG4gICAgaWYgKGMpIHtcclxuICAgICAgdGhpcy5zdG9yYWdlLnNldEl0ZW0oJ3BrY2UnLCBjKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuc3RvcmFnZS5yZW1vdmVJdGVtKCdwa2NlJyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldCBub25jZSgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xyXG4gICAgcmV0dXJuIHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oJ25vbmNlJykgfHwgdW5kZWZpbmVkO1xyXG4gIH1cclxuICBwcml2YXRlIHNldCBub25jZShjOiBzdHJpbmcgfCB1bmRlZmluZWQpIHtcclxuICAgIGlmIChjKSB7XHJcbiAgICAgIHRoaXMuc3RvcmFnZS5zZXRJdGVtKCdub25jZScsIGMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5zdG9yYWdlLnJlbW92ZUl0ZW0oJ25vbmNlJyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzQWNjZXNzVG9rZW5WYWxpZCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBEYXRlLm5vdygpIDwgdGhpcy5jdXJyZW50VXNlci5hY2Nlc3NfdG9rZW5fZXhwaXJlcztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcGVyc2lzdFVzZXIodXNlcj86IFVzZXIpOiB2b2lkIHtcclxuICAgIGlmICghdXNlcikge1xyXG4gICAgICB0aGlzLmNsZWFyVXNlcigpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLnN0b3JhZ2Uuc3RvcmVVc2VyKHVzZXIpO1xyXG4gICAgdGhpcy51c2VyU3ViamVjdC5uZXh0KHVzZXIpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjbGVhclVzZXIoKTogdm9pZCB7XHJcbiAgICB0aGlzLnN0b3JhZ2UuY2xlYXJVc2VyKCk7XHJcbiAgICB0aGlzLnVzZXJTdWJqZWN0Lm5leHQodW5kZWZpbmVkKTtcclxuICB9XHJcblxyXG4gIC8qXHJcbiAgICogQ2hlY2tzIGlmIGN1cnJlbnQgdXJsIGlzIHJlZGlyZWN0IGZyb20gb2lkYyBzZXJ2ZXIgYW5kIGdldHMgYWNjZXNzIHRva2VuIGZyb20gdGhlIHNlcnZlci5cclxuICAgKi9cclxuICBwcml2YXRlIGFzeW5jIGhhbmRsZU9pZGNSZWRpcmVjdCgpIHtcclxuICAgIGNvbnN0IHBrY2UgPSB0aGlzLnBrY2U7XHJcbiAgICB0aGlzLnBrY2UgPSB1bmRlZmluZWQ7XHJcblxyXG4gICAgY29uc3QgdXJsUGFydHMgPSB0aGlzLmxvYy5wYXRoKHRydWUpLnNwbGl0KCc/JywgMik7XHJcbiAgICBsZXQgdXJsSGFzaDogc3RyaW5nO1xyXG4gICAgbGV0IGZpcnN0OiBudW1iZXI7XHJcbiAgICBsZXQgbGFzdDogbnVtYmVyO1xyXG4gICAgbGV0IHVybFBhcnRTcGxpdDogc3RyaW5nW107XHJcblxyXG4gICAgaWYgKHVybFBhcnRzLmxlbmd0aCA9PT0gMikge1xyXG4gICAgICBmaXJzdCA9IHVybFBhcnRzWzFdLmxhc3RJbmRleE9mKCcjJyk7XHJcbiAgICAgIGlmIChmaXJzdCAhPT0gLTEpIHtcclxuICAgICAgICBsYXN0ID0gdXJsUGFydHNbMV0ubGFzdEluZGV4T2YoJyYnKTtcclxuICAgICAgICB1cmxIYXNoID0gdXJsUGFydHNbMV0uc2xpY2UoZmlyc3QsIGxhc3QpO1xyXG4gICAgICAgIHVybFBhcnRTcGxpdCA9IHVybFBhcnRzWzFdLnNwbGl0KCcjJywgMik7XHJcbiAgICAgICAgdXJsUGFydHNbMV0gPSB1cmxQYXJ0c1sxXS5zcGxpdCgnJicpLnBvcCgpO1xyXG4gICAgICAgIHVybFBhcnRzWzFdID0gdXJsUGFydFNwbGl0WzBdLmNvbmNhdCgnJicpLmNvbmNhdCh1cmxQYXJ0c1sxXSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBsZXQgcXVlcnkgPSB1cmxQYXJ0cy5sZW5ndGggPT09IDIgPyB0aGlzLnBhcnNlUXVlcnlTdHJpbmcodXJsUGFydHNbMV0pIDogW107XHJcbiAgICBsZXQgcXVlcnlDb2RlOiBzdHJpbmc7XHJcbiAgICBmb3IgKGxldCBpID0gcXVlcnkubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcclxuICAgICAgaWYgKHF1ZXJ5W2ldLmtleSA9PT0gJ2NvZGUnKSB7XHJcbiAgICAgICAgcXVlcnlDb2RlID0gcXVlcnlbaV0udmFsdWU7XHJcbiAgICAgICAgcXVlcnkgPSBbLi4ucXVlcnkuc2xpY2UoMCwgaSksIC4uLnF1ZXJ5LnNsaWNlKGkgKyAxKV07XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmICh1cmxQYXJ0cy5sZW5ndGggPT09IDIgJiYgcXVlcnlDb2RlKSB7XHJcbiAgICAgIGNvbnN0IG5vbmNlID0gdGhpcy5ub25jZTtcclxuICAgICAgdGhpcy5ub25jZSA9IHVuZGVmaW5lZDtcclxuXHJcbiAgICAgIGNvbnN0IGh0dHBPcHRpb25zID0ge1xyXG4gICAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycyh7XHJcbiAgICAgICAgICBjb2RlOiBxdWVyeUNvZGUsXHJcbiAgICAgICAgICB2ZXJpZmllcjogcGtjZSxcclxuICAgICAgICAgIG5vbmNlOiBub25jZVxyXG4gICAgICAgIH0pXHJcbiAgICAgIH07XHJcblxyXG4gICAgICB0aGlzLnVwZGF0ZVRva2Vuc1BlbmRpbmcobmV3IFRva2Vuc1BlbmRpbmcodHJ1ZSkpO1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLmh0dHBcclxuICAgICAgICAgIC5wb3N0PFRva2VuUmVzcG9uc2U+KHRoaXMuYXV0aENvbmZpZy50b2tlblVybCwge30sIGh0dHBPcHRpb25zKVxyXG4gICAgICAgICAgLnBpcGUobWFwKHRva2VuID0+IHRoaXMucmVhZFVzZXJGcm9tVG9rZW4odG9rZW4pKSlcclxuICAgICAgICAgIC50b1Byb21pc2UoKTtcclxuICAgICAgICB0aGlzLnBlcnNpc3RVc2VyKHVzZXIpO1xyXG4gICAgICAgIHRoaXMudXBkYXRlVG9rZW5zUGVuZGluZyhuZXcgVG9rZW5zUGVuZGluZyhmYWxzZSwgdHJ1ZSkpO1xyXG4gICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIHRoaXMudXBkYXRlVG9rZW5zUGVuZGluZyhuZXcgVG9rZW5zUGVuZGluZyhmYWxzZSwgZmFsc2UpLCBlcnJvci5tZXNzYWdlKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmICh1cmxIYXNoKSB7XHJcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlQnlVcmwoXHJcbiAgICAgICAgYCR7dXJsUGFydHNbMF19JHt0aGlzLnJlY29uc3RydWN0UXVlcnlQYXJhbVN0cmluZyhxdWVyeSl9JHt1cmxIYXNofWAsXHJcbiAgICAgICAgeyByZXBsYWNlVXJsOiB0cnVlIH1cclxuICAgICAgKTtcclxuICAgICAgdGhpcy5yZWRpcmVjdGVkRnJvbUxvZ0luLm5leHQodHJ1ZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKGAke3VybFBhcnRzWzBdfSR7dGhpcy5yZWNvbnN0cnVjdFF1ZXJ5UGFyYW1TdHJpbmcocXVlcnkpfWAsIHtcclxuICAgICAgICByZXBsYWNlVXJsOiB0cnVlXHJcbiAgICAgIH0pO1xyXG4gICAgICB0aGlzLnJlZGlyZWN0ZWRGcm9tTG9nSW4ubmV4dChCb29sZWFuKHRoaXMuY3VycmVudFVzZXIpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyByZWxvYWRQZXJzaXN0ZWRVc2VyRGF0YSgpIHtcclxuICAgIGNvbnN0IHVzZXIgPSB0aGlzLnN0b3JhZ2UucmVhZFVzZXIoKTtcclxuICAgIGlmICh0aGlzLmN1cnJlbnRVc2VyPy5hY2Nlc3NfdG9rZW4gPT09IHVzZXI/LmFjY2Vzc190b2tlbikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuaXNVc2VySW52YWxpZCh1c2VyKSkge1xyXG4gICAgICB0aGlzLmNsZWFyVXNlcigpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5wZXJzaXN0VXNlcih1c2VyKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSByZWNvbnN0cnVjdFF1ZXJ5UGFyYW1TdHJpbmcocXVlcnlQYXJhbXM6IHsga2V5OiBzdHJpbmc7IHZhbHVlOiBzdHJpbmcgfVtdKTogc3RyaW5nIHtcclxuICAgIGxldCBzID0gJz8nO1xyXG4gICAgaWYgKHF1ZXJ5UGFyYW1zLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcbiAgICBmb3IgKGNvbnN0IHEgb2YgcXVlcnlQYXJhbXMpIHtcclxuICAgICAgaWYgKHMgPT09ICc/Jykge1xyXG4gICAgICAgIHMgKz0gYCR7ZW5jb2RlVVJJQ29tcG9uZW50KHEua2V5KX09JHtlbmNvZGVVUklDb21wb25lbnQocS52YWx1ZSl9YDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBzICs9IGAmJHtlbmNvZGVVUklDb21wb25lbnQocS5rZXkpfT0ke2VuY29kZVVSSUNvbXBvbmVudChxLnZhbHVlKX1gO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXBkYXRlVG9rZW5zUGVuZGluZyhzdGF0ZTogVG9rZW5zUGVuZGluZywgZXJyb3JNZXNzYWdlPzogc3RyaW5nKSB7XHJcbiAgICAvLyB0aGUgb3JkZXIgaGVyZSBpcyBpbXBvcnRhbnRcclxuICAgIC8vIGVycm9yTWVzc2FnZSB3aWxsIGJlIHNldCBiZWZvcmUgaXNMb2dnZWRJbiBiZWNvbWVzIGZhbHNlXHJcbiAgICBpZiAoc3RhdGUud2FpdGluZyA9PT0gZmFsc2UpIHtcclxuICAgICAgdGhpcy5lcnJvck1lc3NhZ2VTdWJqZWN0Lm5leHQoZXJyb3JNZXNzYWdlKTtcclxuICAgIH1cclxuICAgIHRoaXMudG9rZW5zUGVuZGluZ1N1YmplY3QubmV4dChzdGF0ZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlYWRVc2VyRnJvbVRva2VuKHRva2VuOiBUb2tlblJlc3BvbnNlKTogVXNlciB7XHJcbiAgICBjb25zdCBhY2Nlc3NUb2tlbkNsYWltcyA9IHRoaXMucmVhZENsYWltc0Zyb21Ub2tlbih0b2tlbi5hY2Nlc3N0b2tlbik7XHJcblxyXG4gICAgLy8gQ2FsY3VsYXRlIGFjdHVhbCBleHBpcnkgZGF0ZSBmb3IgdGhpcyBtYWNoaW5lXHJcbiAgICBjb25zdCBhY2Nlc3NUb2tlblN0b3JlZEF0ID0gRGF0ZS5ub3coKTsgLy8gW21zXVxyXG4gICAgY29uc3QgYWNjZXNzVG9rZW5FeHBpcmVzQXQgPSBhY2Nlc3NUb2tlblN0b3JlZEF0ICsgdG9rZW4uZXhwaXJlc0luICogMTAwMDtcclxuXHJcbiAgICBjb25zdCByZWZyZXNoVG9rZW5DbGFpbXMgPSB0aGlzLnJlYWRDbGFpbXNGcm9tVG9rZW4odG9rZW4ucmVmcmVzaHRva2VuKTtcclxuICAgIGxldCByZWZyZXNoVG9rZW5FeHBpcmVzQXQgPSBudWxsO1xyXG4gICAgaWYgKHJlZnJlc2hUb2tlbkNsYWltcykge1xyXG4gICAgICAvLyBJZiB0aW1lIHZhbHVlIGlzIDAgdG9rZW4gbGFzdHMgaW5kZWZpbml0ZWx5XHJcbiAgICAgIGNvbnN0IHJlZnJlc2hUb2tlbkV4cGlyZXNJbiA9XHJcbiAgICAgICAgcmVmcmVzaFRva2VuQ2xhaW1zWydleHAnXSAhPT0gMCA/IHJlZnJlc2hUb2tlbkNsYWltc1snZXhwJ10gLSByZWZyZXNoVG9rZW5DbGFpbXNbJ2lhdCddIDogMDtcclxuICAgICAgY29uc3QgcmVmcmVzaFRva2VuU3RvcmVkQXQgPSBhY2Nlc3NUb2tlblN0b3JlZEF0O1xyXG4gICAgICByZWZyZXNoVG9rZW5FeHBpcmVzQXQgPVxyXG4gICAgICAgIHJlZnJlc2hUb2tlbkV4cGlyZXNJbiAhPT0gMCA/IHJlZnJlc2hUb2tlblN0b3JlZEF0ICsgcmVmcmVzaFRva2VuRXhwaXJlc0luICogMTAwMCA6IDA7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgcm9sZXMgPSBhY2Nlc3NUb2tlbkNsYWltcz8ucm9sZXM7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdXNlcm5hbWU6IGFjY2Vzc1Rva2VuQ2xhaW1zLnByZWZlcnJlZF91c2VybmFtZSxcclxuICAgICAgbmFtZTogYWNjZXNzVG9rZW5DbGFpbXMubmFtZSA/PyBhY2Nlc3NUb2tlbkNsYWltcy5wcmVmZXJyZWRfdXNlcm5hbWUsXHJcbiAgICAgIGFjY2Vzc190b2tlbjogdG9rZW4uYWNjZXNzdG9rZW4sXHJcbiAgICAgIGFjY2Vzc190b2tlbl9leHBpcmVzOiBhY2Nlc3NUb2tlbkV4cGlyZXNBdCxcclxuICAgICAgYWNjZXNzX3Rva2VuX3N0b3JlZDogYWNjZXNzVG9rZW5TdG9yZWRBdCxcclxuICAgICAgcmVmcmVzaF90b2tlbjogdG9rZW4ucmVmcmVzaHRva2VuLFxyXG4gICAgICByZWZyZXNoX3Rva2VuX2V4cGlyZXM6IHJlZnJlc2hUb2tlbkV4cGlyZXNBdCxcclxuICAgICAgaWRfdG9rZW46IHRva2VuLmlkVG9rZW4sXHJcbiAgICAgIHJvbGVzOiByb2xlc1xyXG4gICAgfSBhcyBVc2VyO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHJlZnJlc2hVc2VySWZOZWVkZWQoKSB7XHJcbiAgICBjb25zdCBhY2Nlc3NUb2tlbkV4cGlyZWQgPSB0aGlzLmN1cnJlbnRVc2VyPy5hY2Nlc3NfdG9rZW5fZXhwaXJlcyA8IERhdGUubm93KCk7XHJcbiAgICBpZiAoYWNjZXNzVG9rZW5FeHBpcmVkKSB7XHJcbiAgICAgIGF3YWl0IHRoaXMucmVmcmVzaFRva2VucygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogSWYgbmVlZGVkLCB0aGlzIG1ldGhvZCBjYW4gYmUgY2FsbGVkIHRvIHJlZnJlc2ggdG9rZW5zIGZvciBjdXJyZW50IHVzZXJcclxuICAgKiBAcmV0dXJucyBQcm9taXNlIHJlc29sdmVkIHdpdGggb2JqZWN0IGNvbnRhaW5pbmcgbmV3IHRva2Vuc1xyXG4gICAqL1xyXG4gIHB1YmxpYyBhc3luYyByZWZyZXNoVG9rZW5zKCk6IFByb21pc2U8YW55PiB7XHJcbiAgICBjb25zdCByZWZyZXNoVG9rZW5WYWxpZCA9IHRoaXMuY3VycmVudFVzZXI/LnJlZnJlc2hfdG9rZW5fZXhwaXJlcyA+IERhdGUubm93KCk7XHJcbiAgICBpZiAoIXJlZnJlc2hUb2tlblZhbGlkKSB7XHJcbiAgICAgIHRoaXMubG9nb3V0KCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBodHRwT3B0aW9ucyA9IHtcclxuICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHtcclxuICAgICAgICBncmFudF90eXBlOiAncmVmcmVzaF90b2tlbicsXHJcbiAgICAgICAgJ3JlZnJlc2gtdG9rZW4nOiB0aGlzLnN0b3JhZ2UuZ2V0SXRlbShTdG9yYWdlTmFtZXMuUmVmcmVzaFRva2VuKVxyXG4gICAgICB9KVxyXG4gICAgfTtcclxuXHJcbiAgICBpZiAoIXRoaXMuYXV0aENvbmZpZy5yZWZyZXNoVXJsKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcigncmVmcmVzaFVybCBtaXNzaW5nIGluIEF1dGhDb25maWcnKTtcclxuICAgIH1cclxuICAgIHRoaXMudXBkYXRlVG9rZW5zUGVuZGluZyhuZXcgVG9rZW5zUGVuZGluZyh0cnVlKSk7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMuaHR0cFxyXG4gICAgICAgIC5wb3N0PFRva2VuUmVzcG9uc2U+KHRoaXMuYXV0aENvbmZpZy5yZWZyZXNoVXJsLCB7fSwgaHR0cE9wdGlvbnMpXHJcbiAgICAgICAgLnBpcGUobWFwKHRva2VuID0+IHRoaXMucmVhZFVzZXJGcm9tVG9rZW4odG9rZW4pKSlcclxuICAgICAgICAudG9Qcm9taXNlKCk7XHJcbiAgICAgIHRoaXMucGVyc2lzdFVzZXIodXNlcik7XHJcbiAgICAgIHRoaXMudXBkYXRlVG9rZW5zUGVuZGluZyhuZXcgVG9rZW5zUGVuZGluZyhmYWxzZSwgdHJ1ZSkpO1xyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgdGhpcy51cGRhdGVUb2tlbnNQZW5kaW5nKG5ldyBUb2tlbnNQZW5kaW5nKGZhbHNlLCBmYWxzZSksIGVycm9yLm1lc3NhZ2UpO1xyXG4gICAgICB0aHJvdyBlcnJvcjtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIExvZ2luIHVzZXIgYW5kIHJlZGlyZWN0IGFmdGVyIHN1Y2Nlc3NmdWwgYXV0aGVudGljYXRpb24uXHJcbiAgICogQ3VzdG9tIGF1dGggc2VydmljZXMgbmVlZCB0byBwcm92aWRlIGltcGxlbWVudGF0aW9uXHJcbiAgICogQHBhcmFtIHJlZGlyZWN0VXJsIFVybCB0byByZWRpcmVjdCBhZnRlciBzdWNjZXNzZnVsIGF1dGhlbnRpY2F0aW9uXHJcbiAgICovXHJcbiAgcHVibGljIGxvZ2luKHJlZGlyZWN0VXJsPzogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBsb2NhdGlvbi5ocmVmID0gdGhpcy5nZW5lcmF0ZUxvZ2luVXJsKHJlZGlyZWN0VXJsID8gcmVkaXJlY3RVcmwgOiBsb2NhdGlvbi5ocmVmKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIExvZyBvdXQgdXNlciBhbmQgcmVkaXJlY3QgYWZ0ZXIuXHJcbiAgICogQ3VzdG9tIGF1dGggc2VydmljZXMgbmVlZCB0byBwcm92aWRlIGltcGxlbWVudGF0aW9uXHJcbiAgICogQHBhcmFtIHJlZGlyZWN0VXJsIFVybCB0byByZWRpcmVjdCBhZnRlciBsb2dnaW5nIG91dFxyXG4gICAqL1xyXG4gIHB1YmxpYyBsb2dvdXQocmVkaXJlY3RVcmw/OiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGNvbnN0IHsgbG9nb3V0VXJsIH0gPSB0aGlzLmF1dGhDb25maWc7XHJcblxyXG4gICAgaWYgKCFsb2dvdXRVcmwpIHtcclxuICAgICAgY29uc29sZS53YXJuKExPR09VVF9DT05GSUdfTk9UX1NFVF9FUlJPUik7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycyh7ICdyZWZyZXNoLXRva2VuJzogdGhpcy5jdXJyZW50VXNlci5yZWZyZXNoX3Rva2VuIH0pO1xyXG4gICAgdGhpcy5odHRwXHJcbiAgICAgIC5wb3N0KGxvZ291dFVybCwge30sIHsgaGVhZGVycyB9KVxyXG4gICAgICAucGlwZShcclxuICAgICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICAgIHRoaXMub25Mb2dvdXQocmVkaXJlY3RVcmwpO1xyXG4gICAgICAgICAgdGhyb3cgZXJyb3I7XHJcbiAgICAgICAgfSlcclxuICAgICAgKVxyXG4gICAgICAuc3Vic2NyaWJlKCgpID0+IHRoaXMub25Mb2dvdXQocmVkaXJlY3RVcmwpKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgb25Mb2dvdXQocmVkaXJlY3RVcmw/OiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMuY2xlYXJVc2VyKCk7XHJcbiAgICB0aGlzLnJlZGlyZWN0SWZOZWVkZWQocmVkaXJlY3RVcmwpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWRpcmVjdElmTmVlZGVkKHJlZGlyZWN0VXJsPzogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBpZiAocmVkaXJlY3RVcmwpIHtcclxuICAgICAgdGhpcy5uYXZpZ2F0ZVRvKHJlZGlyZWN0VXJsKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMucmVsb2FkUGFnZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWxvYWRQYWdlKCk6IHZvaWQge1xyXG4gICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBuYXZpZ2F0ZVRvKHJlZGlyZWN0VXJsOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFtyZWRpcmVjdFVybF0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZW5lcmF0ZUxvZ2luVXJsKHJlZGlyZWN0VXJsOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgcmVkaXJlY3RfYjY0ID0gJycgKyBDcnlwdG9KUy5lbmMuQmFzZTY0LnN0cmluZ2lmeShDcnlwdG9KUy5lbmMuVXRmOC5wYXJzZShyZWRpcmVjdFVybCkpO1xyXG5cclxuICAgIC8vIEdlbmVyYXRlIGEgc2Vzc2lvbiB2YWx1ZS5cclxuICAgIGNvbnN0IG5vbmNlID0gQ3J5cHRvSlMubGliLldvcmRBcnJheS5yYW5kb20oMTYpLnRvU3RyaW5nKCk7XHJcblxyXG4gICAgLy8gR2VuZXJhdGUgcGtjZVxyXG4gICAgY29uc3QgcGtjZSA9IENyeXB0b0pTLmxpYi5Xb3JkQXJyYXkucmFuZG9tKDMyKS50b1N0cmluZygpO1xyXG4gICAgY29uc3QgYnl0ZXMgPSBDcnlwdG9KUy5TSEEyNTYocGtjZSkgYXMgQ3J5cHRvSlMuV29yZEFycmF5O1xyXG4gICAgbGV0IHBrY2VfaGFzaCA9IENyeXB0b0pTLmVuYy5CYXNlNjQuc3RyaW5naWZ5KGJ5dGVzKTtcclxuXHJcbiAgICAvLyBLZXlDbG9hayByZXF1aXJlcyB0aGlzIC0gaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzc2MzYjYXBwZW5kaXgtQVxyXG4gICAgcGtjZV9oYXNoID0gcGtjZV9oYXNoLnJlcGxhY2UoLz0vZywgJycpO1xyXG4gICAgcGtjZV9oYXNoID0gcGtjZV9oYXNoLnJlcGxhY2UoL1xcKy9nLCAnLScpO1xyXG4gICAgcGtjZV9oYXNoID0gcGtjZV9oYXNoLnJlcGxhY2UoL1xcLy9nLCAnXycpO1xyXG5cclxuICAgIHRoaXMucGtjZSA9IHBrY2U7XHJcbiAgICB0aGlzLm5vbmNlID0gbm9uY2U7XHJcblxyXG4gICAgbGV0IHVybCA9IHRoaXMuYXV0aENvbmZpZy5sb2dpblVybDtcclxuICAgIHVybCArPSAnPycgKyB0aGlzLmF1dGhDb25maWcubG9naW5VcmxQYXJhbVJlZGlyZWN0ICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHJlZGlyZWN0X2I2NCk7XHJcbiAgICB1cmwgKz0gJyYnICsgdGhpcy5hdXRoQ29uZmlnLmxvZ2luVXJsUGFyYW1DaGFsbGVuZ2UgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQocGtjZV9oYXNoKTtcclxuICAgIHVybCArPSAnJicgKyB0aGlzLmF1dGhDb25maWcubG9naW5VcmxQYXJhbU5vbmNlICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KG5vbmNlKTtcclxuICAgIHJldHVybiB1cmw7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlYWRDbGFpbXNGcm9tVG9rZW4odG9rZW46IHN0cmluZyk6IFRva2VuQ2xhaW1zIHwgbnVsbCB7XHJcbiAgICBpZiAoIXRva2VuLmluY2x1ZGVzKCcuJykpIHtcclxuICAgICAgLy8gVG9rZW4gaXMgbm90IGEgdmFsaWQgSldUIHRva2VuXHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgdG9rZW5QYXJ0cyA9IHRva2VuLnNwbGl0KCcuJyk7XHJcbiAgICBjb25zdCBjbGFpbXNTdHJpbmcgPSB0aGlzLmI2NERlY29kZVVuaWNvZGUodG9rZW5QYXJ0c1sxXSk7XHJcbiAgICByZXR1cm4gSlNPTi5wYXJzZShjbGFpbXNTdHJpbmcpIGFzIFRva2VuQ2xhaW1zO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBiNjREZWNvZGVVbmljb2RlKHN0cjogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IGJhc2U2NCA9IHN0ci5yZXBsYWNlKC9cXC0vZywgJysnKS5yZXBsYWNlKC9cXF8vZywgJy8nKTtcclxuXHJcbiAgICByZXR1cm4gZGVjb2RlVVJJQ29tcG9uZW50KFxyXG4gICAgICBhdG9iKGJhc2U2NClcclxuICAgICAgICAuc3BsaXQoJycpXHJcbiAgICAgICAgLm1hcChjID0+ICclJyArICgnMDAnICsgYy5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KSkuc2xpY2UoLTIpKVxyXG4gICAgICAgIC5qb2luKCcnKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcGFyc2VRdWVyeVN0cmluZyhxdWVyeVN0cmluZzogc3RyaW5nKTogeyBrZXk6IHN0cmluZzsgdmFsdWU6IHN0cmluZyB9W10ge1xyXG4gICAgaWYgKCFxdWVyeVN0cmluZy5sZW5ndGgpIHtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcXVlcnlEaWN0ID0gW107XHJcbiAgICBjb25zdCBwYWlycyA9IHF1ZXJ5U3RyaW5nLnNwbGl0KCcmJyk7XHJcbiAgICBmb3IgKGNvbnN0IHBhaXIgb2YgcGFpcnMpIHtcclxuICAgICAgY29uc3QgaW5kZXggPSBwYWlyLmluZGV4T2YoJz0nKTtcclxuICAgICAgbGV0IGtleTogc3RyaW5nO1xyXG4gICAgICBsZXQgdmFsdWU6IHN0cmluZztcclxuICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xyXG4gICAgICAgIGtleSA9IHBhaXI7XHJcbiAgICAgICAgdmFsdWUgPSB1bmRlZmluZWQ7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAga2V5ID0gcGFpci5zdWJzdHIoMCwgaW5kZXgpO1xyXG4gICAgICAgIHZhbHVlID0gcGFpci5zdWJzdHIoaW5kZXggKyAxKTtcclxuICAgICAgfVxyXG4gICAgICBxdWVyeURpY3QucHVzaCh7XHJcbiAgICAgICAga2V5OiBkZWNvZGVVUklDb21wb25lbnQoa2V5KSxcclxuICAgICAgICB2YWx1ZTogZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiBxdWVyeURpY3Q7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcmVhZFVzZXJGcm9tU2Vzc2lvblN0b3JhZ2UoKTogVXNlciB7XHJcbiAgICByZXR1cm4gdGhpcy5zdG9yYWdlLnJlYWRVc2VyKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc3RvcmVVc2VyVG9TZXNzaW9uU3RvcmFnZSh1c2VyOiBVc2VyKTogdm9pZCB7XHJcbiAgICB0aGlzLnN0b3JhZ2Uuc3RvcmVVc2VyKHVzZXIpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGNsZWFyVXNlckZyb21TZXNzaW9uU3RvcmFnZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuc3RvcmFnZS5jbGVhclVzZXIoKTtcclxuICB9XHJcbn1cclxuIl19