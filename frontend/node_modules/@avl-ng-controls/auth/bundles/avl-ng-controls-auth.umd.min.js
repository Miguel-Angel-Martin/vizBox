!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs"),require("@angular/common"),require("@angular/common/http"),require("@angular/router"),require("rxjs/operators"),require("crypto-js")):"function"==typeof define&&define.amd?define("@avl-ng-controls/auth",["exports","@angular/core","rxjs","@angular/common","@angular/common/http","@angular/router","rxjs/operators","crypto-js"],t):t(((e=e||self)["avl-ng-controls"]=e["avl-ng-controls"]||{},e["avl-ng-controls"].auth={}),e.ng.core,e.rxjs,e.ng.common,e.ng.common.http,e.ng.router,e.rxjs.operators,e.cryptoJs)}(this,(function(e,t,r,n,o,s,i,a){"use strict";var c,u=new t.InjectionToken(void 0),l=new t.InjectionToken(void 0),h=function(){function e(){this.userSubject=new r.BehaviorSubject(void 0),this.user$=this.userSubject.asObservable(),this.errorMessageSubject=new r.BehaviorSubject(void 0),this.errorMessage$=this.errorMessageSubject.asObservable()}return Object.defineProperty(e.prototype,"currentUser",{get:function(){return this.userSubject.value},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"errorMessage",{get:function(){return this.errorMessageSubject.value},enumerable:!0,configurable:!0}),e.prototype.clearErrorMessage=function(){this.errorMessageSubject.next(void 0)},e}(),f=function(e,t){this.waiting=e,this.success=t};!function(e){e.AccessToken="access_token",e.AccessTokenExpiresAt="access_token_expires_at",e.AccessTokenStoredAt="access_token_stored_at",e.RefreshToken="refresh_token",e.RefreshTokenExpiresAt="refresh_token_expires_at",e.IdToken="id_token",e.Roles="roles",e.UserName="username",e.Name="name"}(c||(c={}));var p,d=function(){function e(e){this.prefix="",this.prefix=null!=e?e:""}return e.prototype.readUser=function(){var e=JSON.parse(this.getItem(c.Roles));return{username:this.getItem(c.UserName),name:this.getItem(c.Name),access_token:this.getItem(c.AccessToken),access_token_expires:this.getNumber(c.AccessTokenExpiresAt),refresh_token:this.getItem(c.RefreshToken),refresh_token_expires:this.getNumber(c.RefreshTokenExpiresAt),id_token:this.getItem(c.IdToken),roles:e}},e.prototype.storeUser=function(e){this.setItem(c.UserName,e.username),this.setItem(c.Name,e.name),this.setItem(c.AccessToken,e.access_token),this.setItem(c.AccessTokenExpiresAt,""+e.access_token_expires),this.setItem(c.RefreshToken,e.refresh_token),this.setItem(c.RefreshTokenExpiresAt,""+e.refresh_token_expires),this.setItem(c.IdToken,e.id_token);var t=JSON.stringify(e.roles);sessionStorage.setItem(c.Roles,""+t)},e.prototype.clearUser=function(){for(var e in c)c.hasOwnProperty(e)&&this.removeItem(c[e])},e.prototype.getNumber=function(e){return parseInt(this.getItem(e),10)},e.prototype.getItem=function(e){return sessionStorage.getItem(this.prefix+e)},e.prototype.setItem=function(e,t){sessionStorage.setItem(this.prefix+e,t)},e.prototype.removeItem=function(e){sessionStorage.removeItem(this.prefix+e)},e}(),g=this&&this.__extends||(p=function(e,t){return(p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}p(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),m=this&&this.__decorate||function(e,t,r,n){var o,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(i=(s<3?o(i):s>3?o(t,r,i):o(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},y=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},v=this&&this.__param||function(e,t){return function(r,n){t(r,n,e)}},b=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,s){function i(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}c((n=n.apply(e,t||[])).next())}))},k=this&&this.__generator||function(e,t){var r,n,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],n=0}finally{r=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},_=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,s=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)i.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(o)throw o.error}}return i},U=this&&this.__spread||function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(_(arguments[t]));return e},I=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},w=function(e){function l(t,n,s,a){var c=e.call(this)||this;c.httpBackend=t,c.authConfig=n,c.router=s,c.loc=a,c.tokensPendingSubject=new r.BehaviorSubject(new f(!1)),c.redirectedFromLogIn=new r.BehaviorSubject(void 0),c.http=new o.HttpClient(c.httpBackend),c.tokensPending$=c.tokensPendingSubject.asObservable(),c.isLoggedIn$=new r.Observable((function(e){var t=c.tokensPendingSubject.value;c.tokensPending$.pipe(i.distinctUntilKeyChanged("waiting"),i.skipWhile((function(e){return!1!==e.waiting})),i.map((function(t){null!=t.success&&e.next(t.success)})),i.take(1)).subscribe(),!0!==t.waiting&&null!==t.success&&e.next(null!=c.currentUser&&c.isAccessTokenValid())})),c.storage=new d(c.authConfig.tokenPrefix);var u=c.storage.readUser();return c.persistedUserInvalid(u)?c.clearUser():c.persistUser(u),null==c.currentUser&&c.pkce?c.handleOidcRedirect():c.redirectedFromLogIn.next(Boolean(c.currentUser)),c}return g(l,e),l.prototype.persistedUserInvalid=function(e){return null==e.username||null==e.access_token||e.access_token_expires<Date.now()},Object.defineProperty(l.prototype,"pkce",{get:function(){return this.storage.getItem("pkce")||void 0},set:function(e){e?this.storage.setItem("pkce",e):this.storage.removeItem("pkce")},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"nonce",{get:function(){return sessionStorage.getItem("nonce")||void 0},set:function(e){e?this.storage.setItem("nonce",e):this.storage.removeItem("nonce")},enumerable:!0,configurable:!0}),l.prototype.isAccessTokenValid=function(){return Date.now()<this.currentUser.access_token_expires},l.prototype.persistUser=function(e){e?(this.storage.storeUser(e),this.userSubject.next(e)):this.clearUser()},l.prototype.clearUser=function(){this.storage.clearUser(),this.userSubject.next(void 0)},l.prototype.handleOidcRedirect=function(){return b(this,void 0,void 0,(function(){var e,t,r,n,s,a,c,u,l,h,p,d,g,m=this;return k(this,(function(y){switch(y.label){case 0:for(e=this.pkce,this.pkce=void 0,2===(t=this.loc.path(!0).split("?",2)).length&&-1!==(n=t[1].lastIndexOf("#"))&&(s=t[1].lastIndexOf("&"),r=t[1].slice(n,s),a=t[1].split("#",2),t[1]=t[1].split("&").pop(),t[1]=a[0].concat("&").concat(t[1])),c=2===t.length?this.parseQueryString(t[1]):[],l=c.length-1;l>=0;l--)if("code"===c[l].key){u=c[l].value,c=U(c.slice(0,l),c.slice(l+1));break}if(2!==t.length||!u)return[3,4];h=this.nonce,this.nonce=void 0,p={headers:new o.HttpHeaders({code:u,verifier:e,nonce:h})},this.updateTokensPending(new f(!0)),y.label=1;case 1:return y.trys.push([1,3,,4]),[4,this.http.post(this.authConfig.tokenUrl,{},p).pipe(i.map((function(e){return m.readUserFromToken(e)}))).toPromise()];case 2:return d=y.sent(),this.persistUser(d),this.updateTokensPending(new f(!1,!0)),[3,4];case 3:return g=y.sent(),this.updateTokensPending(new f(!1,!1),g.message),[3,4];case 4:return r?(this.router.navigateByUrl(""+t[0]+this.reconstructQueryParamString(c)+r,{replaceUrl:!0}),this.redirectedFromLogIn.next(!0)):(this.router.navigateByUrl(""+t[0]+this.reconstructQueryParamString(c),{replaceUrl:!0}),this.redirectedFromLogIn.next(Boolean(this.currentUser))),[2]}}))}))},l.prototype.reloadPersistedUserData=function(){var e=this.storage.readUser();this.persistedUserInvalid(e)?this.clearUser():this.persistUser(e)},l.prototype.reconstructQueryParamString=function(e){var t,r,n="?";if(0===e.length)return"";try{for(var o=I(e),s=o.next();!s.done;s=o.next()){var i=s.value;n+="?"===n?encodeURIComponent(i.key)+"="+encodeURIComponent(i.value):"&"+encodeURIComponent(i.key)+"="+encodeURIComponent(i.value)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return n},l.prototype.updateTokensPending=function(e,t){!1===e.waiting&&this.errorMessageSubject.next(t),this.tokensPendingSubject.next(e)},l.prototype.readUserFromToken=function(e){var t,r=this.readClaimsFromToken(e.accesstoken),n=Date.now(),o=n+1e3*e.expiresIn,s=this.readClaimsFromToken(e.refreshtoken),i=null;if(s){var a=0!==s.exp?s.exp-s.iat:0;i=0!==a?n+1e3*a:0}var u=null==r?void 0:r.roles;if(u&&this.hasRequiredRole(u))return this.storage.setItem(c.AccessTokenStoredAt,""+n),{username:r.preferred_username,name:null!==(t=r.name)&&void 0!==t?t:r.preferred_username,access_token:e.accesstoken,access_token_expires:o,refresh_token:e.refreshtoken,refresh_token_expires:i,id_token:e.idToken,roles:u};throw new Error("Role "+this.authConfig.requiredRole+" not in claims")},l.prototype.hasRequiredRole=function(e){return!this.authConfig.requiredRole||this.authConfig.requiredRole&&-1!==e.indexOf(this.authConfig.requiredRole)},l.prototype.refreshTokens=function(){return b(this,void 0,void 0,(function(){var e,t,r,n=this;return k(this,(function(s){switch(s.label){case 0:if(e={headers:new o.HttpHeaders({grant_type:"refresh_token","refresh-token":this.storage.getItem(c.RefreshToken)})},!this.authConfig.refreshUrl)throw new Error("refreshUrl missing in AuthConfig");this.updateTokensPending(new f(!0)),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,this.http.post(this.authConfig.refreshUrl,{},e).pipe(i.map((function(e){return n.readUserFromToken(e)}))).toPromise()];case 2:return t=s.sent(),this.persistUser(t),this.updateTokensPending(new f(!1,!0)),[3,4];case 3:throw r=s.sent(),this.updateTokensPending(new f(!1,!1),r.message),r;case 4:return[2]}}))}))},l.prototype.login=function(e){location.href=this.generateLoginUrl(e||location.href)},l.prototype.logout=function(e){var t=null!=this.authConfig.logoutUrl||null!=this.authConfig.logoutUrlParamIdToken,r=this.userSubject.getValue();if(this.clearUser(),t){var n=this.authConfig.logoutUrl+"?"+this.authConfig.logoutUrlParamIdToken+"="+encodeURIComponent(r.id_token);this.authConfig.logoutUrlParamRedirect&&(e=null!=e?e:location.href.split("?")[0],n=n+"&"+this.authConfig.logoutUrlParamRedirect+"="+encodeURIComponent(e)),location.href=n}else console.warn("User signed out locally, but logout request towards OIDC server not initiated since logoutUrl or logoutUrlParamIdToken not set in authConfig.")},l.prototype.generateLoginUrl=function(e){var t=""+a.enc.Base64.stringify(a.enc.Utf8.parse(e)),r=a.lib.WordArray.random(16).toString(),n=a.lib.WordArray.random(32).toString(),o=a.SHA256(n),s=a.enc.Base64.stringify(o);s=(s=(s=s.replace(/=/g,"")).replace(/\+/g,"-")).replace(/\//g,"_"),this.pkce=n,this.nonce=r;var i=this.authConfig.loginUrl;return i+="?"+this.authConfig.loginUrlParamRedirect+"="+encodeURIComponent(t),i+="&"+this.authConfig.loginUrlParamChallenge+"="+encodeURIComponent(s),i+="&"+this.authConfig.loginUrlParamNonce+"="+encodeURIComponent(r)},l.prototype.readClaimsFromToken=function(e){if(!e.includes("."))return null;var t=e.split("."),r=this.b64DecodeUnicode(t[1]);return JSON.parse(r)},l.prototype.b64DecodeUnicode=function(e){var t=e.replace(/\-/g,"+").replace(/\_/g,"/");return decodeURIComponent(atob(t).split("").map((function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))},l.prototype.parseQueryString=function(e){var t,r;if(!e.length)return[];var n=[],o=e.split("&");try{for(var s=I(o),i=s.next();!i.done;i=s.next()){var a=i.value,c=a.indexOf("="),u=void 0,l=void 0;-1===c?(u=a,l=void 0):(u=a.substr(0,c),l=a.substr(c+1)),n.push({key:decodeURIComponent(u),value:decodeURIComponent(l)})}}catch(e){t={error:e}}finally{try{i&&!i.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}return n},l.ctorParameters=function(){return[{type:o.HttpBackend},{type:void 0,decorators:[{type:t.Inject,args:[u]}]},{type:s.Router},{type:n.Location}]},l=m([t.Injectable(),v(1,t.Inject(u)),y("design:paramtypes",[o.HttpBackend,Object,s.Router,n.Location])],l)}(h),x=this&&this.__decorate||function(e,t,r,n){var o,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(i=(s<3?o(i):s>3?o(t,r,i):o(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i},j=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},P=this&&this.__param||function(e,t){return function(r,n){t(r,n,e)}},R=this&&this.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},S=function(){function e(e,t){for(var r in this.auth=e,this.basePaths=t,this.enabled=!0,this.basePaths)this.basePaths.hasOwnProperty(r)&&(this.basePaths[r]=this.basePaths[r].toLowerCase())}return e.prototype.setAuthHeader=function(e){var t="Bearer "+this.auth.currentUser.access_token,r=e.headers.set("Authorization",t);return e.clone({headers:r})},e.prototype.intercept=function(e,t){var n,o,s=this;if(!this.enabled)return t.handle(e);var a=e.url.toLowerCase();try{for(var c=R(this.basePaths),u=c.next();!u.done;u=c.next()){var l=u.value;if(a.startsWith(l)){null!=this.auth.currentUser&&(e=this.setAuthHeader(e));break}}}catch(e){n={error:e}}finally{try{u&&!u.done&&(o=c.return)&&o.call(c)}finally{if(n)throw n.error}}return t.handle(e).pipe(i.catchError((function(n){return 401===n.status?r.from(s.auth.refreshTokens()).pipe(i.switchMap((function(r){return t.handle(s.setAuthHeader(e))})),i.catchError((function(e){return r.throwError(n)}))):r.throwError(n)})))},e.ctorParameters=function(){return[{type:h},{type:Array,decorators:[{type:t.Inject,args:[l]}]}]},e=x([t.Injectable(),P(1,t.Inject(l)),j("design:paramtypes",[h,Array])],e)}();e.AUTH_CONFIG=u,e.AvlAuthService=h,e.AvlOidcCodeAuthService=w,e.AvlTokenInterceptor=S,e.INTERCEPTOR_BASE_PATHS=l,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=avl-ng-controls-auth.umd.min.js.map