import { __decorate, __extends, __metadata } from "tslib";
import { Directive, EventEmitter, HostListener, Output, OnInit, OnDestroy, ElementRef, Renderer2, forwardRef, Input } from '@angular/core';
import { AvlInteractionControlDirective } from './avl-interaction-control.directive';
import { NG_VALUE_ACCESSOR, NG_VALIDATORS } from '@angular/forms';
// Defines which property is used as the 'value' for the ControlValueAccessor
var valuePropertyNameMap = {
    // TODO: is there a nameof function is typescript?
    'avl-checkbox': 'checked',
    'avl-date': 'value',
    'avl-dropdown': 'selectedValue',
    'avl-time': 'value',
    'avl-numberfield': 'value',
    'avl-radio-group': 'selectedValue',
    'avl-slider': 'value',
    'avl-textarea': 'value',
    'avl-textfield': 'value',
    'avl-timespan': 'value',
    'avl-chip-list': 'selectedValue',
    'avl-chip-input': 'selectedValues',
    'avl-upload': 'files',
    'avl-search-bar': 'query',
    'avl-icon-toggle': 'checked',
    'avl-switch': 'checked'
};
/** Directive for controls implementing [AvlFormControl]. */
var AvlFormControlDirective = /** @class */ (function (_super) {
    __extends(AvlFormControlDirective, _super);
    function AvlFormControlDirective(elementRef, renderer) {
        var _this = _super.call(this, elementRef) || this;
        _this.elementRef = elementRef;
        _this.renderer = renderer;
        _this.writeValueAlreadyCalled = false;
        //#endregion
        //#region AvlFormControl
        // tslint:disable-next-line:member-ordering
        _this.invalidChange = new EventEmitter();
        var controlTag = _this.elementRef.nativeElement.tagName.toLowerCase();
        _this.valuePropertyName = valuePropertyNameMap[controlTag];
        return _this;
    }
    AvlFormControlDirective_1 = AvlFormControlDirective;
    Object.defineProperty(AvlFormControlDirective.prototype, "readonly", {
        // Angular writes readonly attributes to a readOnly property,
        // because that's how it's called on the native input element.
        set: function (value) {
            if (typeof value === 'boolean') {
                this.elementRef.nativeElement.readonly = value;
            }
            else {
                this.elementRef.nativeElement.readonly = value != null;
            }
        },
        enumerable: true,
        configurable: true
    });
    AvlFormControlDirective.prototype.ngOnInit = function () {
        var _this = this;
        this.unlistenPropertyChangedEvent =
            this.renderer.listen(this.elementRef.nativeElement, this.toKebabCase(this.valuePropertyName) + "-changed", function (e) {
                if (_this.onChangeCallback) {
                    _this.onChangeCallback(e.detail.value);
                }
            });
    };
    AvlFormControlDirective.prototype.ngOnDestroy = function () {
        if (this.unlistenPropertyChangedEvent) {
            this.unlistenPropertyChangedEvent();
        }
    };
    AvlFormControlDirective.prototype.writeValue = function (value) {
        // Because of a bug in Angular writeValue sometimes gets called with a null before being called with the real value,
        // so the null is discarded.
        // TODO: remove when issue is fixed: https://github.com/angular/angular/issues/14988
        if (!this.writeValueAlreadyCalled && value == null) {
            this.writeValueAlreadyCalled = true;
            return;
        }
        this.renderer.setProperty(this.elementRef.nativeElement, this.valuePropertyName, value);
        this.writeValueAlreadyCalled = true;
    };
    AvlFormControlDirective.prototype.registerOnChange = function (fn) {
        this.onChangeCallback = fn;
    };
    AvlFormControlDirective.prototype.registerOnTouched = function (fn) {
        this.onTouchedCallback = fn;
    };
    AvlFormControlDirective.prototype.setDisabledState = function (isDisabled) {
        this.renderer.setProperty(this.elementRef.nativeElement, 'disabled', isDisabled);
    };
    AvlFormControlDirective.prototype.onBlur = function () {
        if (this.onTouchedCallback) {
            this.onTouchedCallback();
        }
    };
    AvlFormControlDirective.prototype.onFocusedChanged = function (focused) {
        if (!focused && this.onTouchedCallback) {
            this.onTouchedCallback();
        }
    };
    AvlFormControlDirective.prototype.toKebabCase = function (camelCaseString) {
        return camelCaseString.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
    };
    AvlFormControlDirective.prototype.invalidChanged = function (e) {
        this.invalidChange.emit(e.detail.value);
        // Trigger validation
        if (this.onChangeCallback) {
            this.onChangeCallback(this.elementRef.nativeElement[this.valuePropertyName]);
        }
    };
    //#endregion
    //#region Validator
    AvlFormControlDirective.prototype.validate = function (control) {
        var formControl = this.elementRef.nativeElement;
        if (formControl.invalid) {
            return { invalid: formControl.errorMessage };
        }
        else {
            return null;
        }
    };
    var AvlFormControlDirective_1;
    AvlFormControlDirective.ctorParameters = function () { return [
        { type: ElementRef },
        { type: Renderer2 }
    ]; };
    __decorate([
        Input(),
        __metadata("design:type", Object),
        __metadata("design:paramtypes", [Object])
    ], AvlFormControlDirective.prototype, "readonly", null);
    __decorate([
        HostListener('blur'),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", []),
        __metadata("design:returntype", void 0)
    ], AvlFormControlDirective.prototype, "onBlur", null);
    __decorate([
        HostListener('focused-changed', ['$event.detail.value']),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", [Object]),
        __metadata("design:returntype", void 0)
    ], AvlFormControlDirective.prototype, "onFocusedChanged", null);
    __decorate([
        Output(),
        __metadata("design:type", EventEmitter)
    ], AvlFormControlDirective.prototype, "invalidChange", void 0);
    __decorate([
        HostListener('invalid-changed', ['$event']),
        __metadata("design:type", Function),
        __metadata("design:paramtypes", [CustomEvent]),
        __metadata("design:returntype", void 0)
    ], AvlFormControlDirective.prototype, "invalidChanged", null);
    AvlFormControlDirective = AvlFormControlDirective_1 = __decorate([
        Directive({
            selector: 'avl-date,avl-dropdown,avl-time,avl-icon-toggle,avl-numberfield,avl-radio-group,avl-slider,avl-textarea,avl-textfield,avl-timespan,avl-checkbox,avl-switch,avl-chip-list,avl-upload,avl-search-bar,avl-chip-input',
            providers: [{ provide: NG_VALUE_ACCESSOR, useExisting: forwardRef(function () { return AvlFormControlDirective_1; }), multi: true },
                { provide: NG_VALIDATORS, useExisting: forwardRef(function () { return AvlFormControlDirective_1; }), multi: true }]
        }),
        __metadata("design:paramtypes", [ElementRef, Renderer2])
    ], AvlFormControlDirective);
    return AvlFormControlDirective;
}(AvlInteractionControlDirective));
export { AvlFormControlDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXZsLWZvcm0tY29udHJvbC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYXZsLWNvbnRyb2xzL25nLWJpbmRlcnMvIiwic291cmNlcyI6WyJsaWIvaW50ZXJmYWNlL2F2bC1mb3JtLWNvbnRyb2wuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNJLE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3JGLE9BQU8sRUFBd0IsaUJBQWlCLEVBQWdELGFBQWEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3RJLDZFQUE2RTtBQUM3RSxJQUFNLG9CQUFvQixHQUFHO0lBQzNCLGtEQUFrRDtJQUNsRCxjQUFjLEVBQUUsU0FBUztJQUN6QixVQUFVLEVBQUUsT0FBTztJQUNuQixjQUFjLEVBQUUsZUFBZTtJQUMvQixVQUFVLEVBQUUsT0FBTztJQUNuQixpQkFBaUIsRUFBRSxPQUFPO0lBQzFCLGlCQUFpQixFQUFFLGVBQWU7SUFDbEMsWUFBWSxFQUFFLE9BQU87SUFDckIsY0FBYyxFQUFFLE9BQU87SUFDdkIsZUFBZSxFQUFFLE9BQU87SUFDeEIsY0FBYyxFQUFFLE9BQU87SUFDdkIsZUFBZSxFQUFHLGVBQWU7SUFDakMsZ0JBQWdCLEVBQUUsZ0JBQWdCO0lBQ2xDLFlBQVksRUFBRSxPQUFPO0lBQ3JCLGdCQUFnQixFQUFFLE9BQU87SUFDekIsaUJBQWlCLEVBQUUsU0FBUztJQUM1QixZQUFZLEVBQUUsU0FBUztDQUN4QixDQUFDO0FBRUYsNERBQTREO0FBTTVEO0lBQTZDLDJDQUE4QjtJQXFCekUsaUNBQXNCLFVBQXNCLEVBQVUsUUFBbUI7UUFBekUsWUFDRSxrQkFBTSxVQUFVLENBQUMsU0FHbEI7UUFKcUIsZ0JBQVUsR0FBVixVQUFVLENBQVk7UUFBVSxjQUFRLEdBQVIsUUFBUSxDQUFXO1FBYmpFLDZCQUF1QixHQUFHLEtBQUssQ0FBQztRQTJFeEMsWUFBWTtRQUVaLHdCQUF3QjtRQUN4QiwyQ0FBMkM7UUFDakMsbUJBQWEsR0FBc0IsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQWhFOUQsSUFBTSxVQUFVLEdBQUksS0FBSSxDQUFDLFVBQVUsQ0FBQyxhQUE2QixDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUN4RixLQUFJLENBQUMsaUJBQWlCLEdBQUcsb0JBQW9CLENBQUMsVUFBVSxDQUFDLENBQUM7O0lBQzVELENBQUM7Z0NBekJVLHVCQUF1QjtJQWFsQyxzQkFBVyw2Q0FBUTtRQUhuQiw2REFBNkQ7UUFDN0QsOERBQThEO2FBRTlELFVBQW9CLEtBQVU7WUFDNUIsSUFBSSxPQUFPLEtBQUssS0FBSyxTQUFTLEVBQUU7Z0JBQzlCLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7YUFDaEQ7aUJBQU07Z0JBQ0wsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsUUFBUSxHQUFHLEtBQUssSUFBSSxJQUFJLENBQUM7YUFDeEQ7UUFDSCxDQUFDOzs7T0FBQTtJQVFELDBDQUFRLEdBQVI7UUFBQSxpQkFPQztRQU5DLElBQUksQ0FBQyw0QkFBNEI7WUFDL0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLEVBQUssSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsYUFBVSxFQUFFLFVBQUMsQ0FBYztnQkFDeEgsSUFBSSxLQUFJLENBQUMsZ0JBQWdCLEVBQUU7b0JBQ3pCLEtBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUN2QztZQUNILENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELDZDQUFXLEdBQVg7UUFDRSxJQUFJLElBQUksQ0FBQyw0QkFBNEIsRUFBRTtZQUNyQyxJQUFJLENBQUMsNEJBQTRCLEVBQUUsQ0FBQztTQUNyQztJQUNILENBQUM7SUFFRCw0Q0FBVSxHQUFWLFVBQVcsS0FBVTtRQUNuQixvSEFBb0g7UUFDcEgsNEJBQTRCO1FBQzVCLG9GQUFvRjtRQUNwRixJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixJQUFJLEtBQUssSUFBSSxJQUFJLEVBQUU7WUFDbEQsSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQztZQUNwQyxPQUFPO1NBQ1I7UUFDRCxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDeEYsSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQztJQUN0QyxDQUFDO0lBRUQsa0RBQWdCLEdBQWhCLFVBQWlCLEVBQXdCO1FBQ3ZDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7SUFDN0IsQ0FBQztJQUVELG1EQUFpQixHQUFqQixVQUFrQixFQUFPO1FBQ3ZCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUM7SUFDOUIsQ0FBQztJQUVELGtEQUFnQixHQUFoQixVQUFpQixVQUFtQjtRQUNsQyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsRUFBRSxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDbkYsQ0FBQztJQUdELHdDQUFNLEdBQU47UUFDRSxJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUMxQixJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztTQUMxQjtJQUNILENBQUM7SUFHRCxrREFBZ0IsR0FBaEIsVUFBaUIsT0FBTztRQUN0QixJQUFJLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUN0QyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztTQUMxQjtJQUNILENBQUM7SUFFTyw2Q0FBVyxHQUFuQixVQUFvQixlQUF1QjtRQUN6QyxPQUFPLGVBQWUsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDM0UsQ0FBQztJQVFELGdEQUFjLEdBQWQsVUFBZSxDQUFjO1FBQzNCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEMscUJBQXFCO1FBQ3JCLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO1lBQ3pCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO1NBQzlFO0lBQ0gsQ0FBQztJQUNELFlBQVk7SUFFWixtQkFBbUI7SUFDbkIsMENBQVEsR0FBUixVQUFTLE9BQXdCO1FBQy9CLElBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBK0IsQ0FBQztRQUNwRSxJQUFJLFdBQVcsQ0FBQyxPQUFPLEVBQUU7WUFDdkIsT0FBTyxFQUFFLE9BQU8sRUFBRSxXQUFXLENBQUMsWUFBWSxFQUFFLENBQUM7U0FDOUM7YUFBTTtZQUNMLE9BQU8sSUFBSSxDQUFDO1NBQ2I7SUFDSCxDQUFDOzs7Z0JBdEZpQyxVQUFVO2dCQUFvQixTQUFTOztJQVJ6RTtRQURDLEtBQUssRUFBRTs7OzJEQU9QO0lBZ0REO1FBREMsWUFBWSxDQUFDLE1BQU0sQ0FBQzs7Ozt5REFLcEI7SUFHRDtRQURDLFlBQVksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLHFCQUFxQixDQUFDLENBQUM7Ozs7bUVBS3hEO0lBU1M7UUFBVCxNQUFNLEVBQUU7a0NBQWdCLFlBQVk7a0VBQTJCO0lBR2hFO1FBREMsWUFBWSxDQUFDLGlCQUFpQixFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7O3lDQUMxQixXQUFXOztpRUFNNUI7SUFoR1UsdUJBQXVCO1FBTG5DLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSxrTkFBa047WUFDNU4sU0FBUyxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsV0FBVyxFQUFFLFVBQVUsQ0FBQyxjQUFNLE9BQUEseUJBQXVCLEVBQXZCLENBQXVCLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFO2dCQUMvRyxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsV0FBVyxFQUFFLFVBQVUsQ0FBQyxjQUFNLE9BQUEseUJBQXVCLEVBQXZCLENBQXVCLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUM7U0FDakcsQ0FBQzt5Q0FzQmtDLFVBQVUsRUFBb0IsU0FBUztPQXJCOUQsdUJBQXVCLENBNkduQztJQUFELDhCQUFDO0NBQUEsQUE3R0QsQ0FBNkMsOEJBQThCLEdBNkcxRTtTQTdHWSx1QkFBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEV2ZW50RW1pdHRlciwgSG9zdExpc3RlbmVyLCBPdXRwdXQsIE9uSW5pdCwgT25EZXN0cm95LCBFbGVtZW50UmVmLCBSZW5kZXJlcjIsIGZvcndhcmRSZWYsIElucHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEF2bEludGVyYWN0aW9uQ29udHJvbERpcmVjdGl2ZSB9IGZyb20gJy4vYXZsLWludGVyYWN0aW9uLWNvbnRyb2wuZGlyZWN0aXZlJztcclxuaW1wb3J0IHsgQ29udHJvbFZhbHVlQWNjZXNzb3IsIE5HX1ZBTFVFX0FDQ0VTU09SLCBWYWxpZGF0b3IsIEFic3RyYWN0Q29udHJvbCwgVmFsaWRhdGlvbkVycm9ycywgTkdfVkFMSURBVE9SUyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcclxuaW1wb3J0IHsgQXZsRm9ybUNvbnRyb2wgfSBmcm9tICdAYXZsLWNvbnRyb2xzL2ludGVyZmFjZXMnO1xyXG5cclxuLy8gRGVmaW5lcyB3aGljaCBwcm9wZXJ0eSBpcyB1c2VkIGFzIHRoZSAndmFsdWUnIGZvciB0aGUgQ29udHJvbFZhbHVlQWNjZXNzb3JcclxuY29uc3QgdmFsdWVQcm9wZXJ0eU5hbWVNYXAgPSB7XHJcbiAgLy8gVE9ETzogaXMgdGhlcmUgYSBuYW1lb2YgZnVuY3Rpb24gaXMgdHlwZXNjcmlwdD9cclxuICAnYXZsLWNoZWNrYm94JzogJ2NoZWNrZWQnLFxyXG4gICdhdmwtZGF0ZSc6ICd2YWx1ZScsXHJcbiAgJ2F2bC1kcm9wZG93bic6ICdzZWxlY3RlZFZhbHVlJyxcclxuICAnYXZsLXRpbWUnOiAndmFsdWUnLFxyXG4gICdhdmwtbnVtYmVyZmllbGQnOiAndmFsdWUnLFxyXG4gICdhdmwtcmFkaW8tZ3JvdXAnOiAnc2VsZWN0ZWRWYWx1ZScsXHJcbiAgJ2F2bC1zbGlkZXInOiAndmFsdWUnLFxyXG4gICdhdmwtdGV4dGFyZWEnOiAndmFsdWUnLFxyXG4gICdhdmwtdGV4dGZpZWxkJzogJ3ZhbHVlJyxcclxuICAnYXZsLXRpbWVzcGFuJzogJ3ZhbHVlJyxcclxuICAnYXZsLWNoaXAtbGlzdCcgOiAnc2VsZWN0ZWRWYWx1ZScsXHJcbiAgJ2F2bC1jaGlwLWlucHV0JzogJ3NlbGVjdGVkVmFsdWVzJyxcclxuICAnYXZsLXVwbG9hZCc6ICdmaWxlcycsXHJcbiAgJ2F2bC1zZWFyY2gtYmFyJzogJ3F1ZXJ5JyxcclxuICAnYXZsLWljb24tdG9nZ2xlJzogJ2NoZWNrZWQnLFxyXG4gICdhdmwtc3dpdGNoJzogJ2NoZWNrZWQnXHJcbn07XHJcblxyXG4vKiogRGlyZWN0aXZlIGZvciBjb250cm9scyBpbXBsZW1lbnRpbmcgW0F2bEZvcm1Db250cm9sXS4gKi9cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICdhdmwtZGF0ZSxhdmwtZHJvcGRvd24sYXZsLXRpbWUsYXZsLWljb24tdG9nZ2xlLGF2bC1udW1iZXJmaWVsZCxhdmwtcmFkaW8tZ3JvdXAsYXZsLXNsaWRlcixhdmwtdGV4dGFyZWEsYXZsLXRleHRmaWVsZCxhdmwtdGltZXNwYW4sYXZsLWNoZWNrYm94LGF2bC1zd2l0Y2gsYXZsLWNoaXAtbGlzdCxhdmwtdXBsb2FkLGF2bC1zZWFyY2gtYmFyLGF2bC1jaGlwLWlucHV0JyxcclxuICBwcm92aWRlcnM6IFt7IHByb3ZpZGU6IE5HX1ZBTFVFX0FDQ0VTU09SLCB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBBdmxGb3JtQ29udHJvbERpcmVjdGl2ZSksIG11bHRpOiB0cnVlIH0sXHJcbiAgeyBwcm92aWRlOiBOR19WQUxJREFUT1JTLCB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBBdmxGb3JtQ29udHJvbERpcmVjdGl2ZSksIG11bHRpOiB0cnVlIH1dXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBBdmxGb3JtQ29udHJvbERpcmVjdGl2ZSBleHRlbmRzIEF2bEludGVyYWN0aW9uQ29udHJvbERpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBDb250cm9sVmFsdWVBY2Nlc3NvciwgVmFsaWRhdG9yIHtcclxuICAvLyNyZWdpb24gQ29udHJvbFZhbHVlQWNjZXNzb3JcclxuICBwcml2YXRlIHZhbHVlUHJvcGVydHlOYW1lO1xyXG4gIHByaXZhdGUgb25Ub3VjaGVkQ2FsbGJhY2s6ICgpID0+IHt9O1xyXG4gIHByaXZhdGUgb25DaGFuZ2VDYWxsYmFjazogKHZhbHVlOiBhbnkpID0+IHZvaWQ7XHJcblxyXG4gIHByaXZhdGUgdW5saXN0ZW5Qcm9wZXJ0eUNoYW5nZWRFdmVudDogKCkgPT4gdm9pZDtcclxuXHJcbiAgcHJpdmF0ZSB3cml0ZVZhbHVlQWxyZWFkeUNhbGxlZCA9IGZhbHNlO1xyXG5cclxuICAvLyBBbmd1bGFyIHdyaXRlcyByZWFkb25seSBhdHRyaWJ1dGVzIHRvIGEgcmVhZE9ubHkgcHJvcGVydHksXHJcbiAgLy8gYmVjYXVzZSB0aGF0J3MgaG93IGl0J3MgY2FsbGVkIG9uIHRoZSBuYXRpdmUgaW5wdXQgZWxlbWVudC5cclxuICBASW5wdXQoKVxyXG4gIHB1YmxpYyBzZXQgcmVhZG9ubHkodmFsdWU6IGFueSkge1xyXG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSB7XHJcbiAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnJlYWRvbmx5ID0gdmFsdWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5yZWFkb25seSA9IHZhbHVlICE9IG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgZWxlbWVudFJlZjogRWxlbWVudFJlZiwgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyKSB7XHJcbiAgICBzdXBlcihlbGVtZW50UmVmKTtcclxuICAgIGNvbnN0IGNvbnRyb2xUYWcgPSAodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQgYXMgSFRNTEVsZW1lbnQpLnRhZ05hbWUudG9Mb3dlckNhc2UoKTtcclxuICAgIHRoaXMudmFsdWVQcm9wZXJ0eU5hbWUgPSB2YWx1ZVByb3BlcnR5TmFtZU1hcFtjb250cm9sVGFnXTtcclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgdGhpcy51bmxpc3RlblByb3BlcnR5Q2hhbmdlZEV2ZW50ID1cclxuICAgICAgdGhpcy5yZW5kZXJlci5saXN0ZW4odGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsIGAke3RoaXMudG9LZWJhYkNhc2UodGhpcy52YWx1ZVByb3BlcnR5TmFtZSl9LWNoYW5nZWRgLCAoZTogQ3VzdG9tRXZlbnQpID0+IHtcclxuICAgICAgICBpZiAodGhpcy5vbkNoYW5nZUNhbGxiYWNrKSB7XHJcbiAgICAgICAgICB0aGlzLm9uQ2hhbmdlQ2FsbGJhY2soZS5kZXRhaWwudmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLnVubGlzdGVuUHJvcGVydHlDaGFuZ2VkRXZlbnQpIHtcclxuICAgICAgdGhpcy51bmxpc3RlblByb3BlcnR5Q2hhbmdlZEV2ZW50KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICB3cml0ZVZhbHVlKHZhbHVlOiBhbnkpIHtcclxuICAgIC8vIEJlY2F1c2Ugb2YgYSBidWcgaW4gQW5ndWxhciB3cml0ZVZhbHVlIHNvbWV0aW1lcyBnZXRzIGNhbGxlZCB3aXRoIGEgbnVsbCBiZWZvcmUgYmVpbmcgY2FsbGVkIHdpdGggdGhlIHJlYWwgdmFsdWUsXHJcbiAgICAvLyBzbyB0aGUgbnVsbCBpcyBkaXNjYXJkZWQuXHJcbiAgICAvLyBUT0RPOiByZW1vdmUgd2hlbiBpc3N1ZSBpcyBmaXhlZDogaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci9pc3N1ZXMvMTQ5ODhcclxuICAgIGlmICghdGhpcy53cml0ZVZhbHVlQWxyZWFkeUNhbGxlZCAmJiB2YWx1ZSA9PSBudWxsKSB7XHJcbiAgICAgIHRoaXMud3JpdGVWYWx1ZUFscmVhZHlDYWxsZWQgPSB0cnVlO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLnJlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCB0aGlzLnZhbHVlUHJvcGVydHlOYW1lLCB2YWx1ZSk7XHJcbiAgICB0aGlzLndyaXRlVmFsdWVBbHJlYWR5Q2FsbGVkID0gdHJ1ZTtcclxuICB9XHJcblxyXG4gIHJlZ2lzdGVyT25DaGFuZ2UoZm46ICh2YWx1ZTogYW55KSA9PiB2b2lkKSB7XHJcbiAgICB0aGlzLm9uQ2hhbmdlQ2FsbGJhY2sgPSBmbjtcclxuICB9XHJcblxyXG4gIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiBhbnkpIHtcclxuICAgIHRoaXMub25Ub3VjaGVkQ2FsbGJhY2sgPSBmbjtcclxuICB9XHJcblxyXG4gIHNldERpc2FibGVkU3RhdGUoaXNEaXNhYmxlZDogYm9vbGVhbikge1xyXG4gICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgJ2Rpc2FibGVkJywgaXNEaXNhYmxlZCk7XHJcbiAgfVxyXG5cclxuICBASG9zdExpc3RlbmVyKCdibHVyJylcclxuICBvbkJsdXIoKSB7XHJcbiAgICBpZiAodGhpcy5vblRvdWNoZWRDYWxsYmFjaykge1xyXG4gICAgICB0aGlzLm9uVG91Y2hlZENhbGxiYWNrKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBASG9zdExpc3RlbmVyKCdmb2N1c2VkLWNoYW5nZWQnLCBbJyRldmVudC5kZXRhaWwudmFsdWUnXSlcclxuICBvbkZvY3VzZWRDaGFuZ2VkKGZvY3VzZWQpIHtcclxuICAgIGlmICghZm9jdXNlZCAmJiB0aGlzLm9uVG91Y2hlZENhbGxiYWNrKSB7XHJcbiAgICAgIHRoaXMub25Ub3VjaGVkQ2FsbGJhY2soKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgdG9LZWJhYkNhc2UoY2FtZWxDYXNlU3RyaW5nOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIGNhbWVsQ2FzZVN0cmluZy5yZXBsYWNlKC8oW2Etel0pKFtBLVpdKS9nLCAnJDEtJDInKS50b0xvd2VyQ2FzZSgpO1xyXG4gIH1cclxuICAvLyNlbmRyZWdpb25cclxuXHJcbiAgLy8jcmVnaW9uIEF2bEZvcm1Db250cm9sXHJcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1lbWJlci1vcmRlcmluZ1xyXG4gIEBPdXRwdXQoKSBpbnZhbGlkQ2hhbmdlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcclxuXHJcbiAgQEhvc3RMaXN0ZW5lcignaW52YWxpZC1jaGFuZ2VkJywgWyckZXZlbnQnXSlcclxuICBpbnZhbGlkQ2hhbmdlZChlOiBDdXN0b21FdmVudCkge1xyXG4gICAgdGhpcy5pbnZhbGlkQ2hhbmdlLmVtaXQoZS5kZXRhaWwudmFsdWUpO1xyXG4gICAgLy8gVHJpZ2dlciB2YWxpZGF0aW9uXHJcbiAgICBpZiAodGhpcy5vbkNoYW5nZUNhbGxiYWNrKSB7XHJcbiAgICAgIHRoaXMub25DaGFuZ2VDYWxsYmFjayh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudFt0aGlzLnZhbHVlUHJvcGVydHlOYW1lXSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8vI2VuZHJlZ2lvblxyXG5cclxuICAvLyNyZWdpb24gVmFsaWRhdG9yXHJcbiAgdmFsaWRhdGUoY29udHJvbDogQWJzdHJhY3RDb250cm9sKTogVmFsaWRhdGlvbkVycm9ycyB8IG51bGwge1xyXG4gICAgY29uc3QgZm9ybUNvbnRyb2wgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCBhcyBBdmxGb3JtQ29udHJvbDtcclxuICAgIGlmIChmb3JtQ29udHJvbC5pbnZhbGlkKSB7XHJcbiAgICAgIHJldHVybiB7IGludmFsaWQ6IGZvcm1Db250cm9sLmVycm9yTWVzc2FnZSB9O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8vI2VuZHJlZ2lvblxyXG59XHJcbiJdfQ==