var AvlFormControlDirective_1;
import { __decorate, __metadata } from "tslib";
import { Directive, EventEmitter, HostListener, Output, OnInit, OnDestroy, ElementRef, Renderer2, forwardRef, Input } from '@angular/core';
import { AvlInteractionControlDirective } from './avl-interaction-control.directive';
import { NG_VALUE_ACCESSOR, NG_VALIDATORS } from '@angular/forms';
// Defines which property is used as the 'value' for the ControlValueAccessor
const valuePropertyNameMap = {
    // TODO: is there a nameof function is typescript?
    'avl-checkbox': 'checked',
    'avl-date': 'value',
    'avl-dropdown': 'selectedValue',
    'avl-time': 'value',
    'avl-numberfield': 'value',
    'avl-radio-group': 'selectedValue',
    'avl-slider': 'value',
    'avl-textarea': 'value',
    'avl-textfield': 'value',
    'avl-timespan': 'value',
    'avl-chip-list': 'selectedValue',
    'avl-chip-input': 'selectedValues',
    'avl-upload': 'files',
    'avl-search-bar': 'query',
    'avl-icon-toggle': 'checked',
    'avl-switch': 'checked'
};
/** Directive for controls implementing [AvlFormControl]. */
let AvlFormControlDirective = AvlFormControlDirective_1 = class AvlFormControlDirective extends AvlInteractionControlDirective {
    constructor(elementRef, renderer) {
        super(elementRef);
        this.elementRef = elementRef;
        this.renderer = renderer;
        this.writeValueAlreadyCalled = false;
        //#endregion
        //#region AvlFormControl
        // tslint:disable-next-line:member-ordering
        this.invalidChange = new EventEmitter();
        const controlTag = this.elementRef.nativeElement.tagName.toLowerCase();
        this.valuePropertyName = valuePropertyNameMap[controlTag];
    }
    // Angular writes readonly attributes to a readOnly property,
    // because that's how it's called on the native input element.
    set readonly(value) {
        if (typeof value === 'boolean') {
            this.elementRef.nativeElement.readonly = value;
        }
        else {
            this.elementRef.nativeElement.readonly = value != null;
        }
    }
    ngOnInit() {
        this.unlistenPropertyChangedEvent =
            this.renderer.listen(this.elementRef.nativeElement, `${this.toKebabCase(this.valuePropertyName)}-changed`, (e) => {
                if (this.onChangeCallback) {
                    this.onChangeCallback(e.detail.value);
                }
            });
    }
    ngOnDestroy() {
        if (this.unlistenPropertyChangedEvent) {
            this.unlistenPropertyChangedEvent();
        }
    }
    writeValue(value) {
        // Because of a bug in Angular writeValue sometimes gets called with a null before being called with the real value,
        // so the null is discarded.
        // TODO: remove when issue is fixed: https://github.com/angular/angular/issues/14988
        if (!this.writeValueAlreadyCalled && value == null) {
            this.writeValueAlreadyCalled = true;
            return;
        }
        this.renderer.setProperty(this.elementRef.nativeElement, this.valuePropertyName, value);
        this.writeValueAlreadyCalled = true;
    }
    registerOnChange(fn) {
        this.onChangeCallback = fn;
    }
    registerOnTouched(fn) {
        this.onTouchedCallback = fn;
    }
    setDisabledState(isDisabled) {
        this.renderer.setProperty(this.elementRef.nativeElement, 'disabled', isDisabled);
    }
    onBlur() {
        if (this.onTouchedCallback) {
            this.onTouchedCallback();
        }
    }
    onFocusedChanged(focused) {
        if (!focused && this.onTouchedCallback) {
            this.onTouchedCallback();
        }
    }
    toKebabCase(camelCaseString) {
        return camelCaseString.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
    }
    invalidChanged(e) {
        this.invalidChange.emit(e.detail.value);
        // Trigger validation
        if (this.onChangeCallback) {
            this.onChangeCallback(this.elementRef.nativeElement[this.valuePropertyName]);
        }
    }
    //#endregion
    //#region Validator
    validate(control) {
        const formControl = this.elementRef.nativeElement;
        if (formControl.invalid) {
            return { invalid: formControl.errorMessage };
        }
        else {
            return null;
        }
    }
};
AvlFormControlDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 }
];
__decorate([
    Input(),
    __metadata("design:type", Object),
    __metadata("design:paramtypes", [Object])
], AvlFormControlDirective.prototype, "readonly", null);
__decorate([
    HostListener('blur'),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], AvlFormControlDirective.prototype, "onBlur", null);
__decorate([
    HostListener('focused-changed', ['$event.detail.value']),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", void 0)
], AvlFormControlDirective.prototype, "onFocusedChanged", null);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], AvlFormControlDirective.prototype, "invalidChange", void 0);
__decorate([
    HostListener('invalid-changed', ['$event']),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [CustomEvent]),
    __metadata("design:returntype", void 0)
], AvlFormControlDirective.prototype, "invalidChanged", null);
AvlFormControlDirective = AvlFormControlDirective_1 = __decorate([
    Directive({
        selector: 'avl-date,avl-dropdown,avl-time,avl-icon-toggle,avl-numberfield,avl-radio-group,avl-slider,avl-textarea,avl-textfield,avl-timespan,avl-checkbox,avl-switch,avl-chip-list,avl-upload,avl-search-bar,avl-chip-input',
        providers: [{ provide: NG_VALUE_ACCESSOR, useExisting: forwardRef(() => AvlFormControlDirective_1), multi: true },
            { provide: NG_VALIDATORS, useExisting: forwardRef(() => AvlFormControlDirective_1), multi: true }]
    }),
    __metadata("design:paramtypes", [ElementRef, Renderer2])
], AvlFormControlDirective);
export { AvlFormControlDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXZsLWZvcm0tY29udHJvbC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYXZsLWNvbnRyb2xzL25nLWJpbmRlcnMvIiwic291cmNlcyI6WyJsaWIvaW50ZXJmYWNlL2F2bC1mb3JtLWNvbnRyb2wuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzSSxPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUNyRixPQUFPLEVBQXdCLGlCQUFpQixFQUFnRCxhQUFhLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUd0SSw2RUFBNkU7QUFDN0UsTUFBTSxvQkFBb0IsR0FBRztJQUMzQixrREFBa0Q7SUFDbEQsY0FBYyxFQUFFLFNBQVM7SUFDekIsVUFBVSxFQUFFLE9BQU87SUFDbkIsY0FBYyxFQUFFLGVBQWU7SUFDL0IsVUFBVSxFQUFFLE9BQU87SUFDbkIsaUJBQWlCLEVBQUUsT0FBTztJQUMxQixpQkFBaUIsRUFBRSxlQUFlO0lBQ2xDLFlBQVksRUFBRSxPQUFPO0lBQ3JCLGNBQWMsRUFBRSxPQUFPO0lBQ3ZCLGVBQWUsRUFBRSxPQUFPO0lBQ3hCLGNBQWMsRUFBRSxPQUFPO0lBQ3ZCLGVBQWUsRUFBRyxlQUFlO0lBQ2pDLGdCQUFnQixFQUFFLGdCQUFnQjtJQUNsQyxZQUFZLEVBQUUsT0FBTztJQUNyQixnQkFBZ0IsRUFBRSxPQUFPO0lBQ3pCLGlCQUFpQixFQUFFLFNBQVM7SUFDNUIsWUFBWSxFQUFFLFNBQVM7Q0FDeEIsQ0FBQztBQUVGLDREQUE0RDtBQU01RCxJQUFhLHVCQUF1QiwrQkFBcEMsTUFBYSx1QkFBd0IsU0FBUSw4QkFBOEI7SUFxQnpFLFlBQXNCLFVBQXNC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QyxFQUFFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxXQUFXLEVBQUUsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLHlCQUF1QixDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRTtZQUMvRyxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsV0FBVyxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyx5QkFBdUIsQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQztLQUNqRyxDQUFDO3FDQXNCa0MsVUFBVSxFQUFvQixTQUFTO0dBckI5RCx1QkFBdUIsQ0E2R25DO1NBN0dZLHVCQUF1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgRXZlbnRFbWl0dGVyLCBIb3N0TGlzdGVuZXIsIE91dHB1dCwgT25Jbml0LCBPbkRlc3Ryb3ksIEVsZW1lbnRSZWYsIFJlbmRlcmVyMiwgZm9yd2FyZFJlZiwgSW5wdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQXZsSW50ZXJhY3Rpb25Db250cm9sRGlyZWN0aXZlIH0gZnJvbSAnLi9hdmwtaW50ZXJhY3Rpb24tY29udHJvbC5kaXJlY3RpdmUnO1xyXG5pbXBvcnQgeyBDb250cm9sVmFsdWVBY2Nlc3NvciwgTkdfVkFMVUVfQUNDRVNTT1IsIFZhbGlkYXRvciwgQWJzdHJhY3RDb250cm9sLCBWYWxpZGF0aW9uRXJyb3JzLCBOR19WQUxJREFUT1JTIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBBdmxGb3JtQ29udHJvbCB9IGZyb20gJ0BhdmwtY29udHJvbHMvaW50ZXJmYWNlcyc7XHJcblxyXG4vLyBEZWZpbmVzIHdoaWNoIHByb3BlcnR5IGlzIHVzZWQgYXMgdGhlICd2YWx1ZScgZm9yIHRoZSBDb250cm9sVmFsdWVBY2Nlc3NvclxyXG5jb25zdCB2YWx1ZVByb3BlcnR5TmFtZU1hcCA9IHtcclxuICAvLyBUT0RPOiBpcyB0aGVyZSBhIG5hbWVvZiBmdW5jdGlvbiBpcyB0eXBlc2NyaXB0P1xyXG4gICdhdmwtY2hlY2tib3gnOiAnY2hlY2tlZCcsXHJcbiAgJ2F2bC1kYXRlJzogJ3ZhbHVlJyxcclxuICAnYXZsLWRyb3Bkb3duJzogJ3NlbGVjdGVkVmFsdWUnLFxyXG4gICdhdmwtdGltZSc6ICd2YWx1ZScsXHJcbiAgJ2F2bC1udW1iZXJmaWVsZCc6ICd2YWx1ZScsXHJcbiAgJ2F2bC1yYWRpby1ncm91cCc6ICdzZWxlY3RlZFZhbHVlJyxcclxuICAnYXZsLXNsaWRlcic6ICd2YWx1ZScsXHJcbiAgJ2F2bC10ZXh0YXJlYSc6ICd2YWx1ZScsXHJcbiAgJ2F2bC10ZXh0ZmllbGQnOiAndmFsdWUnLFxyXG4gICdhdmwtdGltZXNwYW4nOiAndmFsdWUnLFxyXG4gICdhdmwtY2hpcC1saXN0JyA6ICdzZWxlY3RlZFZhbHVlJyxcclxuICAnYXZsLWNoaXAtaW5wdXQnOiAnc2VsZWN0ZWRWYWx1ZXMnLFxyXG4gICdhdmwtdXBsb2FkJzogJ2ZpbGVzJyxcclxuICAnYXZsLXNlYXJjaC1iYXInOiAncXVlcnknLFxyXG4gICdhdmwtaWNvbi10b2dnbGUnOiAnY2hlY2tlZCcsXHJcbiAgJ2F2bC1zd2l0Y2gnOiAnY2hlY2tlZCdcclxufTtcclxuXHJcbi8qKiBEaXJlY3RpdmUgZm9yIGNvbnRyb2xzIGltcGxlbWVudGluZyBbQXZsRm9ybUNvbnRyb2xdLiAqL1xyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ2F2bC1kYXRlLGF2bC1kcm9wZG93bixhdmwtdGltZSxhdmwtaWNvbi10b2dnbGUsYXZsLW51bWJlcmZpZWxkLGF2bC1yYWRpby1ncm91cCxhdmwtc2xpZGVyLGF2bC10ZXh0YXJlYSxhdmwtdGV4dGZpZWxkLGF2bC10aW1lc3BhbixhdmwtY2hlY2tib3gsYXZsLXN3aXRjaCxhdmwtY2hpcC1saXN0LGF2bC11cGxvYWQsYXZsLXNlYXJjaC1iYXIsYXZsLWNoaXAtaW5wdXQnLFxyXG4gIHByb3ZpZGVyczogW3sgcHJvdmlkZTogTkdfVkFMVUVfQUNDRVNTT1IsIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IEF2bEZvcm1Db250cm9sRGlyZWN0aXZlKSwgbXVsdGk6IHRydWUgfSxcclxuICB7IHByb3ZpZGU6IE5HX1ZBTElEQVRPUlMsIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IEF2bEZvcm1Db250cm9sRGlyZWN0aXZlKSwgbXVsdGk6IHRydWUgfV1cclxufSlcclxuZXhwb3J0IGNsYXNzIEF2bEZvcm1Db250cm9sRGlyZWN0aXZlIGV4dGVuZHMgQXZsSW50ZXJhY3Rpb25Db250cm9sRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBWYWxpZGF0b3Ige1xyXG4gIC8vI3JlZ2lvbiBDb250cm9sVmFsdWVBY2Nlc3NvclxyXG4gIHByaXZhdGUgdmFsdWVQcm9wZXJ0eU5hbWU7XHJcbiAgcHJpdmF0ZSBvblRvdWNoZWRDYWxsYmFjazogKCkgPT4ge307XHJcbiAgcHJpdmF0ZSBvbkNoYW5nZUNhbGxiYWNrOiAodmFsdWU6IGFueSkgPT4gdm9pZDtcclxuXHJcbiAgcHJpdmF0ZSB1bmxpc3RlblByb3BlcnR5Q2hhbmdlZEV2ZW50OiAoKSA9PiB2b2lkO1xyXG5cclxuICBwcml2YXRlIHdyaXRlVmFsdWVBbHJlYWR5Q2FsbGVkID0gZmFsc2U7XHJcblxyXG4gIC8vIEFuZ3VsYXIgd3JpdGVzIHJlYWRvbmx5IGF0dHJpYnV0ZXMgdG8gYSByZWFkT25seSBwcm9wZXJ0eSxcclxuICAvLyBiZWNhdXNlIHRoYXQncyBob3cgaXQncyBjYWxsZWQgb24gdGhlIG5hdGl2ZSBpbnB1dCBlbGVtZW50LlxyXG4gIEBJbnB1dCgpXHJcbiAgcHVibGljIHNldCByZWFkb25seSh2YWx1ZTogYW55KSB7XHJcbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHtcclxuICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucmVhZG9ubHkgPSB2YWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnJlYWRvbmx5ID0gdmFsdWUgIT0gbnVsbDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBlbGVtZW50UmVmOiBFbGVtZW50UmVmLCBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIpIHtcclxuICAgIHN1cGVyKGVsZW1lbnRSZWYpO1xyXG4gICAgY29uc3QgY29udHJvbFRhZyA9ICh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCBhcyBIVE1MRWxlbWVudCkudGFnTmFtZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgdGhpcy52YWx1ZVByb3BlcnR5TmFtZSA9IHZhbHVlUHJvcGVydHlOYW1lTWFwW2NvbnRyb2xUYWddO1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICB0aGlzLnVubGlzdGVuUHJvcGVydHlDaGFuZ2VkRXZlbnQgPVxyXG4gICAgICB0aGlzLnJlbmRlcmVyLmxpc3Rlbih0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgYCR7dGhpcy50b0tlYmFiQ2FzZSh0aGlzLnZhbHVlUHJvcGVydHlOYW1lKX0tY2hhbmdlZGAsIChlOiBDdXN0b21FdmVudCkgPT4ge1xyXG4gICAgICAgIGlmICh0aGlzLm9uQ2hhbmdlQ2FsbGJhY2spIHtcclxuICAgICAgICAgIHRoaXMub25DaGFuZ2VDYWxsYmFjayhlLmRldGFpbC52YWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMudW5saXN0ZW5Qcm9wZXJ0eUNoYW5nZWRFdmVudCkge1xyXG4gICAgICB0aGlzLnVubGlzdGVuUHJvcGVydHlDaGFuZ2VkRXZlbnQoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHdyaXRlVmFsdWUodmFsdWU6IGFueSkge1xyXG4gICAgLy8gQmVjYXVzZSBvZiBhIGJ1ZyBpbiBBbmd1bGFyIHdyaXRlVmFsdWUgc29tZXRpbWVzIGdldHMgY2FsbGVkIHdpdGggYSBudWxsIGJlZm9yZSBiZWluZyBjYWxsZWQgd2l0aCB0aGUgcmVhbCB2YWx1ZSxcclxuICAgIC8vIHNvIHRoZSBudWxsIGlzIGRpc2NhcmRlZC5cclxuICAgIC8vIFRPRE86IHJlbW92ZSB3aGVuIGlzc3VlIGlzIGZpeGVkOiBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyL2lzc3Vlcy8xNDk4OFxyXG4gICAgaWYgKCF0aGlzLndyaXRlVmFsdWVBbHJlYWR5Q2FsbGVkICYmIHZhbHVlID09IG51bGwpIHtcclxuICAgICAgdGhpcy53cml0ZVZhbHVlQWxyZWFkeUNhbGxlZCA9IHRydWU7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsIHRoaXMudmFsdWVQcm9wZXJ0eU5hbWUsIHZhbHVlKTtcclxuICAgIHRoaXMud3JpdGVWYWx1ZUFscmVhZHlDYWxsZWQgPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgcmVnaXN0ZXJPbkNoYW5nZShmbjogKHZhbHVlOiBhbnkpID0+IHZvaWQpIHtcclxuICAgIHRoaXMub25DaGFuZ2VDYWxsYmFjayA9IGZuO1xyXG4gIH1cclxuXHJcbiAgcmVnaXN0ZXJPblRvdWNoZWQoZm46IGFueSkge1xyXG4gICAgdGhpcy5vblRvdWNoZWRDYWxsYmFjayA9IGZuO1xyXG4gIH1cclxuXHJcbiAgc2V0RGlzYWJsZWRTdGF0ZShpc0Rpc2FibGVkOiBib29sZWFuKSB7XHJcbiAgICB0aGlzLnJlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCAnZGlzYWJsZWQnLCBpc0Rpc2FibGVkKTtcclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ2JsdXInKVxyXG4gIG9uQmx1cigpIHtcclxuICAgIGlmICh0aGlzLm9uVG91Y2hlZENhbGxiYWNrKSB7XHJcbiAgICAgIHRoaXMub25Ub3VjaGVkQ2FsbGJhY2soKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ2ZvY3VzZWQtY2hhbmdlZCcsIFsnJGV2ZW50LmRldGFpbC52YWx1ZSddKVxyXG4gIG9uRm9jdXNlZENoYW5nZWQoZm9jdXNlZCkge1xyXG4gICAgaWYgKCFmb2N1c2VkICYmIHRoaXMub25Ub3VjaGVkQ2FsbGJhY2spIHtcclxuICAgICAgdGhpcy5vblRvdWNoZWRDYWxsYmFjaygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB0b0tlYmFiQ2FzZShjYW1lbENhc2VTdHJpbmc6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gY2FtZWxDYXNlU3RyaW5nLnJlcGxhY2UoLyhbYS16XSkoW0EtWl0pL2csICckMS0kMicpLnRvTG93ZXJDYXNlKCk7XHJcbiAgfVxyXG4gIC8vI2VuZHJlZ2lvblxyXG5cclxuICAvLyNyZWdpb24gQXZsRm9ybUNvbnRyb2xcclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWVtYmVyLW9yZGVyaW5nXHJcbiAgQE91dHB1dCgpIGludmFsaWRDaGFuZ2U6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG5cclxuICBASG9zdExpc3RlbmVyKCdpbnZhbGlkLWNoYW5nZWQnLCBbJyRldmVudCddKVxyXG4gIGludmFsaWRDaGFuZ2VkKGU6IEN1c3RvbUV2ZW50KSB7XHJcbiAgICB0aGlzLmludmFsaWRDaGFuZ2UuZW1pdChlLmRldGFpbC52YWx1ZSk7XHJcbiAgICAvLyBUcmlnZ2VyIHZhbGlkYXRpb25cclxuICAgIGlmICh0aGlzLm9uQ2hhbmdlQ2FsbGJhY2spIHtcclxuICAgICAgdGhpcy5vbkNoYW5nZUNhbGxiYWNrKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50W3RoaXMudmFsdWVQcm9wZXJ0eU5hbWVdKTtcclxuICAgIH1cclxuICB9XHJcbiAgLy8jZW5kcmVnaW9uXHJcblxyXG4gIC8vI3JlZ2lvbiBWYWxpZGF0b3JcclxuICB2YWxpZGF0ZShjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCB7XHJcbiAgICBjb25zdCBmb3JtQ29udHJvbCA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50IGFzIEF2bEZvcm1Db250cm9sO1xyXG4gICAgaWYgKGZvcm1Db250cm9sLmludmFsaWQpIHtcclxuICAgICAgcmV0dXJuIHsgaW52YWxpZDogZm9ybUNvbnRyb2wuZXJyb3JNZXNzYWdlIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICB9XHJcbiAgLy8jZW5kcmVnaW9uXHJcbn1cclxuIl19