import { Directive, EventEmitter, HostListener, Output, forwardRef, Input } from '@angular/core';
import { AvlInteractionControlDirective } from './avl-interaction-control.directive';
import { NG_VALUE_ACCESSOR, NG_VALIDATORS } from '@angular/forms';
import * as i0 from "@angular/core";
// Defines which property is used as the 'value' for the ControlValueAccessor
const valuePropertyNameMap = {
    // TODO: is there a nameof function is typescript?
    'avl-checkbox': 'checked',
    'avl-date': 'value',
    'avl-dropdown': 'selectedValue',
    'avl-time': 'value',
    'avl-numberfield': 'value',
    'avl-radio-group': 'selectedValue',
    'avl-slider': 'value',
    'avl-textarea': 'value',
    'avl-textfield': 'value',
    'avl-timespan': 'value',
    'avl-chip-list': 'selectedValue',
    'avl-chip-input': 'selectedValues',
    'avl-upload': 'files',
    'avl-search-bar': 'query',
    'avl-icon-toggle': 'checked',
    'avl-switch': 'checked'
};
/** Directive for controls implementing [AvlFormControl]. */
export class AvlFormControlDirective extends AvlInteractionControlDirective {
    constructor(elementRef, renderer) {
        super(elementRef);
        this.elementRef = elementRef;
        this.renderer = renderer;
        this.writeValueAlreadyCalled = false;
        //#endregion
        //#region AvlFormControl
        // tslint:disable-next-line:member-ordering
        this.invalidChange = new EventEmitter();
        const controlTag = this.elementRef.nativeElement.tagName.toLowerCase();
        this.valuePropertyName = valuePropertyNameMap[controlTag];
    }
    // Angular writes readonly attributes to a readOnly property,
    // because that's how it's called on the native input element.
    set readonly(value) {
        if (typeof value === 'boolean') {
            this.elementRef.nativeElement.readonly = value;
        }
        else {
            this.elementRef.nativeElement.readonly = value != null;
        }
    }
    ngOnInit() {
        this.unlistenPropertyChangedEvent =
            this.renderer.listen(this.elementRef.nativeElement, `${this.toKebabCase(this.valuePropertyName)}-changed`, (e) => {
                if (this.onChangeCallback) {
                    this.onChangeCallback(e.detail.value);
                }
            });
    }
    ngOnDestroy() {
        if (this.unlistenPropertyChangedEvent) {
            this.unlistenPropertyChangedEvent();
        }
    }
    writeValue(value) {
        // Because of a bug in Angular writeValue sometimes gets called with a null before being called with the real value,
        // so the null is discarded.
        // TODO: remove when issue is fixed: https://github.com/angular/angular/issues/14988
        if (!this.writeValueAlreadyCalled && value == null) {
            this.writeValueAlreadyCalled = true;
            return;
        }
        this.renderer.setProperty(this.elementRef.nativeElement, this.valuePropertyName, value);
        this.writeValueAlreadyCalled = true;
    }
    registerOnChange(fn) {
        this.onChangeCallback = fn;
    }
    registerOnTouched(fn) {
        this.onTouchedCallback = fn;
    }
    setDisabledState(isDisabled) {
        this.renderer.setProperty(this.elementRef.nativeElement, 'disabled', isDisabled);
    }
    onBlur() {
        if (this.onTouchedCallback) {
            this.onTouchedCallback();
        }
    }
    onFocusedChanged(focused) {
        if (!focused && this.onTouchedCallback) {
            this.onTouchedCallback();
        }
    }
    toKebabCase(camelCaseString) {
        return camelCaseString.replace(/([a-z])([A-Z])/g, '$1-$2').toLowerCase();
    }
    invalidChanged(e) {
        this.invalidChange.emit(e.detail.value);
        // Trigger validation
        if (this.onChangeCallback) {
            this.onChangeCallback(this.elementRef.nativeElement[this.valuePropertyName]);
        }
    }
    //#endregion
    //#region Validator
    validate(control) {
        const formControl = this.elementRef.nativeElement;
        if (formControl.invalid) {
            return { invalid: formControl.errorMessage };
        }
        else {
            return null;
        }
    }
}
AvlFormControlDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.4", ngImport: i0, type: AvlFormControlDirective, deps: [{ token: i0.ElementRef }, { token: i0.Renderer2 }], target: i0.ɵɵFactoryTarget.Directive });
AvlFormControlDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.0.4", type: AvlFormControlDirective, selector: "avl-date,avl-dropdown,avl-time,avl-icon-toggle,avl-numberfield,avl-radio-group,avl-slider,avl-textarea,avl-textfield,avl-timespan,avl-checkbox,avl-switch,avl-chip-list,avl-upload,avl-search-bar,avl-chip-input", inputs: { readonly: "readonly" }, outputs: { invalidChange: "invalidChange" }, host: { listeners: { "blur": "onBlur()", "focused-changed": "onFocusedChanged($event.detail.value)", "invalid-changed": "invalidChanged($event)" } }, providers: [{ provide: NG_VALUE_ACCESSOR, useExisting: forwardRef(() => AvlFormControlDirective), multi: true },
        { provide: NG_VALIDATORS, useExisting: forwardRef(() => AvlFormControlDirective), multi: true }], usesInheritance: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.4", ngImport: i0, type: AvlFormControlDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: 'avl-date,avl-dropdown,avl-time,avl-icon-toggle,avl-numberfield,avl-radio-group,avl-slider,avl-textarea,avl-textfield,avl-timespan,avl-checkbox,avl-switch,avl-chip-list,avl-upload,avl-search-bar,avl-chip-input',
                    providers: [{ provide: NG_VALUE_ACCESSOR, useExisting: forwardRef(() => AvlFormControlDirective), multi: true },
                        { provide: NG_VALIDATORS, useExisting: forwardRef(() => AvlFormControlDirective), multi: true }]
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.Renderer2 }]; }, propDecorators: { readonly: [{
                type: Input
            }], onBlur: [{
                type: HostListener,
                args: ['blur']
            }], onFocusedChanged: [{
                type: HostListener,
                args: ['focused-changed', ['$event.detail.value']]
            }], invalidChange: [{
                type: Output
            }], invalidChanged: [{
                type: HostListener,
                args: ['invalid-changed', ['$event']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXZsLWZvcm0tY29udHJvbC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1iaW5kZXJzL3NyYy9saWIvaW50ZXJmYWNlL2F2bC1mb3JtLWNvbnRyb2wuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQTRDLFVBQVUsRUFBRSxLQUFLLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0ksT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDckYsT0FBTyxFQUF3QixpQkFBaUIsRUFBZ0QsYUFBYSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7O0FBR3RJLDZFQUE2RTtBQUM3RSxNQUFNLG9CQUFvQixHQUFHO0lBQzNCLGtEQUFrRDtJQUNsRCxjQUFjLEVBQUUsU0FBUztJQUN6QixVQUFVLEVBQUUsT0FBTztJQUNuQixjQUFjLEVBQUUsZUFBZTtJQUMvQixVQUFVLEVBQUUsT0FBTztJQUNuQixpQkFBaUIsRUFBRSxPQUFPO0lBQzFCLGlCQUFpQixFQUFFLGVBQWU7SUFDbEMsWUFBWSxFQUFFLE9BQU87SUFDckIsY0FBYyxFQUFFLE9BQU87SUFDdkIsZUFBZSxFQUFFLE9BQU87SUFDeEIsY0FBYyxFQUFFLE9BQU87SUFDdkIsZUFBZSxFQUFHLGVBQWU7SUFDakMsZ0JBQWdCLEVBQUUsZ0JBQWdCO0lBQ2xDLFlBQVksRUFBRSxPQUFPO0lBQ3JCLGdCQUFnQixFQUFFLE9BQU87SUFDekIsaUJBQWlCLEVBQUUsU0FBUztJQUM1QixZQUFZLEVBQUUsU0FBUztDQUN4QixDQUFDO0FBRUYsNERBQTREO0FBTTVELE1BQU0sT0FBTyx1QkFBd0IsU0FBUSw4QkFBOEI7SUFxQnpFLFlBQXNCLFVBQXNCLEVBQVUsUUFBbUI7UUFDdkUsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FB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RSxLQUFLLEVBQUUsSUFBSSxFQUFFO3dCQUMvRyxFQUFFLE9BQU8sRUFBRSxhQUFhLEVBQUUsV0FBVyxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUUsd0JBQXdCLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUM7aUJBQ2pHO3lIQWNZLFFBQVE7c0JBRGxCLEtBQUs7Z0JBdUROLE1BQU07c0JBREwsWUFBWTt1QkFBQyxNQUFNO2dCQVFwQixnQkFBZ0I7c0JBRGYsWUFBWTt1QkFBQyxpQkFBaUIsRUFBRSxDQUFDLHFCQUFxQixDQUFDO2dCQWM5QyxhQUFhO3NCQUF0QixNQUFNO2dCQUdQLGNBQWM7c0JBRGIsWUFBWTt1QkFBQyxpQkFBaUIsRUFBRSxDQUFDLFFBQVEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgRXZlbnRFbWl0dGVyLCBIb3N0TGlzdGVuZXIsIE91dHB1dCwgT25Jbml0LCBPbkRlc3Ryb3ksIEVsZW1lbnRSZWYsIFJlbmRlcmVyMiwgZm9yd2FyZFJlZiwgSW5wdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQXZsSW50ZXJhY3Rpb25Db250cm9sRGlyZWN0aXZlIH0gZnJvbSAnLi9hdmwtaW50ZXJhY3Rpb24tY29udHJvbC5kaXJlY3RpdmUnO1xyXG5pbXBvcnQgeyBDb250cm9sVmFsdWVBY2Nlc3NvciwgTkdfVkFMVUVfQUNDRVNTT1IsIFZhbGlkYXRvciwgQWJzdHJhY3RDb250cm9sLCBWYWxpZGF0aW9uRXJyb3JzLCBOR19WQUxJREFUT1JTIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBBdmxGb3JtQ29udHJvbCB9IGZyb20gJ0BhdmwtaW50ZXJmYWNlcy9pbnRlcmZhY2VzJztcclxuXHJcbi8vIERlZmluZXMgd2hpY2ggcHJvcGVydHkgaXMgdXNlZCBhcyB0aGUgJ3ZhbHVlJyBmb3IgdGhlIENvbnRyb2xWYWx1ZUFjY2Vzc29yXHJcbmNvbnN0IHZhbHVlUHJvcGVydHlOYW1lTWFwID0ge1xyXG4gIC8vIFRPRE86IGlzIHRoZXJlIGEgbmFtZW9mIGZ1bmN0aW9uIGlzIHR5cGVzY3JpcHQ/XHJcbiAgJ2F2bC1jaGVja2JveCc6ICdjaGVja2VkJyxcclxuICAnYXZsLWRhdGUnOiAndmFsdWUnLFxyXG4gICdhdmwtZHJvcGRvd24nOiAnc2VsZWN0ZWRWYWx1ZScsXHJcbiAgJ2F2bC10aW1lJzogJ3ZhbHVlJyxcclxuICAnYXZsLW51bWJlcmZpZWxkJzogJ3ZhbHVlJyxcclxuICAnYXZsLXJhZGlvLWdyb3VwJzogJ3NlbGVjdGVkVmFsdWUnLFxyXG4gICdhdmwtc2xpZGVyJzogJ3ZhbHVlJyxcclxuICAnYXZsLXRleHRhcmVhJzogJ3ZhbHVlJyxcclxuICAnYXZsLXRleHRmaWVsZCc6ICd2YWx1ZScsXHJcbiAgJ2F2bC10aW1lc3Bhbic6ICd2YWx1ZScsXHJcbiAgJ2F2bC1jaGlwLWxpc3QnIDogJ3NlbGVjdGVkVmFsdWUnLFxyXG4gICdhdmwtY2hpcC1pbnB1dCc6ICdzZWxlY3RlZFZhbHVlcycsXHJcbiAgJ2F2bC11cGxvYWQnOiAnZmlsZXMnLFxyXG4gICdhdmwtc2VhcmNoLWJhcic6ICdxdWVyeScsXHJcbiAgJ2F2bC1pY29uLXRvZ2dsZSc6ICdjaGVja2VkJyxcclxuICAnYXZsLXN3aXRjaCc6ICdjaGVja2VkJ1xyXG59O1xyXG5cclxuLyoqIERpcmVjdGl2ZSBmb3IgY29udHJvbHMgaW1wbGVtZW50aW5nIFtBdmxGb3JtQ29udHJvbF0uICovXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnYXZsLWRhdGUsYXZsLWRyb3Bkb3duLGF2bC10aW1lLGF2bC1pY29uLXRvZ2dsZSxhdmwtbnVtYmVyZmllbGQsYXZsLXJhZGlvLWdyb3VwLGF2bC1zbGlkZXIsYXZsLXRleHRhcmVhLGF2bC10ZXh0ZmllbGQsYXZsLXRpbWVzcGFuLGF2bC1jaGVja2JveCxhdmwtc3dpdGNoLGF2bC1jaGlwLWxpc3QsYXZsLXVwbG9hZCxhdmwtc2VhcmNoLWJhcixhdmwtY2hpcC1pbnB1dCcsXHJcbiAgcHJvdmlkZXJzOiBbeyBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUiwgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gQXZsRm9ybUNvbnRyb2xEaXJlY3RpdmUpLCBtdWx0aTogdHJ1ZSB9LFxyXG4gIHsgcHJvdmlkZTogTkdfVkFMSURBVE9SUywgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gQXZsRm9ybUNvbnRyb2xEaXJlY3RpdmUpLCBtdWx0aTogdHJ1ZSB9XVxyXG59KVxyXG5leHBvcnQgY2xhc3MgQXZsRm9ybUNvbnRyb2xEaXJlY3RpdmUgZXh0ZW5kcyBBdmxJbnRlcmFjdGlvbkNvbnRyb2xEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSwgQ29udHJvbFZhbHVlQWNjZXNzb3IsIFZhbGlkYXRvciB7XHJcbiAgLy8jcmVnaW9uIENvbnRyb2xWYWx1ZUFjY2Vzc29yXHJcbiAgcHJpdmF0ZSB2YWx1ZVByb3BlcnR5TmFtZTtcclxuICBwcml2YXRlIG9uVG91Y2hlZENhbGxiYWNrOiAoKSA9PiB7fTtcclxuICBwcml2YXRlIG9uQ2hhbmdlQ2FsbGJhY2s6ICh2YWx1ZTogYW55KSA9PiB2b2lkO1xyXG5cclxuICBwcml2YXRlIHVubGlzdGVuUHJvcGVydHlDaGFuZ2VkRXZlbnQ6ICgpID0+IHZvaWQ7XHJcblxyXG4gIHByaXZhdGUgd3JpdGVWYWx1ZUFscmVhZHlDYWxsZWQgPSBmYWxzZTtcclxuXHJcbiAgLy8gQW5ndWxhciB3cml0ZXMgcmVhZG9ubHkgYXR0cmlidXRlcyB0byBhIHJlYWRPbmx5IHByb3BlcnR5LFxyXG4gIC8vIGJlY2F1c2UgdGhhdCdzIGhvdyBpdCdzIGNhbGxlZCBvbiB0aGUgbmF0aXZlIGlucHV0IGVsZW1lbnQuXHJcbiAgQElucHV0KClcclxuICBwdWJsaWMgc2V0IHJlYWRvbmx5KHZhbHVlOiBhbnkpIHtcclxuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJykge1xyXG4gICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5yZWFkb25seSA9IHZhbHVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucmVhZG9ubHkgPSB2YWx1ZSAhPSBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMikge1xyXG4gICAgc3VwZXIoZWxlbWVudFJlZik7XHJcbiAgICBjb25zdCBjb250cm9sVGFnID0gKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50IGFzIEhUTUxFbGVtZW50KS50YWdOYW1lLnRvTG93ZXJDYXNlKCk7XHJcbiAgICB0aGlzLnZhbHVlUHJvcGVydHlOYW1lID0gdmFsdWVQcm9wZXJ0eU5hbWVNYXBbY29udHJvbFRhZ107XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMudW5saXN0ZW5Qcm9wZXJ0eUNoYW5nZWRFdmVudCA9XHJcbiAgICAgIHRoaXMucmVuZGVyZXIubGlzdGVuKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCBgJHt0aGlzLnRvS2ViYWJDYXNlKHRoaXMudmFsdWVQcm9wZXJ0eU5hbWUpfS1jaGFuZ2VkYCwgKGU6IEN1c3RvbUV2ZW50KSA9PiB7XHJcbiAgICAgICAgaWYgKHRoaXMub25DaGFuZ2VDYWxsYmFjaykge1xyXG4gICAgICAgICAgdGhpcy5vbkNoYW5nZUNhbGxiYWNrKGUuZGV0YWlsLnZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy51bmxpc3RlblByb3BlcnR5Q2hhbmdlZEV2ZW50KSB7XHJcbiAgICAgIHRoaXMudW5saXN0ZW5Qcm9wZXJ0eUNoYW5nZWRFdmVudCgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgd3JpdGVWYWx1ZSh2YWx1ZTogYW55KSB7XHJcbiAgICAvLyBCZWNhdXNlIG9mIGEgYnVnIGluIEFuZ3VsYXIgd3JpdGVWYWx1ZSBzb21ldGltZXMgZ2V0cyBjYWxsZWQgd2l0aCBhIG51bGwgYmVmb3JlIGJlaW5nIGNhbGxlZCB3aXRoIHRoZSByZWFsIHZhbHVlLFxyXG4gICAgLy8gc28gdGhlIG51bGwgaXMgZGlzY2FyZGVkLlxyXG4gICAgLy8gVE9ETzogcmVtb3ZlIHdoZW4gaXNzdWUgaXMgZml4ZWQ6IGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIvaXNzdWVzLzE0OTg4XHJcbiAgICBpZiAoIXRoaXMud3JpdGVWYWx1ZUFscmVhZHlDYWxsZWQgJiYgdmFsdWUgPT0gbnVsbCkge1xyXG4gICAgICB0aGlzLndyaXRlVmFsdWVBbHJlYWR5Q2FsbGVkID0gdHJ1ZTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgdGhpcy52YWx1ZVByb3BlcnR5TmFtZSwgdmFsdWUpO1xyXG4gICAgdGhpcy53cml0ZVZhbHVlQWxyZWFkeUNhbGxlZCA9IHRydWU7XHJcbiAgfVxyXG5cclxuICByZWdpc3Rlck9uQ2hhbmdlKGZuOiAodmFsdWU6IGFueSkgPT4gdm9pZCkge1xyXG4gICAgdGhpcy5vbkNoYW5nZUNhbGxiYWNrID0gZm47XHJcbiAgfVxyXG5cclxuICByZWdpc3Rlck9uVG91Y2hlZChmbjogYW55KSB7XHJcbiAgICB0aGlzLm9uVG91Y2hlZENhbGxiYWNrID0gZm47XHJcbiAgfVxyXG5cclxuICBzZXREaXNhYmxlZFN0YXRlKGlzRGlzYWJsZWQ6IGJvb2xlYW4pIHtcclxuICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsICdkaXNhYmxlZCcsIGlzRGlzYWJsZWQpO1xyXG4gIH1cclxuXHJcbiAgQEhvc3RMaXN0ZW5lcignYmx1cicpXHJcbiAgb25CbHVyKCkge1xyXG4gICAgaWYgKHRoaXMub25Ub3VjaGVkQ2FsbGJhY2spIHtcclxuICAgICAgdGhpcy5vblRvdWNoZWRDYWxsYmFjaygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgQEhvc3RMaXN0ZW5lcignZm9jdXNlZC1jaGFuZ2VkJywgWyckZXZlbnQuZGV0YWlsLnZhbHVlJ10pXHJcbiAgb25Gb2N1c2VkQ2hhbmdlZChmb2N1c2VkKSB7XHJcbiAgICBpZiAoIWZvY3VzZWQgJiYgdGhpcy5vblRvdWNoZWRDYWxsYmFjaykge1xyXG4gICAgICB0aGlzLm9uVG91Y2hlZENhbGxiYWNrKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHRvS2ViYWJDYXNlKGNhbWVsQ2FzZVN0cmluZzogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBjYW1lbENhc2VTdHJpbmcucmVwbGFjZSgvKFthLXpdKShbQS1aXSkvZywgJyQxLSQyJykudG9Mb3dlckNhc2UoKTtcclxuICB9XHJcbiAgLy8jZW5kcmVnaW9uXHJcblxyXG4gIC8vI3JlZ2lvbiBBdmxGb3JtQ29udHJvbFxyXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptZW1iZXItb3JkZXJpbmdcclxuICBAT3V0cHV0KCkgaW52YWxpZENoYW5nZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ2ludmFsaWQtY2hhbmdlZCcsIFsnJGV2ZW50J10pXHJcbiAgaW52YWxpZENoYW5nZWQoZTogQ3VzdG9tRXZlbnQpIHtcclxuICAgIHRoaXMuaW52YWxpZENoYW5nZS5lbWl0KGUuZGV0YWlsLnZhbHVlKTtcclxuICAgIC8vIFRyaWdnZXIgdmFsaWRhdGlvblxyXG4gICAgaWYgKHRoaXMub25DaGFuZ2VDYWxsYmFjaykge1xyXG4gICAgICB0aGlzLm9uQ2hhbmdlQ2FsbGJhY2sodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnRbdGhpcy52YWx1ZVByb3BlcnR5TmFtZV0pO1xyXG4gICAgfVxyXG4gIH1cclxuICAvLyNlbmRyZWdpb25cclxuXHJcbiAgLy8jcmVnaW9uIFZhbGlkYXRvclxyXG4gIHZhbGlkYXRlKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCk6IFZhbGlkYXRpb25FcnJvcnMgfCBudWxsIHtcclxuICAgIGNvbnN0IGZvcm1Db250cm9sID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQgYXMgQXZsRm9ybUNvbnRyb2w7XHJcbiAgICBpZiAoZm9ybUNvbnRyb2wuaW52YWxpZCkge1xyXG4gICAgICByZXR1cm4geyBpbnZhbGlkOiBmb3JtQ29udHJvbC5lcnJvck1lc3NhZ2UgfTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gIH1cclxuICAvLyNlbmRyZWdpb25cclxufVxyXG4iXX0=